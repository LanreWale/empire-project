<script>
(function(){
  const $ = s => document.querySelector(s);

  // Keep invite token for later (unchanged)
  const usp = new URLSearchParams(location.search);
  const i = usp.get('i'); if(i){ sessionStorage.setItem('empire.invite', i); }

  const modal = document.getElementById('loginModal');
  const idInput = document.getElementById('identifier');
  const err = document.getElementById('err');
  const goBtn = document.getElementById('goBtn');
  const modalTitle = document.getElementById('modalTitle');

  let role = 'user';

  function openModal(nextRole){
    role = nextRole;
    localStorage.setItem('empire.role', role);
    modalTitle.textContent = role==='commander' ? 'Commander Login' : 'User Login';
    document.querySelector('label[for="identifier"]').textContent =
      role==='commander' ? 'Commander passphrase' : 'Email or phone';
    idInput.placeholder = role==='commander' ? 'Enter Commander passphrase' : 'you@example.com or +234…';
    idInput.type = role==='commander' ? 'password' : 'text';
    err.style.display='none'; err.textContent='';
    idInput.value='';
    modal.style.display='flex';
    setTimeout(()=>idInput.focus(),50);
  }

  document.querySelector('[data-role="commander"]').onclick = ()=>openModal('commander');
  document.querySelector('[data-role="user"]').onclick = ()=>openModal('user');
  document.getElementById('cancelBtn').onclick = ()=> modal.style.display='none';
  document.getElementById('closeModal').onclick = ()=> modal.style.display='none';
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });
  idInput.addEventListener('keydown', e=>{ if(e.key==='Enter') goBtn.click(); });

  goBtn.addEventListener('click', async ()=>{
    const cred = (idInput.value||'').trim();
    if(!cred){ err.textContent='Please enter your credential.'; err.style.display='block'; return; }

    goBtn.disabled=true; goBtn.textContent='Checking…';
    try{
      if(role==='commander'){
        // passphrase path
        await EmpireAuth.login({mode:'commander', pass: cred});
      }else{
        // user path
        await EmpireAuth.login({mode:'user', id: cred});
      }
      location.href = '/dashboard.html';
    }catch(e){
      err.textContent = 'Access denied: unauthorized';
      err.style.display='block';
      goBtn.disabled=false; goBtn.textContent='Enter The Empire';
    }
  });

  // Auto skip if already authed
  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const me = await EmpireAuth.whoami();
      if(me && me.role){ location.href='/dashboard.html'; }
    }catch{}
  });
})();
</script>