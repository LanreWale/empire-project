<script>
/* ========= CONFIG ========= */
const GAS = "https://script.google.com/macros/s/AKfycbwZVlGMvYonfCNdQlwPHiqqgOVC80_HsyktSYmqmQPBKmRrlzg_yo4lKz_Mmu85B7eY/exec";
const POLL_FAST = 5000;
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const dollars = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD'});

/* ---------- fetch helpers ---------- */
async function get(url, opt={}){
  try{
    const u = new URL(url);
    u.searchParams.set('_t', Date.now());
    const r = await fetch(u, {cache:'no-store', ...opt});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }catch(e){ console.error('GET failed:', e); return null; }
}
function api(action, params={}){
  const u = new URL(GAS);
  u.searchParams.set('action', action);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
  return get(u);
}
async function apiWrite(action, payload={}){
  const url = new URL(GAS);
  url.searchParams.set('action', action);
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }catch{
    Object.entries(payload||{}).forEach(([k,v])=>url.searchParams.set(k, typeof v==='object'?JSON.stringify(v):String(v)));
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
}

/* ---------- normalizers ---------- */
const arr = (m)=> Array.isArray(m) ? m
  : (m&&Array.isArray(m.items)?m.items
  :(m&&Array.isArray(m.rows)?m.rows
  :(m&&Array.isArray(m.data)?m.data:[])));
const obj = (m)=> (m && typeof m==='object')? m : {};
const normDomain = d=> String(d||'').trim().replace(/^https?:\/\//,'').replace(/\/.*$/,'');

/* ---------- flexible getters + live fallbacks ---------- */
const firstVal = (o, keys, fallback=null) => {
  for (const k of keys) if (o && o[k] != null) return o[k];
  return fallback;
};
async function liveGeoSnapshot(windowMin=60){
  const j = await api('analytics', { live:1, windowSec: windowMin*60, limit: 500 });
  const events = arr(j?.live) || arr(j);
  const byGeo = {};
  events.forEach(ev=>{
    const c = ev.country || 'Unknown';
    if(!byGeo[c]) byGeo[c] = {country:c, clicks:0, leads:0, earnings:0};
    byGeo[c].clicks   += Number(ev.clicks||0);
    byGeo[c].leads    += Number(ev.conversions||ev.conv||0);
    byGeo[c].earnings += Number(ev.earnings||0);
  });
  return byGeo;
}
async function liveSourcesSnapshot(windowMin=60){
  const j = await api('analytics', { live:1, windowSec: windowMin*60, limit: 500 });
  const events = arr(j?.live) || arr(j);
  const map = {};
  events.forEach(ev=>{
    const key = ev.source || ev.channel || ev.offerType || 'Other';
    map[key] = (map[key]||0) + Number(ev.earnings||0);
  });
  return map;
}

/* ---------- tiny SVG chart helpers ---------- */
function renderBarChart(el, series=[], labels=[]){
  const host = (typeof el==='string')? $(el) : el;
  if(!host) return;
  host.classList.remove('empty'); host.innerHTML='';
  if(!series.length){ host.classList.add('empty'); host.textContent='No data'; return; }
  const W = host.clientWidth || 600, H = 220, pad=28;
  const max = Math.max(...series.map(v=>Number(v)||0), 1);
  const bw = (W - pad*2) / series.length;
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  const axis = document.createElementNS(svg.namespaceURI,'line');
  axis.setAttribute('x1', pad); axis.setAttribute('y1', H-pad);
  axis.setAttribute('x2', W-pad); axis.setAttribute('y2', H-pad);
  axis.setAttribute('stroke', '#2a4b6a'); axis.setAttribute('stroke-width', '1');
  svg.appendChild(axis);
  series.forEach((v,i)=>{
    const val = Number(v)||0;
    const h = (val/max) * (H - pad*2);
    const x = pad + i*bw + 6, y = (H-pad) - h;
    const rect = document.createElementNS(svg.namespaceURI,'rect');
    rect.setAttribute('x', x); rect.setAttribute('y', y);
    rect.setAttribute('width', Math.max(8, bw-12)); rect.setAttribute('height', Math.max(0,h));
    rect.setAttribute('fill', '#ffd559'); svg.appendChild(rect);
    if(labels[i]){
      const tx = document.createElementNS(svg.namespaceURI,'text');
      tx.setAttribute('x', x + (bw-12)/2); tx.setAttribute('y', H - pad + 14);
      tx.setAttribute('text-anchor', 'middle'); tx.setAttribute('font-size', '10'); tx.setAttribute('fill', '#86a7c9');
      tx.textContent = labels[i].length>8 ? labels[i].slice(0,8)+'…' : labels[i];
      svg.appendChild(tx);
    }
  });
  host.appendChild(svg);
}
function renderPieChart(el, map={}){
  const host = (typeof el==='string')? $(el) : el;
  if(!host) return;
  host.classList.remove('empty'); host.innerHTML='';
  const entries = Object.entries(map||{}).filter(([,v])=>Number(v)>0);
  if(!entries.length){ host.classList.add('empty'); host.textContent='No data'; return; }
  const W=220,H=220,R=90,CX=W/2,CY=H/2;
  const total = entries.reduce((s,[,v])=>s+Number(v),0);
  let angle = -Math.PI/2;
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  entries.forEach(([k,v])=>{
    const frac = Number(v)/total, theta = frac*2*Math.PI;
    const x1=CX+R*Math.cos(angle), y1=CY+R*Math.sin(angle);
    const x2=CX+R*Math.cos(angle+theta), y2=CY+R*Math.sin(angle+theta);
    const large = theta>Math.PI ? 1 : 0;
    const path = document.createElementNS(svg.namespaceURI,'path');
    path.setAttribute('d', `M ${CX} ${CY} L ${x1} ${y1} A ${R} ${R} 0 ${large} 1 ${x2} ${y2} Z`);
    path.setAttribute('fill', '#ffd559'); path.setAttribute('opacity', 0.5 + 0.5*Math.random());
    svg.appendChild(path); angle += theta;
  });
  host.appendChild(svg);
}

/* ========= ROUTER ========= */
function show(route){
  $$('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.route===route));
  $$('[data-page]').forEach(s=>s.style.display = (s.dataset.page===route)?'block':'none');
  if(route==='dashboard') initDashboard();
  if(route==='cpa')       initCpa();
  if(route==='users')     initUsers(currentUsersTab);
  if(route==='analytics') initAnalytics();
  if(route==='wallet')    initWallet();
  if(route==='monitor')   initMonitor();
  if(route==='settings')  initSettings();
}
window.addEventListener('hashchange', ()=>{ const r=(location.hash||'#dashboard').replace('#',''); show(r); });
$('#nav').addEventListener('click', e=>{
  const a = e.target.closest('a'); if(!a) return;
  e.preventDefault(); location.hash = '#'+a.dataset.route;
});

/* ========= DASHBOARD ========= */
async function initDashboard(){
  try{
    const [ov, us] = await Promise.all([ api('overview'), api('users', {status:'APPROVED'}) ]);

    // KPIs
    const t = ov && ov.totals ? ov.totals : (ov||{});
    $('#dash-earn').textContent   = dollars(t.earnings||0);
    $('#dash-clicks').textContent = t.clicks||0;
    const cr = (t.conversionRate!=null) ? Number(t.conversionRate)
              : (t.leads && t.clicks ? (t.leads/t.clicks*100) : 0);
    $('#dash-cr').textContent = Number(cr||0).toFixed(2) + '%';
    $('#dash-users').textContent = arr(us).length;

    // Daily earnings (multi-shape + live fallback)
    let byDay = [];
    if (Array.isArray(ov?.byDay)) byDay = ov.byDay;
    else if (Array.isArray(firstVal(ov, ['days','byday','performance','overviewByDay'], [])))
      byDay = firstVal(ov, ['days','byday','performance','overviewByDay']);
    if (byDay.length){
      renderBarChart('#dash-earnings',
        byDay.map(d=>Number(d.earnings||d.revenue||d.value||0)),
        byDay.map(d=>String(d.t||d.date||d.day||'')));
    } else {
      const live = await api('analytics', { live:1, windowSec: 24*3600, limit: 1000 });
      const evs = arr(live?.live) || arr(live);
      const buckets = {};
      evs.forEach(e=>{ const k=(e.time||'').slice(0,13); buckets[k]=(buckets[k]||0)+Number(e.earnings||0); });
      const keys = Object.keys(buckets).sort().slice(-12);
      if(keys.length) renderBarChart('#dash-earnings', keys.map(k=>buckets[k]), keys.map(k=>k.slice(5)));
      else { const host=$('#dash-earnings'); host.classList.add('empty'); host.textContent='No data'; }
    }

    // Traffic sources (offerTypes/… OR live)
    let sources = firstVal(ov, ['offerTypes','sources','trafficSources','channels','offersByType'], {});
    if (!sources || !Object.keys(sources).length) sources = await liveSourcesSnapshot(60);
    renderPieChart('#dash-sources', sources);

    // By Geo (earnings from overview; clicks/leads from detail or live)
    const tb = $('#tbl-dash-geo'); tb.innerHTML='';
    const geoEarnings = firstVal(ov, ['geo','geoEarnings','earningsByGeo'], {});
    let rows = Object.keys(geoEarnings).map(k=>({country:k, earnings:Number(geoEarnings[k])}))
                 .sort((a,b)=>b.earnings-a.earnings).slice(0,10);
    const geoDetail = Array.isArray(ov?.byGeo) ? ov.byGeo
                     : Array.isArray(ov?.geoDetail) ? ov.geoDetail : [];
    if(!rows.length){
      const liveGeo = await liveGeoSnapshot(60);
      rows = Object.values(liveGeo).sort((a,b)=>b.earnings-a.earnings).slice(0,10)
             .map(g=>({country:g.country, earnings:g.earnings, _clicks:g.clicks, _leads:g.leads}));
    }
    if(!rows.length){ tb.innerHTML='<tr><td colspan="4" class="muted">No data</td></tr>'; }
    else{
      let liveIndex = {};
      if (!geoDetail.length || geoDetail.every(x=>!x.clicks && !x.leads)) liveIndex = await liveGeoSnapshot(60);
      rows.forEach(g=>{
        const match = geoDetail.find(x=>String(x.country).toUpperCase()===String(g.country).toUpperCase());
        const clicks = match ? Number(match.clicks||0) : (liveIndex[g.country]?.clicks||g._clicks||0);
        const leads  = match ? Number(match.leads||0)  : (liveIndex[g.country]?.leads ||g._leads ||0);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${g.country}</td><td>${clicks}</td><td>${leads}</td><td class="money">${dollars(g.earnings||0)}</td>`;
        tb.appendChild(tr);
      });
    }
  }catch(e){ console.error('initDashboard error', e); }
}

/* ========= CPA ACCOUNTS ========= */
async function initCpa(){
  const wrap = $('#cpa-grid'); wrap.innerHTML='';
  try{
    const resp = await api('cpa');
    const items = arr(resp);
    if(!items.length){ wrap.innerHTML = `<div class="card pad empty">No CPA accounts yet.</div>`; return; }
    items.forEach(r=>{
      let convPct = 0;
      const v = (r.conversionrate!=null)? Number(r.conversionrate)
              : (r.conversionRate!=null)? Number(r.conversionRate) : 0;
      convPct = v>1 ? v : v*100;
      const card = document.createElement('div'); card.className='card pad';
      card.innerHTML = `
        <div class="acct">
          <div>
            <h3>${r.account||r.accountid||'—'}</h3>
            <div class="muted" style="margin-bottom:10px">
              Network <b style="color:#fff">${r.network||'—'}</b> · <span class="badge">${(r.status||'ACTIVE')}</span>
            </div>
            <div class="stats">
              <div class="kv"><b>Active Offers</b><span>${r.activeoffers||r.activeOffers||0}</span></div>
              <div class="kv"><b>Revenue</b><span class="money">${dollars(r.revenue||0)}</span></div>
              <div class="kv"><b>Clicks</b><span>${r.clicks||0}</span></div>
              <div class="kv"><b>Conversion</b><span>${convPct.toFixed(2)}%</span></div>
            </div>
          </div>
          <div class="right flex">
            <span class="pill mono">${r.domain||'no-domain'}</span>
            <button class="btn secondary">View Details</button>
          </div>
        </div>`;
      wrap.appendChild(card);
    });
  }catch(e){
    console.error(e);
    wrap.innerHTML = `<div class="card pad empty">Failed to load accounts.</div>`;
  }
}
/* Add New Account modal wiring */
const mdl = document.getElementById('mdl-cpa');
const openMdl  = ()=> mdl.classList.add('open');
const closeMdl = ()=> mdl.classList.remove('open');
document.getElementById('btn-add-acct')?.addEventListener('click', openMdl);
mdl.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) closeMdl(); });
document.getElementById('btn-save-acct')?.addEventListener('click', async ()=>{
  const err = document.getElementById('f-error');
  const v = {
    account : document.getElementById('f-account').value.trim(),
    network : document.getElementById('f-network').value.trim(),
    domain  : normDomain(document.getElementById('f-domain').value),
    status  : document.getElementById('f-status').value,
    apiKey  : document.getElementById('f-key').value.trim(),
    webhook : document.getElementById('f-webhook').value.trim()
  };
  if(!v.account || !v.network){ err.textContent='Account Name and Network are required.'; err.style.display='block'; return; }
  err.style.display='none';
  try{
    const res = await apiWrite('cpaCreate', v);
    if(!res || res.ok!==true) throw new Error('Create failed');
    closeMdl(); await initCpa();
  }catch{ err.textContent='Could not save account. Please try again.'; err.style.display='block'; }
});

/* ========= USERS ========= */
let currentUsersTab = 'APPROVED';
const userTabBtns = $$('[data-users-tab]');
userTabBtns.forEach(b=>b.addEventListener('click',()=>{
  userTabBtns.forEach(x=>x.classList.toggle('active', x===b));
  currentUsersTab = b.dataset.usersTab; initUsers(currentUsersTab);
}));
async function initUsers(tab='APPROVED'){
  const tb = $('#tbl-users'); tb.innerHTML = '';
  try{
    const resp = await api('users', {status: tab});
    let filtered = arr(resp?.items || resp);
    if (!filtered.length) {
      const ALL = arr(resp?.items || resp);
      filtered = ALL.filter(u => String(u.status||'APPROVED').toUpperCase()===tab.toUpperCase());
    }
    if(!filtered.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No ${tab.toLowerCase()} users.</td></tr>`; return; }
    filtered.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.name||'—'}</td><td>${u.email||''}</td><td>${u.phone||''}</td><td>${u.authority||'1x User'}</td>`;
      tb.appendChild(tr);
    });
  }catch{ tb.innerHTML = `<tr><td colspan="4" class="muted">Failed to load users.</td></tr>`; }
}

/* ========= ANALYTICS (base + live) ========= */
let liveTimer=null, liveRows=[];
async function initAnalytics(){
  try{
    const base = await api('analytics');
    let series=[], labels=[];
    const items = arr(base) || arr(base?.items);
    const byDay = Array.isArray(base?.byDay) ? base.byDay
                 : Array.isArray(base?.overviewByDay) ? base.overviewByDay : [];
    if(items.length){
      series = items.map(r=>Number(r.earnings||r.revenue||0));
      labels = items.map(r=>String(r.date||r.t||''));
    }else if(byDay.length){
      series = byDay.map(d=>Number(d.earnings||d.revenue||0));
      labels = byDay.map(d=>String(d.date||d.t||''));
    }else{
      const live = await api('analytics', { live:1, windowSec: 24*3600, limit: 1000 });
      const evs = arr(live?.live) || arr(live);
      const buckets = {};
      evs.forEach(e=>{ const k=(e.time||'').slice(0,13); buckets[k]=(buckets[k]||0)+Number(e.earnings||0); });
      const keys = Object.keys(buckets).sort().slice(-12);
      series = keys.map(k=>buckets[k]); labels = keys.map(k=>k.slice(5));
    }
    if(series.length) renderBarChart('#ana-overview', series, labels);
    else { const host=$('#ana-overview'); host.classList.add('empty'); host.textContent='No data'; }

    let geoMap = firstVal(base, ['geo','geoEarnings','earningsByGeo'], {});
    if(!geoMap || !Object.keys(geoMap).length){
      const liveGeo = await liveGeoSnapshot(60);
      geoMap = Object.fromEntries(Object.values(liveGeo).map(g=>[g.country,g.earnings]));
    }
    renderPieChart('#ana-geo-dist', geoMap);
  }catch{
    const a1=$('#ana-overview'); a1.classList.add('empty'); a1.textContent='Failed to load';
    const a2=$('#ana-geo-dist'); a2.classList.add('empty'); a2.textContent='Failed to load';
  }

  if(liveTimer) clearInterval(liveTimer);
  liveRows = [];
  liveTimer = setInterval(pullLive, POLL_FAST);
  await pullLive();
}
async function pullLive(){
  try{
    const j = await api('analytics', { live:1, limit:24, windowSec:120 });
    const events = arr(j?.live) || arr(j);
    if(!events.length) return;

    liveRows = liveRows.concat(events).slice(-24);
    const tb = $('#tbl-live-perf'); tb.innerHTML='';
    liveRows.slice().reverse().forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML =
        `<td class="mono">${r.time||''}</td><td>${r.country||''}</td><td>${r.offer||''}</td>`+
        `<td>${r.clicks||0}</td><td>${r.conversions||r.conv||0}</td><td class="money">${dollars(r.earnings||0)}</td>`;
      tb.appendChild(tr);
    });

    const byGeo = {};
    events.forEach(ev=>{
      const k = ev.country || 'Unknown';
      if(!byGeo[k]) byGeo[k] = {country:k, clicks:0, conv:0, earnings:0};
      byGeo[k].clicks   += Number(ev.clicks||0);
      byGeo[k].conv     += Number(ev.conversions||ev.conv||0);
      byGeo[k].earnings += Number(ev.earnings||0);
    });
    const tb2 = $('#tbl-live-geo'); tb2.innerHTML='';
    const arrGeo = Object.values(byGeo).sort((a,b)=>b.earnings-a.earnings).slice(0,10);
    if(!arrGeo.length){ tb2.innerHTML='<tr><td colspan="4" class="muted">Waiting for stream…</td></tr>'; return; }
    arrGeo.forEach(g=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${g.country}</td><td>${g.clicks}</td><td>${g.conv}</td><td class="money">${dollars(g.earnings)}</td>`;
      tb2.appendChild(tr);
    });
  }catch{}
}

/* ========= WALLET ========= */
async function initWallet(){
  try{
    const w = obj(await api('wallet'));
    const hist = arr(w.history) || arr(w);
    $('#wal-balance').textContent = dollars(w.balance||0);
    const pendingAmt = hist.filter(t=>String(t.status||'').toUpperCase()==='PENDING')
                           .reduce((s,t)=>s+Number(t.amount||0),0);
    $('#wal-pending').textContent = dollars(pendingAmt);
    const lastPaid = hist.filter(t=>String(t.status||'').toUpperCase()==='COMPLETED').slice(-1)[0];
    $('#wal-last').textContent = dollars(lastPaid ? lastPaid.amount : 0);

    const tb = $('#tbl-wallet'); tb.innerHTML='';
    hist.slice().reverse().forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.date||''}</td><td>${t.method||''}</td><td class="money">${dollars(t.amount||0)}</td><td>${t.status||''}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="4" class="muted">No transactions.</td></tr>`;
  }catch{
    const tb = $('#tbl-wallet'); if(tb) tb.innerHTML = `<tr><td colspan="4" class="muted">Failed to load.</td></tr>`;
  }
}

/* ========= MONITORING ========= */
async function initMonitor(){
  const tb = $('#tbl-monitor'); tb.innerHTML='';
  try{
    const m = obj(await api('monitoring'));
    const events = arr(m.events) || arr(m);
    $('#box-alerts').textContent = events.length;
    $('#box-maint').textContent  = m.maintenance || '—';
    $('#box-health').textContent = m.health || 'OK';
    if(!events.length){ tb.innerHTML = `<tr><td colspan="3" class="muted">No events.</td></tr>`; return; }
    events.forEach(ev=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="mono">${ev.time||''}</td><td>${ev.type||''}</td><td>${ev.msg||ev.message||''}</td>`;
      tb.appendChild(tr);
    });
  }catch{ tb.innerHTML = `<tr><td colspan="3" class="muted">Failed to load.</td></tr>`; }
}

/* ========= SETTINGS ========= */
async function initSettings(){
  try{
    const j = await api('config');
    $('#pretty').textContent = JSON.stringify(j, null, 2);
  }catch{ $('#pretty').textContent = 'Failed to load config'; }
}

/* ========= BOOT ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  const r = (location.hash||'#dashboard').replace('#','');
  show(r);
});
</script>