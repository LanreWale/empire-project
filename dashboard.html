<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Empire — Dashboard</title>
  <meta name="color-scheme" content="dark" />
  <link rel="stylesheet" href="/app/styles/brand.css" />
  <style>
    /* Minimal layout helpers on top of brand.css */
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:#0e1729;border-right:1px solid var(--emp-line);padding:18px 14px}
    .nav-title{font-weight:900;color:#ffd24d;letter-spacing:.4px;margin:4px 0 12px}
    .nav a{display:block;padding:10px 12px;margin:6px 0;border-radius:12px;border:1px solid var(--emp-line);color:var(--emp-ink);text-decoration:none}
    .nav a.active,.nav a:hover{outline:2px solid var(--emp-ring)}
    .content{padding:24px 18px}
    .page-title{display:flex;align-items:center;gap:10px;margin:0 0 12px}
    .page-title .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--emp-line);background:#0f182a;border-radius:999px;padding:6px 10px;color:var(--emp-muted);font-size:12px}
    .grid{display:grid;gap:14px}
    @media(min-width:760px){.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}
    .tab-panel{margin-top:12px}
    .btn{cursor:pointer;border:1px solid var(--emp-line);background:#14203a;color:var(--emp-ink);padding:9px 14px;border-radius:12px}
    .btn.gold{background:linear-gradient(90deg,var(--emp-gold-1),var(--emp-gold-2));color:#10151f;border:none}
    .input{width:100%;background:#0f182a;border:1px solid var(--emp-line);color:var(--emp-ink);padding:10px 12px;border-radius:12px}
    .mt{margin-top:16px}
    .muted{color:var(--emp-muted)}
    .right{display:flex;gap:10px;align-items:center}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--emp-line);text-align:left}
    .chip{display:inline-block;border:1px solid var(--emp-line);border-radius:999px;padding:4px 10px;background:#0f182a}
  </style>
</head>
<body class="brand-bg">
  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="nav-title">EMPIRE</div>
      <nav class="nav">
        <a href="#overview" class="active">Dashboard Overview</a>
        <a href="#accounts">CPA Accounts</a>
        <a href="#users">User Management</a>
        <a href="#analytics">Performance Analytics</a>
        <a href="#wallet">Wallet</a>
        <a href="#security">System Security & Monitoring</a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="content">
      <header class="page-title">
        <img src="/app/assets/brand/emblem.svg" alt="Empire" class="brand-logo" />
        <h1 class="emp-title" style="margin:0">Command Dashboard</h1>
        <span class="badge">Live metrics • Accounts • Users • Analytics • Monitoring</span>
      </header>

      <!-- NAV-TABS via hash -->
      <section id="panel-overview" class="tab-panel">
        <div class="grid cols-2">
          <div class="panel">
            <div class="card-title">Total Earnings (USD)</div>
            <div id="kpi-earn" class="kpi">$0.00</div>
          </div>
          <div class="panel">
            <div class="card-title">Active Users</div>
            <div id="kpi-active" class="kpi">0</div>
          </div>
          <div class="panel">
            <div class="card-title">Approval Rate</div>
            <div id="kpi-approval" class="kpi">—</div>
          </div>
          <div class="panel">
            <div class="card-title">Pending Reviews</div>
            <div id="kpi-pending" class="kpi">0</div>
          </div>
        </div>
        <div class="muted mt" id="summary-note">Loading…</div>
      </section>

      <!-- ACCOUNTS (placeholder structure) -->
      <section id="panel-accounts" class="tab-panel" hidden>
        <div class="panel">
          <div class="right">
            <h3 style="margin:0">CPA Accounts</h3>
            <button class="btn gold" id="btn-add-account">Add New Account</button>
          </div>
          <div class="muted mt">Coming soon: live metrics per account and add-account modal.</div>
        </div>
      </section>

      <!-- USERS (Admin approvals) -->
      <section id="panel-users" class="tab-panel" hidden>
        <div class="panel">
          <h3 style="margin:0 0 10px">Awaiting Approval</h3>

          <div class="right" style="gap:8px;margin-bottom:10px">
            <input id="admin-secret" class="input" placeholder="Enter admin secret…" style="max-width:320px" />
            <button id="save-secret" class="btn">Save</button>
            <button id="load-pending" class="btn">Load pending</button>
            <span id="secret-status" class="muted"></span>
          </div>

          <div class="table-scroll">
            <table class="table">
              <thead>
                <tr><th>Name</th><th>Email</th><th>Phone</th><th>Telegram</th><th>Actions</th></tr>
              </thead>
              <tbody id="pending-body"><tr><td class="muted" colspan="5">Click “Load pending”.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 10px">Approved Users</h3>
          <div class="table-scroll">
            <table class="table" id="users-table">
              <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Scale</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 10px">Add Approved User</h3>
          <div class="grid cols-3">
            <input id="au-name" class="input" placeholder="Full name" />
            <input id="au-email" class="input" placeholder="Email" />
            <input id="au-phone" class="input" placeholder="Phone (+234…)" />
          </div>
          <input id="au-telegram" class="input mt" placeholder="Telegram @handle" />
          <button id="add-user" class="btn gold mt">Add User</button>
          <div id="add-user-status" class="muted mt"></div>
        </div>
      </section>

      <!-- ANALYTICS (placeholder scaffolding) -->
      <section id="panel-analytics" class="tab-panel" hidden>
        <div class="panel">
          <h3 style="margin:0 0 10px">Performance Analytics</h3>
          <div class="muted">Daily / Weekly / Monthly summaries with projected growth — coming soon.</div>
        </div>
      </section>

      <!-- WALLET -->
      <section id="panel-wallet" class="tab-panel" hidden>
        <div class="grid cols-3">
          <div class="card">
            <div class="card-title">Total Inflow (USD)</div>
            <div id="w-inflow" class="big">$0.00</div>
          </div>
          <div class="card">
            <div class="card-title">Total Outflow (USD)</div>
            <div id="w-outflow" class="big">$0.00</div>
          </div>
          <div class="card">
            <div class="card-title">Net (USD)</div>
            <div id="w-net" class="big">$0.00</div>
          </div>
        </div>

        <h3 class="mt">Recent Wallet Activity</h3>
        <div class="table-scroll">
          <table class="table" id="wallet-table">
            <thead>
              <tr><th>Date</th><th>Amount (USD)</th><th>Method</th><th>Status</th></tr>
            </thead>
            <tbody><!-- filled by JS --></tbody>
          </table>
        </div>
      </section>

      <!-- SECURITY / HEALTH -->
      <section id="panel-security" class="tab-panel" hidden>
        <div class="panel">
          <h3 style="margin:0 0 10px">System Security & Monitoring</h3>
          <pre id="health-json" class="muted" style="white-space:pre-wrap">Loading…</pre>
        </div>
      </section>

      <div class="footer">© Empire Affiliate Marketing Hub</div>
    </main>
  </div>

  <script>
    // --------- routing via hash (sidebar)
    const hashToPanel = {
      '#overview':'panel-overview',
      '#accounts':'panel-accounts',
      '#users':'panel-users',
      '#analytics':'panel-analytics',
      '#wallet':'panel-wallet',
      '#security':'panel-security',
    };
    function showPanelFromHash(){
      const h = location.hash || '#overview';
      document.querySelectorAll('.nav a').forEach(a=> a.classList.toggle('active', a.getAttribute('href')===h));
      Object.values(hashToPanel).forEach(id=> document.getElementById(id).hidden = true);
      (document.getElementById(hashToPanel[h])||document.getElementById('panel-overview')).hidden = false;
    }
    window.addEventListener('hashchange', showPanelFromHash);
    showPanelFromHash();

    // --------- helpers
    const el = (id)=> document.getElementById(id);
    const setText = (id,v)=> { const e=el(id); if(e) e.textContent=v; };
    const fmtUSD = (n)=> {
      try { return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(+n||0); }
      catch { return '$'+Number(n||0).toFixed(2); }
    };
    const escapeHtml = (s)=> String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    async function fetchJSON(url, opts){
      const r = await fetch(url, opts || { headers:{'Cache-Control':'no-cache'} });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data?.error || r.status);
      return data;
    }

    // --------- Overview
    async function loadSummary(){
      try{
        const s = await fetchJSON('/.netlify/functions/summary');
        setText('kpi-earn', fmtUSD(s.totalEarnings||0));
        setText('kpi-active', String(s.activeUsers ?? 0));
        setText('kpi-approval', (s.approvalRate!=null) ? (Math.round((s.approvalRate*100)||0)+'%') : '—');
        setText('kpi-pending', String(s.pendingReviews ?? 0));
        el('summary-note').textContent = 'Synced from Google Sheets.';
      }catch(e){
        el('summary-note').textContent = 'Failed to load summary: '+e.message;
      }
    }

    // --------- Health (also used by Security)
    async function loadHealth(){
      try{
        const h = await fetchJSON('/.netlify/functions/health');
        el('health-json').textContent = JSON.stringify(h, null, 2);
      }catch(e){
        el('health-json').textContent = 'Failed to load health: '+e.message;
      }
    }

    // --------- Users (approved list only)
    async function loadUsersTable(){
      const body = document.querySelector('#users-table tbody');
      body.innerHTML = '<tr><td class="muted" colspan="5">Loading…</td></tr>';
      try{
        const u = await fetchJSON('/.netlify/functions/users?limit=100');
        body.innerHTML = '';
        (u.users||[]).forEach(row=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(row.name||'')}</td>
            <td>${escapeHtml(row.email||'')}</td>
            <td>${escapeHtml(row.phone||'')}</td>
            <td><span class="chip">${escapeHtml(row.status||'')}</span></td>
            <td>${escapeHtml(row.scale||'')}</td>`;
          body.appendChild(tr);
        });
        if(!u.users || u.users.length===0) body.innerHTML = '<tr><td class="muted" colspan="5">No users yet.</td></tr>';
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="5">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // --------- Wallet
    async function loadWallet(){
      const body = document.querySelector('#wallet-table tbody');
      body.innerHTML = '<tr><td class="muted" colspan="4">Loading…</td></tr>';
      try{
        const w = await fetchJSON('/.netlify/functions/wallet?limit=50');
        setText('w-inflow', fmtUSD(w.inflow||0));
        setText('w-outflow', fmtUSD(w.outflow||0));
        setText('w-net',    fmtUSD(w.net||0));
        body.innerHTML = '';
        (w.items||[]).forEach(it=>{
          const tr = document.createElement('tr');
          const when = it.ts ? new Date(it.ts).toLocaleString() : '';
          tr.innerHTML = `
            <td>${escapeHtml(when)}</td>
            <td>${fmtUSD(it.amount||0)}</td>
            <td>${escapeHtml(it.method||'')}</td>
            <td>${escapeHtml(it.status||'')}</td>`;
          body.appendChild(tr);
        });
        if(!w.items || w.items.length===0) body.innerHTML = '<tr><td class="muted" colspan="4">No wallet activity yet.</td></tr>';
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="4">Failed to load wallet: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // --------- ADMIN (Pending approvals) — matches admin-pending.js
    const AdminKey = {
      set(v){ try{ localStorage.setItem('emp_admin_secret', v); }catch{} },
      get(){ try{ return localStorage.getItem('emp_admin_secret') || ''; }catch{ return ''; } }
    };
    async function adminCall(method='GET', payload=null){
      const opts = { method, headers:{ 'X-Admin-Secret': AdminKey.get() } };
      if(payload){ opts.headers['Content-Type']='application/json'; opts.body = JSON.stringify(payload); }
      const r = await fetch('/.netlify/functions/admin-pending', opts);
      const data = await r.json().catch(()=> ({}));
      if(!r.ok || data?.ok===false) throw new Error(data?.error || r.status);
      return data;
    }
    async function loadPendingInto(sel){
      const body = document.querySelector(sel);
      body.innerHTML = `<tr><td class="muted" colspan="5">Loading…</td></tr>`;
      try{
        const res = await adminCall('GET');
        const rows = Array.isArray(res.items) ? res.items : (res.rows || []);
        body.innerHTML = '';
        if(!rows.length){ body.innerHTML = `<tr><td class="muted" colspan="5">No pending approvals.</td></tr>`; return; }
        rows.forEach(row=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(row.name||'')}</td>
            <td>${escapeHtml(row.email||'')}</td>
            <td>${escapeHtml(row.phone||'')}</td>
            <td>${escapeHtml(row.telegram||'')}</td>
            <td>
              <button class="btn" data-act="approve">Approve</button>
              <button class="btn" data-act="reject">Reject</button>
            </td>`;
          tr.querySelector('[data-act="approve"]').onclick = async ()=>{
            const b = tr.querySelector('[data-act="approve"]'); b.disabled = true;
            try{
              await adminCall('POST', { action:'mark', id:row.id, status:'approved', name:row.name, email:row.email, phone:row.phone });
              tr.remove();
            }catch(e){ alert('Approve failed: '+e.message); b.disabled=false; }
          };
          tr.querySelector('[data-act="reject"]').onclick = async ()=>{
            const b = tr.querySelector('[data-act="reject"]'); b.disabled = true;
            try{
              await adminCall('POST', { action:'mark', id:row.id, status:'rejected' });
              tr.remove();
            }catch(e){ alert('Reject failed: '+e.message); b.disabled=false; }
          };
          body.appendChild(tr);
        });
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="5">Pending endpoint not available (${escapeHtml(e.message)}).</td></tr>`;
      }
    }

    // wire controls
    (function initAdminUI(){
      const sec = el('admin-secret'); if(sec) sec.value = AdminKey.get();
      const save = el('save-secret'); if(save) save.onclick = ()=>{ AdminKey.set(el('admin-secret').value.trim()); el('secret-status').textContent='Saved.'; };
      const load = el('load-pending'); if(load) load.onclick = ()=>{ el('secret-status').textContent=''; loadPendingInto('#pending-body'); };
    })();

    // simple “Add Approved User” stub (extend to your function if desired)
    el('add-user')?.addEventListener('click', ()=>{
      const name = el('au-name').value.trim();
      const email= el('au-email').value.trim();
      const phone= el('au-phone').value.trim();
      const tgm  = el('au-telegram').value.trim();
      if(!name || !email){ el('add-user-status').textContent='Name and Email required.'; return; }
      el('add-user-status').textContent = 'This button is a stub — wire to your users function if needed.';
    });

    // kick off loads
    loadSummary();
    loadHealth();
    loadUsersTable();
    loadWallet();
  </script>
</body>
</html>