<script>
  function qs(k){ return new URL(location.href).searchParams.get(k); }

  // Load user profile
  async function loadUser() {
    const i = qs('i'); // invite/session token
    const url = i ? `/.netlify/functions/me?i=${encodeURIComponent(i)}` : '/.netlify/functions/me';
    const res = await fetch(url, { credentials: 'include' });
    return res.json();
  }

  // Load health
  async function loadHealth() {
    const res = await fetch('/.netlify/functions/monitor-health');
    return res.json();
  }

  // Load feed
  async function loadFeed() {
    const res = await fetch('/.netlify/functions/monitor-feed');
    return res.json();
  }

  function renderUser(u){
    document.getElementById('note').style.display = 'none';
    document.getElementById('profile').style.display = 'block';
    document.getElementById('name').textContent = u.name || '—';
    document.getElementById('contact').textContent = [u.email,u.phone].filter(Boolean).join(' · ');
    const st = document.getElementById('status');
    st.textContent = u.status || '—';
    st.className = 'pill ' + ((u.status||'').toUpperCase().includes('APPROVED') ? 'ok':'');
    document.getElementById('scale').textContent = (u.scale ?? '—');
  }

  function badge(label, state){
    const cls = state.match(/ONLINE|ACTIVE|OPERATIONAL|CONNECTED/i) ? 'b-ok'
             : state.match(/DEGRADED|WARN/i) ? 'b-warn'
             : 'b-down';
    const el = document.createElement('div');
    el.className = `badge ${cls}`;
    el.textContent = `${label}: ${state}`;
    return el;
  }

  function renderHealth(h){
    const row = document.getElementById('healthRow');
    row.innerHTML = '';
    for (const [k,v] of Object.entries(h)) {
      row.append(badge(k, v));
    }
  }

  function renderFeed(items){
    const tbody = document.querySelector('#feedTable tbody');
    tbody.innerHTML = '';
    if (!items || !items.length){
      document.getElementById('feedEmpty').style.display = 'block';
      return;
    }
    document.getElementById('feedEmpty').style.display = 'none';
    for (const it of items){
      const tr = document.createElement('tr');
      const cells = [
        new Date(it.ts || Date.now()).toLocaleString(),
        it.type || '—',
        it.message || '—',
        it.ref || '—',
        it.actor || '—'
      ];
      for (const c of cells){
        const td = document.createElement('td');
        td.textContent = c;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  async function refreshAll(){
    try {
      const [user, health, feed] = await Promise.all([loadUser(), loadHealth(), loadFeed()]);
      if (user.ok) renderUser(user.user || {});
      if (health.ok) renderHealth(health.data || health);
      if (feed.ok) renderFeed(feed.items || []);
    } catch(e){
      console.error("Error loading dashboard", e);
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', refreshAll);
  refreshAll(); // initial load
</script>