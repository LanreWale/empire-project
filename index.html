<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THE EMPIRE ¬∑ Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-0:#0d1a27; --bg-1:#0f2233; --bg-2:#122a3f; --bg-3:#0b1825;
    --card:#0f2233; --card-2:#132a42; --muted:#7c97b5; --text:#eaf2ff; --accent:#ffd559;
    --good:#1dd1a1; --warn:#ffb142; --bad:#ff6b6b; --line:#173046;
    --shadow:0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    color:var(--text); background:
      radial-gradient(1200px 1200px at 120% -10%, #163b5c 0%, transparent 60%) fixed,
      radial-gradient(1000px 1000px at -10% 120%, #0c2338 0%, transparent 60%) fixed,
      var(--bg-0);
  }

  .page{display:grid; grid-template-columns:260px 1fr; gap:0; min-height:100vh}
  .sidebar{
    background:linear-gradient(180deg,#0d1a27 0%, #0b1825 100%);
    border-right:1px solid var(--line); padding:18px 12px; position:sticky; top:0; height:100vh;
  }
  .brand{display:flex; align-items:center; gap:10px; padding:8px 10px 18px}
  .brand img{width:28px;height:28px}
  .brand span{font-weight:800; letter-spacing:.6px}
  .nav{display:flex; flex-direction:column; gap:6px; margin-top:6px}
  .nav a{
    display:flex; align-items:center; gap:10px; padding:11px 12px;
    color:var(--text); text-decoration:none; border-radius:10px;
    background:transparent; border:1px solid transparent;
  }
  .nav a.active{background:var(--bg-2); border-color:var(--line)}
  .nav small{opacity:.65}

  .content{padding:22px; min-width:0}

  .section-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:4px 0 18px}
  .section-head h2{margin:0; font-size:18px; letter-spacing:.3px}
  .btn{
    background:linear-gradient(180deg,#ffd559,#ffcb31); color:#1b1b1b; border:0; font-weight:700;
    padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow)
  }
  .btn.secondary{background:#173046; color:#d6e7ff; border:1px solid #254660}
  .btn.secondary.active{background:#103b66; border-color:#3a85ff}

  .grid{display:grid; gap:16px}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-1{grid-template-columns:1fr}
  @media (max-width:1150px){ .grid.cols-4{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:760px){ .page{grid-template-columns:1fr} .sidebar{position:static;height:auto} .grid,[class*=cols-]{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)) , var(--card);
    border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)
  }
  .card.pad{padding:16px}

  .kpi{display:flex; flex-direction:column; gap:8px}
  .kpi .label{font-size:12px; color:var(--muted)}
  .kpi .value{font-weight:800; font-size:22px}
  .sub{font-size:11px; color:var(--muted); margin-top:-2px}

  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--line)}
  thead th{background:#0f2b45; text-align:left; padding:11px 12px; font-size:12px; color:#c4d7ef; border-bottom:1px solid var(--line)}
  tbody td{padding:10px 12px; border-bottom:1px solid var(--line)}
  tbody tr:last-child td{border-bottom:0}
  .muted{color:var(--muted)}
  .money{color:var(--good); font-weight:700}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line); background:#14304a}

  .acct{display:grid; grid-template-columns:1fr auto; gap:10px}
  .acct h3{margin:0 0 6px; font-size:20px}
  .acct .stats{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
  .kv{background:var(--card-2); border:1px solid var(--line); border-radius:10px; padding:10px}
  .kv b{display:block; font-size:12px; color:var(--muted); margin-bottom:3px}
  .kv span{font-weight:800}

  .pill{padding:6px 9px; border-radius:999px; background:#103250; border:1px solid var(--line); font-size:12px}
  .flex{display:flex; gap:10px; align-items:center}
  .right{margin-left:auto}

  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  code.pretty{white-space:pre-wrap; display:block; background:#0e2236; border:1px solid var(--line); padding:14px; border-radius:10px}

  .empty{padding:18px; text-align:center; color:var(--muted)}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50}
  .modal.open{display:flex}
  .modal .scrim{position:absolute; inset:0; background:rgba(6,16,26,.6); backdrop-filter: blur(2px)}
  .modal .panel{
    position:relative; width:min(680px,92vw); background:var(--card);
    border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:18px;
  }
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .form-grid .full{grid-column:1 / -1}
  .input{display:flex; flex-direction:column; gap:6px}
  .input label{font-size:12px; color:var(--muted)}
  .input input,.input select{
    background:#0e2236; color:var(--text); border:1px solid #24445e; border-radius:10px; padding:10px 12px; outline:none;
  }
  .input input:focus,.input select:focus{border-color:#3a85ff}
  .modal .footer{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
  .bad{color:var(--bad); font-size:12px}
  /* chart svg */
  .chart svg{width:100%; height:220px; display:block}
</style>
</head>
<body>

<!-- Crash box (always present so blank pages show errors) -->
<pre id="fatal" style="display:none;white-space:pre-wrap;background:#140b0b;color:#ffdede;border:1px solid #522; padding:12px; border-radius:10px; margin:16px"></pre>

<div class="page">
  <aside class="sidebar">
    <div class="brand">
      <img src="https://i.imgur.com/2sGv2cH.png" alt="empire">
      <span>THE EMPIRE</span>
    </div>
    <nav class="nav" id="nav">
      <a href="#dashboard" data-route="dashboard" class="active">üè† Dashboard</a>
      <a href="#cpa" data-route="cpa">üëë CPA Accounts</a>
      <a href="#users" data-route="users">üë• Users</a>
      <a href="#analytics" data-route="analytics">üìä Analytics</a>
      <a href="#wallet" data-route="wallet">üí≥ Payments/Wallet</a>
      <a href="#monitor" data-route="monitor">üõ°Ô∏è Monitoring</a>
      <a href="#settings" data-route="settings">‚öôÔ∏è Settings</a>
    </nav>
  </aside>

  <main class="content">
    <!-- DASHBOARD -->
    <section data-page="dashboard" style="display:block">
      <div class="section-head"><h2>Supreme Command Dashboard</h2><span class="pill">SUPREME COMMANDER</span></div>
      <div class="grid cols-4">
        <div class="card pad kpi"><div class="label">Total Earnings</div><div class="value" id="dash-earn">$0.00</div><div class="sub muted">vs last 7d</div></div>
        <div class="card pad kpi"><div class="label">Active Users</div><div class="value" id="dash-users">0</div><div class="sub muted"><span id="dash-users-diff">24h growth</span></div></div>
        <div class="card pad kpi"><div class="label">Conversion Rate</div><div class="value" id="dash-cr">0.00%</div><div class="sub muted">industry leading</div></div>
        <div class="card pad kpi"><div class="label">Total Clicks</div><div class="value" id="dash-clicks">0</div><div class="sub muted">daily average</div></div>
      </div>

      <div class="grid cols-2" style="margin-top:16px">
        <div class="card pad">
          <h3 style="margin:0 0 10px">Daily Earnings</h3>
          <div id="dash-earnings" class="chart empty">Awaiting data..</div>
        </div>
        <div class="card pad">
          <h3 style="margin:0 0 10px">Traffic Sources</h3>
          <div id="dash-sources" class="chart empty">Awaiting data..</div>
        </div>
      </div>

      <div class="card pad" style="margin-top:16px">
        <h3 style="margin:0 0 10px">By Geo (Top)</h3>
        <table>
          <thead><tr><th>Country</th><th>Clicks</th><th>Leads</th><th>Earnings ($)</th></tr></thead>
          <tbody id="tbl-dash-geo"><tr><td colspan="4" class="muted">No data</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- CPA ACCOUNTS -->
    <section data-page="cpa" style="display:none">
      <div class="section-head">
        <h2>CPA Accounts Management</h2>
        <button class="btn" id="btn-add-acct">+ Add New Account</button>
      </div>
      <div id="cpa-grid" class="grid cols-2"></div>
    </section>

    <!-- ADD NEW ACCOUNT MODAL -->
    <div id="mdl-cpa" class="modal" aria-hidden="true">
      <div class="scrim" data-close></div>
      <div class="panel">
        <h3 style="margin:0 0 12px">Add New CPA Account</h3>
        <div class="form-grid">
          <div class="input"><label>Account Name *</label><input id="f-account" placeholder="e.g. 2288690 / Main Grip"/></div>
          <div class="input"><label>Network *</label><input id="f-network" placeholder="e.g. CPA Grip"/></div>
          <div class="input"><label>Domain</label><input id="f-domain" placeholder="offers.example.com"/></div>
          <div class="input">
            <label>Status</label>
            <select id="f-status">
              <option value="ACTIVE" selected>ACTIVE</option>
              <option value="PAUSED">PAUSED</option>
              <option value="DISABLED">DISABLED</option>
            </select>
          </div>
          <div class="input full"><label>API Key / Token</label><input id="f-key" placeholder="(optional) stored in GAS"/></div>
          <div class="input"><label>Webhook URL</label><input id="f-webhook" placeholder="https://.../postback"/></div>
        </div>
        <div id="f-error" class="bad" style="display:none"></div>
        <div class="footer">
          <button class="btn secondary" data-close>Cancel</button>
          <button class="btn" id="btn-save-acct">Save Account</button>
        </div>
      </div>
    </div>

    <!-- USERS -->
    <section data-page="users" style="display:none">
      <div class="section-head"><h2>Users Management</h2>
        <div class="flex right">
          <button class="btn secondary active" data-users-tab="APPROVED">Approved</button>
          <button class="btn secondary" data-users-tab="PENDING">Pending</button>
          <button class="btn secondary" data-users-tab="REJECTED">Rejected</button>
        </div>
      </div>
      <div class="card pad">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Authority</th></tr></thead>
        <tbody id="tbl-users"><tr><td colspan="4" class="muted">No users.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section data-page="analytics" style="display:none">
      <div class="section-head"><h2>Analytics & Reports</h2></div>
      <div class="grid cols-2">
        <div class="card pad">
          <h3 style="margin:0 0 10px">Performance Overview</h3>
          <div id="ana-overview" class="chart empty">Loading‚Ä¶</div>
        </div>
        <div class="card pad">
          <h3 style="margin:0 0 10px">Geographic Distribution</h3>
          <div id="ana-geo-dist" class="chart empty">Loading‚Ä¶</div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px">
        <div class="card pad">
          <h3 style="margin:0 0 10px">Live Performance Data (last 2 min)</h3>
          <table>
            <thead><tr><th>Time</th><th>Country</th><th>Offer</th><th>Clicks</th><th>Conv.</th><th>Earnings</th></tr></thead>
            <tbody id="tbl-live-perf"><tr><td colspan="6" class="muted">Waiting for stream‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div class="card pad">
          <h3 style="margin:0 0 10px">Live by GEO (rolling)</h3>
          <table>
            <thead><tr><th>Country</th><th>Clicks</th><th>Conv.</th><th>Earnings</th></tr></thead>
            <tbody id="tbl-live-geo"><tr><td colspan="4" class="muted">Waiting for stream‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- WALLET -->
    <section data-page="wallet" style="display:none">
      <div class="section-head"><h2>Wallet</h2></div>
      <div class="grid cols-3">
        <div class="card pad kpi"><div class="label">Balance</div><div class="value" id="wal-balance">$0.00</div></div>
        <div class="card pad kpi"><div class="label">Pending Payout</div><div class="value" id="wal-pending">$0.00</div></div>
        <div class="card pad kpi"><div class="label">Last Payout</div><div class="value" id="wal-last">$0.00</div></div>
      </div>
      <div class="grid cols-2" style="margin-top:16px">
        <div class="card pad">
          <h3 style="margin:0 0 10px">Transaction History</h3>
          <table>
            <thead><tr><th>Date</th><th>Method</th><th>Amount ($)</th><th>Status</th></tr></thead>
            <tbody id="tbl-wallet"><tr><td colspan="4" class="muted">No transactions.</td></tr></tbody>
          </table>
        </div>
        <div class="card pad">
          <h3 style="margin:0 0 10px">Request Withdrawal</h3>
          <div class="muted" style="font-size:13px">Hook this to your GAS write endpoint.</div>
        </div>
      </div>
    </section>

    <!-- MONITORING -->
    <section data-page="monitor" style="display:none">
      <div class="section-head"><h2>Monitoring</h2></div>
      <div class="grid cols-3">
        <div class="card pad kpi"><div class="label">Alerts</div><div class="value" id="box-alerts">‚Äî</div></div>
        <div class="card pad kpi"><div class="label">Maintenance</div><div class="value" id="box-maint">‚Äî</div></div>
        <div class="card pad kpi"><div class="label">System Health</div><div class="value" id="box-health">‚Äî</div></div>
      </div>
      <div class="card pad" style="margin-top:16px">
        <h3 style="margin:0 0 10px">Events Stream</h3>
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead>
          <tbody id="tbl-monitor"><tr><td colspan="3" class="muted">No events.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section data-page="settings" style="display:none">
      <div class="section-head"><h2>Settings</h2></div>
      <div class="card pad">
        <h3 style="margin:0 0 10px">Live Config</h3>
        <code id="pretty" class="pretty mono">{ ‚Ä¶ }</code>
      </div>
    </section>
  </main>
</div>

<!-- ========= FRONTEND SCRIPT ========= -->
<script>
/* ========= FATAL GUARD ========= */
window.onerror = function(msg, src, line, col, err){
  var fatal = document.getElementById('fatal');
  if(!fatal) return;
  fatal.style.display = 'block';
  fatal.textContent =
    '[FATAL] ' + msg + '\n' +
    (src?('at '+src+':'+line+':'+col+'\n'):'') +
    (err && err.stack ? err.stack : '');
};

/* ========= CONFIG ========= */
var GAS = "https://script.google.com/macros/s/AKfycbzFOP1BQCV47c-uRHw0mTs-WHKTSAblrjb9XmpUrVPIjhbQdtNRGAtEWFAkZMUVJ4Uc/exec";
var POLL_FAST = 5000;
var $  = function(s){ return document.querySelector(s); };
var $$ = function(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); };
var dollars = function(n){ return Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD'}); };
function safeGet(o){ for(var i=1;i<arguments.length;i++){ if(!o || typeof o!=='object') return undefined; o = o[arguments[i]]; } return o; }
function arr(m){
  if(Array.isArray(m)) return m;
  if(m && Array.isArray(m.items)) return m.items;
  if(m && Array.isArray(m.rows))  return m.rows;
  if(m && Array.isArray(m.data))  return m.data;
  return [];
}
function obj(m){ return (m && typeof m==='object')? m : {}; }
function normDomain(d){ return String(d||'').trim().replace(/^https?:\/\//,'').replace(/\/.*$/,''); }

/* ========= HTTP HELPERS ========= */
async function get(url, opt){
  opt = opt || {};
  try{
    var u = new URL(url);
    u.searchParams.set('_t', Date.now());
    var r = await fetch(u, Object.assign({cache:'no-store'}, opt));
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }catch(e){ console.error('GET failed:', e); return null; }
}
function api(action, params){
  params = params || {};
  var u = new URL(GAS);
  u.searchParams.set('action', action);
  Object.keys(params).forEach(function(k){ u.searchParams.set(k, params[k]); });
  return get(u);
}
async function apiWrite(action, payload){
  payload = payload||{};
  var url = new URL(GAS);
  url.searchParams.set('action', action);
  try{
    var res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }catch(e){
    // GET fallback
    Object.keys(payload).forEach(function(k){
      var v = payload[k];
      url.searchParams.set(k, (v && typeof v==='object')? JSON.stringify(v): String(v));
    });
    var res2 = await fetch(url, {cache:'no-store'});
    if(!res2.ok) throw new Error('HTTP '+res2.status);
    return res2.json();
  }
}

/* ========= MINI CHARTS (SVG) ========= */
function renderBarChart(el, series, labels){
  series = series||[]; labels = labels||[];
  var host = (typeof el==='string')? $(el) : el; if(!host) return;
  host.classList.remove('empty'); host.innerHTML='';
  if(!series.length){ host.classList.add('empty'); host.textContent='No data'; return; }
  var W = host.clientWidth || 600, H = 220, pad=28;
  var max = Math.max.apply(null, series.map(function(v){return Number(v)||0;}).concat([1]));
  var bw = (W - pad*2) / series.length;
  var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', '0 0 '+W+' '+H);
  var axis = document.createElementNS(svg.namespaceURI,'line');
  axis.setAttribute('x1', pad); axis.setAttribute('y1', H-pad);
  axis.setAttribute('x2', W-pad); axis.setAttribute('y2', H-pad);
  axis.setAttribute('stroke', '#2a4b6a'); axis.setAttribute('stroke-width', '1');
  svg.appendChild(axis);
  series.forEach(function(v,i){
    var val = Number(v)||0;
    var h = (val/max) * (H - pad*2);
    var x = pad + i*bw + 6;
    var y = (H-pad) - h;
    var rect = document.createElementNS(svg.namespaceURI,'rect');
    rect.setAttribute('x', x); rect.setAttribute('y', y);
    rect.setAttribute('width', Math.max(8,bw-12)); rect.setAttribute('height', Math.max(0,h));
    rect.setAttribute('fill', '#ffd559');
    svg.appendChild(rect);
    if(labels[i]){
      var tx = document.createElementNS(svg.namespaceURI,'text');
      tx.setAttribute('x', x + (bw-12)/2);
      tx.setAttribute('y', H - pad + 14);
      tx.setAttribute('text-anchor','middle');
      tx.setAttribute('font-size','10');
      tx.setAttribute('fill','#86a7c9');
      tx.textContent = (String(labels[i]).length>8 ? String(labels[i]).slice(0,8)+'‚Ä¶' : String(labels[i]));
      svg.appendChild(tx);
    }
  });
  host.appendChild(svg);
}
function renderPieChart(el, map){
  map = map||{};
  var host = (typeof el==='string')? $(el) : el; if(!host) return;
  host.classList.remove('empty'); host.innerHTML='';
  var entries = [];
  Object.keys(map).forEach(function(k){ var v = Number(map[k]); if(v>0) entries.push([k,v]); });
  if(!entries.length){ host.classList.add('empty'); host.textContent='No data'; return; }
  var W=220,H=220,R=90,CX=W/2,CY=H/2;
  var total = entries.reduce(function(s,e){ return s+Number(e[1]); },0);
  var angle = -Math.PI/2;
  var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 '+W+' '+H);
  entries.forEach(function(e){
    var frac = Number(e[1])/total;
    var theta = frac * Math.PI*2;
    var x1 = CX + R*Math.cos(angle), y1 = CY + R*Math.sin(angle);
    var x2 = CX + R*Math.cos(angle+theta), y2 = CY + R*Math.sin(angle+theta);
    var large = theta>Math.PI ? 1 : 0;
    var path = document.createElementNS(svg.namespaceURI,'path');
    var d = 'M '+CX+' '+CY+' L '+x1+' '+y1+' A '+R+' '+R+' 0 '+large+' 1 '+x2+' '+y2+' Z';
    path.setAttribute('d', d);
    path.setAttribute('fill','#ffd559');
    path.setAttribute('opacity', 0.7);
    svg.appendChild(path);
    angle += theta;
  });
  host.appendChild(svg);
}

/* ========= ROUTER ========= */
function show(route){
  $$('.nav a').forEach(function(a){ a.classList.toggle('active', a.getAttribute('data-route')===route); });
  $$('[data-page]').forEach(function(s){ s.style.display = (s.getAttribute('data-page')===route)?'block':'none'; });

  if(route==='dashboard') initDashboard();
  if(route==='cpa')       initCpa();
  if(route==='users')     initUsers(currentUsersTab);
  if(route==='analytics') initAnalytics();
  if(route==='wallet')    initWallet();
  if(route==='monitor')   initMonitor();
  if(route==='settings')  initSettings();
}
window.addEventListener('hashchange', function(){
  var r = (location.hash||'#dashboard').replace('#',''); show(r);
});
var navEl = document.getElementById('nav');
if(navEl){
  navEl.addEventListener('click', function(e){
    var a = e.target.closest && e.target.closest('a');
    if(!a) return;
    e.preventDefault(); location.hash = '#'+a.getAttribute('data-route');
  });
}

/* ========= DASHBOARD ========= */
async function initDashboard(){
  try{
    var resOv = api('overview');
    var resUs = api('users', {status:'APPROVED'});
    var ov = await resOv, us = await resUs;

    var t = (ov && ov.totals) ? ov.totals : (ov||{});
    var el;
    if((el=$('#dash-earn')))   el.textContent = dollars(t.earnings||0);
    if((el=$('#dash-clicks'))) el.textContent = t.clicks||0;
    var cr = (t && t.conversionRate!=null) ? Number(t.conversionRate) :
             (t && t.leads && t.clicks ? (t.leads/t.clicks*100) : 0);
    if((el=$('#dash-cr'))) el.textContent = Number(cr||0).toFixed(2)+'%';

    var users = arr(us);
    if((el=$('#dash-users'))) el.textContent = users.length;

    var byDay = arr(safeGet(ov,'byDay'));
    if(byDay.length){
      renderBarChart('#dash-earnings',
        byDay.map(function(d){return Number(d.earnings||0);}),
        byDay.map(function(d){return String(d.t||d.date||'');})
      );
    }else{
      var host = $('#dash-earnings'); if(host){ host.classList.add('empty'); host.textContent='No data'; }
    }

    renderPieChart('#dash-sources', obj(safeGet(ov,'offerTypes')));

    // By Geo
    var tableBody = document.getElementById('tbl-dash-geo');
    var tableHead = tableBody && tableBody.closest('table') ? tableBody.closest('table').querySelector('thead') : null;
    if(tableBody && tableHead){
      var geoMap = obj(safeGet(ov,'geo'));
      var entries = Object.keys(geoMap).map(function(k){ return {country:k, earnings:Number(geoMap[k])||0}; })
        .sort(function(a,b){ return b.earnings-a.earnings; }).slice(0,10);

      var byGeoArr = Array.isArray(safeGet(ov,'byGeo')) ? ov.byGeo : [];
      var hasCL = byGeoArr.some(function(x){ return (x && (x.clicks||x.leads)); });

      tableHead.innerHTML = hasCL ? '<tr><th>Country</th><th>Clicks</th><th>Leads</th><th>Earnings ($)</th></tr>'
                                  : '<tr><th>Country</th><th>Earnings ($)</th></tr>';

      tableBody.innerHTML = '';
      if(!entries.length){
        tableBody.innerHTML = '<tr><td colspan="'+(hasCL?4:2)+'" class="muted">No data</td></tr>';
      }else{
        entries.forEach(function(g){
          if(hasCL){
            var m = byGeoArr.find(function(x){ return x && x.country===g.country; }) || {};
            tableBody.insertAdjacentHTML('beforeend',
              '<tr><td>'+g.country+'</td><td>'+(m.clicks||0)+'</td><td>'+(m.leads||0)+'</td><td class="money">'+dollars(g.earnings)+'</td></tr>');
          }else{
            tableBody.insertAdjacentHTML('beforeend',
              '<tr><td>'+g.country+'</td><td class="money">'+dollars(g.earnings)+'</td></tr>');
          }
        });
      }
    }
  }catch(e){ console.error(e); }
}

/* ========= CPA ACCOUNTS ========= */
async function initCpa(){
  var wrap = document.getElementById('cpa-grid'); if(!wrap) return;
  wrap.innerHTML='';
  try{
    var resp = await api('cpa');
    var items = arr(resp);
    if(!items.length){ wrap.innerHTML = '<div class="card pad empty">No CPA accounts yet.</div>'; return; }
    items.forEach(function(r){
      var convPct = 0, v;
      if (r && r.conversionrate != null){ v = Number(r.conversionrate); convPct = v>1 ? v : v*100; }
      else if (r && r.conversionRate != null){ v = Number(r.conversionRate); convPct = v>1 ? v : v*100; }
      var card = document.createElement('div');
      card.className='card pad';
      card.innerHTML =
        '<div class="acct">'+
          '<div>'+
            '<h3>'+(r.account||r.accountid||'‚Äî')+'</h3>'+
            '<div class="muted" style="margin-bottom:10px">Network <b style="color:#fff">'+(r.network||'‚Äî')+
            '</b> ¬∑ <span class="badge">'+(r.status||'ACTIVE')+'</span></div>'+
            '<div class="stats">'+
              '<div class="kv"><b>Active Offers</b><span>'+(r.activeoffers||r.activeOffers||0)+'</span></div>'+
              '<div class="kv"><b>Revenue</b><span class="money">'+dollars(r.revenue||0)+'</span></div>'+
              '<div class="kv"><b>Clicks</b><span>'+(r.clicks||0)+'</span></div>'+
              '<div class="kv"><b>Conversion</b><span>'+convPct.toFixed(2)+'%</span></div>'+
            </div>'+
          '</div>'+
          '<div class="right flex"><span class="pill mono">'+(r.domain||'no-domain')+'</span><button class="btn secondary">View Details</button></div>'+
        '</div>';
      wrap.appendChild(card);
    });
  }catch(e){
    console.error(e);
    wrap.innerHTML = '<div class="card pad empty">Failed to load accounts.</div>';
  }
}

/* Add New Account modal wiring */
var mdl = document.getElementById('mdl-cpa');
var openMdl  = function(){ mdl.classList.add('open'); };
var closeMdl = function(){ mdl.classList.remove('open'); };
document.getElementById('btn-add-acct')?.addEventListener('click', openMdl);
mdl?.addEventListener('click', function(e){ if(e.target.hasAttribute && e.target.hasAttribute('data-close')) closeMdl(); });
document.getElementById('btn-save-acct')?.addEventListener('click', async function(){
  var err = document.getElementById('f-error');
  var v = {
    account : document.getElementById('f-account').value.trim(),
    network : document.getElementById('f-network').value.trim(),
    domain  : normDomain(document.getElementById('f-domain').value),
    status  : document.getElementById('f-status').value,
    apiKey  : document.getElementById('f-key').value.trim(),
    webhook : document.getElementById('f-webhook').value.trim()
  };
  if(!v.account || !v.network){
    err.textContent = 'Account Name and Network are required.'; err.style.display='block'; return;
  }
  err.style.display='none';
  try{
    var res = await apiWrite('cpaCreate', v); // expect {ok:true}
    if(!res || res.ok!==true) throw new Error('Create failed');
    closeMdl();
    await initCpa();
  }catch(e){
    err.textContent = 'Could not save account. Please try again.'; err.style.display='block';
  }
});

/* ========= USERS ========= */
var currentUsersTab = 'APPROVED';
var userTabBtns = $$('[data-users-tab]');
userTabBtns.forEach(function(b){
  b.addEventListener('click',function(){
    userTabBtns.forEach(function(x){ x.classList.toggle('active', x===b); });
    currentUsersTab = b.getAttribute('data-users-tab'); initUsers(currentUsersTab);
  });
});
async function initUsers(tab){
  tab = tab || 'APPROVED';
  var tb = document.getElementById('tbl-users'); if(!tb) return;
  tb.innerHTML = '';
  try{
    var resp = await api('users', {status: tab});
    var filtered = arr(safeGet(resp,'items')) || arr(resp);

    // Defensive fallback if backend doesn't filter
    if(!filtered.length){
      var ALL = arr(safeGet(resp,'items')) || arr(resp);
      filtered = ALL.filter(function(u){ return String(u.status||'APPROVED').toUpperCase()===tab.toUpperCase(); });
    }

    if(!filtered.length){ tb.innerHTML = '<tr><td colspan="4" class="muted">No '+tab.toLowerCase()+' users.</td></tr>'; return; }
    filtered.forEach(function(u){
      var tr = document.createElement('tr');
      tr.innerHTML = '<td>'+(u.name||'‚Äî')+'</td><td>'+(u.email||'')+'</td><td>'+(u.phone||'')+'</td><td>'+(u.authority||'1x User')+'</td>';
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML = '<tr><td colspan="4" class="muted">Failed to load users.</td></tr>';
  }
}

/* ========= ANALYTICS (base + live) ========= */
var liveTimer=null, liveRows=[];
async function initAnalytics(){
  try{
    var base = await api('analytics'); // {overview, geo, items} or array
    var items = arr(base) || arr(safeGet(base,'items'));

    if(items.length){
      renderBarChart('#ana-overview',
        items.map(function(r){return Number(r.earnings||0);}),
        items.map(function(r){return String(r.date||r.t||'');})
      );
    }else if (Array.isArray(safeGet(base,'byDay')) && base.byDay.length){
      renderBarChart('#ana-overview',
        base.byDay.map(function(d){return Number(d.earnings||0);}),
        base.byDay.map(function(d){return String(d.t||d.date||'');})
      );
    }else{
      var host = $('#ana-overview'); if(host){ host.classList.add('empty'); host.textContent='No data'; }
    }

    renderPieChart('#ana-geo-dist', obj(safeGet(base,'geo')));
  }catch(e){
    var a1 = $('#ana-overview'); if(a1){ a1.classList.add('empty'); a1.textContent='Failed to load'; }
    var a2 = $('#ana-geo-dist'); if(a2){ a2.classList.add('empty'); a2.textContent='Failed to load'; }
  }

  if(liveTimer) clearInterval(liveTimer);
  liveRows = [];
  liveTimer = setInterval(pullLive, POLL_FAST);
  await pullLive();
}
async function pullLive(){
  try{
    var j = await api('analytics', { live:1, limit:24, windowSec:120 });
    var events = arr(safeGet(j,'live')) || arr(j);
    if(!events.length) return;

    // keep last 24 rows
    liveRows = liveRows.concat(events).slice(-24);

    // table
    var tb = document.getElementById('tbl-live-perf'); if(tb){
      tb.innerHTML='';
      liveRows.slice().reverse().forEach(function(r){
        var tr=document.createElement('tr');
        tr.innerHTML =
          '<td class="mono">'+(r.time||'')+'</td><td>'+(r.country||'')+'</td><td>'+(r.offer||'')+'</td>'+
          '<td>'+(r.clicks||0)+'</td><td>'+(r.conversions||r.conv||0)+'</td><td class="money">'+dollars(r.earnings||0)+'</td>';
        tb.appendChild(tr);
      });
    }

    // live by geo (rebuild from this batch)
    var byGeo = {};
    events.forEach(function(ev){
      var k = ev.country || 'Unknown';
      if(!byGeo[k]) byGeo[k] = {country:k, clicks:0, conv:0, earnings:0};
      byGeo[k].clicks   += Number(ev.clicks||0);
      byGeo[k].conv     += Number(ev.conversions||ev.conv||0);
      byGeo[k].earnings += Number(ev.earnings||0);
    });
    var tb2 = document.getElementById('tbl-live-geo');
    if(tb2){
      tb2.innerHTML='';
      var arrGeo = Object.keys(byGeo).map(function(k){return byGeo[k];})
                     .sort(function(a,b){return b.earnings-a.earnings;}).slice(0,10);
      if(!arrGeo.length){ tb2.innerHTML='<tr><td colspan="4" class="muted">Waiting for stream‚Ä¶</td></tr>'; return; }
      arrGeo.forEach(function(g){
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+g.country+'</td><td>'+g.clicks+'</td><td>'+g.conv+'</td><td class="money">'+dollars(g.earnings)+'</td>';
        tb2.appendChild(tr);
      });
    }
  }catch(e){ /* silent */ }
}

/* ========= WALLET ========= */
async function initWallet(){
  try{
    var w = obj(await api('wallet'));
    var hist = arr(w.history) || arr(w);
    var el;
    if((el=$('#wal-balance'))) el.textContent = dollars(w.balance||0);

    var pendingAmt = hist.filter(function(t){return String(t.status||'').toUpperCase()==='PENDING';})
                         .reduce(function(s,t){return s+Number(t.amount||0);},0);
    if((el=$('#wal-pending'))) el.textContent = dollars(pendingAmt);
    var lastPaid = hist.filter(function(t){return String(t.status||'').toUpperCase()==='COMPLETED';}).slice(-1)[0];
    if((el=$('#wal-last'))) el.textContent = dollars(lastPaid ? lastPaid.amount : 0);

    var tb = document.getElementById('tbl-wallet');
    if(tb){
      tb.innerHTML='';
      hist.slice().reverse().forEach(function(t){
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+(t.date||'')+'</td><td>'+(t.method||'')+'</td><td class="money">'+dollars(t.amount||0)+'</td><td>'+(t.status||'')+'</td>';
        tb.appendChild(tr);
      });
      if(!tb.children.length) tb.innerHTML = '<tr><td colspan="4" class="muted">No transactions.</td></tr>';
    }
  }catch(e){
    var tb2 = document.getElementById('tbl-wallet'); if(tb2) tb2.innerHTML = '<tr><td colspan="4" class="muted">Failed to load.</td></tr>';
  }
}

/* ========= MONITORING ========= */
async function initMonitor(){
  var tb = document.getElementById('tbl-monitor'); if(tb) tb.innerHTML='';
  try{
    var m = obj(await api('monitoring')); // expect {events:[...], health, maintenance}
    var events = arr(m.events) || arr(m);
    var el;
    if((el=$('#box-alerts'))) el.textContent = events.length;
    if((el=$('#box-maint')))  el.textContent = m.maintenance || '‚Äî';
    if((el=$('#box-health'))) el.textContent = m.health || 'OK';

    if(tb){
      if(!events.length){
        tb.innerHTML = '<tr><td colspan="3" class="muted">No events.</td></tr>';
      }else{
        events.forEach(function(ev){
          var tr=document.createElement('tr');
          tr.innerHTML='<td class="mono">'+(ev.time||'')+'</td><td>'+(ev.type||'')+'</td><td>'+(ev.msg||ev.message||'')+'</td>';
          tb.appendChild(tr);
        });
      }
    }
  }catch(e){
    if(tb) tb.innerHTML = '<tr><td colspan="3" class="muted">Failed to load.</td></tr>';
  }
}

/* ========= SETTINGS ========= */
async function initSettings(){
  try{
    var j = await api('config');
    var pretty = document.getElementById('pretty'); if(pretty) pretty.textContent = JSON.stringify(j, null, 2);
  }catch(e){
    var pretty2 = document.getElementById('pretty'); if(pretty2) pretty2.textContent = 'Failed to load config';
  }
}

/* ========= BOOT ========= */
window.addEventListener('DOMContentLoaded', function(){
  try{
    console.log('BOOT OK');
    document.body.setAttribute('data-boot','ok');
    var r = (location.hash||'#dashboard').replace('#','');
    show(r);
  }catch(e){
    var fatal = document.getElementById('fatal');
    if(fatal){ fatal.style.display='block'; fatal.textContent = '[BOOT ERROR] '+(e&&e.stack?e.stack:String(e)); }
    console.error(e);
  }
});
</script>
</body>
</html>