<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THE EMPIRE Â· Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-0:#0d1a27; --bg-1:#0f2233; --bg-2:#122a3f; --bg-3:#0b1825;
    --card:#0f2233; --card-2:#132a42; --muted:#7c97b5; --text:#eaf2ff; --accent:#ffd559;
    --good:#1dd1a1; --warn:#ffb142; --bad:#ff6b6b; --line:#173046;
    --shadow:0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    color:var(--text); background:
      radial-gradient(1200px 1200px at 120% -10%, #163b5c 0%, transparent 60%) fixed,
      radial-gradient(1000px 1000px at -10% 120%, #0c2338 0%, transparent 60%) fixed,
      var(--bg-0);
  }/* === Brand Polish from Presentation Pack === */ .btn{background:linear-gradient(180deg,var(--accent),#ffcb31);color:#1b1b1b;font-weight:700; padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow); transition:.15s ease;will-change:transform,box-shadow} .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)} .btn.secondary{background:#173046;color:#d6e7ff;border:1px solid #254660} .btn.secondary:hover{background:#103b66} .btn.secondary.active{background:#103b66;border-color:#3a85ff} .card{transition:box-shadow .15s ease, transform .15s ease} .card:hover{box-shadow:0 10px 26px rgba(0,0,0,.28)} table thead th{background:#0f2b45} tbody tr:hover td{background:rgba(20,48,74,.35)} .pill,.badge{background:#14304a;border:1px solid var(--line)} .toast{background:#0e2236;border:1px solid #24445e;color:var(--text)} .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px; background:#103250;border:1px solid var(--line);font-size:12px} .chip img{width:16px;height:16px;border-radius:4px;display:block} .skeleton{position:relative;overflow:hidden;background:#10263d;border-radius:10px;min-height:42px} .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent); transform:translateX(-100%);animation:sheen 1.2s infinite} @keyframes sheen{to{transform:translateX(100%)} } .chart{min-height:220px} a:focus,button:focus,input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px #3a85ff} </style>

</head>
<body>
  <!-- BODY CONTENT SAME AS PROVIDED (dashboard, cpa, users, analytics, wallet, monitor, settings) -->  <!-- Scripts --><script>
// Existing JS + UI Polish Pack merged
(function(){
  const css = getComputedStyle(document.documentElement);
  const THEME = {
    accent:(css.getPropertyValue('--accent')||'#ffd559').trim(),
    axis:(css.getPropertyValue('--line')||'#173046').trim(),
    label:(css.getPropertyValue('--muted')||'#7c97b5').trim()
  };
  
  // === LIVE DATA ENDPOINT (from your GAS web app) ===
  const API_URL = 'https://script.google.com/macros/s/AKfycbyCjLNnMm0yQZeQ2PUn-zvNkWbp8vTpw-kZEu_zup6NiMW-ScR_cYwj59b4i09MgrdV/exec';
  async function api(action, init){
    const q = new URL(API_URL);
    q.searchParams.set('action', action);
    try{
      const res = await fetch(q, {method:'GET', ...(init||{})});
      const json = await res.json();
      if(!json || json.ok===false){ throw new Error(json && json.error || 'api_error'); }
      return json;
    }catch(err){ console.error('API', action, err); toast('Failed to load '+action); return null; }
  }
  function $(s){return document.querySelector(s)}
  function $$(s){return Array.from(document.querySelectorAll(s))}
  // (moved above)

  function ensureSVG(){return document.createElementNS('http://www.w3.org/2000/svg','svg');}

  /* ========= CHART HELPERS ========= */
  function _host(el){ return (typeof el==='string')? document.querySelector(el) : el; }
  function _whenVisible(el, fn){
    const h = _host(el); if(!h) return;
    const run = ()=>{ if((h.clientWidth||0) > 40){ fn(); obs && obs.disconnect(); } };
    run();
    const obs = new ResizeObserver(()=>run());
    obs.observe(h);
  }
  window.renderBarChart=function(el,series=[],labels=[]){
    const host=_host(el); if(!host)return;
    _whenVisible(host, ()=>{
      host.classList.remove('empty'); host.innerHTML='';
      if(!series.length){ host.classList.add('empty'); host.textContent='No data'; return; }
      const W=Math.max(host.clientWidth||320,300),H=220,pad=28;
      const max=Math.max(...series.map(v=>Number(v)||0),1);
      const bw=(W-pad*2)/series.length;
      const svg=ensureSVG();svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      const axis=document.createElementNS(svg.namespaceURI,'line');
      axis.setAttribute('x1',pad);axis.setAttribute('y1',H-pad);
      axis.setAttribute('x2',W-pad);axis.setAttribute('y2',H-pad);
      axis.setAttribute('stroke',THEME.axis);axis.setAttribute('stroke-width','1');
      svg.appendChild(axis);
      series.forEach((v,i)=>{
        const val=Number(v)||0,h=(val/max)*(H-pad*2),x=pad+i*bw+6,y=(H-pad)-h;
        const rect=document.createElementNS(svg.namespaceURI,'rect');
        rect.setAttribute('x',x);rect.setAttribute('y',y);
        rect.setAttribute('width',Math.max(8,bw-12));rect.setAttribute('height',Math.max(0,h));
        rect.setAttribute('rx','6');rect.setAttribute('fill',THEME.accent);
        svg.appendChild(rect);
      });
      host.appendChild(svg);
    });
  };

  window.renderPieChart=function(el,map={}){
    const host=_host(el); if(!host)return;
    _whenVisible(host, ()=>{
      host.classList.remove('empty'); host.innerHTML='';
      const entries=Object.entries(map||{}).filter(([,v])=>Number(v)>0);
      if(!entries.length){ host.classList.add('empty'); host.textContent='No data'; return; }
      const W=220,H=220,R=90,CX=W/2,CY=H/2,total=entries.reduce((s,[,v])=>s+Number(v),0);
      let angle=-Math.PI/2;const svg=ensureSVG();svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      entries.forEach(([k,v],i)=>{
        const frac=Number(v)/total,theta=frac*Math.PI*2;
        const x1=CX+R*Math.cos(angle),y1=CY+R*Math.sin(angle);
        const x2=CX+R*Math.cos(angle+theta),y2=CY+R*Math.sin(angle+theta);
        const p=document.createElementNS(svg.namespaceURI,'path');
        p.setAttribute('d',`M ${CX} ${CY} L ${x1} ${y1} A ${R} ${R} 0 ${theta>Math.PI?1:0} 1 ${x2} ${y2} Z`);
        p.setAttribute('fill',THEME.accent); p.setAttribute('opacity',0.6+0.3*((i%3)/3));
        svg.appendChild(p); angle+=theta;
      });
      host.appendChild(svg);
    });
  };

  /* ========= DATA RENDERERS (wired to your selectors) ========= */
  function text(id, value){ const el=$(id); if(el) el.textContent=value; }
  function fmt(n){ try{ return Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }catch{ return n; } }

  async function loadOverview(){
    const d = await api('overview'); if(!d) return;
    const t = d.totals||{}; const p=d.totalsPretty||{};
    text('#kpi-earnings', p.earningsUsd||('$'+fmt(t.earnings)) );
    text('#kpi-clicks', fmt(t.clicks));
    text('#kpi-leads', fmt(t.leads));
    text('#kpi-conv', (p.conversionRatePct||fmt(t.conversionRate)+'%'));
    renderBarChart('#dash-earnings', (d.byDay||[]).map(r=>r.earnings||0), (d.byDay||[]).map(r=>r.date?.slice(5)));
    renderPieChart('#dash-sources', d.devices||d.offerTypes||d.geo||{});
    const tbody = $('#geo-table');
    if(tbody && d.byGeo){ tbody.innerHTML = d.byGeo.map(r=>`<tr><td>${r.country}</td><td>${fmt(r.clicks)}</td><td>${fmt(r.leads)}</td><td class=\"$\">$${fmt(r.earnings)}</td></tr>`).join(''); }
  }

  async function loadCpa(){
    const d = await api('cpa'); if(!d) return;
    const grid = $('#cpa-grid'); if(!grid) return;
    grid.innerHTML = (d.items||[]).map(acc=>`
      <div class=\"acct card\">
        <div class=\"left\">
          <div class=\"h1\">${acc.account}</div>
          <div class=\"muted\">Network</div>
          <div class=\"h2\">${acc.network||'CPA Grip'}</div>
        </div>
        <div class=\"right\">
          <span class=\"pill mono\">${acc.domain||''}</span>
          <div class=\"stat\"><span>Active Offers</span><b>${fmt(acc.activeOffers)}</b></div>
          <div class=\"stat\"><span>Revenue</span><b class=\"good\">$${fmt(acc.revenue)}</b></div>
          <div class=\"stat\"><span>Clicks</span><b>${fmt(acc.clicks)}</b></div>
          <div class=\"stat\"><span>Conversion</span><b>${fmt((Number(acc.conversionRate)||0)*100)}%</b></div>
        </div>
        <div class=\"actions\"><button class=\"btn secondary\">View Details</button></div>
      </div>`).join('');
    enhanceCPAChips();
  }

  async function loadUsers(){
    const d = await api('users'); if(!d) return;
    const tbody = $('#users-tbody'); if(!tbody) return;
    tbody.innerHTML = (d.items||[]).map(u=>`<tr><td>${u.name}</td><td>${u.email}</td><td>${u.phone||''}</td><td>${u.authority||''}</td><td>${u.status||''}</td></tr>`).join('');
  }

  async function loadAnalytics(){
    const d = await api('analytics'); if(!d) return;
    renderBarChart('#ana-overview', (d.byDay||[]).map(r=>r.earnings||0), (d.byDay||[]).map(r=>r.date?.slice(5)));
    renderPieChart('#ana-geo-dist', d.geo||{});
    const live = $('#ana-live'); if(live && d.items){
      live.innerHTML = d.items.slice(0,8).map(r=>`<tr><td>${r.date? new Date(r.date).toLocaleTimeString():''}</td><td>${r.country||''}</td><td>${r.device||''}</td><td>${fmt(r.clicks)}</td><td>${fmt(r.leads)}</td><td>$${fmt(r.earnings)}</td></tr>`).join('');
    }
  }

  async function loadWallet(){
    const d = await api('wallet'); if(!d) return;
    text('#wallet-balance', '$'+fmt(d.balance||0));
    const tbody = $('#wallet-history'); if(tbody && d.history){
      tbody.innerHTML = d.history.map(h=>`<tr><td>${h.date||''}</td><td>${h.method||''}</td><td>$${fmt(h.amount)}</td><td>${h.status||''}</td></tr>`).join('');
    }
  }

  async function loadMonitoring(){
    const d = await api('monitoring'); if(!d) return;
    text('#mon-health', d.health||''); text('#mon-maint', d.maintenance||'â');
    const tbody = $('#mon-events'); if(tbody && d.events){
      tbody.innerHTML = d.events.map(e=>`<tr><td>${e.time||''}</td><td>${e.type||'system'}</td><td>${e.message||''}</td></tr>`).join('');
    }
  }

  /* ========= UX helpers: skeleton + safe preview ========= */
  const PREVIEW_TIMEOUT_MS = 1600;
  const PREVIEW = true;
  function skeletonizeCharts(){
    ['#dash-earnings','#dash-sources','#ana-overview','#ana-geo-dist'].forEach(sel=>{
      const el=document.querySelector(sel);
      if(el && !el._sk){ el._sk=true; el.classList.add('skeleton'); }
    });
  }
  function unskeletonize(sel){
    const el=document.querySelector(sel);
    if(el){ el.classList.remove('skeleton'); }
  }
  function seedPreview(){
    renderBarChart('#dash-earnings',[120,180,90,220,160,140,200],['Mon','Tue','Wed','Thu','Fri','Sat','Sun']);
    renderPieChart('#dash-sources',{Search:45,Social:25,Display:15,Direct:15});
    unskeletonize('#dash-earnings');unskeletonize('#dash-sources');
    renderBarChart('#ana-overview',[40,70,55,80,65,95,110],['Mon','Tue','Wed','Thu','Fri','Sat','Sun']);
    renderPieChart('#ana-geo-dist',{US:120,NG:90,GB:60,IN:50,CA:40});
    unskeletonize('#ana-overview');unskeletonize('#ana-geo-dist');
  }

  // Call skeletonize and preview on boot
  skeletonizeCharts();
  setTimeout(()=>{ if(PREVIEW) seedPreview(); }, PREVIEW_TIMEOUT_MS);

  // Enhance CPA chips
  function faviconUrl(domain){return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=32`;}
  function enhanceCPAChips(){
    $$('#cpa-grid .acct .right').forEach(box=>{if(box._chipApplied)return;box._chipApplied=true;
      const pill=box.querySelector('.pill.mono');if(!pill)return;const domain=pill.textContent.trim();
      const chip=document.createElement('span');chip.className='chip';
      const img=document.createElement('img');img.src=faviconUrl(domain);
      chip.appendChild(img);chip.appendChild(document.createTextNode(domain));
      pill.replaceWith(chip);
    });
  }
  const origShow=window.show||function(){};
  window.show=async function(route){
    origShow(route);
    try{
      if(route==='dashboard') await loadOverview();
      else if(route==='cpa'){ await loadCpa(); setTimeout(enhanceCPAChips,30); }
      else if(route==='users') await loadUsers();
      else if(route==='analytics') await loadAnalytics();
      else if(route==='wallet') await loadWallet();
      else if(route==='monitoring') await loadMonitoring();
      else if(!route){ await loadOverview(); }
    }catch(e){ console.error('route load', route, e); }
  };

})();

/* Fire initial route reliably */
(function(){
  const first=(location.hash||'#dashboard').replace('#','');
  show(first);
  setTimeout(()=>show(first),0);
})();
</script></body>
</html>