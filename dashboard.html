<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Empire — Dashboard</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="stylesheet" href="/app/styles/brand.css"/>
</head>
<body class="brand-bg">
  <div class="emp-wrap">
    <!-- Header -->
    <header class="emp-header">
      <img src="/app/assets/brand/emblem.svg" alt="Empire Emblem" class="brand-logo"/>
      <div>
        <div class="emp-title">Empire — Dashboard</div>
        <div class="emp-sub">Live command overview · Sheets + Paystack + Telegram</div>
      </div>
    </header>

    <!-- Optional hero -->
    <div class="hero">
      <div class="badge">▲</div>
      <div>
        <div class="title">Live Operations</div>
        <div class="sub">Tracking users, events, system health and wallet in real time.</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="overview">Overview</button>
      <button class="tab" data-tab="health">Health</button>
      <button class="tab" data-tab="users">Users</button>
      <button class="tab" data-tab="events">Events</button>
      <button class="tab" data-tab="wallet">Wallet</button>
    </div>

    <!-- OVERVIEW -->
    <section id="tab-overview" class="panel">
      <div class="grid cols-2">
        <div class="card">
          <div class="card-title">Total Earnings (USD)</div>
          <div id="kpi-earn" class="kpi">$0.00</div>
        </div>
        <div class="card">
          <div class="card-title">Active Users</div>
          <div id="kpi-active" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="card-title">Approval Rate</div>
          <div id="kpi-approval" class="kpi">—</div>
        </div>
        <div class="card">
          <div class="card-title">Pending Reviews</div>
          <div id="kpi-pending" class="kpi">0</div>
        </div>
      </div>
      <div class="muted mt" id="summary-note">Loading…</div>
    </section>

    <!-- HEALTH -->
    <section id="tab-health" class="panel" hidden>
      <pre id="health-json" class="muted" style="white-space:pre-wrap;margin:0">Loading…</pre>
    </section>

    <!-- USERS -->
    <section id="tab-users" class="panel" hidden>
      <div class="muted" style="margin-bottom:8px">Registered Users</div>
      <div class="card table-scroll">
        <table class="table" id="users-table">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Scale</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- EVENTS -->
    <section id="tab-events" class="panel" hidden>
      <div class="muted" style="margin-bottom:8px">Recent Activity</div>
      <div class="card table-scroll">
        <table class="table" id="events-table">
          <thead><tr><th>When</th><th>Actor</th><th>Type</th><th>Message</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- WALLET -->
    <section id="tab-wallet" class="panel" hidden>
      <div class="grid cols-2">
        <div class="card">
          <div class="card-title">Total Inflow (USD)</div>
          <div id="w-inflow" class="big">—</div>
        </div>
        <div class="card">
          <div class="card-title">Total Outflow (USD)</div>
          <div id="w-outflow" class="big">—</div>
        </div>
        <div class="card">
          <div class="card-title">Net (USD)</div>
          <div id="w-net" class="big">—</div>
        </div>
      </div>

      <h3 class="mt" style="margin-bottom:8px">Recent Wallet Activity</h3>
      <div class="card table-scroll">
        <table class="table" id="wallet-table">
          <thead>
            <tr><th>Date</th><th>Amount (USD)</th><th>Method</th><th>Status</th></tr>
          </thead>
          <tbody><!-- filled by JS --></tbody>
        </table>
      </div>
    </section>

    <div class="footer">© Empire Affiliate Marketing Hub</div>
  </div>

  <script>
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const sections = {
      overview: document.getElementById('tab-overview'),
      health:   document.getElementById('tab-health'),
      users:    document.getElementById('tab-users'),
      events:   document.getElementById('tab-events'),
      wallet:   document.getElementById('tab-wallet'),
    };
    tabs.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const k = b.dataset.tab;
        Object.entries(sections).forEach(([id,el])=> el.hidden = id!==k );
        // lazy load per tab
        if (k==='health') loadHealth();
        if (k==='users')  loadUsers();
        if (k==='events') loadEvents();
        if (k==='wallet') loadWallet();
      });
    });

    // Helpers
    const el = (id)=> document.getElementById(id);
    const setText = (id, v)=> { const e = el(id); if (e) e.textContent = v; };
    const escapeHtml = (s)=> String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const fmtUSD = (n)=> {
      try { return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }).format(+n||0); }
      catch { return '$' + (Number(n||0).toFixed(2)); }
    };
    async function fetchJSON(url){
      const r = await fetch(url, { headers: { 'Cache-Control': 'no-cache' }});
      if (!r.ok) throw new Error(`${r.status} ${url}`);
      return r.json();
    }

    // Overview
    async function loadSummary(){
      try{
        const s = await fetchJSON('/.netlify/functions/summary');
        setText('kpi-earn',    fmtUSD(s.totalEarnings||0));
        setText('kpi-active',  String(s.activeUsers ?? 0));
        setText('kpi-approval', (s.approvalRate!=null) ? (Math.round((s.approvalRate*100)||0)+'%') : '—');
        setText('kpi-pending', String(s.pendingReviews ?? 0));
        el('summary-note').textContent = 'Synced from Google Sheets.';
      }catch(e){
        el('summary-note').textContent = 'Failed to load summary: ' + e.message;
      }
    }

    // Health
    let healthOnce=false;
    async function loadHealth(){
      if (healthOnce) return; healthOnce=true;
      try{
        const h = await fetchJSON('/.netlify/functions/health');
        el('health-json').textContent = JSON.stringify(h, null, 2);
      }catch(e){
        el('health-json').textContent = 'Failed to load health: ' + e.message;
      }
    }

    // Users
    let usersOnce=false;
    async function loadUsers(){
      const body = document.querySelector('#users-table tbody');
      body.innerHTML = '<tr><td class="muted" colspan="5">Loading…</td></tr>';
      try{
        const u = await fetchJSON('/.netlify/functions/users?limit=100');
        body.innerHTML = '';
        (u.users||[]).forEach(row=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(row.name||'')}</td>
            <td>${escapeHtml(row.email||'')}</td>
            <td>${escapeHtml(row.phone||'')}</td>
            <td><span class="chip">${escapeHtml(row.status||'')}</span></td>
            <td>${escapeHtml(row.scale||'')}</td>
          `;
          body.appendChild(tr);
        });
        if (!u.users || u.users.length===0){
          body.innerHTML = '<tr><td class="muted" colspan="5">No users yet.</td></tr>';
        }
        usersOnce=true;
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="5">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // Events
    let eventsOnce=false;
    async function loadEvents(){
      const body = document.querySelector('#events-table tbody');
      body.innerHTML = '<tr><td class="muted" colspan="4">Loading…</td></tr>';
      try{
        const ev = await fetchJSON('/.netlify/functions/events?limit=50');
        body.innerHTML = '';
        (ev.events||[]).forEach(item=>{
          const when = item.ts ? new Date(item.ts).toLocaleString() : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(when)}</td>
            <td>${escapeHtml(item.actor||'')}</td>
            <td>${escapeHtml(item.type||'')}</td>
            <td>${escapeHtml(item.msg||'')}</td>
          `;
          body.appendChild(tr);
        });
        if (!ev.events || ev.events.length===0){
          body.innerHTML = '<tr><td class="muted" colspan="4">No events yet.</td></tr>';
        }
        eventsOnce=true;
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="4">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // Wallet
    let walletOnce=false;
    async function loadWallet(){
      const body = document.querySelector('#wallet-table tbody');
      body.innerHTML = '<tr><td class="muted" colspan="4">Loading…</td></tr>';
      try{
        const w = await fetchJSON('/.netlify/functions/wallet?limit=50'); // {ok,inflow,outflow,net,items[]}
        setText('w-inflow',  fmtUSD(w.inflow||0));
        setText('w-outflow', fmtUSD(w.outflow||0));
        setText('w-net',     fmtUSD(w.net||0));

        body.innerHTML = '';
        (w.items||[]).forEach(row=>{
          const when = row.ts ? new Date(row.ts).toLocaleString() : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(when)}</td>
            <td>${fmtUSD(row.amount||0)}</td>
            <td>${escapeHtml(row.method||'')}</td>
            <td><span class="chip">${escapeHtml(row.status||'')}</span></td>
          `;
          body.appendChild(tr);
        });
        if (!w.items || w.items.length===0){
          body.innerHTML = '<tr><td class="muted" colspan="4">No wallet activity yet.</td></tr>';
        }
        walletOnce=true;
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="4">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // Kick off Overview immediately
    loadSummary();
  </script>
</body>
</html>