<script>
/* ========= tiny on-screen console (helps on mobile) ========= */
(function(){
  const box=document.createElement('div');
  box.id='empireDebug'; box.style.cssText='position:fixed;right:10px;bottom:10px;max-width:60vw;max-height:40vh;overflow:auto;background:#0b1320;border:1px solid #2a3a66;border-radius:10px;padding:8px 10px;font:12px/1.4 system-ui,Segoe UI,Arial;color:#cde;z-index:99999;display:none';
  document.body.appendChild(box);
  window.empireLog=(...a)=>{ box.style.display='block'; const d=document.createElement('div'); d.textContent=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); box.appendChild(d); };
})();

/* ====================== CONFIG ====================== */
const EMPIRE = {
  API_URL: "https://script.google.com/macros/s/AKfycbz-jj7Cr_KzqCku4SQPQ14MEIuCPdq5OEgiiqjo_O2A0FItBrHlmfkoJHViDxuX4P6z/exec",
  KEY: "GENERALISIMO@15769"
};

/* ====================== UTILS ======================= */
const $=id=>document.getElementById(id);
const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const fmtUSD=n=> (Number(n||0)).toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2});
const num=n=> (Number(n||0)).toLocaleString('en-US');
const pct=n=> (Number(n||0)).toFixed(2)+'%';
const esc=s=> String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const escapeHTML = (s) => String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));

/* =================== API HELPERS ==================== */
function withKey(u){ if(EMPIRE.KEY) u.searchParams.set('key',EMPIRE.KEY); return u; }
async function apiGet(action, params={}){
  const u = withKey(new URL(EMPIRE.API_URL));
  u.searchParams.set('action', action);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
  empireLog('GET', u.toString());
  const r = await fetch(u.toString(), {method:'GET'});
  const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON from GAS'}));
  empireLog('→', j);
  return j;
}
async function apiPost(action, body={}){
  const u = withKey(new URL(EMPIRE.API_URL));
  u.searchParams.set('action', action);
  empireLog('POST', u.toString(), body);
  const r = await fetch(u.toString(), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON from GAS'}));
  empireLog('→', j);
  return j;
}

/* ====================== NAV ========================= */
function showTab(tabId){
  qa('.navlink').forEach(a=>a.classList.toggle('active', a.dataset.target===tabId));
  qa('.view').forEach(v=>v.classList.toggle('active', v.id===tabId));
  $('#routeInfo').textContent = 'Route: #'+tabId;
  // lazy-load per tab
  if (tabId==='overview')   loadOverview().catch(e=>empireLog('overview err',e));
  if (tabId==='cpa')        loadCPA().catch(e=>empireLog('cpa err',e));
  if (tabId==='users')      loadUsers().catch(e=>empireLog('users err',e));
  if (tabId==='analytics')  loadAnalytics().catch(e=>empireLog('analytics err',e));
  if (tabId==='wallet')     loadWallet().catch(e=>empireLog('wallet err',e));
  if (tabId==='monitoring') loadMonitoring().catch(e=>empireLog('monitoring err',e));
  if (tabId==='settings')   loadSettings().catch(e=>empireLog('settings err',e));
}
function initTabs(){
  qa('.navlink').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      const id=a.dataset.target;
      history.replaceState(null,'','#'+id);
      showTab(id);
    });
  });
  window.addEventListener('hashchange', ()=>{
    const id=(location.hash||'#overview').replace('#','');
    showTab(id);
  });
  const start=(location.hash||'#overview').replace('#','');
  showTab(start);
}

/* ================ OVERVIEW LOADER =================== */
async function loadOverview(){
  const d = await apiGet('overview');
  const t   = d.totals || d || {};
  const geo = d.geo || (d.breakdowns&&d.breakdowns.byGeo) || {};
  const dev = d.devices || (d.breakdowns&&d.breakdowns.byDevice) || {};
  const typ = d.offerTypes || (d.breakdowns&&d.breakdowns.byOfferType) || {};
  const byD = d.byDay || (d.breakdowns&&d.breakdowns.byDay) || {};

  $('#ov-earnings').textContent = fmtUSD(t.earnings || t.totalEarnings || 0);
  $('#ov-leads').textContent    = num(t.leads || t.activeUsers || 0);
  $('#ov-clicks').textContent   = num(t.clicks || 0);
  $('#ov-convrate').textContent = (t.convRate!=null? pct(t.convRate) : (t.conversionRate!=null? pct(t.conversionRate):'0.00%'));
  $('#ov-epc').textContent      = fmtUSD(t.epc || 0);
  $('#ov-cpa').textContent      = fmtUSD(t.cpa || 0);
  $('#ov-rpm').textContent      = fmtUSD(t.rpm || 0);

  const paint = (id, obj)=>{
    const tb=$(id); tb.innerHTML='';
    Object.keys(obj||{}).forEach(k=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${esc(k)}</td><td class="num">${fmtUSD(obj[k])}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML=`<tr><td colspan="2" class="muted">No data</td></tr>`;
  };
  paint('tbl-geo',geo); paint('tbl-device',dev); paint('tbl-offerType',typ);

  const byBody=$('#tbl-byDay'); byBody.innerHTML='';
  const rows = Array.isArray(byD) ? byD : Object.entries(byD||{}).map(([date,val])=>({date,val}));
  rows.forEach(x=>{
    const tr=document.createElement('tr');
    const dt=x.date||x[0]||''; const v=x.val||x.value||x.amount||x[1]||0;
    tr.innerHTML=`<td>${esc(dt)}</td><td class="num">${fmtUSD(v)}</td>`;
    byBody.appendChild(tr);
  });
  if(!byBody.children.length) byBody.innerHTML=`<tr><td colspan="2" class="muted">No data</td></tr>`;
}

/* ================ CPA ACCOUNTS ====================== */
async function loadCPA(){
  const grid=$('#cpaGrid'); grid.innerHTML='';
  const r = await apiGet('cpaaccounts');
  (r.items || r.accounts || r.rows || []).forEach(acc=>{
    const name=acc.name||acc.id||'CPA';
    const offers=acc.offers||acc.activeOffers||0;
    const revenue=acc.revenue||0; const clicks=acc.clicks||0;
    const cr = acc.conversionRate!=null ? (typeof acc.conversionRate==='string'?acc.conversionRate:pct(acc.conversionRate)) : '—';
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="muted" style="margin-bottom:6px">${esc(name)}</div>
      <div class="row">
        <div class="col"><div class="muted">Active Offers</div><div class="kpi">${num(offers)}</div></div>
        <div class="col"><div class="muted">Revenue</div><div class="kpi">${fmtUSD(revenue)}</div></div>
        <div class="col"><div class="muted">Clicks</div><div class="kpi">${num(clicks)}</div></div>
        <div class="col"><div class="muted">Conversion</div><div class="kpi">${cr}</div></div>
      </div>`;
    grid.appendChild(el);
  });
  if(!grid.children.length) grid.innerHTML=`<div class="note">No CPA Grip accounts found in GAS output.</div>`;
}

/* ==================== USERS ======================== */
async function loadUsers(){
  // Pending
  try{
    const p = await apiGet('users',{state:'pending'});
    const body=$('#pendingBody'); body.innerHTML='';
    (p.items||p.users||[]).forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${esc(u.name||'')}</td><td>${esc(u.email||'')}</td><td>${esc(u.phone||'')}</td>
                    <td><button class="btnApproveRow">Approve</button></td>`;
      tr.querySelector('.btnApproveRow').onclick=async()=>{
        const res=await apiPost('approve-user',{email:u.email,approve:true});
        alert(res.ok?'Approved':('Failed: '+(res.error||''))); loadUsers();
      };
      body.appendChild(tr);
    });
    if(!body.children.length) body.innerHTML=`<tr><td colspan="4" class="muted">No pending users</td></tr>`;
  }catch(e){ $('#pendingBody').innerHTML=`<tr><td colspan="4">Failed: ${esc(e.message)}</td></tr>`; }

  // Approved
  try{
    const a = await apiGet('users',{state:'approved'});
    const body=$('#usersBody'); body.innerHTML='';
    (a.items||a.users||[]).forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${esc(u.name||'')}</td><td>${esc(u.email||'')}</td><td>${esc(u.whatsapp||u.phone||'')}</td>
                    <td>${esc(u.bank||'')}</td><td>${esc(u.account||'')}</td>
                    <td>${esc(u.authority||'User')}</td><td><span class="status">${esc(u.status||'ACTIVE')}</span></td>`;
      body.appendChild(tr);
    });
    if(!body.children.length) body.innerHTML=`<tr><td colspan="7" class="muted">No approved users</td></tr>`;
  }catch(e){ $('#usersBody').innerHTML=`<tr><td colspan="7">Failed: ${esc(e.message)}</td></tr>`; }
}

/* =================== ANALYTICS ===================== */
async function loadAnalytics(){
  const r = await apiGet('analytics');
  const body=$('#analyticsBody'); body.innerHTML='';
  const rows = r.rows || r.items || r.byDay || r.daily || [];
  const arr  = Array.isArray(rows) ? rows
               : Object.entries(rows).map(([date,v])=>({date,clicks:v.clicks||0,leads:v.leads||0,earnings:v.earnings||v||0}));
  arr.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(x.date||'')}</td><td class="num">${num(x.clicks||0)}</td>
                  <td class="num">${num(x.leads||0)}</td><td class="num">${fmtUSD(x.earnings||0)}</td>`;
    body.appendChild(tr);
  });
  if(!body.children.length) body.innerHTML=`<tr><td colspan="4" class="muted">No analytics data</td></tr>`;
}

/* ===================== WALLET ====================== */
async function loadWallet(){
  try{
    const w = await apiGet('walletoverview');
    $('#wallet-totalIn').textContent  = fmtUSD(w.totalIn  ?? 0);
    $('#wallet-totalOut').textContent = fmtUSD(w.totalOut ?? 0);
    $('#wallet-balance').textContent  = fmtUSD(w.balance  ?? ((w.totalIn||0)-(w.totalOut||0)));
    // banks
    try{
      const b = await apiGet('banks');
      const sel=$('#bankSelect'); sel.innerHTML='';
      (b.banks||b.rows||[]).forEach(x=>{
        const opt=document.createElement('option');
        opt.value=x.code||x.id||''; opt.textContent=`${x.name||'Bank'} (${x.code||''})`;
        sel.appendChild(opt);
      });
    }catch(_){}
  }catch(e){ empireLog('wallet err',e); }

  $('#btnWithdraw').onclick=async()=>{
    const acct=$('#acctNumber').value.trim(), bank=$('#bankSelect').value, amt=Number($('#withdrawAmt').value||0);
    if(!acct||!bank||!amt) return alert('Enter account, bank and amount.');
    if(amt<50) return alert('Minimum withdrawal is $50.');
    const res = await apiPost('withdraw-request',{account:acct,bank,amount:amt});
    alert(res.ok?'Withdrawal requested':('Failed: '+(res.error||''))); loadWallet();
  };
}

/* =================== MONITORING ==================== */
function setBadge(el, ok){ el.textContent=ok?'ONLINE':'OFFLINE'; el.className='badge '+(ok?'ok':'down'); }
async function loadMonitoring(){
  const st = await apiGet('monitoring');
  setBadge($('#serverBadge'), st.server!==false);
  setBadge($('#dbBadge'),     st.db!==false);
  setBadge($('#sheetsBadge'), st.sheets!==false);
  setBadge($('#aiBadge'),     st.ai!==false);
  const body=$('#evBody'); body.innerHTML='';
  (st.events||st.feed||[]).forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(e.time||'')}</td><td>${esc(e.type||'')}</td><td>${esc(e.msg||'')}</td><td>${esc(e.ref||'')}</td><td>${esc(e.actor||'')}</td>`;
    body.appendChild(tr);
  });
  if(!body.children.length) body.innerHTML=`<tr><td colspan="5" class="muted">No events</td></tr>`;
}

/* ===================== SETTINGS ==================== */
async function loadSettings(){
  const r = await apiGet('systemsettings');
  const rows=r.settings||r.rows||[];
  const body=$('#settingsBody'); body.innerHTML='';
  (rows||[]).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(x.key||x.k||'')}</td><td>${esc(x.value||x.v||'')}</td>
                  <td>${esc(x.desc||x.description||'')}</td><td>${esc(x.updated||'')}</td>`;
    body.appendChild(tr);
  });
  if(!body.children.length) body.innerHTML=`<tr><td colspan="4" class="muted">No settings</td></tr>`;
}

/* ====================== INIT ======================= */
window.addEventListener('DOMContentLoaded', ()=>{
  initTabs();            // hash+click router
  showTab((location.hash||'#overview').replace('#','')); // initial load
});
</script>