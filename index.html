<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>THE EMPIRE</title>
<style>
  :root{
    --bg:#0e1a28;--bg2:#0c1623;--card:#0f1f31;--muted:#6d819d;--txt:#dce7f7;
    --accent:#2fb5ff;--good:#25d366;--bad:#ff6b6b;--warn:#ffb020;--ink:#09131e;
    --ring:rgba(47,181,255,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,#0b1a2a 0%,#0b243c 100%);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
  /* sidebar */
  .side{background:linear-gradient(180deg,#091525,#08101c);border-right:1px solid rgba(255,255,255,.04)}
  .brand{display:flex;gap:.6rem;align-items:center;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.04)}
  .brand img{width:26px;height:26px}
  .brand b{letter-spacing:.3px}
  .nav a{display:flex;align-items:center;gap:.6rem;padding:12px 16px;color:#c9d7ea;border-left:3px solid transparent}
  .nav a:hover{background:rgba(255,255,255,.03)}
  .nav a.active{background:rgba(47,181,255,.08);border-left-color:var(--accent);color:#fff}
  .ico{width:18px;height:18px;opacity:.9}
  /* main */
  .main{padding:18px 18px 42px}
  .header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 14px}
  h2{margin:0;font-weight:700;letter-spacing:.4px}
  .badge{padding:6px 10px;border-radius:999px;background:#0d2a40;border:1px solid rgba(47,181,255,.35);color:#bfe7ff;font-weight:600}
  /* cards */
  .grid{display:grid;gap:14px}
  .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .card{background:linear-gradient(180deg,#0f2033,#0c1a2a);border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .card h3{margin:0 0 8px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);font-size:15px;color:#b5c9e6}
  .pad{padding:14px}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi b{font-size:22px}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  th{font-size:12px;text-transform:uppercase;letter-spacing:.3px;color:#9cb2d2;text-align:left}
  tr:last-child td{border-bottom:none}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px}
  .pill.ok{background:rgba(37,211,102,.12);border:1px solid rgba(37,211,102,.45);color:#9dffc7}
  .pill.warn{background:rgba(255,176,32,.12);border:1px solid rgba(255,176,32,.45);color:#ffdca3}
  .mono{font-variant-numeric:tabular-nums}
  .flex{display:flex;gap:12px;align-items:center}
  .right{margin-left:auto}
  .btn{background:#12304b;border:1px solid rgba(47,181,255,.4);color:#cfeaff;padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{box-shadow:0 0 0 3px var(--ring)}
  /* views */
  .view{display:none}
  .view.active{display:block}
  @media(max-width:980px){.wrap{grid-template-columns:1fr}.side{position:sticky;top:0;z-index:5}.nav{display:grid;grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <!-- SIDEBAR -->
  <aside class="side">
    <div class="brand">
      <img src="https://i.imgur.com/9Rr4kqP.png" alt="">
      <b>THE EMPIRE</b>
    </div>
    <nav class="nav" id="nav">
      <a href="#dashboard" data-view="dashboard" class="active"><span class="ico">üè†</span>Dashboard</a>
      <a href="#accounts"  data-view="accounts"><span class="ico">üëë</span>CPA Accounts</a>
      <a href="#users"     data-view="users"><span class="ico">üë•</span>Users</a>
      <a href="#analytics" data-view="analytics"><span class="ico">üìä</span>Analytics</a>
      <a href="#wallet"    data-view="wallet"><span class="ico">üí≥</span>Payments/Wallet</a>
      <a href="#monitor"   data-view="monitor"><span class="ico">üì°</span>Monitoring</a>
      <a href="#settings"  data-view="settings"><span class="ico">‚öôÔ∏è</span>Settings</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- DASHBOARD -->
    <section class="view active" id="view-dashboard">
      <div class="header">
        <h2>Supreme Command Dashboard</h2>
        <span class="badge" id="commander-badge">SUPREME COMMANDER</span>
      </div>

      <div class="grid g-4">
        <div class="card pad kpi"><span class="muted">Total Earnings</span><b class="mono" id="kpi-earn">$0.00</b></div>
        <div class="card pad kpi"><span class="muted">Active Users</span><b class="mono" id="kpi-users">0</b><span class="muted" id="kpi-users-sub">24h growth</span></div>
        <div class="card pad kpi"><span class="muted">Conversion Rate</span><b class="mono" id="kpi-cr">0.00%</b><span class="muted">industry leading</span></div>
        <div class="card pad kpi"><span class="muted">Total Clicks</span><b class="mono" id="kpi-clicks">0</b><span class="muted">daily average</span></div>
      </div>

      <div class="grid g-2" style="margin-top:14px">
        <div class="card">
          <h3>Daily Earnings</h3>
          <div class="pad muted" id="sparkline">Awaiting data‚Ä¶</div>
        </div>
        <div class="card">
          <h3>Traffic Sources</h3>
          <div class="pad muted" id="traffic-sources">Awaiting data‚Ä¶</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>By Geo (Top)</h3>
        <div class="pad">
          <table id="tbl-geo">
            <thead><tr><th>Country</th><th>Clicks</th><th>Leads</th><th>Earnings ($)</th></tr></thead>
            <tbody><tr><td colspan="4" class="muted">No data</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ACCOUNTS -->
    <section class="view" id="view-accounts">
      <div class="header"><h2>CPA Accounts</h2><button class="btn" id="btn-add">+ Add New Account</button></div>
      <div class="grid g-2" id="acc-grid"></div>
    </section>

    <!-- USERS -->
    <section class="view" id="view-users">
      <div class="header"><h2>Users</h2></div>
      <div class="card">
        <h3>Approved</h3>
        <div class="pad">
          <table id="tbl-users">
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Authority</th><th>Status</th></tr></thead>
            <tbody><tr><td colspan="5" class="muted">No users.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section class="view" id="view-analytics">
      <div class="header"><h2>Analytics</h2></div>
      <div class="card">
        <h3>Live Performance (last 2 min)</h3>
        <div class="pad">
          <table id="tbl-live">
            <thead><tr><th>Time</th><th>Country</th><th>Offer</th><th>Device</th><th>Clicks</th><th>Conv.</th><th>Earnings</th></tr></thead>
            <tbody><tr><td colspan="7" class="muted">Listening‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Live by Geo (rolling)</h3>
        <div class="pad">
          <table id="tbl-live-geo">
            <thead><tr><th>Country</th><th>Clicks</th><th>Conv.</th><th>Earnings</th></tr></thead>
            <tbody><tr><td colspan="4" class="muted">Listening‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- WALLET -->
    <section class="view" id="view-wallet">
      <div class="header"><h2>Wallet</h2></div>
      <div class="grid g-3">
        <div class="card pad kpi"><span class="muted">Balance</span><b class="mono" id="wallet-bal">$0.00</b></div>
        <div class="card pad kpi"><span class="muted">Last Payout</span><b class="mono" id="wallet-last">‚Äî</b></div>
        <div class="card pad kpi"><span class="muted">Status</span><span class="pill ok" id="wallet-status">OK</span></div>
      </div>
      <div class="card" style="margin-top:14px">
        <h3>Transactions</h3>
        <div class="pad">
          <table id="tbl-tx">
            <thead><tr><th>Date</th><th>Method</th><th>Amount ($)</th><th>Status</th></tr></thead>
            <tbody><tr><td colspan="4" class="muted">No transactions.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MONITOR -->
    <section class="view" id="view-monitor">
      <div class="header"><h2>Monitoring</h2></div>
      <div class="grid g-3">
        <div class="card pad"><div class="muted">Intelligent Alert System</div><div id="box-alerts" class="mono" style="font-size:22px">0</div></div>
        <div class="card pad"><div class="muted">Predictive Maintenance</div><div id="box-maint" class="mono" style="font-size:22px">‚Äî</div></div>
        <div class="card pad"><div class="muted">System Health</div><div id="box-health" class="mono" style="font-size:22px">‚Äî</div></div>
      </div>
      <div class="card" style="margin-top:14px">
        <h3>Events</h3>
        <div class="pad">
          <table id="tbl-monitor">
            <thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead>
            <tbody><tr><td colspan="3" class="muted">No events.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="view" id="view-settings">
      <div class="header"><h2>Settings</h2></div>
      <div class="card"><h3>Current Config</h3><pre class="pad" id="settings-json" style="white-space:pre-wrap;overflow:auto"></pre></div>
    </section>
  </main>
</div>

<script>
/* ==== CONFIG ==== */
const GAS = "https://script.google.com/macros/s/AKfycbwZVlGMvYonfCNdQlwPHiqqgOVC80_HsyktSYmqmQPBKmRrlzg_yo4lKz_Mmu85B7eY/exec"; // <-- REPLACE with your script.google.com/webapp URL

/* ==== HELPERS ==== */
const $ = (q,el=document)=>el.querySelector(q);
const $$ = (q,el=document)=>[...el.querySelectorAll(q)];
const fmtUsd = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const safe = v => v ?? '';

async function api(params){
  const url = GAS + (GAS.includes('?')?'&':'?') + new URLSearchParams(params).toString();
  const r = await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error(r.status+" "+r.statusText);
  return r.json();
}

/* ==== ROUTER ==== */
function activate(view){
  // sidebar active
  $$('#nav a').forEach(a=>a.classList.toggle('active',a.dataset.view===view));
  // view panels
  $$('.view').forEach(v=>v.classList.toggle('active',v.id==='view-'+view));
  // lazy init
  const fn = ({
    dashboard:initDashboard,
    accounts:initAccounts,
    users:initUsers,
    analytics:initAnalytics,
    wallet:initWallet,
    monitor:initMonitor,
    settings:initSettings
  })[view];
  if(fn) fn();
}
function handleHash(){ activate(location.hash.replace('#','')||'dashboard'); }
window.addEventListener('hashchange',handleHash);

/* ==== VIEWS ==== */
let bootDone=false, liveTimer=null;

async function initDashboard(){
  try{
    const j = await api({action:'overview'});
    $('#kpi-earn').textContent  = fmtUsd(j.earnings);
    $('#kpi-users').textContent = safe(j.users);
    $('#kpi-cr').textContent    = (j.conversionRate??0)+'%';
    $('#kpi-clicks').textContent= safe(j.clicks);
    // geo
    const tb = $('#tbl-geo tbody'); tb.innerHTML='';
    (j.byGeo||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${safe(r.country)}</td><td class="mono">${safe(r.clicks)}</td><td class="mono">${safe(r.leads)}</td><td class="mono">${fmtUsd(r.earnings)}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="4" class="muted">No data</td></tr>`;
  }catch(e){
    console.error(e);
  }
}

async function initAccounts(){
  try{
    const j = await api({action:'accounts'});
    const grid = $('#acc-grid'); grid.innerHTML='';
    (j.accounts||[]).forEach(a=>{
      const card = document.createElement('div');
      card.className='card pad';
      card.innerHTML = `
        <div class="flex"><b style="font-size:18px">${safe(a.account||a.id)}</b>
          <span class="right pill ok">${safe(a.status)||'ACTIVE'}</span>
        </div>
        <div class="muted" style="margin-top:6px">Network</div>
        <div style="font-weight:600">${safe(a.network||'CPA Grip')}</div>
        <div class="grid g-3" style="margin-top:10px">
          <div><div class="muted">Active Offers</div><div class="mono">${safe(a.active_offers||a.offers)||0}</div></div>
          <div><div class="muted">Clicks</div><div class="mono">${safe(a.clicks)||0}</div></div>
          <div><div class="muted">Revenue</div><div class="mono">${fmtUsd(a.revenue)}</div></div>
        </div>
      `;
      grid.appendChild(card);
    });
  }catch(e){ console.error(e); }
}

async function initUsers(){
  try{
    const j = await api({action:'users'});
    const tb = $('#tbl-users tbody'); tb.innerHTML='';
    (j.approved||j.users||[]).forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${safe(u.name)}</td><td>${safe(u.email)}</td><td>${safe(u.phone)}</td><td>${safe(u.authority||'1x User')}</td><td><span class="pill ok">Active</span></td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="5" class="muted">No users.</td></tr>`;
  }catch(e){ console.error(e); }
}

async function initAnalytics(){
  // start fast polling once (shared timer)
  if(liveTimer) return;
  const tick = async ()=>{
    try{
      const j = await api({action:'live'});
      // Live performance stream
      const tb = $('#tbl-live tbody'); if(tb) {
        tb.innerHTML='';
        (j.live||[]).forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td class="mono">${safe(r.time)}</td><td>${safe(r.country)}</td><td>${safe(r.offer)}</td><td>${safe(r.device)}</td><td class="mono">${safe(r.clicks)||0}</td><td class="mono">${safe(r.conversions||r.leads)||0}</td><td class="mono">${fmtUsd(r.earnings)}</td>`;
          tb.appendChild(tr);
        });
        if(!tb.children.length) tb.innerHTML = `<tr><td colspan="7" class="muted">Listening‚Ä¶</td></tr>`;
      }
      // Rolling by Geo
      const tg = $('#tbl-live-geo tbody'); if(tg){
        tg.innerHTML='';
        (j.byGeo||[]).forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${safe(r.country)}</td><td class="mono">${safe(r.clicks)||0}</td><td class="mono">${safe(r.conversions||r.leads)||0}</td><td class="mono">${fmtUsd(r.earnings)}</td>`;
          tg.appendChild(tr);
        });
        if(!tg.children.length) tg.innerHTML = `<tr><td colspan="4" class="muted">Listening‚Ä¶</td></tr>`;
      }
      // mirror KPIs to dashboard if visible
      if($('#view-dashboard').classList.contains('active')){
        $('#kpi-earn').textContent  = fmtUsd(j.kpis?.earnings);
        $('#kpi-clicks').textContent= j.kpis?.clicks ?? $('#kpi-clicks').textContent;
        $('#kpi-cr').textContent    = (j.kpis?.cr ?? '0.00')+'%';
      }
    }catch(e){ console.warn('live tick',e.message); }
  };
  await tick();
  liveTimer = setInterval(tick, 3000); // tight polling (3s)
}

async function initWallet(){
  try{
    const j = await api({action:'wallet'});
    $('#wallet-bal').textContent  = fmtUsd(j.balance);
    $('#wallet-last').textContent = safe(j.lastPayout)||'‚Äî';
    const tb = $('#tbl-tx tbody'); tb.innerHTML='';
    (j.tx||[]).forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${safe(t.date)}</td><td>${safe(t.method)}</td><td class="mono">${fmtUsd(t.amount)}</td><td>${safe(t.status)}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="4" class="muted">No transactions.</td></tr>`;
  }catch(e){ console.error(e); }
}

async function initMonitor(){
  try{
    const j = await api({action:'monitoring'});
    $('#box-alerts').textContent = j.alerts ?? 0;
    $('#box-maint').textContent  = j.maintenance ?? '‚Äî';
    $('#box-health').textContent = j.health ?? '‚Äî';
    const tb = $('#tbl-monitor tbody'); tb.innerHTML='';
    (j.events||[]).forEach(ev=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="mono">${safe(ev.time)}</td><td>${safe(ev.type)}</td><td>${safe(ev.message)}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="3" class="muted">No events.</td></tr>`;
  }catch(e){ console.error(e); }
}

async function initSettings(){
  try{
    const j = await api({action:'config'});
    $('#settings-json').textContent = JSON.stringify(j,null,2);
    $('#commander-badge').textContent = (j.commander_name||'SUPREME COMMANDER').replaceAll('_',' ');
  }catch(e){
    $('#settings-json').textContent = 'Unable to load config: '+e.message;
  }
}

/* ==== BOOT ==== */
window.addEventListener('DOMContentLoaded',()=>{
  // allow clicking the whole left nav (works on mobile)
  $$('#nav a').forEach(a=>a.addEventListener('click',ev=>{
    ev.preventDefault(); location.hash = a.getAttribute('href');
  }));
  handleHash();            // show first view
  initAnalytics();         // start live polling early (even off-tab)
  bootDone=true;
});
</script>
</body>
</html>