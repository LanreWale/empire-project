<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>THE EMPIRE — Supreme Command</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="assets/css/empire-style.css" />
  <style>
    /* tiny helpers for tables/chips */
    .chip{display:inline-block;padding:.22rem .55rem;border-radius:999px;font-size:.78rem;font-weight:700;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08)}
    .chip.success{background:rgba(45,212,191,.12);border-color:rgba(45,212,191,.25);color:#b6fff0}
    .chip.fail{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.22);color:#ffb2b2}
    .chip.pending{background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.25);color:#ffe7a3}
    .right{ text-align:right }
    .muted{ color:var(--emp-muted) }
    .small{ font-size:.85rem }
    .mt-1{margin-top:.5rem}.mt-2{margin-top:1rem}.mt-3{margin-top:1.5rem}
    .w-100{width:100%}
    .hidden{display:none}
    .emp-shell{display:grid;grid-template-columns:260px 1fr;min-height:100svh}
    .emp-sidebar{padding:18px;background:var(--emp-card);border-right:1px solid var(--emp-border)}
    .emp-brand{display:block;font-weight:900;letter-spacing:.08em;margin-bottom:10px}
    .emp-content{padding:18px}
    .section-title{font-size:1.25rem;margin:2px 0 14px;font-weight:900;letter-spacing:.02em}
    .grid{display:grid;gap:14px}.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:1fr 1fr 1fr}.cols-4{grid-template-columns:repeat(4,1fr)}
    .kpi-card{background:var(--emp-card);border:1px solid var(--emp-border);border-radius:14px;padding:14px}
    .kpi-card .label{display:block;color:var(--emp-muted);font-size:.88rem;margin-bottom:6px}
    .kpi-card .val{font-size:1.6rem;font-weight:900}
    .emp-card{padding:14px}
    .card-title{margin-bottom:8px;font-size:1rem;font-weight:800}
    .btn{background:var(--emp-accent);color:#1a1a1a;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    table.table{width:100%;border-collapse:collapse}
    table.table th,table.table td{padding:10px;border-bottom:1px solid var(--emp-border)}
    table.table th{color:var(--emp-muted);text-align:left;font-weight:800}
    @media (max-width: 980px){.emp-shell{grid-template-columns:1fr}.emp-sidebar{position:sticky;top:0;z-index:10}}
  </style>
</head>
<body class="bg-empire-hero">
  <div class="emp-shell">
    <!-- SIDEBAR -->
    <aside class="emp-sidebar">
      <span class="emp-brand">⚔️ THE EMPIRE</span>
      <nav class="emp-nav">
        <a class="emp-tab active" href="#dashboard">Dashboard</a>
        <a class="emp-tab" href="#cpa">CPA Accounts</a>
        <a class="emp-tab" href="#users">Users</a>
        <a class="emp-tab" href="#analytics">Analytics</a>
        <a class="emp-tab" href="#wallet">Payments/Wallet</a>
        <a class="emp-tab" href="#security">Security</a>
        <a class="emp-tab" href="#monitoring">Monitoring</a>
        <a class="emp-tab" href="#logout">Logout</a>
      </nav>
      <div class="mt-2 small muted">© 2025 The Empire</div>
    </aside>

    <!-- MAIN -->
    <main class="emp-content">
      <!-- DASHBOARD -->
      <section id="dashboard" class="emp-view">
        <h2 class="section-title">Supreme Command Dashboard <span class="chip small">Live</span></h2>
        <div class="grid cols-4">
          <div class="kpi-card">
            <span class="label">Total Earnings</span>
            <span class="val" id="kpiTotalEarnings">$0</span>
            <div class="small muted" id="kpiUpdatedAt"></div>
          </div>
          <div class="kpi-card">
            <span class="label">Active Users</span>
            <span class="val" id="kpiActiveUsers">0</span>
            <div class="small muted">+ last sync <span id="kpiLastSync"></span></div>
          </div>
          <div class="kpi-card">
            <span class="label">Conversion Rate</span>
            <span class="val" id="kpiConvRate">0.00%</span>
            <div class="small muted">Industry leading</div>
          </div>
          <div class="kpi-card">
            <span class="label">Total Clicks</span>
            <span class="val" id="kpiClicks">0</span>
            <div class="small muted">Daily average</div>
          </div>
        </div>

        <div class="grid cols-2 mt-3">
          <div class="emp-card">
            <h3 class="card-title">Daily Earnings</h3>
            <canvas id="dailyChart" height="140"></canvas>
          </div>
          <div class="emp-card">
            <h3 class="card-title">Traffic Sources</h3>
            <canvas id="trafficChart" height="140"></canvas>
          </div>
        </div>
      </section>

      <!-- CPA ACCOUNTS -->
      <section id="cpa" class="emp-view hidden">
        <h2 class="section-title">CPA Accounts Management <span class="chip small">Live</span></h2>
        <button class="btn" id="btnAddCpa">+ Add New Account</button>
        <table class="table mt-2" id="cpaTable">
          <thead>
            <tr><th>Account</th><th>Network</th><th>Status</th><th class="right">Leads</th><th class="right">Earnings</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="small muted mt-1" id="cpaHint"></div>
      </section>

      <!-- USERS -->
      <section id="users" class="emp-view hidden">
        <h2 class="section-title">Users Management <span class="chip small">Live</span></h2>
        <div class="small muted mt-1" id="usersSummary"></div>
        <button class="btn mt-1" id="btnAddUser">+ Add New User</button>
        <table class="table mt-2" id="userTable">
          <thead>
            <tr><th>Username</th><th>Email</th><th>Phone</th><th>Level</th><th>Status</th><th class="right">Earnings</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- ANALYTICS -->
      <section id="analytics" class="emp-view hidden">
        <h2 class="section-title">Analytics & Reports <span class="chip small">Live</span></h2>
        <div class="grid cols-2">
          <div class="emp-card"><h3 class="card-title">Performance Overview (Monthly)</h3><canvas id="perfChart" height="140"></canvas></div>
          <div class="emp-card"><h3 class="card-title">Geographic Distribution</h3><canvas id="geoChart" height="140"></canvas></div>
        </div>
        <div class="emp-card mt-3">
          <h3 class="card-title">Live Performance Data</h3>
          <table class="table" id="analyticsTable">
            <thead><tr><th>Date</th><th class="right">Clicks</th><th class="right">Leads</th><th class="right">Earnings</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- WALLET -->
      <section id="wallet" class="emp-view hidden">
        <h2 class="section-title">Universal Withdrawal &amp; History <span class="chip small">Live</span></h2>
        <div class="grid cols-3">
          <div class="kpi-card"><span class="label">Inflow</span><span class="val" id="kpiInflow">$0</span></div>
          <div class="kpi-card"><span class="label">Outflow</span><span class="val" id="kpiOutflow">$0</span></div>
          <div class="kpi-card"><span class="label">Net</span><span class="val" id="kpiNet">$0</span></div>
        </div>
        <div class="mt-2">
          <button class="btn" id="btnWithdraw">Request Withdrawal</button>
        </div>
        <table class="table mt-2" id="walletTable">
          <thead><tr><th>Time</th><th class="right">Amount</th><th>Method</th><th>Dir</th><th>Status</th><th>Name</th><th>Email</th><th>Phone</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- SECURITY -->
      <section id="security" class="emp-view hidden">
        <h2 class="section-title">Security Overview <span class="chip small">Live</span></h2>
        <div class="grid cols-3">
          <div class="kpi-card"><span class="label">Alerts (24h)</span><span class="val" id="secAlerts">0</span></div>
          <div class="kpi-card"><span class="label">Failed Logins</span><span class="val" id="secFailed">0</span></div>
          <div class="kpi-card"><span class="label">Blocks</span><span class="val" id="secBlocks">0</span></div>
        </div>
        <div class="emp-card mt-3">
          <h3 class="card-title">Recent Security Activity</h3>
          <ul id="securityList" class="small"></ul>
        </div>
      </section>

      <!-- MONITORING -->
      <section id="monitoring" class="emp-view hidden">
        <h2 class="section-title">System Monitoring <span class="chip small">Live</span></h2>
        <table class="table" id="monitorTable">
          <thead><tr><th>Time</th><th>Event</th><th>Details</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="logout" class="emp-view hidden">
        <h2 class="section-title">Logout</h2>
        <div class="muted">To protect your command, simply close this window or clear your session.</div>
      </section>
    </main>
  </div>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
    // ---------- CONFIG ----------
    const BASE = "https://script.google.com/macros/s/AKfycbysJmVXlrOE1_J3uw5wMqs9cnKtj-uuoxj0Mmj8JWTj7eZMvp9XJYXrs-0leocNXI6w/exec";

    // ---------- HELPERS ----------
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const fmtMoney = n => '$' + (Number(n||0)).toLocaleString();
    const fmtPct = n => (Number(n||0)).toFixed(2) + '%';
    const fmtTime = t => {
      if(!t) return '';
      try { return new Date(t).toLocaleString(); } catch { return t; }
    };
    const setText = (id,val) => { const el = document.getElementById(id); if(el) el.textContent = val; };

    // ---------- NAV ----------
    $$('.emp-tab').forEach(tab=>{
      tab.addEventListener('click', e=>{
        e.preventDefault();
        const target = tab.getAttribute('href');
        $$('.emp-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        $$('.emp-view').forEach(v=>v.classList.add('hidden'));
        document.querySelector(target).classList.remove('hidden');
      });
    });

    // ---------- DASHBOARD (summary + charts) ----------
    async function loadSummary(){
      const res = await fetch(`${BASE}?action=summary`);
      const j = await res.json();
      if(!j.ok) return;

      // You reported these keys in your working response:
      // pendingOnboarding, activeAssociates, approvalsToday, walletInflow24,
      // earningsWeek, conversionRate, totalClicksWeek, updatedAt
      setText('kpiActiveUsers', j.activeAssociates ?? 0);
      setText('kpiConvRate', fmtPct(j.conversionRate ?? 0));
      setText('kpiClicks', (j.totalClicksWeek ?? 0).toLocaleString());
      setText('kpiUpdatedAt', 'Updated ' + fmtTime(j.updatedAt));

      // "Total Earnings" — your wallet totals come from walletmetrics.
      // We'll compute Net and show as Total Earnings on the home KPI to match your screenshots.
      try {
        const w = await (await fetch(`${BASE}?action=walletmetrics`)).json();
        if(w.ok){
          setText('kpiTotalEarnings', fmtMoney(w.net));
        }
      } catch {}
    }

    // Charts: daily earnings & traffic
    let dailyChart, trafficChart, perfChart, geoChart;
    function drawDashboardCharts(monthly={}, geo={}){
      // daily from monthly latest month if present; else zeros
      const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      const daily = [0,0,0,0,0,0,0];

      const gold = getComputedStyle(document.documentElement).getPropertyValue('--gold') || '#ffd166';

      if(dailyChart) dailyChart.destroy();
      dailyChart = new Chart(document.getElementById('dailyChart'),{
        type:'line',
        data:{labels, datasets:[{label:'Earnings', data:daily, borderColor:gold.trim(), tension:.35}]},
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>'$'+v}}}}
      });

      if(trafficChart) trafficChart.destroy();
      trafficChart = new Chart(document.getElementById('trafficChart'),{
        type:'doughnut',
        data:{labels:['Direct','Referral','Social','Organic'],
          datasets:[{data:[40,20,25,15]}]},
        options:{plugins:{legend:{position:'bottom'}}}
      });
    }

    // ---------- CPA ACCOUNTS ----------
    async function loadCpa(){
      const tbody = $('#cpaTable tbody');
      tbody.innerHTML = '';
      let out = '';
      try{
        const j = await (await fetch(`${BASE}?action=listCPAAccounts`)).json();
        if(j.ok && Array.isArray(j.items) && j.items.length){
          j.items.forEach(a=>{
            out += `<tr>
              <td>${a.name||a.account||'-'}</td>
              <td>${a.network||a.type||'-'}</td>
              <td>${statusChip(a.status)}</td>
              <td class="right">${(a.leads??0).toLocaleString()}</td>
              <td class="right">${fmtMoney(a.earnings??0)}</td>
            </tr>`;
          });
          $('#cpaHint').textContent = `Total: ${j.items.length} account(s).`;
        }else{
          out = `<tr><td colspan="5" class="muted">No CPA accounts.</td></tr>`;
          $('#cpaHint').textContent = 'Tip: Use “+ Add New Account” to register your Grip accounts.';
        }
      }catch(e){
        out = `<tr><td colspan="5" class="muted">Unable to load CPA accounts.</td></tr>`;
      }
      tbody.innerHTML = out;
    }

    // ---------- USERS ----------
    async function loadUsers(){
      const tbody = $('#userTable tbody');
      tbody.innerHTML = '';
      try{
        const j = await (await fetch(`${BASE}?action=usersOverview`)).json();
        if(j.ok){
          const total = j.total ?? 0;
          const active = j.active ?? 0;
          const earnings = j.totalEarnings ?? 0;
          $('#usersSummary').textContent = `Total Users: ${total} • Active: ${active} • Override Income: ${fmtMoney(earnings)}`;

          const rows = (j.items||[]).map(u=>`
            <tr>
              <td>${u.Name||u.username||'-'}</td>
              <td>${u.Email||'-'}</td>
              <td>${u.Phone||'-'}</td>
              <td>${u.Level||u.level||'—'}</td>
              <td>${statusChip(u.status||'confirmed')}</td>
              <td class="right">${fmtMoney(u.Earnings||u.earnings||0)}</td>
            </tr>`);
          tbody.innerHTML = rows.join('') || `<tr><td colspan="6" class="muted">No users found.</td></tr>`;
        }else{
          tbody.innerHTML = `<tr><td colspan="6" class="muted">Unable to load users.</td></tr>`;
        }
      }catch{
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Unable to load users.</td></tr>`;
      }
    }

    // ---------- ANALYTICS ----------
    async function loadAnalytics(){
      // Your 2 possible shapes observed:
      // A) { ok:true, monthly:{ "2025-08":123, "2025-09":456 }, geo:{ NG: 10, US: 5 }, latest:[{Date,...}] }
      // B) { ok:true, byStatus:{success,pending,failed}, todayIn:0 }
      // We’ll use (A) when present and still render even if empty.

      let j = {};
      try { j = await (await fetch(`${BASE}?action=analyticsOverview`)).json(); } catch {}

      // Monthly column chart
      const monthly = j.monthly || {};
      const mLabels = Object.keys(monthly);
      const mValues = mLabels.map(k=>Number(monthly[k]||0));
      const gold = getComputedStyle(document.documentElement).getPropertyValue('--gold') || '#ffd166';

      if(perfChart) perfChart.destroy();
      perfChart = new Chart(document.getElementById('perfChart'),{
        type:'bar',
        data:{labels:mLabels.length?mLabels:["No Data"],datasets:[{data:mValues.length?mValues:[0], backgroundColor:gold.trim()}]},
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>'$'+v}}}}
      });

      // Geo doughnut
      const geo = j.geo || {};
      const gLabels = Object.keys(geo);
      const gValues = gLabels.map(k=>Number(geo[k]||0));
      if(geoChart) geoChart.destroy();
      geoChart = new Chart(document.getElementById('geoChart'),{
        type:'doughnut',
        data:{labels:gLabels.length?gLabels:["—"],datasets:[{data:gValues.length?gValues:[1]}]},
        options:{plugins:{legend:{position:'bottom'}}}
      });

      // Latest table
      const tbody = $('#analyticsTable tbody');
      const latest = Array.isArray(j.latest)?j.latest:[];
      tbody.innerHTML = latest.map(r=>`
        <tr>
          <td>${fmtTime(r.Date||r.Time||r.t||'')}</td>
          <td class="right">${(r.Clicks||0).toLocaleString()}</td>
          <td class="right">${(r.Leads||0).toLocaleString()}</td>
          <td class="right">${fmtMoney(r.Earnings||r.Amount||0)}</td>
        </tr>`).join('') || `<tr><td colspan="4" class="muted">No recent analytics rows.</td></tr>`;
    }

    // ---------- WALLET ----------
    async function loadWallet(){
      try{
        const j = await (await fetch(`${BASE}?action=walletmetrics`)).json();
        if(!j.ok) return;
        setText('kpiInflow', fmtMoney(j.inflow||0));
        setText('kpiOutflow', fmtMoney(j.outflow||0));
        setText('kpiNet', fmtMoney(j.net||0));

        const tbody = $('#walletTable tbody');
        const rec = Array.isArray(j.recent)?j.recent:[];
        tbody.innerHTML = rec.map(r=>`
          <tr>
            <td>${fmtTime(r.Time)}</td>
            <td class="right">${fmtMoney(r.Amount)}</td>
            <td>${r.Method||'-'}</td>
            <td>${(r.Direction||'').toLowerCase()}</td>
            <td>${statusChip(r.Status)}</td>
            <td>${r.Name||''}</td>
            <td>${r.Email||''}</td>
            <td>${r.Phone||''}</td>
          </tr>
        `).join('');
      }catch(e){}
    }

    // ---------- SECURITY ----------
    async function loadSecurity(){
      try{
        const j = await (await fetch(`${BASE}?action=securityOverview`)).json();
        if(!j.ok) return;
        // Your sample carried errorCount and a "recent" array with mixed fields
        setText('secAlerts', j.errorCount ?? 0);
        setText('secFailed', j.failedLogins ?? 0);
        setText('secBlocks', j.blocks ?? 0);
        const ul = $('#securityList'); ul.innerHTML = '';
        (j.recent||[]).slice(0,25).forEach(x=>{
          const li = document.createElement('li');
          li.innerHTML = `<span class="muted">${fmtTime(x.Timestamp||x.time)}</span> — <b>${x.User||x.user||''}</b> <span class="muted">${x.Action||x.action||''}</span> <span class="muted">${x.Status||''}</span>`;
          ul.appendChild(li);
        });
      }catch(e){}
    }

    // ---------- MONITORING ----------
    async function loadMonitoring(){
      const tbody = $('#monitorTable tbody');
      tbody.innerHTML = '';
      try{
        const j = await (await fetch(`${BASE}?action=monitoringFeed`)).json();
        if(j.ok){
          const items = j.items || [];
          tbody.innerHTML = items.map(i=>`
            <tr>
              <td>${fmtTime(i.t||i.time)}</td>
              <td><span class="chip">${i.type||'event'}</span></td>
              <td>${i.msg||i.message||''}</td>
            </tr>
          `).join('') || `<tr><td colspan="3" class="muted">No activity.</td></tr>`;
        }else{
          tbody.innerHTML = `<tr><td colspan="3" class="muted">No activity.</td></tr>`;
        }
      }catch{
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Unable to load feed.</td></tr>`;
      }
    }

    // ---------- UTIL ----------
    function statusChip(s=''){
      const v = (s||'').toString().toLowerCase();
      let cls = 'chip';
      if(v.includes('success') || v.includes('confirmed') || v.includes('ok')) cls += ' success';
      else if(v.includes('fail') || v.includes('error')) cls += ' fail';
      else if(v.includes('pend')) cls += ' pending';
      return `<span class="${cls}">${s||'—'}</span>`;
    }

    // ---------- INIT ----------
    async function boot(){
      await loadSummary();
      drawDashboardCharts(); // base scaffolding
      await Promise.all([
        loadCpa(),
        loadUsers(),
        loadAnalytics(),
        loadWallet(),
        loadSecurity(),
        loadMonitoring(),
      ]);
    }
    boot();
  </script>
</body>
</html>