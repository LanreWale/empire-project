<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Empire — Dashboard</title>
  <meta name="color-scheme" content="dark"/>
  <!-- Brand styles you already have -->
  <link rel="stylesheet" href="/app/styles/brand.css"/>
  <style>
    /* layout bits just for this page */
    .shell{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .side{
      background:#0e182a;border-right:1px solid var(--emp-line);padding:20px 14px
    }
    .brand-box{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .brand-box img{width:36px;height:36px}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav a{
      display:block;padding:11px 12px;border-radius:12px;border:1px solid var(--emp-line);
      background:#0f182a;color:var(--emp-ink);text-decoration:none
    }
    .nav a.active{outline:2px solid var(--emp-ring)}
    .main{padding:28px 14px}
    .title{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .title .t{font-size:28px;font-weight:900;letter-spacing:.2px}
    .title .badge{border:1px solid var(--emp-line);border-radius:999px;padding:6px 10px;background:#0f182a;color:var(--emp-muted)}
    .cards{display:grid;gap:14px}
    @media(min-width:760px){.cards.cols-3{grid-template-columns:1fr 1fr 1fr}}
    @media(min-width:900px){.cards.cols-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--emp-panel);border:1px solid var(--emp-line);border-radius:16px;padding:16px}
    .card-title{color:var(--emp-muted);font-size:13px;margin-bottom:6px}
    .big{font-size:34px;font-weight:900}
    .mt{margin-top:10px}
    .tab-btn{padding:10px 16px;border-radius:14px;background:#0f182a;border:1px solid var(--emp-line);cursor:pointer}
    .tab-btn:hover{border-color:var(--emp-ring)}
    .tab-panel{background:rgba(15,24,42,.9);border:1px solid var(--emp-line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;align-items:center}
    .input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--emp-line);background:#0f182a;color:var(--emp-ink)}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--emp-line);text-align:left}
    .table th{color:#cfe0ff}
    .table-scroll{overflow:auto}
    .footer{opacity:.75;text-align:center;margin-top:28px;font-size:12px}
  </style>
</head>
<body class="brand-bg">
  <div class="shell">
    <!-- ============ SIDEBAR ============ -->
    <aside class="side">
      <div class="brand-box">
        <img src="/app/assets/brand/emblem.svg" alt="Empire"/>
        <div class="emp-title" style="font-size:20px">EMPIRE</div>
      </div>
      <nav class="nav" id="nav">
        <a href="#overview"  data-tab="overview"  class="active">Dashboard Overview</a>
        <a href="#accounts"  data-tab="accounts">CPA Accounts</a>
        <a href="#users"     data-tab="users">User Management</a>
        <a href="#analytics" data-tab="analytics">Performance Analytics</a>
        <a href="#wallet"    data-tab="wallet">Wallet</a>
        <a href="#security"  data-tab="security">Security & Monitoring</a>
      </nav>
    </aside>

    <!-- ============ MAIN ============ -->
    <main class="main">
      <div class="title">
        <img src="/app/assets/brand/emblem.svg" alt="E" width="28" height="28"/>
        <div class="t">Command Dashboard</div>
        <div class="badge">Live metrics • Accounts • Users • Analytics • Monitoring</div>
      </div>

      <!-- ===== OVERVIEW ===== -->
      <section id="tab-overview" class="tab-panel">
        <div class="cards cols-2">
          <div class="card">
            <div class="card-title">Total Earnings (USD)</div>
            <div id="kpi-earn" class="big">$0.00</div>
          </div>
          <div class="card">
            <div class="card-title">Active Users</div>
            <div id="kpi-active" class="big">0</div>
          </div>
          <div class="card">
            <div class="card-title">Approval Rate</div>
            <div id="kpi-approval" class="big">—</div>
          </div>
          <div class="card">
            <div class="card-title">Pending Reviews</div>
            <div id="kpi-pending" class="big">0</div>
          </div>
        </div>
        <div id="summary-note" class="muted mt">Loading…</div>
      </section>

      <!-- ===== CPA ACCOUNTS (placeholder UI) ===== -->
      <section id="tab-accounts" class="tab-panel" hidden>
        <div class="card-title">CPA Accounts Management</div>
        <div id="accounts-msg" class="muted mt">Coming online (uses your /users & sheets later).</div>
        <div class="mt">
          <div class="card-title">Add New CPA Account</div>
          <div class="cards cols-2">
            <input id="acc-name" class="input" placeholder="Account name"/>
            <input id="acc-domain" class="input" placeholder="Domain/URL (https://)"/>
            <input id="acc-userid" class="input" placeholder="User ID"/>
            <input id="acc-apikey" class="input" placeholder="API Key"/>
          </div>
          <button class="tab-btn mt" id="btn-add-acc">Add Account</button>
          <div id="add-acc-note" class="muted mt"></div>
        </div>
      </section>

      <!-- ===== USER MANAGEMENT (Admin approvals) ===== -->
      <section id="tab-users" class="tab-panel" hidden>
        <div class="emp-header" style="justify-content:space-between;align-items:center">
          <div>
            <div class="emp-title" style="font-size:22px">User Management</div>
            <div class="muted">Approve or reject new registrations and manage approved users.</div>
          </div>
          <div class="card" style="min-width:280px">
            <div class="card-title">Admin secret</div>
            <div class="row">
              <input id="admin-secret" type="password" class="input" placeholder="Enter admin secret"/>
              <button id="btn-save-secret" class="tab-btn">Save</button>
            </div>
            <div id="admin-secret-note" class="muted mt"></div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div class="card-title">Awaiting Approval</div>
            <button id="btn-load-pending" class="tab-btn">Load pending</button>
            <div id="pending-msg" class="muted"></div>
          </div>
          <div class="table-scroll mt">
            <table class="table" id="pending-table">
              <thead>
                <tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Telegram</th><th>Actions</th></tr>
              </thead>
              <tbody><tr><td class="muted" colspan="6">Click “Load pending”.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div class="card-title">Approved Users</div>
            <button id="btn-load-approved" class="tab-btn">Refresh</button>
            <div id="approved-msg" class="muted"></div>
          </div>
          <div class="table-scroll mt">
            <table class="table" id="approved-table">
              <thead>
                <tr><th>Name</th><th>Email</th><th>Phone</th><th>Scale</th><th>Status</th></tr>
              </thead>
              <tbody><tr><td class="muted" colspan="5">No data loaded yet.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Add Approved User</div>
          <div class="cards cols-2">
            <input id="add-name"  class="input" placeholder="Full name"/>
            <input id="add-email" class="input" placeholder="Email"/>
            <input id="add-phone" class="input" placeholder="Phone (+234…)"/>
            <input id="add-tele"  class="input" placeholder="Telegram @handle"/>
          </div>
          <button id="btn-add-user" class="tab-btn mt">Add User</button>
          <div id="add-user-msg" class="muted mt"></div>
        </div>
      </section>

      <!-- ===== ANALYTICS (placeholder; hook your charts later) ===== -->
      <section id="tab-analytics" class="tab-panel" hidden>
        <div class="card-title">Performance Analytics</div>
        <div class="muted">Daily / Weekly / Monthly summaries & projections will render here.</div>
      </section>

      <!-- ===== WALLET ===== -->
      <section id="tab-wallet" class="tab-panel" hidden>
        <div class="cards cols-3">
          <div class="card"><div class="card-title">Total Inflow (USD)</div><div id="w-inflow" class="big">$0.00</div></div>
          <div class="card"><div class="card-title">Total Outflow (USD)</div><div id="w-outflow" class="big">$0.00</div></div>
          <div class="card"><div class="card-title">Net (USD)</div><div id="w-net" class="big">$0.00</div></div>
        </div>
        <h3 class="mt">Recent Wallet Activity</h3>
        <div class="table-scroll">
          <table class="table" id="wallet-table">
            <thead><tr><th>Date</th><th>Amount (USD)</th><th>Method</th><th>Status</th></tr></thead>
            <tbody><tr><td class="muted" colspan="4">Loading…</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- ===== SECURITY ===== -->
      <section id="tab-security" class="tab-panel" hidden>
        <div class="card-title">System Security & Monitoring</div>
        <div id="health-json" class="muted">Loading…</div>
      </section>

      <div class="footer">© Empire Affiliate Marketing Hub</div>
    </main>
  </div>

  <script>
    // ---------- tabs
    const views = ['overview','accounts','users','analytics','wallet','security'];
    const panels = Object.fromEntries(views.map(v=>[v, document.getElementById('tab-'+v)]));
    const nav = document.getElementById('nav');
    function show(tab){
      views.forEach(v => { panels[v].hidden = (v!==tab); });
      nav.querySelectorAll('a').forEach(a=>a.classList.toggle('active', a.dataset.tab===tab));
      location.hash = '#'+tab;
      if (tab==='wallet') loadWallet();
      if (tab==='security') loadHealth();
    }
    nav.querySelectorAll('a').forEach(a=>a.addEventListener('click', e=>{
      e.preventDefault(); show(a.dataset.tab);
    }));
    show(location.hash.replace('#','')||'overview');

    // ---------- helpers
    const fmtUSD = n => {
      try { return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(+n||0); }
      catch { return '$'+(Number(n||0).toFixed(2)); }
    };
    const setText = (id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
    const escapeHtml = s => String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    async function fetchJSON(url){
      const r = await fetch(url, {headers:{'Cache-Control':'no-cache'}});
      if(!r.ok) throw new Error(r.status+' '+url);
      return r.json();
    }

    // ---------- Overview
    (async function loadSummary(){
      try{
        const s = await fetchJSON('/.netlify/functions/summary');
        setText('kpi-earn', fmtUSD(s.totalEarnings||0));
        setText('kpi-active', String(s.activeUsers??0));
        setText('kpi-approval', (s.approvalRate!=null)? (Math.round((s.approvalRate*100)||0)+'%') : '—');
        setText('kpi-pending', String(s.pendingReviews??0));
        setText('summary-note','Synced from Google Sheets.');
      }catch(e){
        setText('summary-note','Failed to load summary: '+e.message);
      }
    })();

    // ---------- Wallet
    async function loadWallet(){
      const body = document.querySelector('#wallet-table tbody');
      body.innerHTML = '<tr><td class="muted" colspan="4">Loading…</td></tr>';
      try{
        const w = await fetchJSON('/.netlify/functions/wallet?limit=50');
        setText('w-inflow', fmtUSD(w.inflow||0));
        setText('w-outflow', fmtUSD(w.outflow||0));
        setText('w-net', fmtUSD(w.net||0));
        const rows = (w.items||[]).map(i=>{
          const when = i.ts ? new Date(i.ts).toLocaleString() : '';
          return `<tr><td>${escapeHtml(when)}</td><td>${fmtUSD(i.amount||0)}</td><td>${escapeHtml(i.method||'')}</td><td>${escapeHtml(i.status||'')}</td></tr>`;
        });
        body.innerHTML = rows.length? rows.join('') : '<tr><td class="muted" colspan="4">No wallet entries.</td></tr>';
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="4">Failed to load wallet: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    // ---------- Health (security)
    async function loadHealth(){
      try{
        const h = await fetchJSON('/.netlify/functions/health');
        document.getElementById('health-json').textContent = JSON.stringify(h,null,2);
      }catch(e){
        document.getElementById('health-json').textContent = 'Failed: '+e.message;
      }
    }

    // ---------- Admin / approvals
    const ADMIN_FN = '/.netlify/functions/admin-pending';
    const admin = {
      get secret(){ return localStorage.getItem('EMP_ADMIN_SECRET') || ''; },
      set secret(v){ localStorage.setItem('EMP_ADMIN_SECRET', v || ''); }
    };
    const setNote = (id,msg)=>{ const e=document.getElementById(id); if(e) e.textContent = msg||''; };

    (function initAdminUI(){
      const inp = document.getElementById('admin-secret');
      if (inp){ inp.value = admin.secret; setNote('admin-secret-note', admin.secret ? 'Saved locally.' : 'Enter your admin secret and click Save.'); }
      const saveBtn = document.getElementById('btn-save-secret');
      if (saveBtn) saveBtn.addEventListener('click', ()=>{
        admin.secret = (document.getElementById('admin-secret').value||'').trim();
        setNote('admin-secret-note', admin.secret ? 'Saved locally.' : 'Cleared.');
      });
      const loadPending = document.getElementById('btn-load-pending');
      if (loadPending) loadPending.addEventListener('click', loadPendingRows);
      const loadApproved = document.getElementById('btn-load-approved');
      if (loadApproved) loadApproved.addEventListener('click', loadApprovedRows);
      const addUser = document.getElementById('btn-add-user');
      if (addUser) addUser.addEventListener('click', addApprovedUser);
    })();

    async function adminFetch(path='', opts={}){
      const headers = Object.assign({'Content-Type':'application/json','x-admin-secret': admin.secret}, opts.headers||{});
      const r = await fetch(ADMIN_FN + path, Object.assign({}, opts, { headers }));
      let data = null; try{ data = await r.json(); }catch{}
      if (!r.ok) throw new Error((data && (data.error||data.message)) || ''+r.status);
      return data;
    }

    function td(s){ return `<td>${escapeHtml(s ?? '')}</td>`; }
    function btn(label, cls){ return `<button class="tab-btn ${cls||''}" style="padding:6px 10px">${label}</button>`; }

    async function loadPendingRows(){
      setNote('pending-msg','Loading…');
      const body = document.querySelector('#pending-table tbody');
      body.innerHTML = `<tr><td class="muted" colspan="6">Loading…</td></tr>`;
      try{
        const res = await adminFetch('', { method:'GET' });
        if (!res.ok) throw new Error(res.error||'Failed');
        const items = res.items || [];
        if (!items.length){
          body.innerHTML = `<tr><td class="muted" colspan="6">No pending approvals.</td></tr>`;
        }else{
          body.innerHTML = items.map(row=>{
            const actions = `<div class="row">${btn('Approve','btn-approve')}${btn('Reject','btn-reject')}</div>`;
            return `<tr data-id="${escapeHtml(row.id||'')}" data-name="${escapeHtml(row.name||'')}" data-email="${escapeHtml(row.email||'')}" data-phone="${escapeHtml(row.phone||'')}" data-tele="${escapeHtml(row.telegram||row.tele||'')}">
                      ${td(row.id)}${td(row.name)}${td(row.email)}${td(row.phone)}${td(row.telegram||row.tele||'')}${td(actions)}
                    </tr>`;
          }).join('');
          body.querySelectorAll('.btn-approve').forEach(b=>b.addEventListener('click', ()=> markRow(b,'approved')));
          body.querySelectorAll('.btn-reject').forEach(b=>b.addEventListener('click', ()=> markRow(b,'dismissed')));
        }
        setNote('pending-msg','');
      }catch(e){
        setNote('pending-msg',`Error: ${e.message}${admin.secret?'':' (Set admin secret first.)'}`);
        body.innerHTML = `<tr><td class="muted" colspan="6">Failed to load.</td></tr>`;
      }
    }

    async function markRow(button, status){
      const tr = button.closest('tr');
      const id = tr?.dataset?.id || ''; if (!id) return;
      const name = tr?.dataset?.name || ''; const phone = tr?.dataset?.phone || '';
      const old = tr.innerHTML; tr.innerHTML = `<td colspan="6" class="muted">Processing ${escapeHtml(status)}…</td>`;
      try{
        const payload = { action:'mark', id, status, user:{ name, phone } };
        const res = await adminFetch('', { method:'POST', body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(res.error||'Failed');
        tr.remove(); loadApprovedRows();
      }catch(e){
        tr.innerHTML = old; alert('Action failed: '+e.message);
      }
    }

    async function loadApprovedRows(){
      setNote('approved-msg','Loading…');
      const body = document.querySelector('#approved-table tbody');
      body.innerHTML = `<tr><td class="muted" colspan="5">Loading…</td></tr>`;
      try{
        const r = await fetch('/.netlify/functions/users?status=approved',{headers:{'Cache-Control':'no-cache'}});
        const d = await r.json();
        const rows = (d.users||[]).map(u=>`<tr>${td(u.name)}${td(u.email)}${td(u.phone)}${td(u.scale||'')}${td(u.status||'approved')}</tr>`);
        body.innerHTML = rows.length? rows.join('') : `<tr><td class="muted" colspan="5">No approved users yet.</td></tr>`;
        setNote('approved-msg','');
      }catch(e){
        setNote('approved-msg','Could not load approved users.');
        body.innerHTML = `<tr><td class="muted" colspan="5">Failed.</td></tr>`;
      }
    }

    async function addApprovedUser(){
      setNote('add-user-msg','Submitting…');
      const name = document.getElementById('add-name').value.trim();
      const email= document.getElementById('add-email').value.trim();
      const phone= document.getElementById('add-phone').value.trim();
      const tele = document.getElementById('add-tele').value.trim();
      if(!name||!email){ setNote('add-user-msg','Name and email are required.'); return; }
      try{
        // Optional: if you add a handler for /create on the admin function
        const res = await adminFetch('/create', { method:'POST', body: JSON.stringify({action:'createApproved', user:{name,email,phone,telegram:tele}})});
        if(res.ok){ setNote('add-user-msg','User added.'); loadApprovedRows(); }
        else { setNote('add-user-msg', res.error || 'Create API not implemented yet.'); }
      }catch(e){ setNote('add-user-msg','Error: '+e.message); }
    }
  </script>
</body>
</html>