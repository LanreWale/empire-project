<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Empire ‚Äî Command Dashboard</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preload" href="/app/assets/brand/emblem.svg" as="image">
  <link rel="stylesheet" href="/app/styles/brand.css"/>
  <style>
    /* Minimal layout scaffolding; colors & visuals come from /app/styles/brand.css */
    :root{--nav-w:260px}
    body{margin:0}
    .shell{display:grid;grid-template-columns:var(--nav-w) 1fr;min-height:100vh}
    .side{
      padding:20px 14px;border-right:1px solid var(--emp-line);background:rgba(10,17,31,.6)
    }
    .brand-head{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .brand-head img{width:34px;height:34px}
    .brand-name{font-weight:900;letter-spacing:.3px}
    .menu{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .btn{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid var(--emp-line);background:#0f182a;color:var(--emp-ink);cursor:pointer}
    .btn.active{outline:2px solid var(--emp-ring)}
    .main{padding:22px 16px}
    .hidden{display:none}
    .cards{display:grid;gap:14px}
    @media(min-width:820px){.cards.cols-2{grid-template-columns:1fr 1fr}.cards.cols-3{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--emp-panel);border:1px solid var(--emp-line);border-radius:var(--radius);padding:14px}
    .card-title{color:var(--emp-muted);font-size:13px;margin-bottom:6px}
    .kpi{font-size:36px;font-weight:900}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--emp-line);text-align:left}
    .muted{color:var(--emp-muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{display:inline-block;border:1px solid var(--emp-line);border-radius:999px;padding:4px 10px;background:#0f182a}
    .hero{margin:0 0 14px}
    pre.log{white-space:pre-wrap;background:#0b162a;border:1px solid var(--emp-line);border-radius:12px;padding:12px}
  </style>
</head>
<body class="brand-bg">
  <div class="shell">
    <!-- LEFT NAV -->
    <aside class="side">
      <div class="brand-head">
        <img src="/app/assets/brand/emblem.svg" alt="Empire"/>
        <div>
          <div class="brand-name emp-title">EMPIRE HQ</div>
          <div class="muted" style="font-size:12px">Supreme Command</div>
        </div>
      </div>

      <div class="menu" id="menu">
        <button class="btn active" data-view="overview">üìä Overview</button>
        <button class="btn" data-view="cpa">üß© CPA Accounts</button>
        <button class="btn" data-view="users">üë• User Management</button>
        <button class="btn" data-view="analytics">üìà Performance Analytics</button>
        <button class="btn" data-view="wallet">üí≥ Wallet</button>
        <button class="btn" data-view="security">üõ°Ô∏è System Security</button>
        <button class="btn" data-view="monitor">üõ∞Ô∏è Monitoring & Alerts</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main emp-wrap">
      <div class="hero panel">
        <div class="row">
          <img src="/app/assets/brand/commander_badge.png" alt="Supreme Command" width="84" height="84" style="border-radius:12px;border:1px solid var(--emp-line)"/>
          <div>
            <div class="emp-title">Command Dashboard</div>
            <div class="muted">Live control of operations: offers, users, payouts, and system health.</div>
          </div>
        </div>
      </div>

      <!-- ===== OVERVIEW ===== -->
      <section id="view-overview">
        <div class="cards cols-3">
          <div class="card">
            <div class="card-title">Total Earnings (USD)</div>
            <div class="kpi" id="kpi-earn">$0.00</div>
          </div>
          <div class="card">
            <div class="card-title">Active Users</div>
            <div class="kpi" id="kpi-active">0</div>
          </div>
          <div class="card">
            <div class="card-title">Approval Rate</div>
            <div class="kpi" id="kpi-approval">‚Äî</div>
          </div>
        </div>

        <div class="cards cols-2" style="margin-top:12px">
          <div class="card">
            <div class="card-title">Pending Reviews</div>
            <div class="kpi" id="kpi-pending">0</div>
            <div class="muted" id="summary-note" style="margin-top:6px">Loading‚Ä¶</div>
          </div>
          <div class="card">
            <div class="card-title">System Health</div>
            <pre class="log" id="health-json">Loading‚Ä¶</pre>
          </div>
        </div>
      </section>

      <!-- ===== CPA ACCOUNTS ===== -->
      <section id="view-cpa" class="hidden">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">CPA Grip Accounts</h2>
          <button class="btn" id="btnAddCpa">‚ûï Add Account</button>
        </div>
        <div id="cpa-error" class="muted" style="margin:10px 0;display:none"></div>

        <div class="card" style="overflow:auto">
          <table class="table" id="cpa-table">
            <thead>
              <tr><th>Account</th><th>Today</th><th>Yesterday</th><th>7d</th><th>30d</th><th>EPC</th><th>CR</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ===== USERS ===== -->
      <section id="view-users" class="hidden">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">User Management</h2>
          <a class="btn" href="https://superlative-pothos-ebf5f2.netlify.app/?ref=SUPREME_COMMANDER" target="_blank" rel="noopener">‚úâÔ∏è Invite Link</a>
        </div>

        <div class="cards cols-2" style="margin-top:10px">
          <div class="card">
            <div class="card-title">Awaiting Approval</div>
            <div id="pending-note" class="muted">Loading‚Ä¶</div>
            <div style="overflow:auto;margin-top:8px">
              <table class="table" id="pending-table">
                <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Action</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Approved Users</div>
            <div style="overflow:auto">
              <table class="table" id="users-table">
                <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Scale</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== ANALYTICS ===== -->
      <section id="view-analytics" class="hidden">
        <h2>Performance Analytics</h2>
        <div id="analytics-note" class="muted">Connect to your metrics feed to populate charts.</div>
        <!-- Hook points for your chart lib; data comes from /summary & CPA feed -->
        <div class="cards cols-2" style="margin-top:8px">
          <div class="card">
            <div class="card-title">Monthly Earnings (Bar)</div>
            <div id="chart-monthly" style="height:240px"></div>
          </div>
          <div class="card">
            <div class="card-title">Geo Distribution (Pie)</div>
            <div id="chart-geo" style="height:240px"></div>
          </div>
        </div>
      </section>

      <!-- ===== WALLET ===== -->
      <section id="view-wallet" class="hidden">
        <h2>Payments / Wallet</h2>
        <div class="cards cols-3">
          <div class="card"><div class="card-title">Available Balance (USD)</div><div class="kpi" id="w-available">$0.00</div></div>
          <div class="card"><div class="card-title">Processing</div><div class="kpi" id="w-proc">$0.00</div></div>
          <div class="card"><div class="card-title">Withdrawals (Last 30d)</div><div class="kpi" id="w-out">$0.00</div></div>
        </div>

        <h3 style="margin:16px 0 8px">Recent Wallet Activity</h3>
        <div class="card" style="overflow:auto">
          <table class="table" id="wallet-table">
            <thead><tr><th>Date</th><th>Amount (USD)</th><th>Method</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ===== SECURITY ===== -->
      <section id="view-security" class="hidden">
        <h2>System Security</h2>
        <div class="card">
          <div class="card-title">Recommendations</div>
          <ul class="muted" style="margin:6px 0 0 18px;line-height:1.6">
            <li>Rotate all secrets quarterly (Netlify env + GAS keys).</li>
            <li>Lock down Apps Script to only the Netlify origin if feasible.</li>
            <li>Use role-based scopes for admin operations.</li>
          </ul>
        </div>
      </section>

      <!-- ===== MONITOR ===== -->
      <section id="view-monitor" class="hidden">
        <h2>Monitoring & Alerts</h2>
        <div class="card">
          <div class="card-title">Event Feed</div>
          <div class="muted" id="events-note">Loading‚Ä¶</div>
          <div style="overflow:auto;margin-top:8px">
            <table class="table" id="events-table">
              <thead><tr><th>When</th><th>Actor</th><th>Type</th><th>Message</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---------- TABS ----------
    const views = ["overview","cpa","users","analytics","wallet","security","monitor"];
    const menu = document.getElementById("menu");
    menu.querySelectorAll(".btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        menu.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const v = btn.dataset.view;
        views.forEach(id => {
          const el = document.getElementById("view-"+id);
          if (el) el.classList.toggle("hidden", id !== v);
        });
      });
    });

    // ---------- HELPERS ----------
    const $ = (id)=>document.getElementById(id);
    const fmtUSD = v => {
      try { return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(+v||0); }
      catch { return "$" + Number(v||0).toFixed(2); }
    };
    async function getJSON(url){
      const r = await fetch(url,{headers:{'Cache-Control':'no-cache'}});
      if(!r.ok) throw new Error(r.status+" "+url);
      return r.json();
    }

    // ---------- OVERVIEW + HEALTH ----------
    async function loadSummary(){
      try{
        const s = await getJSON("/.netlify/functions/summary");
        $("kpi-earn").textContent = fmtUSD(s.totalEarnings ?? s.earnings ?? 0);
        $("kpi-active").textContent = String(s.activeUsers ?? 0);
        $("kpi-approval").textContent = (s.approvalRate!=null) ? Math.round((s.approvalRate*100)||0)+"%" : "‚Äî";
        $("kpi-pending").textContent = String(s.pendingReviews ?? s.pending ?? 0);
        $("summary-note").textContent = "Synced from Google Sheets.";
      }catch(e){
        $("summary-note").textContent = "Summary error: "+e.message;
      }
    }
    async function loadHealth(){
      try{
        const h = await getJSON("/.netlify/functions/health");
        $("health-json").textContent = JSON.stringify(h,null,2);
      }catch(e){
        $("health-json").textContent = "Health error: "+e.message;
      }
    }

    // ---------- USERS (approved list) ----------
    async function loadUsers(){
      const body = $("#users-table tbody");
      body.innerHTML = '<tr><td class="muted" colspan="5">Loading‚Ä¶</td></tr>';
      try{
        const u = await getJSON("/.netlify/functions/users?limit=200");
        body.innerHTML = "";
        (u.users||[]).forEach(row=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(row.name)}</td>
            <td>${esc(row.email)}</td>
            <td>${esc(row.phone)}</td>
            <td><span class="chip">${esc(row.status||"")}</span></td>
            <td>${esc(row.scale||"")}</td>`;
          body.appendChild(tr);
        });
        if(!u.users || u.users.length===0){
          body.innerHTML = '<tr><td class="muted" colspan="5">No approved users.</td></tr>';
        }
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="5">Users error: ${esc(e.message)}</td></tr>`;
      }
    }

    // ---------- PENDING (via admin-pending GET) ----------
    async function loadPending(){
      const note = $("pending-note");
      const body = $("#pending-table tbody");
      note.textContent = "Loading‚Ä¶";
      body.innerHTML = "";
      try{
        const r = await fetch("/.netlify/functions/admin-pending",{headers:{ "x-admin-secret": localStorage.getItem("ADMIN_SECRET")||"" }});
        if(!r.ok){ note.textContent = "Unauthorized or error ("+r.status+")."; return; }
        const data = await r.json();
        if(!data.ok){ note.textContent = "Error: "+(data.error||""); return; }
        const items = data.items||[];
        note.textContent = items.length ? "" : "No pending approvals.";
        if(!items.length) return;
        items.forEach(it=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(it.name||"")}</td>
            <td>${esc(it.phone||"")}</td>
            <td>${esc(it.email||"")}</td>
            <td>
              <button class="btn" data-act="approve" data-id="${esc(it.id||"")}">Approve</button>
              <button class="btn" data-act="dismiss" data-id="${esc(it.id||"")}">Reject</button>
            </td>`;
          body.appendChild(tr);
        });
        body.querySelectorAll("button[data-act]").forEach(b=>{
          b.addEventListener("click", async ()=>{
            const id = b.dataset.id;
            const status = b.dataset.act === "approve" ? "approved" : "dismissed";
            b.disabled = true;
            try{
              const r2 = await fetch("/.netlify/functions/admin-pending",{
                method:"POST",
                headers:{
                  "Content-Type":"application/json",
                  "x-admin-secret": localStorage.getItem("ADMIN_SECRET")||""
                },
                body: JSON.stringify({ action:"mark", id, status })
              });
              const j = await r2.json();
              if(!r2.ok || !j.ok) alert("Action failed: "+(j.error||r2.status));
              else { b.textContent = "Done"; loadPending(); loadUsers(); }
            }catch(e){ alert("Action error: "+e.message); }
            finally{ b.disabled = false; }
          });
        });
      }catch(e){
        note.textContent = "Pending error: "+e.message;
      }
    }

    // ---------- EVENTS ----------
    async function loadEvents(){
      const body = $("#events-table tbody");
      const note = $("#events-note");
      note.textContent = "Loading‚Ä¶";
      body.innerHTML = "";
      try{
        const ev = await getJSON("/.netlify/functions/events?limit=100");
        const rows = ev.events||[];
        note.textContent = rows.length ? "" : "No events yet.";
        rows.forEach(x=>{
          const tr=document.createElement("tr");
          const when = x.ts ? new Date(x.ts).toLocaleString() : "";
          tr.innerHTML = `<td>${esc(when)}</td><td>${esc(x.actor||"")}</td><td>${esc(x.type||"")}</td><td>${esc(x.msg||"")}</td>`;
          body.appendChild(tr);
        });
      }catch(e){
        note.textContent = "Events error: "+e.message;
      }
    }

    // ---------- WALLET ----------
    async function loadWallet(){
      const body = $("#wallet-table tbody");
      body.innerHTML = '<tr><td class="muted" colspan="4">Loading‚Ä¶</td></tr>';
      try{
        const w = await getJSON("/.netlify/functions/wallet"); // {ok,inflow,outflow,net,items[]}
        $("#w-available").textContent = fmtUSD((w.net ?? 0) + (w.outflow ?? 0)); // rough: inflow - outflow => net; available ~ net
        $("#w-proc").textContent = fmtUSD(0); // hook for processing if your feed has it
        $("#w-out").textContent = fmtUSD(w.outflow ?? 0);
        body.innerHTML = "";
        (w.items||[]).forEach(row=>{
          const when = row.ts ? new Date(row.ts).toLocaleString() : "";
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${esc(when)}</td><td>${fmtUSD(row.amount||0)}</td><td>${esc(row.method||"")}</td><td>${esc(row.status||"")}</td>`;
          body.appendChild(tr);
        });
        if (!w.items || w.items.length===0){
          body.innerHTML = '<tr><td class="muted" colspan="4">No wallet activity.</td></tr>';
        }
      }catch(e){
        body.innerHTML = `<tr><td class="muted" colspan="4">Wallet error: ${esc(e.message)}</td></tr>`;
      }
    }

    // ---------- CPA ACCOUNTS ----------
    async function loadCpa(){
      const body = $("#cpa-table tbody");
      const err = $("#cpa-error");
      err.style.display = "none";
      body.innerHTML = '<tr><td class="muted" colspan="8">Loading‚Ä¶</td></tr>';
      try{
        const r = await fetch("/.netlify/functions/cpa",{headers:{'Cache-Control':'no-cache'}});
        if(r.status===404){
          err.textContent = "CPA endpoint not installed yet (/netlify/functions/cpa).";
          err.style.display = "block";
          body.innerHTML = '<tr><td class="muted" colspan="8">Add function to show accounts.</td></tr>';
          return;
        }
        if(!r.ok) throw new Error(r.status);
        const data = await r.json();
        const rows = data.accounts||data.items||[];
        body.innerHTML = "";
        rows.forEach(a=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(a.name||a.account||"")}</td>
            <td>${fmtUSD(a.today||0)}</td>
            <td>${fmtUSD(a.yesterday||0)}</td>
            <td>${fmtUSD(a.sevenDay||a.d7||0)}</td>
            <td>${fmtUSD(a.thirtyDay||a.d30||0)}</td>
            <td>${esc(a.epc||"-")}</td>
            <td>${esc(a.cr||"-")}</td>
            <td><span class="chip">${esc(a.status||"")}</span></td>
          `;
          body.appendChild(tr);
        });
        if(body.children.length===0){
          body.innerHTML = '<tr><td class="muted" colspan="8">No CPA accounts.</td></tr>';
        }
      }catch(e){
        err.textContent = "CPA error: "+e.message;
        err.style.display = "block";
      }
    }

    // ---------- UTIL ----------
    function esc(s){return String(s??"").replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

    // ---------- BOOT ----------
    loadSummary();
    loadHealth();
    loadUsers();
    loadPending();
    loadEvents();
    loadWallet();
    loadCpa();
  </script>
</body>
</html>