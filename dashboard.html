<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>THE EMPIRE — Supreme Command</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#0b1220; --panel:#111a2c; --panel2:#0e1729; --ink:#e9eefb;
  --muted:#9db0d5; --gold:#ffcc33; --ok:#2ecc71; --warn:#ffb020; --bad:#ff5a6b; --line:#21304b;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, #13203a 0%, var(--bg) 55%), var(--bg);color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
a{color:inherit}
.wrapper{display:grid; grid-template-columns:240px 1fr; min-height:100vh}
.aside{background:linear-gradient(#0f1527,#0a1120);border-right:1px solid #0f213a; padding:16px}
.brand{font-weight:800;letter-spacing:.5px;margin-bottom:10px}
.nav a{display:block;padding:10px 12px;border-radius:10px;color:var(--muted);text-decoration:none}
.nav a.active,.nav a:hover{background:#0d1930;color:var(--ink)}
.main{padding:18px}
.head{display:flex;gap:12px;align-items:center;margin-bottom:14px}
.badge{background:#0d1c33;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #143055}
.grid{display:grid;gap:16px}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:repeat(3,1fr)}
.card{background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);border:1px solid #0f213a;border-radius:16px;padding:16px;box-shadow:0 2px 0 #0a1427 inset}
h1{font-weight:800;margin:0}
h2{margin:0 0 10px;font-weight:700}
.kpi{display:flex;flex-direction:column;gap:4px}
.kpi .val{font-size:26px;font-weight:900;letter-spacing:.3px}
.kpi .muted{color:var(--muted);font-size:12px}
.row{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid #10213c;background:#0c1630}
.tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #1f2f55;background:#0b1935;margin-left:6px}
.tag-ok{border-color:#234d36;background:#0c291b;color:#bff2ce}
.tag-warn{border-color:#5a3b12;background:#2b1d0c;color:#ffd9a1}
.tag-bad{border-color:#5a1f28;background:#2b0d12;color:#ffb3bf}
.input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #203556;background:#0b1831;color:#e6eefc}
.btn{background:linear-gradient(180deg,#ffd366,#ffbf28); color:#1a1300;font-weight:800;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn-secondary{background:#0d1b34;border:1px solid #22385d;color:#d6e2fb;border-radius:10px;padding:10px 14px;cursor:pointer}
.flex{display:flex}.between{justify-content:space-between}.center{justify-content:center;align-items:center}
.ch{height:220px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #172744;text-align:left}
small{color:var(--muted)}
.hide{display:none}
footer{color:#6f86b3;margin-top:30px}
@media(max-width:1000px){.wrapper{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrapper">
  <aside class="aside">
    <div class="brand">THE EMPIRE</div>
    <nav class="nav">
      <a href="#dash" class="active">Dashboard</a>
      <a href="#cpa">CPA Accounts</a>
      <a href="#users">Users</a>
      <a href="#analytics">Analytics</a>
      <a href="#wallet">Payments/Wallet</a>
      <a href="#security">Security</a>
      <a href="#monitor">Monitoring</a>
      <a href="#logout">Logout</a>
    </nav>
    <footer>© 2025 The Empire</footer>
  </aside>

  <main class="main">
    <div class="head"><h1>Supreme Command Dashboard</h1><span class="badge" id="live-badge">Live</span></div>

    <!-- DASHBOARD -->
    <section id="dash" class="grid g3">
      <div class="card kpi"><div class="muted">Total Earnings</div><div class="val" id="kpi-earn">$0</div><small id="kpi-earn-upd"></small></div>
      <div class="card kpi"><div class="muted">Active Users</div><div class="val" id="kpi-users">0</div><small id="kpi-users-upd"></small></div>
      <div class="card kpi"><div class="muted">Conversion Rate</div><div class="val" id="kpi-cr">0.00%</div><small>Industry leading</small></div>

      <div class="card">
        <h2>Daily Earnings</h2>
        <canvas id="ch-earn" class="ch"></canvas>
      </div>
      <div class="card">
        <h2>Traffic Sources</h2>
        <canvas id="ch-traffic" class="ch"></canvas>
      </div>
      <div class="card kpi"><div class="muted">Total Clicks</div><div class="val" id="kpi-clicks">0</div><small>Daily average</small></div>
    </section>

    <!-- CPA ACCOUNTS -->
    <section id="cpa" class="hide">
      <div class="flex between"><h2>CPA Accounts Management</h2><button class="btn" onclick="openCPA()">+ Add New Account</button></div>
      <div id="cpa-list" class="grid g3" style="margin-top:12px"></div>
    </section>

    <!-- USERS -->
    <section id="users" class="hide">
      <div class="flex between"><h2>Users Management</h2><button class="btn" onclick="openUser()">+ Add New User</button></div>
      <div class="card" style="margin-top:12px">
        <div class="flex" style="gap:20px;margin-bottom:6px">
          <div>Total Users: <b id="u-total">0</b></div>
          <div>Active: <b id="u-active">0</b></div>
          <div>Override Income: <b id="u-earn">$0</b></div>
        </div>
        <div id="u-bylevel" class="flex" style="gap:8px;flex-wrap:wrap"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <table>
          <thead><tr><th>Username</th><th>Email</th><th>Phone</th><th>Level</th><th>Authority</th><th>Status</th><th class="right">Earnings</th></tr></thead>
          <tbody id="u-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analytics" class="hide">
      <h2>Analytics & Reports</h2>
      <div class="grid g2">
        <div class="card"><h3>Performance Overview (Monthly)</h3><canvas id="ch-month" class="ch"></canvas></div>
        <div class="card"><h3>Geographic Distribution</h3><canvas id="ch-geo" class="ch"></canvas></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Live Performance Data</h3>
        <div id="an-live"></div>
      </div>
    </section>

    <!-- WALLET -->
    <section id="wallet" class="hide">
      <h2>Universal Withdrawal & History</h2>
      <div class="grid g2">
        <div class="card">
          <div class="grid g2">
            <input id="wd-amount" class="input" placeholder="Amount (USD)" type="number" min="20">
            <select id="wd-category" class="input">
              <option>Traditional Banks</option><option>Wallets</option><option>Crypto</option>
            </select>
            <input id="wd-country" class="input" placeholder="Country/Region">
            <input id="wd-method"  class="input" placeholder="Payment Method (e.g., Polaris Bank)">
            <input id="wd-accno"   class="input" placeholder="Account Number">
            <input id="wd-accname" class="input" placeholder="Account Holder Name">
          </div>
          <div style="margin-top:10px"><button class="btn" onclick="submitWithdrawal()">Request Withdrawal</button></div>
          <small id="wd-msg"></small>
        </div>
        <div class="card">
          <div class="flex between"><h3>Transaction History & Status</h3><small id="wallet-net"></small></div>
          <div id="wd-list" style="max-height:380px;overflow:auto"></div>
        </div>
      </div>
    </section>

    <!-- SECURITY -->
    <section id="security" class="hide">
      <h2>Security Overview</h2>
      <div class="grid g3">
        <div class="card kpi"><div class="muted">Alerts (24h)</div><div class="val" id="sec-alerts">0</div></div>
        <div class="card kpi"><div class="muted">Failed Logins</div><div class="val" id="sec-failed">0</div></div>
        <div class="card kpi"><div class="muted">Blocks</div><div class="val" id="sec-blocks">0</div></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Recent Security Activity</h3>
        <div id="sec-list"></div>
      </div>
    </section>

    <!-- MONITORING -->
    <section id="monitor" class="hide">
      <h2>System Monitoring</h2>
      <div id="mon-list" class="card"></div>
    </section>

    <!-- MODALS -->
    <div id="modal-cpa" class="hide" style="position:fixed;inset:0;background:#0008" onclick="closeCPA(event)">
      <div class="card" style="max-width:420px;margin:8% auto" onclick="event.stopPropagation()">
        <h3>Add New CPA Account</h3>
        <div class="grid g2" style="margin-top:10px">
          <input id="cpa-name" class="input" placeholder="Account Name">
          <input id="cpa-network" class="input" placeholder="Network">
          <input id="cpa-id" class="input" placeholder="Account ID">
          <input id="cpa-key" class="input" placeholder="API Key">
        </div>
        <div class="flex" style="gap:8px;margin-top:10px;justify-content:flex-end">
          <button class="btn-secondary" onclick="hide('modal-cpa')">Cancel</button>
          <button class="btn" onclick="submitCPA()">Add Account</button>
        </div>
        <small id="cpa-msg"></small>
      </div>
    </div>

    <div id="modal-user" class="hide" style="position:fixed;inset:0;background:#0008" onclick="closeUser(event)">
      <div class="card" style="max-width:480px;margin:8% auto" onclick="event.stopPropagation()">
        <h3>Add New User</h3>
        <div class="grid g2" style="margin-top:10px">
          <input id="u-name" class="input" placeholder="Username">
          <input id="u-email" class="input" placeholder="Email">
          <input id="u-phone" class="input" placeholder="WhatsApp Number">
          <input id="u-level" class="input" placeholder="Level (1-5)" value="1">
          <input id="u-auth" class="input" placeholder="Authority (e.g., 1x)" value="1x">
        </div>
        <div class="flex" style="gap:8px;margin-top:10px;justify-content:flex-end">
          <button class="btn-secondary" onclick="hide('modal-user')">Cancel</button>
          <button class="btn" onclick="submitUser()">Add User</button>
        </div>
        <small id="user-msg"></small>
      </div>
    </div>

  </main>
</div>

<script>
/* ====== CONFIG ====== */
const GAS_BASE = 'https://script.google.com/macros/s/AKfycbysJmVXlrOE1_J3uw5wMqs9cnKtj-uuoxj0Mmj8JWTj7eZMvp9XJYXrs-0leocNXI6w/exec';
const PASS     = 'GENERALISIMO@2025';

/* ====== SMALL UTILS ====== */
const $ = sel => document.querySelector(sel);
const fmtMoney = n => '$'+Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
const fmtNum   = n => Number(n||0).toLocaleString();
const fmtTime  = t => new Date(t).toLocaleString();
function show(id){ $('#'+id).classList.remove('hide'); }
function hide(id){ $('#'+id).classList.add('hide'); }
function esc(s){return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
async function api(action, params={}){
  const qs = new URLSearchParams({action, pass:PASS, ...params});
  const r = await fetch(GAS_BASE+'?'+qs,{cache:'no-store'});
  return r.json();
}
async function post(action, body={}){
  const form = new URLSearchParams({action, pass:PASS, ...body});
  const r = await fetch(GAS_BASE,{method:'POST', body:form});
  return r.json();
}

/* ====== NAV ====== */
document.querySelectorAll('.nav a').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('main > section').forEach(s=>s.classList.add('hide'));
    const id = a.getAttribute('href').slice(1);
    show(id);
    // lazy load
    if(id==='cpa') loadCPA();
    else if(id==='users') loadUsers();
    else if(id==='analytics') loadAnalytics();
    else if(id==='wallet') loadWallet();
    else if(id==='security') loadSecurity();
    else if(id==='monitor') loadMonitor();
  });
});

/* ====== DASHBOARD ====== */
async function loadDash(){
  const cm = await api('commanderMetrics'); // total earnings, active users, CR, clicks
  $('#kpi-earn').textContent = fmtMoney(cm.earningsTotal||0);
  $('#kpi-users').textContent = fmtNum(cm.activeUsers||0);
  $('#kpi-cr').textContent    = (Number(cm.conversionRate||0).toFixed(2))+'%';
  $('#kpi-clicks').textContent= fmtNum(cm.totalClicksWeek||0);
  $('#kpi-earn-upd').textContent  = 'Updated '+new Date().toLocaleString();
  $('#kpi-users-upd').textContent = '+ last sync '+new Date().toLocaleString();

  // charts (simple)
  drawLine('#ch-earn',['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],[800,1200,2400,4800,2300,3400,4100]);
  drawDonut('#ch-traffic',['Direct','Social','Email','Referral'],[35,25,20,20]);
}

/* ====== CPA ====== */
function openCPA(){ show('modal-cpa'); $('#cpa-msg').textContent=''; }
function closeCPA(e){ if(e && e.target.id!=='modal-cpa')return; hide('modal-cpa'); }
async function submitCPA(){
  const p = { name:$('#cpa-name').value.trim(), network:$('#cpa-network').value.trim(),
              accountId:$('#cpa-id').value.trim(), apiKey:$('#cpa-key').value.trim() };
  const r = await post('addCPAAccount', p);
  $('#cpa-msg').textContent = r.ok? 'Account added.' : ('Error: '+(r.error||''));
  if(r.ok){ hide('modal-cpa'); loadCPA(); }
}
async function loadCPA(){
  const data = await api('listCPAAccounts');
  const box = $('#cpa-list'); box.innerHTML='';
  if(!data?.items?.length){ box.innerHTML='<div class="card">No CPA accounts.</div>'; return; }
  data.items.forEach(a=>{
    const d = document.createElement('div');
    d.className='card';
    d.innerHTML = `
      <div class="flex between"><div><b>${esc(a.name)}</b> <span class="tag">${esc(a.status||'ACTIVE')}</span></div><small>${esc(a.network)}</small></div>
      <div class="grid g2" style="margin-top:8px">
        <div>Active Offers<br><b>${fmtNum(a.activeOffers)}</b></div>
        <div>Revenue<br><b>${fmtMoney(a.revenue)}</b></div>
        <div>Clicks<br><b>${fmtNum(a.clicks)}</b></div>
        <div>Conversion<br><b>${(Number(a.conversion)||0).toFixed(1)}%</b></div>
      </div>
      <small>ID: ${esc(a.accountId)} · Key: ${esc(a.apiKeyMasked||'••••')}</small>`;
    box.appendChild(d);
  });
}

/* ====== USERS ====== */
function openUser(){ show('modal-user'); $('#user-msg').textContent=''; }
function closeUser(e){ if(e && e.target.id!=='modal-user')return; hide('modal-user'); }
async function submitUser(){
  const p = { username:$('#u-name').value.trim(), email:$('#u-email').value.trim(), phone:$('#u-phone').value.trim(),
              level:$('#u-level').value.trim(), authority:$('#u-auth').value.trim() };
  const r = await post('addUser', p);
  $('#user-msg').textContent = r.ok? 'User added.' : ('Error: '+(r.error||'')); 
  if(r.ok){ hide('modal-user'); loadUsers(); }
}
async function loadUsers(){
  const u = await api('usersOverview');
  $('#u-total').textContent  = fmtNum(u.total||0);
  $('#u-active').textContent = fmtNum(u.active||0);
  $('#u-earn').textContent   = fmtMoney(u.totalEarnings||0);
  const box = $('#u-bylevel'); box.innerHTML='';
  Object.keys(u.byLevel||{}).sort().forEach(k=>{
    const s=document.createElement('span'); s.className='badge'; s.textContent=`Level ${k}: ${u.byLevel[k]}`;
    box.appendChild(s);
  });
  const tb = $('#u-tbody'); tb.innerHTML='';
  (u.items||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(x.username)}</td><td>${esc(x.email)}</td><td>${esc(x.phone||'')}</td>
      <td>${esc(x.level||'')}</td><td>${esc(x.authority||'')}</td><td>${esc(x.status||'')}</td>
      <td style="text-align:right">${fmtMoney(x.earnings||0)}</td>`;
    tb.appendChild(tr);
  });
}

/* ====== ANALYTICS ====== */
async function loadAnalytics(){
  const an = await api('analyticsOverview');
  const months = Object.keys(an.monthly||{}).sort();
  drawBar('#ch-month', months, months.map(m=>Number(an.monthly[m]||0)));
  const geok = Object.keys(an.geo||{}); drawDonut('#ch-geo', geok, geok.map(k=>Number(an.geo[k]||0)));
  const live = $('#an-live'); live.innerHTML='';
  (an.latest||[]).forEach(r=>{
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `<div style="width:180px">${fmtTime(r.time)}</div>
      <div style="width:100px">${esc(r.country||'')}</div>
      <div style="width:140px">${esc(r.offer||'')}</div>
      <div style="width:90px">${esc(r.device||'')}</div>
      <div style="width:80px;text-align:right">${fmtNum(r.clicks||0)}</div>
      <div style="width:80px;text-align:right">${fmtNum(r.leads||0)}</div>
      <div style="width:120px;text-align:right">${fmtMoney(r.earnings||0)}</div>`;
    live.appendChild(row);
  });
}

/* ====== WALLET ====== */
async function loadWallet(){
  const w = await api('walletoverview');
  $('#wallet-net').textContent = `Inflow: ${fmtMoney(w.inflow||0)} · Outflow: ${fmtMoney(w.outflow||0)} · Net: ${fmtMoney(w.net||0)}`;
  const box = $('#wd-list'); box.innerHTML='';
  (w.recent||[]).forEach(t=>{
    const el=document.createElement('div'); el.className='row';
    const tag = String(t.Status||'').toLowerCase().startsWith('succ')?'tag-ok':
                (String(t.Status||'').toLowerCase().startsWith('pend')?'tag-warn':'tag-bad');
    el.innerHTML = `<div style="width:180px">${fmtTime(t.Time)}</div>
    <div style="width:90px;text-align:right">${fmtMoney(t.Amount)}</div>
    <div style="width:120px">${esc(t.Method||'')}</div>
    <div style="width:120px">${esc(t.Direction||'')}</div>
    <div style="width:120px"><span class="tag ${tag}">${esc(t.Status||'')}</span></div>
    <div style="flex:1;text-align:right">${esc(t.Email||'')}</div>`;
    box.appendChild(el);
  });
}
async function submitWithdrawal(){
  const p = {
    amount:$('#wd-amount').value, category:$('#wd-category').value, country:$('#wd-country').value,
    method:$('#wd-method').value, accountNumber:$('#wd-accno').value, accountName:$('#wd-accname').value
  };
  const r = await post('requestWithdrawal', p);
  $('#wd-msg').textContent = r.ok ? `Submitted. Ref ${r.ref} (${r.status})` : ('Error: '+(r.error||'')); 
  if(r.ok) loadWallet();
}

/* ====== SECURITY ====== */
async function loadSecurity(){
  const s = await api('securityOverview');
  $('#sec-alerts').textContent = fmtNum(s.alerts24h||0);
  $('#sec-failed').textContent = fmtNum(s.failedLogins||0);
  $('#sec-blocks').textContent = fmtNum(s.blocks||0);
  const box = $('#sec-list'); box.innerHTML='';
  (s.items||[]).forEach(i=>{
    const el=document.createElement('div'); el.className='row';
    el.innerHTML = `<div style="width:180px">${fmtTime(i.time)}</div>
      <div style="width:120px">${esc(i.user||'')}</div>
      <div style="width:160px">${esc(i.action||'')}</div>
      <div style="width:200px">${esc(i.status||'')}</div>
      <div style="flex:1">${esc(i.details||'')}</div>`;
    box.appendChild(el);
  });
}

/* ====== MONITORING ====== */
async function loadMonitor(){
  const m = await api('monitoringFeed');
  const box = $('#mon-list'); box.innerHTML='';
  (m.items||[]).forEach(it=>{
    const el=document.createElement('div'); el.className='row';
    el.innerHTML = `<div style="width:180px">${fmtTime(it.t)}</div>
    <div class="badge">${esc(it.type)}</div>
    <div style="flex:1">${esc(it.msg)}</div>`;
    box.appendChild(el);
  });
}

/* ====== Tiny chart helpers (canvas, no deps) ====== */
function drawLine(sel, labels, data){
  const c=$(sel); const ctx=c.getContext('2d'); c.width=c.clientWidth; c.height=c.clientHeight;
  ctx.clearRect(0,0,c.width,c.height);
  const p=10, left=40, bottom=22, top=10, right=10;
  const W=c.width-left-right, H=c.height-top-bottom;
  const max=Math.max(1, ...data); ctx.strokeStyle='#ffd36a'; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((v,i)=>{
    const x = left + (W*(i/(data.length-1||1)));
    const y = top + H - (H*(v/max));
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }); ctx.stroke();
  ctx.fillStyle='#9db0d5'; ctx.font='12px system-ui';
  labels.forEach((t,i)=>{ const x=left + (W*(i/(labels.length-1||1))); ctx.fillText(t, x-8, c.height-4); });
}
function drawDonut(sel, labels, data){
  const c=$(sel), ctx=c.getContext('2d'); c.width=c.clientWidth; c.height=c.clientHeight;
  ctx.clearRect(0,0,c.width,c.height);
  const total=data.reduce((a,b)=>a+Number(b||0),0)||1;
  let a0=-Math.PI/2; const cx=c.width/2, cy=c.height/2, r=Math.min(cx,cy)-10, ir=r*0.58;
  data.forEach((v,i)=>{
    const a1 = a0 + (2*Math.PI*(v/total));
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath();
    ctx.fillStyle=`hsl(${(i*68)%360} 80% 50%)`; ctx.fill();
    a0=a1;
  });
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(cx,cy,ir,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over';
}
function drawBar(sel, labels, data){
  const c=$(sel), ctx=c.getContext('2d'); c.width=c.clientWidth; c.height=c.clientHeight;
  const max=Math.max(1,...data); const left=40, bottom=22, W=c.width-left-10, H=c.height-10-bottom, bw=W/(data.length||1)*0.7;
  ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#ffd36a';
  data.forEach((v,i)=>{ const h=H*(v/max), x=left + i*(W/(data.length||1)) + ((W/(data.length||1))-bw)/2, y=10 + H - h; ctx.fillRect(x,y,bw,h); });
  ctx.fillStyle='#9db0d5'; ctx.font='12px system-ui';
  labels.forEach((t,i)=>{ const x=left+i*(W/(labels.length||1)); ctx.fillText(t, x, c.height-4); });
}

/* ====== BOOT ====== */
(async function(){
  await loadDash();
  // Default tab: dash already visible. Others lazy loaded by nav clicks.
})();
</script>
</body>
</html>