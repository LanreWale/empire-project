<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THE EMPIRE â€¢ Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0e2233;--panel:#0f2538;--muted:#7c97b5;--text:#eaf2ff;--accent:#ffd559;--line:#183249;--good:#1dd1a1;--warn:#ffb142;--bad:#ff6b6b;--r:14px}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;color:var(--text);background:#0d1a27}
  .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh;background:
    radial-gradient(1100px 1100px at 120% -10%, #163b5c 0%, transparent 60%),
    radial-gradient(900px 900px at -10% 120%, #0c2338 0%, transparent 60%),var(--bg)}
  aside{background:#0c1c2b;border-right:1px solid #132c42;padding:14px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px;margin:8px 0 18px}
  nav a{display:block;padding:10px 12px;border-radius:10px;color:#d9e7ff;text-decoration:none;margin:4px 0}
  nav a.active,nav a:hover{background:#122a40}
  main{padding:18px 22px}
  .grid{display:grid;gap:14px}
  .kpis{grid-template-columns:repeat(4,minmax(220px,1fr))}
  .two{grid-template-columns:1fr 1fr}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);box-shadow:0 6px 24px rgba(0,0,0,.22)}
  .panel h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px}
  .panel .pad{padding:14px 16px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px 12px;border-bottom:1px solid #15334a}
  thead th{background:#0f2b45;text-align:left;color:#cfe2ff}
  .knum{font-size:22px;font-weight:800}
  .muted{color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#103250;border:1px solid var(--line);font-size:12px}
  .chart{min-height:220px}
  .hidden{display:none}
  .toast{position:fixed;top:14px;right:14px;background:#0e2236;border:1px solid #24445e;padding:10px 12px;border-radius:10px;z-index:11;max-width:80vw}
</style>
</head>
<body>
<div class="app">
  <aside>
    <div class="brand">ðŸ‘‘ THE EMPIRE</div>
    <nav id="nav">
      <a href="#dashboard" data-route="dashboard" class="active">Dashboard</a>
      <a href="#cpa" data-route="cpa">CPA Accounts</a>
      <a href="#users" data-route="users">Users</a>
      <a href="#analytics" data-route="analytics">Analytics</a>
      <a href="#wallet" data-route="wallet">Payments/Wallet</a>
      <a href="#monitoring" data-route="monitoring">Monitoring</a>
      <a href="#settings" data-route="settings">Settings</a>
    </nav>
  </aside>

  <main>
    <!-- DASHBOARD -->
    <section id="route-dashboard" class="route">
      <div class="grid kpis">
        <div class="panel"><h3>Total Earnings</h3><div class="pad"><div id="kpi-earnings" class="knum">$0.00</div><div class="muted">vs last 7d</div></div></div>
        <div class="panel"><h3>Total Clicks</h3><div class="pad"><div id="kpi-clicks" class="knum">0</div><div class="muted">daily average</div></div></div>
        <div class="panel"><h3>Leads</h3><div class="pad"><div id="kpi-leads" class="knum">0</div></div></div>
        <div class="panel"><h3>Conversion Rate</h3><div class="pad"><div id="kpi-conv" class="knum">0%</div><div class="muted">industry leading</div></div></div>
      </div>

      <div class="grid two" style="margin-top:14px">
        <div class="panel"><h3>Daily Earnings</h3><div class="pad"><div id="dash-earnings" class="chart"></div></div></div>
        <div class="panel"><h3>Traffic Sources</h3><div class="pad"><div id="dash-sources" class="chart"></div></div></div>
      </div>

      <div class="panel" style="margin-top:14px">
        <h3>By Geo (Top)</h3>
        <div class="pad">
          <table>
            <thead><tr><th>Country</th><th>Clicks</th><th>Leads</th><th>Earnings ($)</th></tr></thead>
            <tbody id="geo-table"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CPA -->
    <section id="route-cpa" class="route hidden">
      <div class="grid two" id="cpa-grid"></div>
    </section>

    <!-- USERS -->
    <section id="route-users" class="route hidden">
      <div class="panel">
        <h3>Users Management</h3>
        <div class="pad">
          <table>
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Authority</th><th>Status</th></tr></thead>
            <tbody id="users-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="route-analytics" class="route hidden">
      <div class="grid two">
        <div class="panel"><h3>Performance Overview</h3><div class="pad"><div id="ana-overview" class="chart"></div></div></div>
        <div class="panel"><h3>Geographic Distribution</h3><div class="pad"><div id="ana-geo-dist" class="chart"></div></div></div>
      </div>
      <div class="panel" style="margin-top:14px">
        <h3>Live Performance Data (last 2 min)</h3>
        <div class="pad"><table><thead><tr><th>Time</th><th>Country</th><th>Offer</th><th>Device</th><th>Clicks</th><th>Conv</th><th>Earnings</th></tr></thead><tbody id="ana-live"></tbody></table></div>
      </div>
    </section>

    <!-- WALLET -->
    <section id="route-wallet" class="route hidden">
      <div class="grid two">
        <div class="panel"><h3>Balance</h3><div class="pad"><div id="wallet-balance" class="knum">$0.00</div></div></div>
        <div class="panel"><h3>Request Withdrawal</h3><div class="pad">Use back-office to submit payouts.</div></div>
      </div>
      <div class="panel" style="margin-top:14px">
        <h3>Transaction History</h3>
        <div class="pad"><table><thead><tr><th>Date</th><th>Method</th><th>Amount ($)</th><th>Status</th></tr></thead><tbody id="wallet-history"></tbody></table></div>
      </div>
    </section>

    <!-- MONITORING -->
    <section id="route-monitoring" class="route hidden">
      <div class="grid two">
        <div class="panel"><h3>System Health</h3><div class="pad"><div>Health: <strong id="mon-health">â€”</strong></div><div>Maintenance: <strong id="mon-maint">â€”</strong></div></div></div>
        <div class="panel"><h3>Service Status</h3><div class="pad">See backend dashboard for per-service metrics.</div></div>
      </div>
      <div class="panel" style="margin-top:14px">
        <h3>Events Stream</h3>
        <div class="pad"><table><thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead><tbody id="mon-events"></tbody></table></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="route-settings" class="route hidden">
      <div class="panel"><h3>Live Config</h3><div class="pad"><pre id="cfg-json" style="white-space:pre-wrap;margin:0"></pre></div></div>
    </section>
  </main>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* ===== Helpers ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbyCjLNnMm0yQZeQ2PUn-zvNkWbp8vTpw-kZEu_zup6NiMW-ScR_cYwj59b4i09MgrdV/exec";
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"), 4000); }

/* Basic charts (SVG, no libs) */
const THEME={accent:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#ffd559', axis:getComputedStyle(document.documentElement).getPropertyValue('--line').trim()||'#183249', label:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#7c97b5'};
function svgEl(tag){return document.createElementNS('http://www.w3.org/2000/svg',tag)}
function renderBarChart(el,series,labels){
  const host = (typeof el==='string')?$(el):el; if(!host) return;
  host.innerHTML=''; const W=host.clientWidth||340,H=220,p=28,max=Math.max(...series,1),bw=(W-p*2)/series.length,svg=svgEl('svg'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  const axis=svgEl('line'); axis.setAttribute('x1',p);axis.setAttribute('y1',H-p);axis.setAttribute('x2',W-p);axis.setAttribute('y2',H-p);axis.setAttribute('stroke',THEME.axis);axis.setAttribute('stroke-width','1'); svg.appendChild(axis);
  series.forEach((v,i)=>{ const h=(v/max)*(H-p*2),x=p+i*bw+6,y=(H-p)-h,rect=svgEl('rect'); rect.setAttribute('x',x);rect.setAttribute('y',y);rect.setAttribute('width',Math.max(8,bw-12));rect.setAttribute('height',Math.max(0,h));rect.setAttribute('rx','6');rect.setAttribute('fill',THEME.accent); svg.appendChild(rect);
    if(labels && labels[i]){ const tx=svgEl('text'); tx.setAttribute('x',x+(bw-12)/2); tx.setAttribute('y',H-p+14); tx.setAttribute('text-anchor','middle'); tx.setAttribute('font-size','10'); tx.setAttribute('fill',THEME.label); tx.textContent=labels[i]; svg.appendChild(tx); }
  });
  host.appendChild(svg);
}
function renderPieChart(el,map){
  const host=(typeof el==='string')?$(el):el; if(!host) return;
  host.innerHTML=''; const entries=Object.entries(map||{}).filter(([,v])=>+v>0); if(!entries.length){ host.textContent='No data'; return; }
  const W=220,H=220,R=90,CX=W/2,CY=H/2,total=entries.reduce((s,[,v])=>s+Number(v),0); let a=-Math.PI/2; const svg=svgEl('svg'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  entries.forEach(([,v],i)=>{ const theta=(v/total)*Math.PI*2, x1=CX+R*Math.cos(a), y1=CY+R*Math.sin(a), x2=CX+R*Math.cos(a+theta), y2=CY+R*Math.sin(a+theta), p=svgEl('path');
    p.setAttribute('d',`M ${CX} ${CY} L ${x1} ${y1} A ${R} ${R} 0 ${theta>Math.PI?1:0} 1 ${x2} ${y2} Z`); p.setAttribute('fill',THEME.accent); p.setAttribute('opacity',0.6+0.3*((i%3)/3)); svg.appendChild(p); a+=theta; });
  host.appendChild(svg);
}

/* ===== API ===== */
async function api(action){
  const url = API_URL + "?action=" + encodeURIComponent(action);
  const res = await fetch(url, {mode:"cors", cache:"no-cache"});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ===== Loaders ===== */
async function loadOverview(){
  const data = await api("overview");
  // KPIs
  $("#kpi-earnings").textContent = data.totalsPretty?.earningsUsd ?? `$${Number(data.totals?.earnings||0).toLocaleString()}`;
  $("#kpi-clicks").textContent   = (data.totals?.clicks ?? 0).toLocaleString();
  $("#kpi-leads").textContent    = (data.totals?.leads ?? 0).toLocaleString();
  $("#kpi-conv").textContent     = (data.totalsPretty?.conversionRatePct ?? ((data.totals?.conversionRate||0)*1).toFixed(2)+"%");
  // charts
  renderBarChart("#dash-earnings",(data.byDay||[]).map(d=>Number(d.earnings)||0),(data.byDay||[]).map(d=>String(d.date).slice(5)));
  renderPieChart("#dash-sources", data.devices || data.offerTypes || {});
  // geo table
  const tb=$("#geo-table"); tb.innerHTML="";
  (data.byGeo||[]).forEach(g=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${g.country}</td><td>${(g.clicks||0).toLocaleString()}</td><td>${(g.leads||0).toLocaleString()}</td><td style="color:#1dd1a1">$${Number(g.earnings||0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>`;
    tb.appendChild(tr);
  });
}

async function loadCpa(){
  const data = await api("cpa");
  const host=$("#cpa-grid"); host.innerHTML="";
  (data.items||[]).forEach(x=>{
    const card=document.createElement("div"); card.className="panel";
    card.innerHTML=`<h3>${x.account}</h3>
      <div class="pad">
        <div class="chip"><img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(x.domain)}&sz=32" style="width:16px;height:16px;border-radius:4px"> ${x.domain}</div>
        <div style="margin-top:10px" class="grid" style="grid-template-columns:1fr 1fr">
          <div><div class="muted">Network</div><strong>${x.network}</strong></div>
          <div><div class="muted">Active Offers</div><strong>${x.activeOffers}</strong></div>
          <div><div class="muted">Revenue</div><strong style="color:#1dd1a1">$${Number(x.revenue||0).toLocaleString()}</strong></div>
          <div><div class="muted">Clicks</div><strong>${(x.clicks||0).toLocaleString()}</strong></div>
          <div><div class="muted">Conversion</div><strong>${((x.conversionRate||0)*100).toFixed(2)}%</strong></div>
          <div><div class="muted">Status</div><strong>${x.status}</strong></div>
        </div>
      </div>`;
    host.appendChild(card);
  });
}

async function loadUsers(){
  const data = await api("users");
  const tb=$("#users-tbody"); tb.innerHTML="";
  (data.items||[]).forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${u.name||""}</td><td>${u.email||""}</td><td>${u.phone||""}</td><td>${u.authority||""}</td><td>${u.status||""}</td>`;
    tb.appendChild(tr);
  });
}

async function loadAnalytics(){
  const data = await api("analytics");
  renderBarChart("#ana-overview",(data.byDay||[]).map(x=>Number(x.earnings)||0),(data.byDay||[]).map(x=>String(x.date).slice(5)));
  renderPieChart("#ana-geo-dist", data.geo||{});
  const tb=$("#ana-live"); tb.innerHTML="";
  (data.items||[]).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.date||""}</td><td>${r.country||""}</td><td>${r.offertype||""}</td><td>${r.device||""}</td><td>${(r.clicks||0).toLocaleString()}</td><td>${(r.leads||0).toLocaleString()}</td><td>$${Number(r.earnings||0).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}

async function loadWallet(){
  const data = await api("wallet");
  $("#wallet-balance").textContent = `$${Number(data.balance||0).toLocaleString()}`;
  const tb=$("#wallet-history"); tb.innerHTML="";
  (data.history||[]).forEach(h=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${h.date||""}</td><td>${h.method||""}</td><td>$${Number(h.amount||0).toLocaleString()}</td><td>${h.status||""}</td>`;
    tb.appendChild(tr);
  });
}

async function loadMonitoring(){
  const data = await api("monitoring");
  $("#mon-health").textContent = data.health || "â€”";
  $("#mon-maint").textContent = data.maintenance || "â€”";
  const tb=$("#mon-events"); tb.innerHTML="";
  (data.events||[]).forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${e.time||""}</td><td>${e.type||""}</td><td>${e.message||""}</td>`;
    tb.appendChild(tr);
  });
}

async function loadSettings(){
  const data = await api("config");
  $("#cfg-json").textContent = JSON.stringify(data,null,2);
}

/* ===== Router ===== */
const ROUTES = {
  dashboard: loadOverview,
  cpa: loadCpa,
  users: loadUsers,
  analytics: loadAnalytics,
  wallet: loadWallet,
  monitoring: loadMonitoring,
  settings: loadSettings
};

function setActive(route){
  $$("#nav a").forEach(a=>a.classList.toggle("active", a.dataset.route===route));
  $$(".route").forEach(s=>s.classList.add("hidden"));
  const sec = $("#route-"+route); if(sec) sec.classList.remove("hidden");
}

async function show(route){
  route = ROUTES[route] ? route : "dashboard";
  setActive(route);
  try{ await ROUTES[route](); }
  catch(err){ toast("Load error on "+route+": "+(err.message||err)); console.error(err); }
}

/* Boot */
document.addEventListener("click", (e)=>{
  const a=e.target.closest('a[data-route]'); if(!a) return;
  e.preventDefault(); const r=a.dataset.route; history.replaceState(null,"","#"+r); show(r);
});
window.addEventListener("hashchange", ()=> show((location.hash||"#dashboard").slice(1)));

document.addEventListener("DOMContentLoaded", ()=>{
  const first=(location.hash||"#dashboard").slice(1);
  show(first);
});
</script>
</body>
</html>