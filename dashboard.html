<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>THE EMPIRE — Supreme Command Dashboard</title>
<style>
  :root{--bg:#081123;--panel:#0f1a33;--card:#0c162c;--card2:#0b1428;--ring:#1f2a44;--muted:#93a3bb;--text:#e8eef6;--accent:#facc15;--ok:#22c55e;--bad:#ef4444;}
  *{box-sizing:border-box}body{margin:0;background:radial-gradient(1200px 800px at 15% -10%,#19325f 0,#081123 55%) fixed;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .app{display:flex;min-height:100dvh}.sidebar{width:220px;background:linear-gradient(#0a1429,#091226);border-right:1px solid #0c1220;padding:18px;position:sticky;top:0;height:100dvh}
  .brand{font-weight:800;letter-spacing:.06em;margin:2px 0 16px}.nav{display:flex;flex-direction:column;gap:8px}
  .nav button{all:unset;cursor:pointer;padding:10px 12px;border-radius:10px;color:#cbd5e1;border:1px solid transparent}
  .nav button.active,.nav button:hover{background:var(--panel);border-color:#1f2a44;color:#fff}
  .content{flex:1;min-width:0;padding:20px 22px}.grid{display:grid;gap:14px}
  .cols-4{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}.cols-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--ring);border-radius:14px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
  .kpi .lbl{color:var(--muted)}.kpi .v{font-size:26px;font-weight:800;margin-top:2px}
  .pill{display:inline-block;padding:.18rem .55rem;border-radius:999px;font-size:12px;border:1px solid #24314f;background:#101a31;color:#cbd5e1}
  .pill.ok{border-color:#1f6b3a;background:#0f2a1a;color:#b7f7c1}.pill.bad{border-color:#6b1f1f;background:#2a0f0f;color:#ffc3c3}
  .muted{color:var(--muted)} table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #1f2937;vertical-align:top} th{position:sticky;top:0;background:#0f182d;text-align:left}
  .right{margin-left:auto} canvas{width:100%;height:220px;display:block}
  dialog{border:none;border-radius:14px;background:#0f1a33;color:#fff;padding:0;max-width:520px;width:90vw}
  dialog .dlg-hd{padding:14px 16px;border-bottom:1px solid #1f2a44;font-weight:700}
  dialog .dlg-bd{padding:14px 16px} dialog .row{display:flex;gap:10px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #25314d;background:#0b1428;color:#e8eef6}
  .btn{all:unset;background:#183052;border:1px solid #2a3b5e;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:#1b3460;border-color:#2f4780} .btn.ok{background:#0f2a1a;border-color:#1f6b3a}
  .btn.bad{background:#2a0f0f;border-color:#6b1f1f}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">THE EMPIRE</div>
    <div class="nav">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="cpa">CPA Accounts</button>
      <button data-tab="users">Users</button>
      <button data-tab="analytics">Analytics</button>
      <button data-tab="wallet">Payments/Wallet</button>
      <button data-tab="security">Security</button>
      <button data-tab="monitoring">Monitoring</button>
      <button data-tab="logout">Logout</button>
    </div>
    <div class="muted" style="margin-top:14px;font-size:12px">© 2025 The Empire</div>
  </aside>

  <main class="content">
    <!-- DASHBOARD -->
    <section id="tab-dashboard">
      <div class="row"><h2>Supreme Command Dashboard <span class="pill">Live</span></h2></div>
      <div class="grid cols-4" style="margin-top:8px">
        <div class="card kpi">
          <div class="lbl">Total Earnings</div>
          <div class="v" id="db-earnings">$0.00</div>
          <small class="muted" id="db-earnings-note"></small>
        </div>
        <div class="card kpi">
          <div class="lbl">Active Users</div>
          <div class="v" id="db-active">0</div>
          <small class="muted" id="db-active-note"></small>
        </div>
        <div class="card kpi">
          <div class="lbl">Conversion Rate</div>
          <div class="v" id="db-cr">0%</div>
          <small class="muted">Industry leading</small>
        </div>
        <div class="card kpi">
          <div class="lbl">Total Clicks</div>
          <div class="v" id="db-clicks">0</div>
          <small class="muted">Daily average</small>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card"><div class="lbl muted">Daily Earnings</div><canvas id="chart-earnings"></canvas></div>
        <div class="card"><div class="lbl muted">Traffic Sources</div><canvas id="chart-traffic"></canvas></div>
      </div>
    </section>

    <!-- CPA ACCOUNTS -->
    <section id="tab-cpa" hidden>
      <div class="row"><h2>CPA Accounts Management</h2><span id="cpa-meta" class="muted right"></span></div>
      <div id="cpa-cards" class="grid cols-2" style="margin-top:8px"><div class="card muted">Loading CPA accounts…</div></div>
    </section>

    <!-- USERS -->
    <section id="tab-users" hidden>
      <div class="row">
        <h2>Users Management</h2>
        <div class="right">
          <button class="btn primary" id="btn-add-user">+ Add New User</button>
        </div>
      </div>
      <div class="card">
        <div class="row">
          <div><div class="muted">Your Invite Link</div><div id="invite-link" style="word-break:break-all">—</div></div>
          <span class="right muted" id="users-meta"></span>
        </div>
      </div>
      <div class="card" style="margin-top:12px" id="users-table"><div class="muted">Loading users…</div></div>
    </section>

    <!-- ANALYTICS -->
    <section id="tab-analytics" hidden>
      <h2>Analytics & Reports</h2>
      <div class="grid cols-2">
        <div class="card"><div class="muted">Performance Overview (Jan–Jul 2025)</div><canvas id="chart-months"></canvas></div>
        <div class="card"><div class="muted">Geographic Distribution</div><canvas id="chart-geo"></canvas></div>
      </div>
      <div class="card" style="margin-top:12px"><div class="muted">Live Performance Data</div><div id="an-live" style="margin-top:6px" class="muted">Loading…</div></div>
    </section>

    <!-- WALLET -->
    <section id="tab-wallet" hidden>
      <h2>Universal Withdrawal & History</h2>
      <div class="grid cols-2">
        <div class="card" id="wallet-balance">
          <div class="muted">Balance Calculation</div>
          <div class="grid cols-2" style="margin-top:8px">
            <div><small class="muted">Available Balance</small><div id="w-av" class="v" style="font-weight:800">$0.00</div></div>
            <div><small class="muted">Withdrawal Amount</small><div id="w-amt" class="v">$0.00</div></div>
          </div>
          <div style="margin-top:8px"><small class="muted">Remaining Balance</small><div id="w-rem" class="v" style="font-weight:800">$0.00</div></div>
          <hr style="border:0;border-top:1px solid #1f2a44;margin:12px 0">
          <!-- Withdrawal form -->
          <div class="grid cols-2">
            <div>
              <label>Amount (USD)</label><input id="wd-amount" type="number" min="0" step="1" placeholder="Enter amount">
              <label style="margin-top:8px">Payout Category</label>
              <select id="wd-category"><option>Traditional Banks</option><option>E-Wallets</option><option>Crypto</option></select>
              <label style="margin-top:8px">Country/Region</label><input id="wd-country" placeholder="Nigeria">
              <label style="margin-top:8px">Payment Method</label><input id="wd-method" placeholder="Polaris Bank">
            </div>
            <div>
              <label>Account Number</label><input id="wd-acct" placeholder="Enter account number">
              <label style="margin-top:8px">Account Holder Name</label><input id="wd-name" placeholder="Enter account holder name">
              <div style="margin-top:12px;display:flex;gap:8px">
                <button class="btn ok" id="btn-request-wd" title="Requires GAS endpoint: requestWithdrawal">Request Withdrawal</button>
                <span id="wd-msg" class="muted" style="align-self:center"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="card" id="wallet-history">
          <div class="muted">Transaction History & Status</div>
          <div id="wallet-table" style="margin-top:6px" class="muted">Loading…</div>
        </div>
      </div>
    </section>

    <!-- SECURITY -->
    <section id="tab-security" hidden>
      <h2>Security Overview</h2>
      <div class="grid cols-4" style="margin-bottom:10px">
        <div class="card kpi"><div class="lbl">Alerts (24h)</div><div class="v" id="sec-alerts">0</div></div>
        <div class="card kpi"><div class="lbl">Blocks</div><div class="v" id="sec-blocks">0</div></div>
        <div class="card kpi"><div class="lbl">Failed Logins</div><div class="v" id="sec-fails">0</div></div>
        <div class="card kpi"><div class="lbl">Status</div><div class="v" id="sec-status">OK</div></div>
      </div>
      <div class="card" id="sec-table"><div class="muted">Loading security events…</div></div>
    </section>

    <!-- MONITORING -->
    <section id="tab-monitoring" hidden>
      <h2>System Monitoring</h2>
      <div class="card" id="mon-feed"><div class="muted">Loading activity feed…</div></div>
    </section>

    <section id="tab-logout" hidden><h2>Logout</h2><div class="card muted">Close this tab to exit.</div></section>
  </main>
</div>

<!-- Add User Modal -->
<dialog id="dlg-user">
  <div class="dlg-hd">Add New User</div>
  <div class="dlg-bd">
    <div class="row"><div><label>Username</label><input id="new-username" placeholder="Enter username"></div></div>
    <div class="row"><div><label>Email</label><input id="new-email" type="email" placeholder="Enter email"></div></div>
    <div class="row"><div><label>WhatsApp Number</label><input id="new-phone" placeholder="+2348012345678"></div></div>
    <div class="row"><div><label>Authority Level</label>
      <select id="new-level"><option>Level 1</option><option>Level 2</option><option>Level 3</option><option>Level 4</option><option>Level 5</option></select>
    </div></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btn-cancel-user">Cancel</button>
      <button class="btn ok" id="btn-save-user">Add User</button>
      <span id="user-msg" class="muted" style="align-self:center;margin-left:8px"></span>
    </div>
  </div>
</dialog>

<script>
/*** CONFIG ***/
const BASE="https://script.google.com/macros/s/AKfycbysJmVXlrOE1_J3uw5wMqs9cnKtj-uuoxj0Mmj8JWTj7eZMvp9XJYXrs-0leocNXI6w/exec";
const PASS="GENERALISIMO@2025";

/*** UTIL ***/
const $=s=>document.querySelector(s);
function fmtMoney(n){n=Number(n||0);return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2})}
function fmtNum(n){return Number(n||0).toLocaleString()}
function fmtTime(t){try{return new Date(t).toLocaleString()}catch(_){return t||""}}
function val(o,...keys){for(const k of keys){if(k in o && o[k]!==undefined && o[k]!==null && o[k]!=="") return o[k]}return undefined}
async function fetchJSON(action,extra={}){const u=new URL(BASE);u.searchParams.set("action",action);u.searchParams.set("pass",PASS);for(const[k,v] of Object.entries(extra))u.searchParams.set(k,v);const r=await fetch(u,{cache:"no-store"});const j=await r.json().catch(()=>({ok:false,error:"bad_json"}));if(!r.ok||j.ok===false) throw new Error(j.error||("HTTP "+r.status));return j}
async function maybe(action,extra){try{return await fetchJSON(action,extra)}catch(_){return null}}

/*** CANVAS MINI CHARTS ***/
function barChart(canvas,series,labels){
  const ctx=canvas.getContext("2d"),w=canvas.width=canvas.clientWidth,h=canvas.height=canvas.clientHeight, pad=24;
  ctx.clearRect(0,0,w,h); if(!series.length) return;
  const max=Math.max(...series,1); const bw=(w-pad*2)/series.length*0.7, gap=(w-pad*2)/series.length*0.3;
  series.forEach((v,i)=>{const x=pad+i*(bw+gap); const bh=(h-pad*2)*(v/max); ctx.fillStyle="#facc15"; ctx.fillRect(x,h-pad-bh,bw,bh); ctx.fillStyle="#9fb0c5"; ctx.font="12px system-ui"; ctx.fillText(labels[i]||"",x, h-6);});
}
function donut(canvas,parts){
  const ctx=canvas.getContext("2d"),w=canvas.width=canvas.clientWidth,h=canvas.height=canvas.clientHeight; ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2, r=Math.min(w,h)/2-10, ir=r*0.55; const cols=["#facc15","#60a5fa","#34d399","#fb923c","#e879f9","#f87171","#22d3ee"];
  const sum=(parts.reduce((a,b)=>a+Number(b.v||0),0))||1; let a0=-Math.PI/2;
  parts.forEach((p,i)=>{const a1=a0+2*Math.PI*(Number(p.v||0)/sum); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=cols[i%cols.length]; ctx.arc(cx,cy,r,a0,a1); ctx.lineTo(cx,cy); ctx.fill(); a0=a1;});
  ctx.globalCompositeOperation="destination-out"; ctx.beginPath(); ctx.arc(cx,cy,ir,0,2*Math.PI); ctx.fill(); ctx.globalCompositeOperation="source-over";
}

/*** DASHBOARD ***/
async function loadDashboard(){
  const [summary, wallet, users, analytics, cmd] = await Promise.all([
    maybe("summary"), maybe("walletOverview"), maybe("usersOverview"), maybe("analyticsOverview"), maybe("commanderMetrics")
  ]);

  // === Total Earnings (correct cumulative) ===
  let total = val(cmd||{}, "totalEarnings");
  if(total===undefined) total = val(analytics||{},"totalEarnings");
  if(total===undefined && analytics && analytics.monthly){
    total = Object.values(analytics.monthly).map(Number).reduce((a,b)=>a+b,0);
  }
  if(total===undefined) total = val(users||{}, "totalEarnings");
  if(total===undefined) total = val(wallet||{}, "net","inflow"); // fallback
  $("#db-earnings").textContent = fmtMoney(total||0);
  $("#db-earnings-note").textContent = (analytics&&analytics.updatedAt)?`Updated ${fmtTime(analytics.updatedAt)}`: (wallet&&wallet.updatedAt?`Updated ${fmtTime(wallet.updatedAt)}`:"");

  $("#db-active").textContent = fmtNum(val(users||{},"active","Active","Active Users")||0);
  $("#db-active-note").textContent = users&&users.updatedAt?`+ last sync ${fmtTime(users.updatedAt)}`:"";

  const cr = Number(val(analytics||{},"conversionRate","CR")||0);
  $("#db-cr").textContent = cr.toFixed(2)+"%";
  $("#db-clicks").textContent = fmtNum(val(summary||{},"totalClicksWeek","Clicks","Total Clicks")||0);

  // Daily earnings from wallet
  const w = await maybe("listwallet",{limit:300})||{recent:[]};
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"], sums=[0,0,0,0,0,0,0];
  (w.recent||[]).forEach(r=>{ if((r.Direction||"").toLowerCase()==="in"){ const d=new Date(r.Time).getDay(); const i=(d+6)%7; sums[i]+=Number(r.Amount||0)}});
  barChart($("#chart-earnings"),sums,days);

  // Traffic by Method
  const byMethod={}; (w.recent||[]).forEach(r=>{ if((r.Direction||"").toLowerCase()==="in"){ const k=r.Method||"Other"; byMethod[k]=(byMethod[k]||0)+Number(r.Amount||0)}});
  const parts=Object.entries(byMethod).map(([k,v])=>({k,v})); donut($("#chart-traffic"), parts.length?parts:[{k:"No Data",v:1}]);
}

/*** CPA ACCOUNTS ***/
async function loadCPA(){
  const cards=$("#cpa-cards");
  const data = await maybe("listCPAAccounts");
  const items = (data && (data.items||data.list||data.accounts)) || [];

  // Map with flexible headers
  function mapRow(a){
    return {
      name: val(a,"name","account","Account Name","Network","Title")||"CPA",
      status: val(a,"status","Status")||"ACTIVE",
      activeOffers: Number(val(a,"activeOffers","Active Offers","Offers","Active")||0),
      revenue: Number(val(a,"revenue","Revenue")||0),
      clicks: Number(val(a,"clicks","Clicks")||0),
      conversion: Number(val(a,"conversion","Conversion")||0)
    };
  }

  if(items.length){
    $("#cpa-meta").textContent = `${fmtNum(items.length)} accounts`;
    cards.innerHTML = items.map(x=>mapRow(x)).map(a=>`
      <div class="card">
        <div class="row"><strong>${a.name}</strong><span class="pill ${/active/i.test(a.status)?"ok":""} right">${a.status}</span></div>
        <div class="grid cols-4" style="margin-top:8px">
          <div><small class="muted">Active Offers</small><div class="v">${fmtNum(a.activeOffers)}</div></div>
          <div><small class="muted">Revenue</small><div class="v">${fmtMoney(a.revenue)}</div></div>
          <div><small class="muted">Clicks</small><div class="v">${fmtNum(a.clicks)}</div></div>
          <div><small class="muted">Conversion</small><div class="v">${a.conversion}%</div></div>
        </div>
      </div>`).join("");
  }else{
    // derive from wallet by Method
    const w=await maybe("listwallet",{limit:300})||{recent:[]};
    const agg={}; (w.recent||[]).forEach(r=>{ if((r.Direction||"").toLowerCase()==="in"){ const k=r.Method||"Unknown"; agg[k]=(agg[k]||0)+Number(r.Amount||0)}});
    const derived=Object.entries(agg).map(([k,v])=>({name:k,status:"ACTIVE",activeOffers:0,revenue:v,clicks:0,conversion:0}));
    $("#cpa-meta").textContent = `${derived.length} accounts (derived)`;
    cards.innerHTML = derived.length? derived.map(a=>`
      <div class="card">
        <div class="row"><strong>${a.name}</strong><span class="pill ok right">ACTIVE</span></div>
        <div class="grid cols-4" style="margin-top:8px">
          <div><small class="muted">Active Offers</small><div class="v">—</div></div>
          <div><small class="muted">Revenue</small><div class="v">${fmtMoney(a.revenue)}</div></div>
          <div><small class="muted">Clicks</small><div class="v">—</div></div>
          <div><small class="muted">Conversion</small><div class="v">—</div></div>
        </div>
      </div>`).join("") : '<div class="card muted">No CPA sources found.</div>';
  }
}

/*** USERS ***/
async function loadUsers(){
  const [ov, list] = await Promise.all([ maybe("usersOverview"), maybe("listassociates",{limit:500}) ]);
  $("#users-meta").textContent = ov&&ov.updatedAt?`Updated ${fmtTime(ov.updatedAt)}`:"";
  $("#invite-link").textContent = val(ov||{},"inviteLink","Invite","Link") || "—";

  const items=(list&&list.items)||[];
  const rows=items.map(x=>`
    <tr>
      <td>${val(x,"Username","Name")||"-"}</td>
      <td>${val(x,"Email")||"-"}</td>
      <td>${val(x,"Phone","Phone Number")||"-"}</td>
      <td>${val(x,"Authority","Level","Current Level")||"-"}</td>
      <td>${x.Earnings?fmtMoney(x.Earnings):"-"}</td>
      <td><span class="pill ${/active|confirm/i.test(val(x,"Status")||"")?"ok":""}">${val(x,"Status")||"—"}</span></td>
      <td class="muted">${val(x,"Actions")||"View • Edit"}</td>
    </tr>`).join("") || `<tr><td colspan="7" class="muted">No users.</td></tr>`;
  $("#users-table").innerHTML=`
    <div style="overflow:auto;max-height:65vh">
      <table>
        <thead><tr><th>Username</th><th>Email</th><th>Phone</th><th>Authority</th><th>Earnings</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

/*** ANALYTICS ***/
async function loadAnalytics(){
  const an = await maybe("analyticsOverview")||{};
  const months = an.monthly || {};
  const labels = Object.keys(months); const values = labels.map(k=>Number(months[k]||0));
  barChart($("#chart-months"), values, labels);
  const geo = an.geo || {}; const parts = Object.keys(geo).map(k=>({k,v:Number(geo[k]||0)}));
  donut($("#chart-geo"), parts.length?parts:[{k:"No Data",v:1}]);
  const live = an.latest || [];
  $("#an-live").innerHTML = live.length? table(live,["Date & Time","Country","Offer Type","Device","Clicks","Leads","Earnings ($)"]) : "<span class='muted'>No live rows.</span>";
  function table(rows, headers){return `<div style="overflow:auto;max-height:55vh"><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr>${headers.map(h=>`<td>${r[h]??""}</td>`).join("")}</tr>`).join("")}</tbody></table></div>`;}
}

/*** WALLET ***/
async function loadWallet(){
  const [ov, list] = await Promise.all([ maybe("walletOverview"), maybe("listwallet",{limit:200}) ]);
  const net = Number(val(ov||{},"net","inflow")||0);
  $("#w-av").textContent  = fmtMoney(net);
  $("#w-amt").textContent = fmtMoney(0);
  $("#w-rem").textContent = fmtMoney(net);

  const rows=((list&&list.recent)||[]).map(x=>`
    <tr>
      <td>${fmtTime(x.Time)}</td>
      <td>${fmtMoney(x.Amount)}</td>
      <td>${x.Method||"-"}</td>
      <td>${x.Status||"-"}</td>
      <td><span class="pill ${x.Direction==='in'?'ok':x.Direction==='out'?'bad':''}">${x.Direction||"—"}</span></td>
      <td>${x.Name||"-"}</td>
      <td>${x.Email||"-"}</td>
      <td>${x.Phone||"-"}</td>
    </tr>`).join("") || `<tr><td colspan="8" class="muted">No transactions.</td></tr>`;
  $("#wallet-table").innerHTML=`
    <div style="overflow:auto;max-height:65vh">
      <table><thead><tr><th>Time</th><th>Amount</th><th>Method</th><th>Status</th><th>Dir</th><th>Name</th><th>Email</th><th>Phone</th></tr></thead><tbody>${rows}</tbody></table>
    </div>`;
}

/*** SECURITY ***/
async function loadSecurity(){
  const s=await maybe("securityOverview");
  if(s){
    $("#sec-alerts").textContent=fmtNum(s.alerts24h||0);
    $("#sec-blocks").textContent=fmtNum(s.blocks||0);
    $("#sec-fails").textContent =fmtNum(s.failedLogins||0);
    $("#sec-status").textContent=s.status||"OK";
    render(s.items||[]);
  }else{
    const m=await maybe("monitoringFeed")||{recent:[]};
    const items=(m.recent||[]).filter(r=>/security|blocked|fail/i.test(r.Action||""));
    $("#sec-alerts").textContent=fmtNum(items.length);
    $("#sec-blocks").textContent=fmtNum(items.filter(i=>/block/i.test(i.Action||"")).length);
    $("#sec-fails").textContent =fmtNum(items.filter(i=>/fail/i.test(i.Action||"")).length);
    $("#sec-status").textContent="OK";
    render(items);
  }
  function render(items){
    const rows=items.map(x=>`
      <tr>
        <td>${fmtTime(x.Timestamp||x.t)}</td>
        <td>${x.User||"-"}</td>
        <td>${x.Action||x.type||"-"}</td>
        <td>${x.Email||"-"}</td>
        <td>${x["Phone Number"]||"-"}</td>
        <td class="muted">${x.Status||x.msg||""}</td>
      </tr>`).join("") || `<tr><td colspan="6" class="muted">No security events.</td></tr>`;
    $("#sec-table").innerHTML=`<div style="overflow:auto;max-height:65vh"><table><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Email</th><th>Phone</th><th>Details</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  }
}

/*** MONITORING ***/
async function loadMonitoring(){
  const m=await maybe("monitoringFeed")||{recent:[]};
  const rows=(m.recent||[]).map(x=>`
    <tr><td>${fmtTime(x.Timestamp||x.t)}</td><td>${x.User||"-"}</td><td>${x.Action||x.type||"-"}</td><td>${x.Email||"-"}</td><td>${x["Phone Number"]||"-"}</td><td class="muted">${x.Status||x.msg||""}</td></tr>
  `).join("") || `<tr><td colspan="6" class="muted">No activity.</td></tr>`;
  $("#mon-feed").innerHTML=`<div style="overflow:auto;max-height:70vh"><table><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Email</th><th>Phone</th><th>Details</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/*** ADD USER (modal + submit) ***/
const dlg=$("#dlg-user");
$("#btn-add-user").addEventListener("click",()=>dlg.showModal());
$("#btn-cancel-user").addEventListener("click",()=>dlg.close());
$("#btn-save-user").addEventListener("click",async()=>{
  const payload={
    username:$("#new-username").value.trim(),
    email:$("#new-email").value.trim(),
    phone:$("#new-phone").value.trim(),
    level:$("#new-level").value
  };
  $("#user-msg").textContent="Submitting…";
  try{
    const res = await fetchJSON("addUser",payload); // requires GAS endpoint
    $("#user-msg").textContent = res.ok?"Added. Refreshing…":"Failed";
    await loadUsers(); setTimeout(()=>dlg.close(),400);
  }catch(e){
    $("#user-msg").textContent = "Endpoint missing (addUser). Add it in GAS or share link invite.";
  }
});

/*** WITHDRAWAL submit ***/
$("#btn-request-wd").addEventListener("click",async()=>{
  const p={
    amount:$("#wd-amount").value, category:$("#wd-category").value, country:$("#wd-country").value,
    method:$("#wd-method").value, account:$("#wd-acct").value, name:$("#wd-name").value
  };
  $("#wd-msg").textContent="Submitting…";
  try{
    const res=await fetchJSON("requestWithdrawal",p); // requires GAS endpoint
    $("#wd-msg").textContent = res.ok?"Request submitted":"Failed";
    await loadWallet();
  }catch(e){
    $("#wd-msg").textContent="Endpoint missing (requestWithdrawal).";
  }
});

/*** TABS ***/
const TAB_FN={dashboard:loadDashboard,cpa:loadCPA,users:loadUsers,analytics:loadAnalytics,wallet:loadWallet,security:loadSecurity,monitoring:loadMonitoring,logout:()=>{}};
function showTab(id){document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active",b.dataset.tab===id));document.querySelectorAll("main > section").forEach(s=>s.hidden = s.id !== "tab-"+id);TAB_FN[id]&&TAB_FN[id]();}
document.querySelectorAll(".nav button").forEach(b=>b.addEventListener("click",()=>showTab(b.dataset.tab)));showTab("dashboard");
</script>
</body>
</html>