<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>⚔️ The Empire Dashboard ⚔️</title>
<style>
  :root{--bg:#0b1424;--panel:#0f172a;--card:#101826;--accent:#ffd166;--muted:#9fb3c8;--line:#1f2a44;}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#e6f1ff}
  .layout{display:flex;min-height:100vh}
  nav{width:240px;background:var(--panel);padding:20px}
  nav h2{margin:0 0 16px;color:var(--accent)}
  .navlink{display:block;padding:10px 12px;margin:6px 0;border-radius:8px;color:#e6f1ff;text-decoration:none}
  .navlink:hover{background:#1b2742}.navlink.active{background:#223157;box-shadow:inset 0 0 0 1px #2d416f}
  main{flex:1;padding:20px;overflow:auto}
  .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,.4)}
  .card h3{margin:0 0 10px;color:var(--accent)}
  h4{margin:14px 0 6px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 10px;border:1px solid var(--line)} th{background:#1f2a44}
  .num{text-align:right} .muted{color:var(--muted)} .row{display:flex;gap:16px;flex-wrap:wrap}
  .kpi{flex:1 1 200px;background:#0d1525;border:1px solid #14213d;border-radius:10px;padding:12px}
  .kpi .label{font-size:.9rem;color:var(--muted)} .kpi .val{font-size:1.4rem;font-weight:700;margin-top:4px}
  .view{display:none}.view.active{display:block}
  .toolbar{display:flex;gap:8px;align-items:center}
  button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(.95)}
  .log{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#0a1120;border:1px dashed #2a3b66;border-radius:10px;padding:10px;margin-top:10px;color:#a9c1ff}
</style>
</head>
<body>
<div class="layout">
  <nav>
    <h2>⚔️ Empire</h2>
    <a class="navlink active" href="#overview" data-target="overview">Overview</a>
  </nav>
  <main>
    <section id="overview" class="view active card">
      <div class="toolbar">
        <h3 style="margin-right:auto">Overview</h3>
        <button id="btnRefresh">Refresh</button>
        <span class="muted" id="stamp">—</span>
      </div>

      <div class="row" id="kpis">
        <div class="kpi"><div class="label">Earnings</div><div class="val" id="ov-earnings">$0.00</div></div>
        <div class="kpi"><div class="label">Leads</div><div class="val" id="ov-leads">0</div></div>
        <div class="kpi"><div class="label">Clicks</div><div class="val" id="ov-clicks">0</div></div>
        <div class="kpi"><div class="label">Conversion Rate</div><div class="val" id="ov-convrate">0.00%</div></div>
        <div class="kpi"><div class="label">EPC</div><div class="val" id="ov-epc">$0.00</div></div>
        <div class="kpi"><div class="label">CPA</div><div class="val" id="ov-cpa">$0.00</div></div>
        <div class="kpi"><div class="label">RPM</div><div class="val" id="ov-rpm">$0.00</div></div>
      </div>

      <h4>By Geo</h4>
      <table><thead><tr><th>Country</th><th class="num">Earnings ($)</th></tr></thead><tbody id="tbl-geo"></tbody></table>

      <h4>By Device</h4>
      <table><thead><tr><th>Device</th><th class="num">Earnings ($)</th></tr></thead><tbody id="tbl-device"></tbody></table>

      <h4>By Offer Type</h4>
      <table><thead><tr><th>Offer Type</th><th class="num">Earnings ($)</th></tr></thead><tbody id="tbl-offerType"></tbody></table>

      <h4>By Day</h4>
      <table><thead><tr><th>Date</th><th class="num">Earnings ($)</th></tr></thead><tbody id="tbl-byDay"></tbody></table>

      <div class="log" id="debug"></div>
    </section>
  </main>
</div>

<script>
/*** 1) CONFIG — replace with your working Apps Script Web App URL ***/
const API_URL = https://script.google.com/macros/s/AKfycbz-jj7Cr_KzqCku4SQPQ14MEIuCPdq5OEgiiqjo_O2A0FItBrHlmfkoJHViDxuX4P6z/exec

/*** 2) HELPERS ***/
const $$ = s => document.querySelector(s);
const fmtMoney = n => "$" + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
const fmtPct    = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) + "%";
function setStamp(){ $$("#stamp").textContent = new Date().toLocaleString(); }
function log(obj){ $$("#debug").textContent = typeof obj==="string" ? obj : JSON.stringify(obj,null,2); }
function fillTable(tbodySel, obj, labelHeader){
  const tb = $$(tbodySel); tb.innerHTML = "";
  if(!obj || typeof obj!=="object"){ tb.innerHTML = `<tr><td colspan="2" class="muted">No data</td></tr>`; return; }
  // sort descending by value
  const rows = Object.entries(obj).sort((a,b)=>Number(b[1])-Number(a[1]));
  for(const [k,v] of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${k}</td><td class="num">${fmtMoney(v)}</td>`;
    tb.appendChild(tr);
  }
}

/*** 3) CORE: load overview matching your payload shape ***/
async function loadOverview(){
  try{
    const url = API_URL; // endpoint already returns totals + breakdowns
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // keep a compact copy in the log for troubleshooting
    log(data);

    // --- totals: your payload uses "totals" with convRate, epc, cpa, rpm ---
    const t = data.totals || {};
    $$("#ov-earnings").textContent = fmtMoney(t.earnings);
    $$("#ov-leads").textContent    = Number(t.leads||0).toLocaleString();
    $$("#ov-clicks").textContent   = Number(t.clicks||0).toLocaleString();
    $$("#ov-convrate").textContent = fmtPct(t.convRate ?? t.conversionRate);
    $$("#ov-epc").textContent      = fmtMoney(t.epc);
    $$("#ov-cpa").textContent      = fmtMoney(t.cpa);
    $$("#ov-rpm").textContent      = fmtMoney(t.rpm);

    // --- breakdowns: byGeo, byDevice, byOfferType, byDay ---
    const b = data.breakdowns || data; // support either structure
    fillTable("#tbl-geo",       b.byGeo);
    fillTable("#tbl-device",    b.byDevice);
    fillTable("#tbl-offerType", b.byOfferType);

    // byDay may be an object with date-string keys; sort by date desc
    const byDay = b.byDay || {};
    const dayRows = Object.entries(byDay)
      .map(([k,v]) => [new Date(k), v])
      .sort((a,b)=>b[0]-a[0]);

    const tbDay = $$("#tbl-byDay"); tbDay.innerHTML = "";
    if(dayRows.length===0){
      tbDay.innerHTML = `<tr><td colspan="2" class="muted">No data</td></tr>`;
    } else {
      for(const [d,amt] of dayRows){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.toDateString()}</td><td class="num">${fmtMoney(amt)}</td>`;
        tbDay.appendChild(tr);
      }
    }

    setStamp();
  }catch(err){
    log("Error: " + (err?.message || err));
  }
}

/*** 4) BOOT ***/
document.getElementById("btnRefresh").addEventListener("click", loadOverview);
loadOverview();
</script>
</body>
</html>