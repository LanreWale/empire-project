<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THE EMPIRE · Minimal Probe</title>
<style>
  :root{--bg:#0e1b28;--card:#14263a;--line:#224057;--text:#eaf2ff;--muted:#89a2bf;--good:#1dd1a1;--bad:#ff6b6b}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Inter,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi div{background:#102233;border:1px solid var(--line);border-radius:10px;padding:10px;min-width:160px}
  .muted{color:var(--muted)} .money{color:var(--good);font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  th,td{padding:9px 10px;border-bottom:1px solid var(--line)} thead th{background:#0f2b45;text-align:left}
  tbody tr:last-child td{border-bottom:0}
  #log{white-space:pre-wrap;background:#2a1013;border:1px solid #5a1a22;color:#ffd2d2;border-radius:10px;padding:10px}
  .ok{color:#9cffc7} .btn{padding:8px 10px;border:1px solid var(--line);background:#0f2336;color:var(--text);border-radius:8px;cursor:pointer}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#10314f}
</style>
</head>
<body>
<div class="wrap">
  <h1>THE EMPIRE · Minimal Probe <span id="status" class="pill">booting…</span></h1>

  <div class="grid">
    <div class="card">
      <h3>Overview</h3>
      <div class="kpi">
        <div><div class="muted">Total Earnings</div><div id="ov-earn">$0.00</div></div>
        <div><div class="muted">Total Clicks</div><div id="ov-clicks">0</div></div>
        <div><div class="muted">Conversion</div><div id="ov-cr">0%</div></div>
        <div><div class="muted">Active Users</div><div id="ov-users">0</div></div>
      </div>
      <h4 style="margin:12px 0 6px">By Geo (Top)</h4>
      <table>
        <thead><tr><th>Country</th><th>Clicks</th><th>Leads</th><th>Earnings</th></tr></thead>
        <tbody id="tbl-geo"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>CPA Accounts</h3>
      <table>
        <thead><tr><th>Account</th><th>Network</th><th>Revenue</th><th>Conv.</th></tr></thead>
        <tbody id="tbl-cpa"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
      </table>
      <div style="margin-top:8px"><button id="btn-add" class="btn">Test “Add New Account” Call</button> <span class="muted">(dry-run)</span></div>
    </div>

    <div class="card">
      <h3>Users (counts)</h3>
      <div id="users-counts" class="muted">Loading…</div>
      <table style="margin-top:8px">
        <thead><tr><th>Name</th><th>Email</th><th>Status</th></tr></thead>
        <tbody id="tbl-users"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Wallet & Monitoring</h3>
      <div class="kpi">
        <div><div class="muted">Balance</div><div id="w-bal">$0.00</div></div>
        <div><div class="muted">Pending</div><div id="w-pend">$0.00</div></div>
        <div><div class="muted">Last Payout</div><div id="w-last">$0.00</div></div>
      </div>
      <h4 style="margin:12px 0 6px">Monitor Snapshot</h4>
      <div>Alerts: <b id="m-alerts">0</b> · Maintenance: <b id="m-maint">—</b> · Health: <b id="m-health">OK</b></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Error Log</h3>
    <div id="log">(empty)</div>
  </div>

</div>

<script>
/* ---------- CONFIG ---------- */
const GAS = "https://script.google.com/macros/s/AKfycbwZVlGMvYonfCNdQlwPHiqqgOVC80_HsyktSYmqmQPBKmRrlzg_yo4lKz_Mmu85B7eY/exec";

/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const dollars = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
const percent = n => (Number(n||0)).toFixed(2) + '%';
const log = (msg,isErr=false)=>{ const el=$("#log"); if(!el) return; el.textContent += (isErr?'[ERR] ':'[INFO] ') + msg + "\n"; };
const safeJSON = v => { try{ return JSON.stringify(v,null,2); }catch{ return String(v); } };

/* ---------- FETCH ---------- */
async function api(action, params={}){
  const u = new URL(GAS);
  u.searchParams.set('action', action);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
  const r = await fetch(u, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status+' for '+action);
  return r.json();
}

/* ---------- PAGE FILLERS ---------- */
async function loadOverview(){
  const j = await api('overview');
  log('overview: ' + safeJSON(j));
  const t = j.totals || j || {};
  $('#ov-earn').textContent   = dollars(t.earnings||0);
  $('#ov-clicks').textContent = t.clicks||0;
  $('#ov-cr').textContent     = percent( (t.conversionRate!=null)?t.conversionRate:(t.leads&&t.clicks?(t.leads/t.clicks*100):0) );

  const geoMap = j.geo || {};
  const clicksMap = j.geoClicks || {};
  const leadsMap  = j.geoLeads  || {};
  const rows = Object.keys(geoMap).map(k=>({
    country:k,
    earn:Number(geoMap[k]||0),
    clicks:Number(clicksMap[k]||0),
    leads:Number(leadsMap[k]||0)
  })).sort((a,b)=>b.earn-a.earn).slice(0,10);
  const tb = $('#tbl-geo'); tb.innerHTML='';
  if(!rows.length){ tb.innerHTML = '<tr><td colspan="4" class="muted">No data</td></tr>'; }
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.country}</td><td>${r.clicks}</td><td>${r.leads}</td><td class="money">${dollars(r.earn)}</td>`;
    tb.appendChild(tr);
  });
}

async function loadCpa(){
  const j = await api('cpa');
  log('cpa: ' + safeJSON(j));
  const items = Array.isArray(j)? j : (Array.isArray(j.items)? j.items : []);
  const tb = $('#tbl-cpa'); tb.innerHTML='';
  if(!items.length){ tb.innerHTML = '<tr><td colspan="4" class="muted">No CPA accounts.</td></tr>'; return; }
  items.forEach(r=>{
    const account = r.account || r.accountid || '—';
    const network = r.network || '—';
    const rev     = r.revenue || 0;
    const crRaw   = r.conversionRate!=null? r.conversionRate : r.conversionrate;
    const cr      = (crRaw>1?crRaw:crRaw*100)||0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${account}</td><td>${network}</td><td class="money">${dollars(rev)}</td><td>${cr.toFixed(2)}%</td>`;
    tb.appendChild(tr);
  });
}

async function loadUsers(){
  const j = await api('users');
  log('users: ' + safeJSON(j));
  const list = Array.isArray(j)? j : (Array.isArray(j.items)? j.items : []);
  const counts = {APPROVED:0,PENDING:0,REJECTED:0};
  list.forEach(u=>{ counts[String(u.status||'APPROVED').toUpperCase()]++ });
  $('#users-counts').innerHTML = `Approved: <b class="ok">${counts.APPROVED}</b> · Pending: <b>${counts.PENDING}</b> · Rejected: <b>${counts.REJECTED}</b>`;

  const tb = $('#tbl-users'); tb.innerHTML='';
  list.slice(0,10).forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${u.name||'—'}</td><td>${u.email||''}</td><td>${u.status||'APPROVED'}</td>`;
    tb.appendChild(tr);
  });
  if(!tb.children.length) tb.innerHTML = '<tr><td colspan="3" class="muted">No users</td></tr>';
}

async function loadWalletMonitor(){
  const w = await api('wallet');  log('wallet: ' + safeJSON(w));
  const m = await api('monitoring'); log('monitoring: ' + safeJSON(m));

  $('#w-bal').textContent  = dollars((w||{}).balance||0);
  const hist = (w && Array.isArray(w.history)) ? w.history : (Array.isArray(w)?w:[]);
  const pend = hist.filter(t=>String(t.status||'').toUpperCase()==='PENDING').reduce((s,t)=>s+Number(t.amount||0),0);
  $('#w-pend').textContent = dollars(pend);
  const last = hist.filter(t=>String(t.status||'').toUpperCase()==='COMPLETED').slice(-1)[0];
  $('#w-last').textContent = dollars(last?last.amount:0);

  $('#m-alerts').textContent = (m && m.events)? m.events.length : (Array.isArray(m)? m.length : 0);
  $('#m-maint').textContent  = (m && m.maintenance) || '—';
  $('#m-health').textContent = (m && m.health) || 'OK';
}

/* ---------- ADD TEST ---------- */
document.getElementById('btn-add').addEventListener('click', async ()=>{
  try{
    const payload = {account:'TEST', network:'CPA Grip', domain:'example.com', status:'ACTIVE'};
    const res = await fetch(GAS+'?action=cpaCreate', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j = await res.json().catch(()=>({}));
    log('cpaCreate response: ' + safeJSON(j));
    alert('Request sent. See Error Log box for response.');
  }catch(e){ log('cpaCreate failed: '+e.message,true); }
});

/* ---------- BOOT ---------- */
(async function boot(){
  try{
    $('#status').textContent='loading…';
    await Promise.all([
      loadOverview(),
      loadCpa(),
      loadUsers(),
      loadWalletMonitor()
    ]);
    $('#status').textContent='OK';
  }catch(e){
    $('#status').textContent='ERROR';
    log(e.stack||e.message||String(e), true);
  }
})();

/* Surfacing ANY runtime error on page */
window.addEventListener('error', e=>{
  log((e.error && e.error.stack) ? e.error.stack : (e.message||'Unknown error'), true);
});
</script>
</body>
</html>