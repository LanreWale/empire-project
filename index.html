<script>
/* ========= CONFIG ========= */
const GAS = "https://script.google.com/macros/s/AKfycbwZVlGMvYonfCNdQlwPHiqqgOVC80_HsyktSYmqmQPBKmRrlzg_yo4lKz_Mmu85B7eY/exec";
const POLL_FAST = 5000;

/* ========= SHORTCUTS ========= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const dollars = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
const toNum = v => (v==null ? 0 : Number(String(v).replace(/[$,]/g,'')) || 0);
const normDomain = d=> String(d||'').trim().replace(/^https?:\/\//,'').replace(/\/.*$/,'');

/* ========= FETCH HELPERS ========= */
const get = async (url, opt={})=>{
  const u = new URL(url);
  u.searchParams.set('_t', Date.now());
  const r = await fetch(u, {cache:'no-store', ...opt});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
};
const api = (action, params={})=>{
  const u = new URL(GAS);
  u.searchParams.set('action', action);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
  return get(u);
};
const apiWrite = async (action, payload={})=>{
  const url = new URL(GAS);
  url.searchParams.set('action', action);
  try{
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }catch(e){
    Object.entries(payload||{}).forEach(([k,v])=>url.searchParams.set(k, typeof v==='object'?JSON.stringify(v):String(v)));
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
};

/* ========= NORMALIZERS & UTIL ========= */
const arr = (maybe) => {
  if (Array.isArray(maybe)) return maybe;
  if (maybe && Array.isArray(maybe.items)) return maybe.items;
  if (maybe && Array.isArray(maybe.rows))  return maybe.rows;
  if (maybe && Array.isArray(maybe.data))  return maybe.data;
  return [];
};
const obj = (maybe) => (maybe && typeof maybe === 'object') ? maybe : {};

/* tolerant read: pick the first existing key among aliases */
const pick = (o, keys, dft=undefined)=>{
  for(const k of keys){
    if (o && o[k] != null) return o[k];
  }
  return dft;
};

/* ========= TINY SVG CHARTS (no libs) ========= */
const sparkline = (values = [], w = 520, h = 120) => {
  if (!values.length) return '<div class="empty">No data</div>';
  const max = Math.max(...values), min = Math.min(...values);
  const xs = values.map((_, i) => (values.length === 1 ? 0.5 : i / (values.length - 1)));
  const pts = values.map((v, i) => {
    const x = 12 + xs[i] * (w - 24);
    const y = h - 12 - (max === min ? 0.5 : (v - min) / (max - min)) * (h - 24);
    return `${x},${y}`;
  }).join(' ');
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}">
    <polyline points="${pts}" fill="none" stroke="#ffd559" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
};
const barlist = (entries = [], w = 520, h = 160) => {
  if (!entries.length) return '<div class="empty">No data</div>';
  const pad = 8, gap = 10, bw = (w - 2 * pad - gap * (entries.length - 1)) / entries.length;
  const max = Math.max(...entries.map(e => e.v || 0), 1);
  const bars = entries.map((e, i) => {
    const x = pad + i * (bw + gap);
    const bh = ((e.v || 0) / max) * (h - 40);
    const y = h - 20 - bh;
    return `<g>
      <rect x="${x}" y="${y}" width="${bw}" height="${bh}" rx="6" ry="6" fill="#59a6ff"/>
      <text x="${x + bw / 2}" y="${h - 6}" font-size="10" text-anchor="middle" fill="#c4d7ef">${e.k}</text>
    </g>`;
  }).join('');
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}">${bars}</svg>`;
};

/* ========= ROUTER ========= */
function show(route){
  $$('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.route===route));
  $$('[data-page]').forEach(s=>s.style.display = (s.dataset.page===route)?'block':'none');

  if(route==='dashboard') initDashboard();
  if(route==='cpa')       initCpa();
  if(route==='users')     initUsers(currentUsersTab);
  if(route==='analytics') initAnalytics();
  if(route==='wallet')    initWallet();
  if(route==='monitor')   initMonitor();
  if(route==='settings')  initSettings();
}
window.addEventListener('hashchange', ()=>{
  const r = location.hash.replace('#','')||'dashboard'; show(r);
});
$('#nav').addEventListener('click', e=>{
  if(e.target.closest('a')){
    const r = e.target.closest('a').dataset.route;
    location.hash = '#'+r;
  }
});

/* ========= DASHBOARD ========= */
async function initDashboard(){
  try{
    const [ov, us, ana] = await Promise.all([
      api('overview'),
      api('users'),
      api('analytics')
    ]);

    // KPIs
    const t = ov?.totals || ov || {};
    $('#dash-earn').textContent   = dollars(toNum(pick(t,['earnings','revenue','totalEarnings'],0)));
    $('#dash-clicks').textContent = toNum(pick(t,['clicks','totalClicks'],0));
    const leads = toNum(pick(t,['leads','conversions'],0));
    const cr = (t.conversionRate != null)
      ? Number(t.conversionRate)
      : ($('#dash-clicks').textContent ? (leads / Number($('#dash-clicks').textContent) * 100) : 0);
    $('#dash-cr').textContent = `${Number(cr||0).toFixed(2)}%`;

    const users = arr(us);
    const active = users.filter(u => String(u.status||'APPROVED').toUpperCase()==='APPROVED').length;
    $('#dash-users').textContent = active;
    $('#dash-users-diff').textContent = '24h growth';

    // Daily earnings chart
    const byDay = Array.isArray(ov?.byDay) ? ov.byDay : [];
    const dayVals = byDay.map(d => toNum(d.earnings ?? d.value));
    if (dayVals.length) {
      $('#dash-earnings').innerHTML = sparkline(dayVals);
    } else {
      const live = arr(ana?.live) || [];
      const buckets = {};
      live.forEach(e=>{
        const k = (e.time||'').slice(0,16);
        buckets[k] = (buckets[k]||0) + toNum(e.earnings);
      });
      const vals = Object.keys(buckets).sort().map(k=>buckets[k]);
      $('#dash-earnings').innerHTML = vals.length ? sparkline(vals) : '<div class="empty">No data</div>';
    }

    // Traffic sources (from overview.offerTypes)
    const src = ov?.offerTypes || {};
    const entries = Object.keys(src).map(k => ({ k, v: toNum(src[k]) }));
    $('#dash-sources').innerHTML = entries.length ? barlist(entries) : '<div class="empty">No data</div>';

    // By Geo (Clicks, Leads, Earnings)
    const geoEarn = ov?.geo || {};
    const geoAgg = {};
    (arr(ana?.items) || []).forEach(it=>{
      const country = it.country || it.value || 'Unknown';
      const clicks  = toNum(it.clicks);
      const conv    = toNum(it.leads ?? it.conversions ?? it.conv);
      const earn    = toNum(it.earnings);
      if (!geoAgg[country]) geoAgg[country] = {country, clicks:0, leads:0, earnings:0};
      geoAgg[country].clicks   += clicks;
      geoAgg[country].leads    += conv;
      geoAgg[country].earnings += earn;
    });
    Object.keys(geoEarn).forEach(k=>{
      if (!geoAgg[k]) geoAgg[k] = {country:k, clicks:0, leads:0, earnings:0};
      geoAgg[k].earnings = toNum(geoEarn[k]);
    });

    const tb = $('#tbl-dash-geo'); tb.innerHTML='';
    const rows = Object.values(geoAgg).sort((a,b)=>b.earnings-a.earnings).slice(0,10);
    if (!rows.length) {
      tb.innerHTML = '<tr><td colspan="4" class="muted">No data</td></tr>';
    } else {
      rows.forEach(g=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${g.country}</td><td>${g.clicks}</td><td>${g.leads}</td><td class="money">${dollars(g.earnings)}</td>`;
        tb.appendChild(tr);
      });
    }
  }catch(e){
    console.error(e);
  }
}

/* ========= CPA ACCOUNTS ========= */
async function initCpa(){
  const wrap = $('#cpa-grid'); wrap.innerHTML='';
  try{
    const resp = await api('cpa');
    // accept both {items:[...]} and [...]
    const raw = arr(resp);
    // map both old headers (account, activeOffers, conversionRate…) and new lowercase headers (accountid, activeoffers, conversionrate…)
    const items = raw.map(r=>{
      const account = String(pick(r,['account','accountid'],'')).trim();
      const network = pick(r,['network'],'');
      const domain  = pick(r,['domain'],'');
      const status  = String(pick(r,['status'],'ACTIVE')).toUpperCase();
      const activeOffers = toNum(pick(r,['activeOffers','activeoffers'],0));
      const revenue = toNum(pick(r,['revenue'],0));
      const clicks  = toNum(pick(r,['clicks'],0));
      let conv      = pick(r,['conversionRate','conversionrate'],0);
      conv = Number(conv); conv = conv > 1 ? conv : conv * 100; // ratio or %
      return {account, network, domain, status, activeOffers, revenue, clicks, conv};
    });

    if(!items.length){ wrap.innerHTML = `<div class="card pad empty">No CPA accounts yet.</div>`; return; }

    items.forEach(r=>{
      const card = document.createElement('div');
      card.className='card pad';
      card.innerHTML = `
        <div class="acct">
          <div>
            <h3>${r.account||'—'}</h3>
            <div class="muted" style="margin-bottom:10px">Network <b style="color:#fff">${r.network||'—'}</b> · <span class="badge">${r.status}</span></div>
            <div class="stats">
              <div class="kv"><b>Active Offers</b><span>${r.activeOffers}</span></div>
              <div class="kv"><b>Revenue</b><span class="money">${dollars(r.revenue)}</span></div>
              <div class="kv"><b>Clicks</b><span>${r.clicks}</span></div>
              <div class="kv"><b>Conversion</b><span>${r.conv.toFixed(2)}%</span></div>
            </div>
          </div>
          <div class="right flex">
            <span class="pill mono">${r.domain||'no-domain'}</span>
            <button class="btn secondary" data-view-acct="${r.account}">View Details</button>
          </div>
        </div>`;
      wrap.appendChild(card);
    });
  }catch(e){
    console.error(e);
    wrap.innerHTML = `<div class="card pad empty">Failed to load accounts.</div>`;
  }
}

/* Add New Account modal wiring (requires #mdl-cpa HTML block present) */
const mdl = document.getElementById('mdl-cpa');
const openMdl  = ()=> mdl && mdl.classList.add('open');
const closeMdl = ()=> mdl && mdl.classList.remove('open');
document.getElementById('btn-add-acct')?.addEventListener('click', openMdl);
mdl?.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) closeMdl(); });
document.getElementById('btn-save-acct')?.addEventListener('click', async ()=>{
  const err = document.getElementById('f-error');
  const v = {
    account : document.getElementById('f-account').value.trim(),
    network : document.getElementById('f-network').value.trim(),
    domain  : normDomain(document.getElementById('f-domain').value),
    status  : document.getElementById('f-status').value,
    apiKey  : document.getElementById('f-key').value.trim(),
    webhook : document.getElementById('f-webhook').value.trim()
  };
  if(!v.account || !v.network){
    err.textContent = 'Account Name and Network are required.'; err.style.display='block'; return;
  }
  err.style.display='none';
  try{
    const res = await apiWrite('cpaCreate', v);
    if(!res || res.ok!==true) throw new Error('Create failed');
    closeMdl();
    await initCpa();
  }catch(e){
    err.textContent = 'Could not save account. Please try again.'; err.style.display='block';
  }
});

/* ========= USERS ========= */
let currentUsersTab = 'APPROVED';
const userTabBtns = $$('[data-users-tab]');
userTabBtns.forEach(b=>b.addEventListener('click',()=>{
  userTabBtns.forEach(x=>x.classList.toggle('active', x===b));
  currentUsersTab = b.dataset.usersTab; initUsers(currentUsersTab);
}));
async function initUsers(tab='APPROVED'){
  const tb = $('#tbl-users'); tb.innerHTML = '';
  try{
    // ask backend with status hint
    const resp = await api('users', {status: tab});
    let list = arr(resp?.items || resp);
    // fallback: filter locally if backend returns all
    if (!list.length) {
      const all  = arr(resp?.items || resp);
      list = all.filter(u => String(u.status||'APPROVED').toUpperCase()===tab);
    }
    if(!list.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No ${tab.toLowerCase()} users.</td></tr>`; return; }
    list.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.name||'—'}</td><td>${u.email||''}</td><td>${u.phone||''}</td><td>${u.authority||'1x User'}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML = `<tr><td colspan="4" class="muted">Failed to load users.</td></tr>`;
  }
}

/* ========= ANALYTICS (base + live) ========= */
let liveTimer=null, liveRows=[];
async function initAnalytics(){
  try{
    const base = await api('analytics');
    const baseItems = arr(base) || arr(base?.items);
    // Overview chart: treat base items as {metric:date,value:number} or any series-like shape
    const seriesVals = baseItems.map(x=>toNum(x.value ?? x.earnings ?? x.clicks ?? 0));
    $('#ana-overview').innerHTML = seriesVals.length ? sparkline(seriesVals) : '<div class="empty">No data</div>';
    // Geo distribution (bar chart proxy: top 6 countries by clicks if present, else by value)
    const geoBucket = {};
    baseItems.forEach(x=>{
      const k = x.country || x.value || x.metric || '—';
      const v = toNum(x.clicks ?? x.earnings ?? x.value ?? 0);
      geoBucket[k] = (geoBucket[k]||0) + v;
    });
    const tops = Object.entries(geoBucket).map(([k,v])=>({k, v})).sort((a,b)=>b.v-a.v).slice(0,6);
    $('#ana-geo-dist').innerHTML = tops.length ? barlist(tops) : '<div class="empty">No data</div>';
  }catch(e){
    $('#ana-overview').innerHTML = '<div class="empty">No data</div>';
    $('#ana-geo-dist').innerHTML = '<div class="empty">No data</div>';
  }

  if(liveTimer) clearInterval(liveTimer);
  liveRows = [];
  liveTimer = setInterval(pullLive, POLL_FAST);
  await pullLive();
}
async function pullLive(){
  try{
    const j = await api('analytics', { live:1, limit:24, windowSec:120 });
    const events = arr(j?.live) || arr(j);
    // keep window
    liveRows = liveRows.concat(events).slice(-24);

    const tb = $('#tbl-live-perf'); tb.innerHTML='';
    if(!liveRows.length){
      tb.innerHTML='<tr><td colspan="6" class="muted">Waiting for stream…</td></tr>';
    }else{
      liveRows.slice().reverse().forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML =
          `<td class="mono">${r.time||''}</td><td>${r.country||''}</td><td>${r.offer||''}</td>`+
          `<td>${toNum(r.clicks)}</td><td>${toNum(r.leads ?? r.conversions ?? r.conv)}</td><td class="money">${dollars(toNum(r.earnings))}</td>`;
        tb.appendChild(tr);
      });
    }

    // recompute geo each poll from the newest payload only
    const byGeo = {};
    events.forEach(ev=>{
      const k = ev.country || 'Unknown';
      if(!byGeo[k]) byGeo[k] = {country:k, clicks:0, conv:0, earnings:0};
      byGeo[k].clicks   += toNum(ev.clicks);
      byGeo[k].conv     += toNum(ev.leads ?? ev.conversions ?? ev.conv);
      byGeo[k].earnings += toNum(ev.earnings);
    });

    const tb2 = $('#tbl-live-geo'); tb2.innerHTML='';
    const arrGeo = Object.values(byGeo).sort((a,b)=>b.earnings-a.earnings).slice(0,10);
    if(!arrGeo.length){
      tb2.innerHTML='<tr><td colspan="4" class="muted">Waiting for stream…</td></tr>';
    }else{
      arrGeo.forEach(g=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${g.country}</td><td>${g.clicks}</td><td>${g.conv}</td><td class="money">${dollars(g.earnings)}</td>`;
        tb2.appendChild(tr);
      });
    }
  }catch(e){ /* silent */ }
}

/* ========= WALLET ========= */
async function initWallet(){
  try{
    const w = obj(await api('wallet'));
    const hist = arr(w.history) || arr(w);

    $('#wal-balance').textContent = dollars(toNum(w.balance));

    const pendingAmt = hist.filter(t=>String(t.status||'').toUpperCase()==='PENDING')
                           .reduce((s,t)=>s+toNum(t.amount),0);
    $('#wal-pending').textContent = dollars(pendingAmt);

    const lastPaid = hist.filter(t=>String(t.status||'').toUpperCase()==='COMPLETED').slice(-1)[0];
    $('#wal-last').textContent = dollars(lastPaid ? toNum(lastPaid.amount) : 0);

    const tb = $('#tbl-wallet'); tb.innerHTML='';
    hist.slice().reverse().forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.date||''}</td><td>${t.method||''}</td><td class="money">${dollars(toNum(t.amount))}</td><td>${t.status||''}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="4" class="muted">No transactions.</td></tr>`;
  }catch(e){
    const tb = $('#tbl-wallet');
    if(tb) tb.innerHTML = `<tr><td colspan="4" class="muted">Failed to load.</td></tr>`;
  }
}

/* ========= MONITORING ========= */
async function initMonitor(){
  const tb = $('#tbl-monitor'); tb.innerHTML='';
  try{
    const m = obj(await api('monitoring'));
    const events = arr(m.events) || arr(m);

    $('#box-alerts').textContent = events.length;
    $('#box-maint').textContent  = m.maintenance || '—';
    $('#box-health').textContent = m.health || 'OK';

    if(!events.length){
      tb.innerHTML = `<tr><td colspan="3" class="muted">No events.</td></tr>`;
      return;
    }
    events.forEach(ev=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="mono">${ev.time||''}</td><td>${ev.type||''}</td><td>${ev.msg||ev.message||''}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML = `<tr><td colspan="3" class="muted">Failed to load.</td></tr>`;
  }
}

/* ========= SETTINGS ========= */
async function initSettings(){
  try{
    const j = await api('config');
    const pretty = v => { try{ return JSON.stringify(v, null, 2); }catch{ return String(v); } };
    $('#pretty').textContent = pretty(j);
  }catch(e){
    $('#pretty').textContent = 'Failed to load config';
  }
}

/* ========= BOOT ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  const r = (location.hash||'#dashboard').replace('#','');
  show(r);
});
</script>