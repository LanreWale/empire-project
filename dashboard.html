<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Empire — Command Dashboard</title>
<meta name="color-scheme" content="dark"/>

<link rel="stylesheet" href="/app/styles/brand.css"/>

<style>
:root{
  --bg:#0b1220; --panel:#0f182a; --ink:#e8eefc; --muted:#9fb2d1; --line:#1f2b44; --ring:#2f3b58;
  --gold1:#ffd24d; --gold2:#ffb11a; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 800px at 70% -10%, rgba(255,178,46,.12) 0%, rgba(255,178,46,0) 65%),
           linear-gradient(180deg, rgba(24,35,62,.55), rgba(24,35,62,.1)), var(--bg);
  color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
}
.shell{display:grid; grid-template-columns:260px 1fr; gap:18px; max-width:1280px; margin:0 auto; padding:24px 14px 40px}
@media(max-width:980px){ .shell{grid-template-columns:1fr} }
.sidebar{background:rgba(15,24,42,.9); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
.brandRow{display:flex; align-items:center; gap:10px; margin-bottom:16px}
.brandRow img{width:44px;height:44px}
.brandTitle{font-weight:900; letter-spacing:.3px; background:linear-gradient(90deg,var(--gold1),var(--gold2)); -webkit-background-clip:text; background-clip:text; color:transparent}
.nav{display:flex; flex-direction:column; gap:8px}
.nav button{ text-align:left; width:100%; background:#0f182a; border:1px solid var(--line); color:#cfe0ff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
.nav button.active{ outline:2px solid var(--ring) }
.top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px }
.top .right{display:flex; gap:8px; align-items:center}
.btn{background:#2b66f6; color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800}
.btn.alt{background:#25304a; color:#d1d5db; border:1px solid #2f3b58}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #2f3b58; background:#25304a}
.badge.ok{background:rgba(22,163,74,.2); border-color:#166534}
.badge.down{background:rgba(220,38,38,.2); border-color:#991b1b}
.badge.warn{background:rgba(245,158,11,.2); border-color:#b45309}
.panel{background:rgba(15,24,42,.9); border:1px solid var(--line); border-radius:16px; padding:16px; margin-bottom:16px}
.grid{display:grid; gap:14px}
@media(min-width:960px){ .cols-2{grid-template-columns:1fr 1fr} .cols-3{grid-template-columns:repeat(3,1fr)} .cols-4{grid-template-columns:repeat(4,1fr)} }
.card{background:#0f182a; border:1px solid var(--line); border-radius:14px; padding:16px}
.card .muted{color:var(--muted)}
.kpi{font-size:34px; font-weight:900}
.table{width:100%; border-collapse:collapse; font-size:14px}
.table th,.table td{padding:10px; border-bottom:1px solid var(--line); text-align:left}
.table th{color:#cfe0ff}
.tableScroll{overflow:auto}
.hidden{display:none !important}
label{display:block; font-size:13px; color:#cfe0ff; margin:10px 0 6px}
input,select,textarea{width:100%; background:#0b162a; color:#e8eefc; border:1px solid var(--ring); border-radius:12px; padding:12px 10px}
.row{display:flex; gap:10px; flex-wrap:wrap}
.row > *{flex:1}
.note{margin-top:10px; padding:10px; border-radius:10px}
.note.ok{background:#0f2a18; border:1px solid #1e5d38; color:#b7f7c3}
.note.err{background:#2a0f13; border:1px solid #5d1e28; color:#ffb4c0}
.chartBox{height:260px}
.status{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#121a2b}
.status.ACTIVE{background:rgba(22,163,74,.18); border-color:#166534}
.status.PENDING{background:rgba(245,158,11,.18); border-color:#b45309}
.status.BLOCKED{background:rgba(220,38,38,.18); border-color:#991b1b}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>

<div class="shell">
  <aside class="sidebar">
    <div class="brandRow">
      <img src="/app/assets/brand/commander_badge.png" alt="Supreme Command"/>
      <div>
        <div class="brandTitle">The Empire</div>
        <div style="font-size:12px;color:var(--muted)">Command & Control</div>
      </div>
    </div>

    <div class="nav">
      <button data-tab="dashboard" class="active">Dashboard Overview</button>
      <button data-tab="cpa">CPA Accounts</button>
      <button data-tab="users">User Management</button>
      <button data-tab="analytics">Performance Analytics</button>
      <button data-tab="wallet">Wallet</button>
      <button data-tab="security">System Security</button>
      <button data-tab="monitoring">Monitoring & Alerts</button>
    </div>
  </aside>

  <main>
    <div class="top">
      <div>
        <span class="badge" id="serverBadge">SERVER — …</span>
        <span class="badge" id="dbBadge">DB — …</span>
        <span class="badge" id="sheetsBadge">SHEETS — …</span>
        <span class="badge" id="aiBadge">AI — …</span>
      </div>
      <div class="right">
        <button id="btnSetAdmin" class="btn alt" type="button">Unlock Admin</button>
        <a class="btn" href="/index.html">Logout</a>
      </div>
    </div>

    <!-- ===== DASHBOARD OVERVIEW ===== -->
    <section id="view-dashboard" class="panel">
      <div class="grid cols-3">
        <div class="card"><div class="muted">Total Earnings (USD)</div><div id="kpi-earn" class="kpi">$0.00</div></div>
        <div class="card"><div class="muted">Active Users</div><div id="kpi-active" class="kpi">0</div></div>
        <div class="card"><div class="muted">Approval Rate</div><div id="kpi-approval" class="kpi">—</div></div>
        <div class="card"><div class="muted">Pending Reviews</div><div id="kpi-pending" class="kpi">0</div></div>
        <div class="card"><div class="muted">Total Clicks</div><div id="kpi-clicks" class="kpi">0</div></div>
        <div class="card"><div class="muted">Conversion Rate</div><div id="kpi-cr" class="kpi">—</div></div>
      </div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card"><div class="muted">Monthly Performance</div><div class="chartBox"><canvas id="chartMonthly"></canvas></div></div>
        <div class="card"><div class="muted">Geographic Distribution</div><div class="chartBox"><canvas id="chartGeo"></canvas></div></div>
      </div>

      <div class="panel">
        <div class="muted" style="margin-bottom:6px">Live Performance</div>
        <div class="tableScroll">
          <table class="table" id="tbl-live">
            <thead><tr><th>Time</th><th>Country</th><th>Offer</th><th>Device</th><th>Clicks</th><th>Leads</th><th>Earnings (USD)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== CPA ACCOUNTS ===== -->
    <section id="view-cpa" class="panel hidden">
      <div class="top" style="margin:0 0 6px">
        <div class="muted">All CPA Grip Accounts</div>
        <button id="btnAddCpaOpen" class="btn" type="button">Add New Account</button>
      </div>
      <div id="cpaGrid" class="grid cols-3"></div>

      <!-- Add Account Modal -->
      <div id="modalAddCpa" class="panel hidden">
        <h3 style="margin:0 0 6px">Add CPA Account</h3>
        <div class="row">
          <div><label>Name</label><input id="cpaName" placeholder="Account Name"/></div>
          <div><label>Domain</label><input id="cpaDomain" placeholder="example.com"/></div>
        </div>
        <div class="row">
          <div><label>User ID</label><input id="cpaUserId" placeholder="UID from network"/></div>
          <div><label>API Key</label><input id="cpaApiKey" placeholder="•••••••"/></div>
        </div>
        <div class="row">
          <div><label>Starting Revenue (USD)</label><input id="cpaStartRev" type="number" step="0.01" value="0"/></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnAddCpaSave" class="btn" type="button">Save</button>
          <button id="btnAddCpaClose" class="btn alt" type="button">Close</button>
        </div>
        <div id="cpaNote" class="note ok hidden">Saved.</div>
      </div>
    </section>

    <!-- ===== USER MANAGEMENT ===== -->
    <section id="view-users" class="panel hidden">
      <div class="grid cols-2">
        <div class="card">
          <div class="muted">Invite link (working)</div>
          <input id="inviteLink" readonly value="https://superlative-pothos-ebf5f2.netlify.app/?ref=SUPREME_COMMANDER"/>
        </div>
        <div class="card">
          <div class="muted">Pending Approvals</div>
          <div class="tableScroll" style="max-height:240px">
            <table class="table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th></th></tr></thead><tbody id="pendingBody"></tbody></table>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="top" style="margin:0 0 6px">
          <div class="muted">Approved Users</div>
          <button id="btnAddUserOpen" class="btn" type="button">Add New User</button>
        </div>
        <div class="tableScroll">
          <table class="table"><thead><tr><th>Name</th><th>Email</th><th>WhatsApp</th><th>Bank</th><th>Account</th><th>Authority</th><th>Status</th></tr></thead><tbody id="usersBody"></tbody></table>
        </div>
      </div>

      <!-- Add User Modal -->
      <div id="modalAddUser" class="panel hidden">
        <h3 style="margin:0 0 6px">Add User</h3>
        <div class="row">
          <div><label>Name</label><input id="uName"/></div>
          <div><label>Email</label><input id="uEmail" type="email"/></div>
        </div>
        <div class="row">
          <div><label>WhatsApp</label><input id="uWa" placeholder="+234..."/></div>
          <div><label>Authority</label><input id="uAuth" placeholder="User / Manager / Admin"/></div>
        </div>
        <div class="row">
          <div><label>Bank</label><input id="uBank"/></div>
          <div><label>Account</label><input id="uAcct"/></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnAddUserSave" class="btn" type="button">Save</button>
          <button id="btnAddUserClose" class="btn alt" type="button">Close</button>
        </div>
        <div id="userNote" class="note ok hidden">Saved.</div>
      </div>
    </section>

    <!-- ===== ANALYTICS ===== -->
    <section id="view-analytics" class="panel hidden">
      <div class="grid cols-2">
        <div class="card"><div class="muted">Monthly Performance</div><div class="chartBox"><canvas id="chartMonthly2"></canvas></div></div>
        <div class="card"><div class="muted">Geo Distribution</div><div class="chartBox"><canvas id="chartGeo2"></canvas></div></div>
      </div>
      <div class="panel">
        <div class="muted" style="margin-bottom:6px">Live Performance</div>
        <div class="tableScroll">
          <table class="table" id="tbl-live2">
            <thead><tr><th>Time</th><th>Country</th><th>Offer</th><th>Device</th><th>Clicks</th><th>Leads</th><th>Earnings (USD)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== WALLET ===== -->
    <section id="view-wallet" class="panel hidden">
      <div class="grid cols-4">
        <div class="card"><div class="muted">Available Balance</div><div id="w-available" class="kpi">$0.00</div></div>
        <div class="card"><div class="muted">Withdrawal Amount</div><div id="w-withdraw" class="kpi">$0.00</div></div>
        <div class="card"><div class="muted">Processing</div><div id="w-proc" class="kpi">$0.00</div></div>
        <div class="card"><div class="muted">Remaining</div><div id="w-remaining" class="kpi">$0.00</div></div>
      </div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div class="muted">Request Withdrawal</div>
          <div class="row">
            <div><label>Amount (USD)</label><input id="wd-amt" type="number" step="0.01" value="0"/></div>
            <div><label>Method</label>
              <select id="wd-method">
                <option value="">Select…</option>
                <option value="bank">Bank</option>
                <option value="wallet">Wallet</option>
                <option value="fintech">Fintech</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>Bank / Channel</label><select id="wd-bank"><option value="">—</option></select></div>
            <div><label>Account</label><input id="wd-acct" placeholder="1234567890"/></div>
          </div>
          <div class="row">
            <div><label>WhatsApp</label><input id="wd-wa" placeholder="+234..."/></div>
            <div><label>Account Name</label><input id="wd-name" readonly placeholder="Validate to fetch name"/></div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button id="btnValidate" class="btn alt" type="button">Validate Account</button>
            <button id="btnWithdraw" class="btn" type="button">Submit Request</button>
          </div>
          <div id="wdNote" class="note ok hidden">Submitted.</div>
          <div id="wdErr" class="note err hidden">Error.</div>
        </div>

        <div class="card">
          <div class="muted">Recent Wallet Activity</div>
          <div id="walletList"></div>
        </div>
      </div>
    </section>

    <!-- ===== SECURITY ===== -->
    <section id="view-security" class="panel hidden">
      <div class="grid cols-2">
        <div class="card">
          <div class="muted">Admin Controls</div>
          <div>Admin Secret: <span id="admStatus" class="badge">NOT SET</span></div>
          <div style="margin-top:10px">
            <button id="btnAdminSet" class="btn alt" type="button">Set / Change Admin Secret</button>
            <button id="btnAdminClear" class="btn alt" type="button">Clear</button>
          </div>
          <p class="muted" style="margin-top:8px">Used for approval actions via <code>/.netlify/functions/admin-pending</code>.</p>
        </div>
        <div class="card">
          <div class="muted">Public Config</div>
          <pre id="pubCfg" style="white-space:pre-wrap; font-size:12px"></pre>
        </div>
      </div>
    </section>

    <!-- ===== MONITORING ===== -->
    <section id="view-monitoring" class="panel hidden">
      <div class="grid cols-2">
        <div class="card">
          <div class="muted">System Health</div>
          <div style="margin-top:8px">Server: <span id="h-server" class="badge">—</span></div>
          <div>Database: <span id="h-db" class="badge">—</span></div>
          <div>Sheets: <span id="h-sheets" class="badge">—</span></div>
          <div>AI: <span id="h-ai" class="badge">—</span></div>
          <div class="muted" style="margin-top:10px">Auto-refresh every 15s.</div>
        </div>
        <div class="card">
          <div class="muted">Event Feed</div>
          <div class="tableScroll" style="max-height:340px">
            <table class="table">
              <thead><tr><th>Time</th><th>Type</th><th>Message</th><th>Ref</th><th>Actor</th></tr></thead>
              <tbody id="evBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="panel" style="text-align:center;opacity:.75">© Empire Affiliate Marketing Hub</div>
  </main>
</div>

<!-- Bootstrap: load public config, then dashboard.js -->
<script>
  (async () => {
    try {
      // default base to Netlify Functions; GAS set by public-config response
      window.EMPIRE_API = '/.netlify/functions';
      const res = await fetch('/.netlify/functions/public-config', { headers: { 'Cache-Control': 'no-cache' }});
      const cfg = await res.json().catch(()=> ({}));
      window.GAS_URL = cfg && (cfg.gasUrl || cfg.appsScriptUrl || '');
      // also show public config in Security tab
      window.__PUBLIC_CFG__ = cfg || {};
    } catch(e) {
      window.GAS_URL = '';
      window.__PUBLIC_CFG__ = { error: String(e) };
    } finally {
      var s = document.createElement('script');
      s.src = '/app/dashboard.js';
      document.body.appendChild(s);
    }
  })();
</script>
</body>
</html>