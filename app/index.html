<script>
  /* ======= GAS wiring ======= */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbx5FniYFG6YWADrBbfkzVmsGBeqh4Je28x-doOePGC2yolON_C8quh42_gpSdrV9eru/exec";
  const KEY     = "GENERALISIMO@15769";

  const $ = (id) => document.getElementById(id);
  const escapeHTML = (s) => String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
  const getPIN = () => localStorage.getItem("empire_cmd_user") || "";
  const setPIN = (v) => localStorage.setItem("empire_cmd_user", v || "");
  const headerAuth = () => (getPIN() ? { "x-cmd-user": getPIN() } : {});

  const setMsg = (el, ok, html) => {
    el.className = "msg " + (ok ? "ok" : "bad");
    el.innerHTML = html;
  };

  $("savePin").onclick = () => {
    setPIN($("pin").value.trim());
    $("pinStatus").textContent = "PIN saved (used as x-cmd-user header).";
  };
  $("clearPin").onclick = () => {
    setPIN("");
    $("pin").value = "";
    $("pinStatus").textContent = "PIN cleared.";
  };
  window.addEventListener("DOMContentLoaded", () => {
    $("pin").value = getPIN();
    $("pinStatus").textContent = getPIN() ? "PIN loaded." : "No PIN saved.";
  });

  // Generic POSTer to GAS ?action=...&key=...
  async function callGAS(action, body, msgEl){
    const url = `${GAS_URL}?action=${encodeURIComponent(action)}&key=${encodeURIComponent(KEY)}`;
    try{
      const headers = { "content-type": "application/json", ...headerAuth() };
      const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body || {}) });
      const data = await r.json();
      setMsg(msgEl, data.ok !== false, `<pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>`);
    }catch(e){
      setMsg(msgEl, false, escapeHTML(String(e)));
    }
  }

  /* ======= Button handlers (now pointing to GAS) ======= */
  // Create Invite
  $("btnInvite").onclick = () => {
    const body = {
      name: $("inv_name").value.trim(),
      email: $("inv_email").value.trim(),
      phone: $("inv_phone").value.trim(),
      telegramHandle: $("inv_tg").value.trim()
    };
    callGAS("invite-create", body, $("inviteMsg"));
  };

  // Approve / Reject User
  $("btnApprove").onclick = () => {
    const body = {
      name: $("appr_name").value.trim(),
      email: $("appr_email").value.trim(),
      phone: $("appr_phone").value.trim(),
      approve: $("appr_approve").value === "true"
    };
    callGAS("approve-user", body, $("apprMsg"));
  };

  // Set User Level
  $("btnLevel").onclick = () => {
    const body = {
      email: $("lvl_email").value.trim(),
      level: $("lvl_level").value.trim(),
      reason: $("lvl_reason").value.trim()
    };
    callGAS("user-level-set", body, $("lvlMsg"));
  };

  // Log Performance
  $("btnPerf").onclick = () => {
    const body = {
      email: $("perf_email").value.trim(),
      clicks: Number($("perf_clicks").value || 0),
      conversions: Number($("perf_conversions").value || 0),
      revenueUSD: Number($("perf_revenue").value || 0),
      level: $("perf_level").value.trim(),
      notes: $("perf_notes").value.trim(),
      phone: $("perf_phone").value.trim(),
      notify: $("perf_notify").value === "true"
    };
    callGAS("log-performance", body, $("perfMsg"));
  };
</script>