<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THE EMPIRE — Command Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --gold:#D4AF37; --ink:#0b0f14; --card:#111823; --muted:#8aa0b3; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14,#0a121c);color:#eaf2fb}
    header{padding:18px 20px;border-bottom:1px solid #152232;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;letter-spacing:.5px}
    .gold{color:var(--gold)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:var(--card);border:1px solid #1a2740;border-radius:16px;padding:16px}
    @media(min-width:900px){.span-3{grid-column:span 3}.span-4{grid-column:span 4}.span-6{grid-column:span 6}.span-8{grid-column:span 8}.span-12{grid-column:span 12}}
    .kpi{display:flex;align-items:center;justify-content:space-between;margin:6px 0;padding:12px;border-radius:12px;background:#0e1622}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .val{font-weight:800;font-size:22px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button,textarea{background:#0e1622;color:#eaf2fb;border:1px solid #22324d;border-radius:10px;padding:10px}
    button{cursor:pointer}
    .btn{background:var(--gold);color:#0a0d12;border:none;font-weight:700}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #1f2b42;padding:10px;text-align:left;font-size:14px}
  </style>
</head>
<body>
  <header>
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3 6 6 .9-4.5 4.2 1.1 6.9L12 17l-5.6 3 1.1-6.9L3 8.9 9 8l3-6z" fill="var(--gold)"/></svg>
    <div class="brand">THE <span class="gold">EMPIRE</span> — Command</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card span-8">
        <h3>Overview</h3>
        <div class="grid">
          <div class="span-6">
            <div class="kpi"><div><div class="label">Total Earnings</div><div id="kpi-earn" class="val">—</div></div></div>
            <div class="kpi"><div><div class="label">Leads</div><div id="kpi-leads" class="val">—</div></div></div>
            <div class="kpi"><div><div class="label">Clicks</div><div id="kpi-clicks" class="val">—</div></div></div>
          </div>
          <div class="span-6">
            <div class="kpi"><div><div class="label">Conversion Rate</div><div id="kpi-cr" class="val">—</div></div></div>
            <div class="kpi"><div><div class="label">EPC</div><div id="kpi-epc" class="val">—</div></div></div>
            <div class="kpi"><div><div class="label">CPA</div><div id="kpi-cpa" class="val">—</div></div></div>
          </div>
        </div>
      </section>

      <section class="card span-4">
        <h3>Wallet</h3>
        <div class="kpi"><div><div class="label">Balance</div><div id="wallet-balance" class="val">—</div></div></div>
        <div class="row">
          <input id="wd-amount" type="number" placeholder="Amount" />
          <select id="wd-method">
            <option value="bank">Bank</option>
            <option value="flutterwave">Flutterwave</option>
            <option value="payoneer">Payoneer</option>
          </select>
          <input id="wd-details" placeholder="Acct/Email/Notes" />
          <button id="wd-btn" class="btn">Request Withdrawal</button>
        </div>
        <div class="muted" id="wd-msg" style="margin-top:8px"></div>
      </section>

      <section class="card span-6">
        <h3>Daily Earnings</h3>
        <canvas id="chart-daily" height="140"></canvas>
      </section>

      <section class="card span-6">
        <h3>Traffic Sources</h3>
        <canvas id="chart-sources" height="140"></canvas>
      </section>

      <section class="card span-12">
        <h3>Geographic Distribution</h3>
        <table class="table" id="geo-table"><thead><tr><th>Country</th><th>Earnings</th></tr></thead><tbody></tbody></table>
      </section>

      <section class="card span-12">
        <h3>Monitoring — Recent Events</h3>
        <table class="table" id="mon-table"><thead><tr><th>Timestamp</th><th>Event</th><th>Meta</th><th>Actor</th><th>Note</th></tr></thead><tbody></tbody></table>
      </section>
    </div>
  </div>

  <script>
    // === CONFIG: set your GAS Web App URL here ===
    window.GAS_URL = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYMENT/exec";

    async function api(action, opts={}){
      const u = new URL(window.GAS_URL);
      u.searchParams.set('action', action);
      const res = await fetch(u, { method:'GET', cache:'no-store' });
      return res.json();
    }
    async function post(action, body={}){
      const data = new URLSearchParams({ action, ...body });
      const res = await fetch(window.GAS_URL, { method:'POST', body:data });
      return res.json();
    }

    function fmt(n){
      if (typeof n !== 'number') n = Number(n||0);
      return n.toLocaleString(undefined,{maximumFractionDigits:2});
    }

    async function boot(){
      const bundle = await api('bundle');
      if (!bundle.ok) throw new Error(bundle.error||'Bundle failed');
      const { totals, daily, sources, geo, wallet, monitor } = bundle;

      // KPIs
      document.getElementById('kpi-earn').textContent   = '$'+fmt(totals.earnings||0);
      document.getElementById('kpi-leads').textContent   = fmt(totals.leads||0);
      document.getElementById('kpi-clicks').textContent  = fmt(totals.clicks||0);
      document.getElementById('kpi-cr').textContent      = (totals.conversionRate||0)+"%";
      document.getElementById('kpi-epc').textContent     = '$'+fmt(totals.epc||0);
      document.getElementById('kpi-cpa').textContent     = '$'+fmt(totals.cpa||0);
      document.getElementById('wallet-balance').textContent = '$'+fmt(wallet.balance||0);

      // Geo table
      const gt = document.querySelector('#geo-table tbody'); gt.innerHTML='';
      (geo||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.country}</td><td>$${fmt(r.earnings)}</td>`; gt.appendChild(tr); });

      // Monitoring table
      const mt = document.querySelector('#mon-table tbody'); mt.innerHTML='';
      (monitor||[]).slice(-50).reverse().forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.timestamp||''}</td><td>${r.event||''}</td><td>${r.meta||''}</td><td>${r.actor||''}</td><td>${r.note||''}</td>`;
        mt.appendChild(tr);
      });

      // Charts
      renderDaily(daily||[]); renderSources(sources||[]);

      // Wire withdrawal
      document.getElementById('wd-btn').onclick = async ()=>{
        const amount = Number(document.getElementById('wd-amount').value||0);
        const method = document.getElementById('wd-method').value;
        const details= document.getElementById('wd-details').value;
        if (!amount || amount<=0) { return msg('Enter a valid amount'); }
        const r = await post('withdraw', { user:'COMMANDER', amount, method, details });
        msg(r.ok ? 'Withdrawal submitted. Check Withdrawals sheet.' : ('Error: '+(r.error||'unknown')));
      }
      function msg(t){ document.getElementById('wd-msg').textContent=t; }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    function renderDaily(rows){
      const ctx = document.getElementById('chart-daily');
      new Chart(ctx, { type:'line', data:{ labels: rows.map(r=>r.date), datasets:[{ label:'Earnings', data: rows.map(r=>r.earnings) }] }, options:{ responsive:true, maintainAspectRatio:false } });
    }
    function renderSources(rows){
      const ctx = document.getElementById('chart-sources');
      new Chart(ctx, { type:'bar', data:{ labels: rows.map(r=>r.source), datasets:[{ label:'Earnings', data: rows.map(r=>r.earnings) }] }, options:{ responsive:true, maintainAspectRatio:false } });
    }
    // boot page
    boot().catch(err=>{ console.error(err); alert('Boot failed: '+err.message); });
  </script>
</body>
</html>