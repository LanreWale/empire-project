<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THE EMPIRE ‚Äî Command Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#0c121b;--panel:#0f1623;--panel-2:#121b2a;--ink:#cfe3ff;--muted:#8ea4c7;
    --accent:#ffd24d;--accent-2:#ffb703;--good:#40d589;--bad:#ff6b6b;--line:#1e2940;
    --ring: 0 0 0 2px #213455, 0 0 0 4px rgba(255,210,77,.25);
    --rad:14px;--rad-sm:10px;--shadow:0 8px 30px rgba(0,0,0,.35)
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:14px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0c121be6 50%,#0c121b00);backdrop-filter:blur(6px)}
  .brand{font-weight:800;letter-spacing:.1em}
  .nav{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid var(--line)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 10px;border-radius:10px;background:#0e1522;color:var(--muted);border:1px solid #142036;cursor:pointer}
  .tab.active{color:#fff;background:#142036}
  .cta{padding:9px 12px;border-radius:10px;background:var(--accent);color:#2d2312;font-weight:700;border:none;cursor:pointer}
  .grid{display:grid;gap:14px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow)}
  .panel .title{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700;color:#e9f2ff}
  .panel .body{padding:14px 16px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi{background:#101a2b;border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi .lbl{color:var(--muted);font-size:12px}
  .kpi .val{font-weight:800;font-size:20px;margin-top:2px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 10px;border-bottom:1px solid var(--line)}
  th{color:#a9bee0;text-transform:uppercase;font-size:12px;letter-spacing:.04em;text-align:left}
  tr:hover td{background:#0e1524}
  .muted{color:var(--muted)}
  .empty{color:#99aac9;padding:14px}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .modal .backdrop{position:absolute;inset:0;background:#0009}
  .modal .panel{position:relative;min-width:min(720px,92vw)}
  .modal .x{position:absolute;top:10px;right:10px;background:#18243b;border:1px solid var(--line);width:34px;height:34px;border-radius:10px;color:#9fb6db;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .label{color:#9fb6db;font-size:12px}
  .input,.select{background:#0e1626;border:1px solid #1a2741;border-radius:10px;padding:10px 11px;color:#d9e7ff;outline:none}
  .input:focus,.select:focus{box-shadow:var(--ring)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #273756;background:#15223a;color:#cde1ff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#2a230f;border-color:#f3c43a;font-weight:800}
  .footer-actions{display:flex;gap:10px;justify-content:flex-end;padding-top:6px}
  /* sections */
  .section{display:none}
  .section.show{display:block}
  canvas{width:100%!important;height:260px!important}
  .pill{display:inline-flex;align-items:center;padding:6px 8px;border-radius:999px;background:#15223a;border:1px solid #223151;color:#9fb6db;font-size:12px;margin-right:6px}
  @media (max-width:900px){
    .kpis{grid-template-columns:1fr 1fr}
    .grid.cols-2{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header class="topbar">
  <div class="nav wrap">
    <div class="brand">üõ°Ô∏è THE EMPIRE</div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-target="overview">Overview</button>
      <button class="tab" data-target="cpa">CPA Accounts</button>
      <button class="tab" data-target="users">Users</button>
      <button class="tab" data-target="analytics">Analytics</button>
      <button class="tab" data-target="wallet">Wallet</button>
      <button class="tab" data-target="monitoring">Monitoring</button>
      <button class="tab" data-target="settings">Settings</button>
    </div>
    <button id="btnAdd" class="cta">+ Add Account</button>
  </div>
</header>

<main class="wrap">
  <!-- OVERVIEW -->
  <section id="overview" class="section show">
    <h2>WELCOME TO THE EMPIRE</h2>
    <div class="kpis" id="kpiRow">
      <div class="kpi"><div class="lbl">Daily Earnings</div><div class="val" id="kpi-earn">$0.00</div></div>
      <div class="kpi"><div class="lbl">Total Clicks</div><div class="val" id="kpi-clicks">0</div></div>
      <div class="kpi"><div class="lbl">Total Leads</div><div class="val" id="kpi-leads">0</div></div>
      <div class="kpi"><div class="lbl">Conversion Rate</div><div class="val" id="kpi-cr">0.00%</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:14px">
      <div class="panel">
        <div class="title">Daily Earnings</div>
        <div class="body"><canvas id="chartDaily"></canvas></div>
      </div>
      <div class="panel">
        <div class="title">Traffic Sources</div>
        <div class="body empty muted">No data.</div>
      </div>
      <div class="panel">
        <div class="title">By GEO</div>
        <div class="body"><table><thead><tr><th>Country</th><th>Earnings ($)</th></tr></thead><tbody id="tbl-geo"></tbody></table></div>
      </div>
      <div class="panel">
        <div class="title">By DEVICE</div>
        <div class="body"><table><thead><tr><th>Device</th><th>Earnings ($)</th></tr></thead><tbody id="tbl-device"></tbody></table></div>
      </div>
    </div>
    <div id="ovr-err" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- CPA -->
  <section id="cpa" class="section">
    <h2>CPA ACCOUNTS</h2>
    <div class="panel">
      <div class="body">
        <table>
          <thead>
            <tr><th>Account</th><th>Network</th><th>Custom Domain</th><th>Active Offers</th><th>Revenue ($)</th><th>Clicks</th><th>Conversion (%)</th></tr>
          </thead>
          <tbody id="tbl-cpa"><tr><td colspan="7" class="empty">No CPA accounts yet.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- USERS -->
  <section id="users" class="section">
    <h2>USERS MANAGEMENT</h2>
    <div class="body" style="margin:10px 0">
      <span class="pill" id="u-all">All</span>
      <span class="pill" id="u-approved">Approved</span>
      <span class="pill" id="u-pending">Pending</span>
      <span class="pill" id="u-rejected">Rejected</span>
    </div>
    <div class="panel">
      <div class="body">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Authority</th></tr></thead>
          <tbody id="tbl-users"><tr><td colspan="4" class="empty">Failed to load users.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section id="analytics" class="section">
    <h2>ANALYTICS</h2>
    <div class="grid cols-2">
      <div class="panel"><div class="title">Performance Overview</div><div class="body"><canvas id="chartPerf"></canvas></div></div>
      <div class="panel"><div class="title">Geographic Distribution</div><div class="body"><canvas id="chartGeo"></canvas></div></div>
    </div>
    <div id="ana-err" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- WALLET -->
  <section id="wallet" class="section">
    <h2>WALLET</h2>
    <div class="grid cols-2">
      <div class="panel">
        <div class="title">Transaction History</div>
        <div class="body">
          <table>
            <thead><tr><th>Date</th><th>Method</th><th>Amount ($)</th><th>Status</th></tr></thead>
            <tbody id="tbl-wallet"><tr><td colspan="4" class="empty">No transactions.</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="panel">
        <div class="title">Validate Account</div>
        <div class="body">
          <div class="row">
            <div class="field"><label class="label">Country</label>
              <select class="select" id="w-country"><option value="NG">NG</option><option value="US">US</option></select></div>
            <div class="field"><label class="label">Bank Code</label><input class="input" id="w-bankcode" placeholder="058" /></div>
            <div class="field"><label class="label">Account Number</label><input class="input" id="w-acct" placeholder="0123456789" /></div>
            <div class="field"><label class="label">&nbsp;</label><button class="btn" id="btnValidate">Validate</button></div>
            <div class="field"><label class="label">Phone</label><input class="input" id="w-phone" placeholder="+234..." /></div>
            <div class="field"><label class="label">Amount (USD)</label><input class="input" id="w-amt" value="200" /></div>
          </div>
          <div class="footer-actions"><button class="btn primary" id="btnWithdraw">Request Withdrawal</button></div>
          <div id="w-msg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- MONITORING -->
  <section id="monitoring" class="section">
    <h2>MONITORING</h2>
    <div class="panel">
      <div class="body">
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead>
          <tbody id="tbl-mon"><tr><td colspan="3" class="empty">No events.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="section">
    <h2>SETTINGS</h2>
    <div class="panel">
      <div class="body"><pre id="cfg" class="muted">{}</pre></div>
    </div>
  </section>
</main>

<!-- ADD CPA ACCOUNT MODAL -->
<div class="modal" id="cpaModal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="panel">
    <button class="x" title="Close" data-close>√ó</button>
    <div class="title">Add New CPA Account</div>
    <div class="body">
      <form id="cpaForm">
        <div class="row">
          <div class="field"><label class="label">Account Name</label><input class="input" name="accountName" required /></div>
          <div class="field"><label class="label">Network</label>
            <select class="select" name="network" required>
              <option value="">Select‚Ä¶</option><option>CPA Grip</option><option>CPAlead</option><option>AdWork Media</option><option>OGAds</option>
            </select></div>
          <div class="field"><label class="label">Account ID</label><input class="input" name="accountId" required /></div>
          <div class="field"><label class="label">Custom Domain</label><input class="input" name="domain" placeholder="yourdomain.com" /></div>
          <div class="field"><label class="label">Active Offers</label><input class="input" name="activeOffers" type="number" value="0"/></div>
          <div class="field"><label class="label">Revenue (USD)</label><input class="input" name="revenue" type="number" step="0.01" value="0"/></div>
          <div class="field"><label class="label">Clicks</label><input class="input" name="clicks" type="number" value="0"/></div>
          <div class="field"><label class="label">Conversion Rate (%)</label><input class="input" name="conversionRate" type="number" step="0.01" value="0.00"/></div>
        </div>
        <div class="footer-actions">
          <button type="button" class="btn" data-close>Cancel</button>
          <button type="submit" class="btn primary">+ Add Account</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ====== CONFIG ====== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZVlGMvYonfCNdQlwPHiqqgOVC80_HsyktSYmqmQPBKmRrlzg_yo4lKz_Mmu85B7eY/exec';

/* ====== SIMPLE HELPERS ====== */
const $ = (q, el=document)=>el.querySelector(q);
const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
const fmtUsd = n => '$' + Number(n||0).toFixed(2);

/* ====== TABS ====== */
$('#tabs').addEventListener('click', (e)=>{
  const btn = e.target.closest('.tab'); if(!btn) return;
  $$('.tab').forEach(t=>t.classList.toggle('active', t===btn));
  const target = btn.dataset.target;
  $$('.section').forEach(s=>s.classList.toggle('show', s.id===target));
});

/* ====== FETCH HELPERS ====== */
async function apiGet(action){
  const res = await fetch(`${GAS_URL}?action=${encodeURIComponent(action)}`);
  return res.json();
}
async function apiPost(payload){
  const res = await fetch(GAS_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  return res.json();
}

/* ====== OVERVIEW + ANALYTICS (from single Analytics tab) ====== */
let chartDaily, chartPerf, chartGeo;
async function loadAnalytics(){
  try{
    const a = await apiGet('analytics'); // uses consolidated 'Analytics' sheet
    // KPIs (from overview)
    const earn = a.overview?.earnings||0, leads=a.overview?.leads||0, clicks=a.overview?.clicks||0;
    $('#kpi-earn').textContent = fmtUsd(earn);
    $('#kpi-leads').textContent = leads;
    $('#kpi-clicks').textContent = clicks;
    const cr = clicks ? (leads/clicks*100) : 0;
    $('#kpi-cr').textContent = cr.toFixed(2)+'%';

    // Daily chart
    const days = (a.byDay||[]).map(r=>({t:String(r.date), v:Number(r.earnings||0)}));
    if(chartDaily) chartDaily.destroy();
    chartDaily = new Chart($('#chartDaily'), {
      type:'line',
      data:{ labels:days.map(d=>d.t), datasets:[{label:'Earnings', data:days.map(d=>d.v)}] },
      options:{ scales:{ y:{beginAtZero:true} } }
    });

    // Geo table
    const geoT = $('#tbl-geo'); geoT.innerHTML='';
    (a.byGeo||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.country||r.Country||''}</td><td>${fmtUsd(r.earnings)}</td>`;
      geoT.appendChild(tr);
    });

    // Device table
    const devT = $('#tbl-device'); devT.innerHTML='';
    (a.byDevice||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.device||r.Device||''}</td><td>${fmtUsd(r.earnings)}</td>`;
      devT.appendChild(tr);
    });

    // Analytics section charts
    if(chartPerf) chartPerf.destroy();
    chartPerf = new Chart($('#chartPerf'), {
      type:'bar',
      data:{ labels:days.map(d=>d.t), datasets:[{label:'Earnings', data:days.map(d=>d.v)}] },
      options:{ scales:{ y:{beginAtZero:true} } }
    });

    if(chartGeo) chartGeo.destroy();
    const geo = (a.byGeo||[]);
    chartGeo = new Chart($('#chartGeo'), {
      type:'doughnut',
      data:{ labels:geo.map(g=>g.country), datasets:[{data:geo.map(g=>Number(g.earnings||0))}] }
    });

    $('#ovr-err').textContent='';
    $('#ana-err').textContent='';
  }catch(err){
    $('#ovr-err').textContent = 'Failed to load overview.';
    $('#ana-err').textContent = 'Failed to load analytics.';
    console.error(err);
  }
}

/* ====== CPA ACCOUNTS ====== */
async function loadCpa(){
  try{
    const j = await apiGet('cpa');
    const tbody = $('#tbl-cpa'); tbody.innerHTML='';
    if(!j.items || !j.items.length){
      tbody.innerHTML = `<tr><td colspan="7" class="empty">No CPA accounts yet.</td></tr>`;
      return;
    }
    j.items.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.account||''}</td>
        <td>${r.network||''}</td>
        <td>${r.domain||''}</td>
        <td>${r.activeOffers||0}</td>
        <td>${fmtUsd(r.revenue)}</td>
        <td>${r.clicks||0}</td>
        <td>${((r.conversionRate||0)*100).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
  }catch(e){
    console.error(e);
  }
}

/* ====== USERS ====== */
async function loadUsers(){
  try{
    const j = await apiGet('users');
    const tbody = $('#tbl-users'); tbody.innerHTML='';
    (j.items||[]).forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${u.name||''}</td><td>${u.email||''}</td><td>${u.phone||''}</td><td>${u.authority||''}</td>`;
      tbody.appendChild(tr);
    });
    if(!tbody.children.length) tbody.innerHTML=`<tr><td colspan="4" class="empty">No users.</td></tr>`;
  }catch(e){
    $('#tbl-users').innerHTML=`<tr><td colspan="4" class="empty">Failed to load users.</td></tr>`;
  }
}

/* ====== WALLET ====== */
async function loadWallet(){
  try{
    const j = await apiGet('wallet');
    const tb = $('#tbl-wallet'); tb.innerHTML='';
    (j.history||[]).forEach(h=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${h.date||''}</td><td>${h.method||''}</td><td>${fmtUsd(h.amount)}</td><td>${h.status||''}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="4" class="empty">No transactions.</td></tr>`;
  }catch(e){ console.error(e); }
}
$('#btnValidate').addEventListener('click', async ()=>{
  const params = new URLSearchParams({
    action:'validateBank',
    country: $('#w-country').value,
    code: $('#w-bankcode').value,
    acct: $('#w-acct').value
  });
  const res = await fetch(`${GAS_URL}?${params}`); const j = await res.json();
  $('#w-msg').textContent = j.valid ? `‚úÖ ${j.holder||'Verified Account'}` : `‚ùå ${j.message||'Invalid account'}`;
});
$('#btnWithdraw').addEventListener('click', async ()=>{
  const payload = {
    action:'withdraw',
    amount: Number($('#w-amt').value||0),
    method:'Bank',
    country: $('#w-country').value,
    bankCode: $('#w-bankcode').value,
    account: $('#w-acct').value,
    phone: $('#w-phone').value
  };
  const j = await apiPost(payload);
  $('#w-msg').textContent = j.ok ? `‚úÖ Request ID: ${j.requestId}` : `‚ùå ${j.error||'Failed'}`;
  if(j.ok) loadWallet();
});

/* ====== MONITORING ====== */
async function loadMonitoring(){
  try{
    const j = await apiGet('monitoring');
    const tb = $('#tbl-mon'); tb.innerHTML='';
    (j.events||[]).forEach(ev=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ev.time||''}</td><td>${ev.type||''}</td><td>${ev.msg||''}</td>`;
      tb.appendChild(tr);
    });
    if(!tb.children.length) tb.innerHTML = `<tr><td colspan="3" class="empty">No events.</td></tr>`;
  }catch(e){ console.error(e); }
}

/* ====== SETTINGS ====== */
async function loadConfig(){
  try{
    const j = await apiGet('config');
    $('#cfg').textContent = JSON.stringify(j, null, 2);
  }catch(e){
    $('#cfg').textContent = 'Failed to load config.';
  }
}

/* ====== MODAL (Add CPA) ====== */
const modal = $('#cpaModal');
const openModal = ()=>modal.classList.add('show');
const closeModal = ()=>modal.classList.remove('show');
$('#btnAdd').addEventListener('click', openModal);
modal.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeModal(); });

$('#cpaForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  const payload = { action:'addcpa', ...data };
  try{
    const j = await apiPost(payload);
    if(!j.ok) throw new Error(j.error||'Add failed');
    closeModal();
    await loadCpa();
    alert('CPA account added ‚úîÔ∏è');
  }catch(err){
    alert('Add CPA failed: ' + err.message);
  }
});

/* ====== INITIAL LOAD ====== */
(async function init(){
  await Promise.all([loadAnalytics(), loadCpa(), loadUsers(), loadWallet(), loadMonitoring(), loadConfig()]);
})();
</script>
</body>
</html>