<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>THE EMPIRE â€” Command Dashboard</title>
<link rel="icon" href="assets/brand/empire-logo.png" type="image/png"/>
<style>
  :root{ --bg:#0f1620; --panel:#121a25; --ink:#e9eef6; --muted:#8ca1c2; --brand:#f2c230; --line:#223046; }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  input,select,button{background:#0d1420;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
  .nav-btn{cursor:pointer}
  .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
  .side{background:#0c121a;border-right:1px solid var(--line);padding:14px 10px}
  .brand{display:flex;align-items:center;gap:8px;padding:8px 10px;margin-bottom:8px}
  .brand img{width:20px;height:20px}
  .brand .t1{font-weight:800;letter-spacing:.5px}
  .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .nav button{all:unset;cursor:pointer;padding:9px 12px;border-radius:8px;color:var(--muted)}
  .nav button.active,.nav button:hover{background:var(--panel);color:var(--ink);border:1px solid var(--line)}
  main{padding:18px}
  h1{font-size:18px;letter-spacing:.6px;margin:0 0 12px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .span-12{grid-column:span 12}
  .span-6{grid-column:span 6}
  .span-4{grid-column:span 4}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .kpi{background:var(--panel);border:1px solid var(--line);padding:10px 12px;border-radius:10px;min-width:120px}
  .kpi .lab{color:var(--muted);font-size:12px}
  .kpi .val{font-weight:800;font-size:18px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .panel h3{margin:0 0 10px 0;font-size:13px;color:var(--muted);letter-spacing:.3px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--line)}
  th{color:var(--muted);text-align:left;font-weight:600}
  .muted{color:var(--muted)}
  .note{padding:10px;border-radius:8px}
  .note.err{background:#2b1114;border:1px solid #541015}
  .hidden{display:none}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .hero{background:url('assets/brand/welcome_banner.jpg') center/cover no-repeat;min-height:90px;border-radius:12px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;letter-spacing:2px}
  .spark{height:30px;width:120px;display:block}
  @media(max-width:1024px){ .grid{grid-template-columns:repeat(6,1fr)} .span-6{grid-column:span 6} .span-4{grid-column:span 6} }
  @media(max-width:680px){ .app{grid-template-columns:1fr} .side{position:sticky;top:0;z-index:2} }
</style>
</head>
<body>
<div class="app">
  <aside class="side">
    <div class="brand">
      <img src="assets/brand/empire-logo.png" alt="The Empire"/>
      <div class="t1">THE EMPIRE</div>
    </div>
    <div class="nav">
      <button class="active" data-tab="dashboard">Overview</button>
      <button data-tab="cpa">CPA Accounts</button>
      <button data-tab="users">Users</button>
      <button data-tab="analytics">Analytics</button>
      <button data-tab="wallet">Wallet</button>
      <button data-tab="monitoring">Monitoring</button>
      <button data-tab="settings">Settings</button>
    </div>
  </aside>

  <main>
    <!-- ============ OVERVIEW ============ -->
    <section id="view-dashboard" class="view">
      <h1>COMMAND DASHBOARD</h1>
      <div class="hero span-12">WELCOME TO THE EMPIRE</div>

      <div class="kpis">
        <div class="kpi">
          <div class="lab">Earnings</div><div class="val" id="kpi-earn">$0.00</div>
          <canvas id="earn-spark" class="spark"></canvas>
        </div>
        <div class="kpi"><div class="lab">Leads</div><div class="val" id="kpi-leads">0</div></div>
        <div class="kpi"><div class="lab">Clicks</div><div class="val" id="kpi-clicks">0</div></div>
        <div class="kpi"><div class="lab">EPC</div><div class="val" id="kpi-epc">$0.00</div></div>
        <div class="kpi"><div class="lab">CPA</div><div class="val" id="kpi-cpa">$0.00</div></div>
        <div class="kpi"><div class="lab">RPM</div><div class="val" id="kpi-rpm">$0.00</div></div>
        <div class="kpi"><div class="lab">Conv. Rate</div><div class="val" id="kpi-cr">0.00%</div></div>
      </div>

      <div class="grid">
        <div class="panel span-6">
          <h3>BY GEO</h3>
          <table id="tbl-geo"><thead><tr><th>Country</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>BY DEVICE</h3>
          <table id="tbl-device"><thead><tr><th>Device</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>BY OFFER TYPE</h3>
          <table id="tbl-offer"><thead><tr><th>Offer Type</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>BY DAY</h3>
          <table id="tbl-day"><thead><tr><th>Date</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="ovrErr" class="note err hidden">Failed to load overview.</div>
    </section>

    <!-- ============ CPA ACCOUNTS ============ -->
    <section id="view-cpa" class="view hidden">
      <h1>CPA ACCOUNTS</h1>
      <div style="text-align:right;margin-bottom:10px">
        <button id="btnAddCpa" class="nav-btn">+ Add New Account</button>
      </div>
      <div id="cpaGrid" class="grid"></div>
    </section>

    <!-- Modal -->
    <div id="cpaModal" class="hidden" style="position:fixed;inset:0;background:#0009;display:flex;align-items:center;justify-content:center;z-index:50">
      <div class="panel" style="width:520px;max-width:95%">
        <h3>Add CPA Account</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <input id="cpa_id" placeholder="Account ID"/>
          <input id="cpa_network" placeholder="Network (e.g., CPA Grip)"/>
          <input id="cpa_domain" placeholder="Custom Domain"/>
          <input id="cpa_offers" placeholder="Active Offers" type="number"/>
          <input id="cpa_clicks" placeholder="Clicks" type="number"/>
          <input id="cpa_revenue" placeholder="Revenue (USD)" type="number" step="0.01"/>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="cpaSave" class="nav-btn">Save</button>
          <button id="cpaCancel" class="nav-btn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ============ USERS ============ -->
    <section id="view-users" class="view hidden">
      <h1>USERS</h1>
      <table id="tbl-users">
        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Authority</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ============ ANALYTICS ============ -->
    <section id="view-analytics" class="view hidden">
      <h1>ANALYTICS</h1>
      <table id="tbl-analytics"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- ============ WALLET ============ -->
    <section id="view-wallet" class="view hidden">
      <h1>WALLET</h1>
      <div class="kpis">
        <div class="kpi"><div class="lab">Balance</div><div class="val" id="wallet-balance">$0.00</div></div>
      </div>

      <div class="panel span-12" style="margin-bottom:12px">
        <h3>Universal Withdrawal Request</h3>
        <div class="grid">
          <div class="span-4"><label class="muted">WhatsApp (for notifications)</label><input id="wd_phone" placeholder="e.g., +2348012345678" style="width:100%"></div>
          <div class="span-4"><label class="muted">Payment Method</label>
            <select id="wd_method" style="width:100%">
              <option value="Bank">Bank</option>
              <option value="Payoneer">Payoneer</option>
              <option value="Wise">Wise</option>
              <option value="Crypto">Crypto (USDT)</option>
            </select>
          </div>
          <div class="span-4"><label class="muted">Country/Region</label>
            <select id="wd_country" style="width:100%">
              <option value="NG">Nigeria</option>
              <option value="US">United States</option>
              <option value="GB">United Kingdom</option>
              <option value="CA">Canada</option>
            </select>
          </div>

          <div class="span-3"><label class="muted">Bank Name</label><input id="wd_bank" placeholder="e.g., GTBank" style="width:100%"></div>
          <div class="span-3"><label class="muted">Bank Code</label><input id="wd_bankcode" placeholder="e.g., 058 (NG)" style="width:100%"></div>
          <div class="span-3"><label class="muted">Account Number</label><input id="wd_acct" placeholder="10-digit NUBAN" style="width:100%"></div>
          <div class="span-3"><label class="muted">Account Holder Name</label><input id="wd_name" placeholder="Auto-filled if verified" style="width:100%"></div>

          <div class="span-3"><label class="muted">Payout Category</label>
            <select id="wd_cat" style="width:100%">
              <option>Traditional Banks</option>
              <option>Fintech Wallets</option>
              <option>Crypto</option>
            </select>
          </div>
          <div class="span-3"><label class="muted">Amount (USD)</label><input id="wd_amt" type="number" step="1" min="1" placeholder="Minimum $200" style="width:100%"></div>
          <div class="span-3"><label class="muted">Withdrawal Amount</label><div id="wd_withdraw" class="val">$0.00</div></div>
          <div class="span-3"><label class="muted">Remaining Balance</label><div id="wd_remaining" class="val">$0.00</div></div>
        </div>

        <div id="wd_msg" class="note hidden" style="margin-top:10px"></div>
        <div style="margin-top:10px">
          <button id="wd_validate" class="nav-btn">Validate Account</button>
          <button id="wd_request" class="nav-btn">Request Withdrawal</button>
        </div>
      </div>

      <div id="walletList" class="grid"></div>
    </section>

    <!-- ============ MONITORING ============ -->
    <section id="view-monitoring" class="view hidden">
      <h1>MONITORING</h1>
      <table id="tbl-monitor"><thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- ============ SETTINGS ============ -->
    <section id="view-settings" class="view hidden">
      <h1>SETTINGS</h1>
      <pre id="cfgDump" class="panel" style="white-space:pre-wrap"></pre>
    </section>
  </main>
</div>

<script>
  /* ======= CONFIG ======= */
  const GAS_BASE = "https://script.google.com/macros/s/AKfycbybjkx3-vLj8D3LZgvG7YWdOgJOnQdxIZ56MZ8KtnIZoBFjIJcYveX8IZ8j9rVtpKtR/exec";
  const api = (action, params={}) => {
    const u = new URL(GAS_BASE);
    u.searchParams.set('action', action);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
    return u.toString();
  };

  /* ======= UTILS ======= */
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (n) => (+n || 0).toLocaleString();
  const usd = (n) => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(+n||0);
  async function jget(url){ const r = await fetch(url,{cache:'no-store',headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }
  async function jpost(body){ const r=await fetch(GAS_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }
  function showError(el,msg){ el.classList.remove('hidden'); el.textContent = msg; }

  /* ======= TABS ======= */
  function showTab(key){
    document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
    document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
    const view = document.getElementById('view-'+key); if(view) view.classList.remove('hidden');

    if(key==='dashboard') loadOverview();
    if(key==='cpa')       loadCpa();
    if(key==='users')     loadUsers();
    if(key==='analytics') loadAnalytics();
    if(key==='wallet')    loadWallet();
    if(key==='monitoring')loadMonitoring();
    if(key==='settings')  loadSettings();
  }
  document.querySelectorAll('.nav button').forEach(b=>{
    b.addEventListener('click', ()=>{ location.hash=b.dataset.tab; showTab(b.dataset.tab); });
  });

  /* ======= OVERVIEW ======= */
  async function loadOverview(){
    try{
      const j = await jget(api("overview"));
      const t = j.totals || {};
      const tp = j.totalsPretty || {};
      $('kpi-earn').textContent  = usd(t.earnings || 0);
      $('kpi-leads').textContent = num(t.leads || 0);
      $('kpi-clicks').textContent= num(t.clicks || 0);
      $('kpi-epc').textContent   = usd(t.epc || 0);
      $('kpi-cpa').textContent   = usd(t.cpa || 0);
      $('kpi-rpm').textContent   = usd(t.rpm || 0);
      $('kpi-cr').textContent    = tp.conversionRatePct || ((t.conversionRate ?? 0).toFixed(2) + '%');

      const fillObj = (tbody, obj) => {
        tbody.innerHTML = '';
        Object.entries(obj||{}).forEach(([k,v])=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${esc(k)}</td><td>${usd(v)}</td>`;
          tbody.appendChild(tr);
        });
        if(!tbody.children.length){ tbody.innerHTML = `<tr><td colspan="2" class="muted">No data</td></tr>`; }
      };
      fillObj(document.querySelector('#tbl-geo tbody'), j.geo);
      fillObj(document.querySelector('#tbl-device tbody'), j.devices);
      fillObj(document.querySelector('#tbl-offer tbody'), j.offerTypes);

      const dayBody = document.querySelector('#tbl-day tbody'); dayBody.innerHTML='';
      const byDay = Array.isArray(j.byDay) ? j.byDay
                   : Object.entries(j.byDay||{}).map(([d,v])=>({t:d, earnings:v}));
      byDay.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(r.t||r.date||'')}</td><td>${usd(r.earnings||r.value||0)}</td>`;
        dayBody.appendChild(tr);
      });
      if(!dayBody.children.length) dayBody.innerHTML=`<tr><td colspan="2" class="muted">No data</td></tr>`;

      // tiny sparkline
      (function tinySpark(values){
        const c = document.getElementById('earn-spark'); if (!c) return;
        const ctx = c.getContext('2d'); const w=c.width=120, h=c.height=30;
        ctx.clearRect(0,0,w,h);
        if (!values || !values.length) return;
        const max=Math.max(...values), min=Math.min(...values);
        ctx.beginPath();
        values.forEach((v,i)=>{
          const x=(i/(values.length-1))*w;
          const y=h - (max===min? h/2 : ((v-min)/(max-min))*h);
          i?ctx.lineTo(x,y):ctx.moveTo(x,y);
        });
        ctx.lineWidth=1.5; ctx.strokeStyle='#f2c230'; ctx.stroke();
      })( (byDay||[]).map(r=>+r.earnings||0) );

      $('ovrErr')?.classList.add('hidden');
    }catch(e){
      showError($('ovrErr'), `Failed to load overview: ${e.message}`);
      console.warn('overview failed', e);
    }
  }

  /* ======= CPA ======= */
  async function loadCpa(){
    const grid=$('cpaGrid'); grid.innerHTML='';
    try{
      const j = await jget(api("cpa"));
      const seen = new Set();
      (j.items||[]).forEach(acc=>{
        const id = String(acc.account||'').trim();
        if (!id || seen.has(id)) return;
        seen.add(id);
        const conv = acc.conversionRate!=null
          ? (typeof acc.conversionRate==='string' && acc.conversionRate.endsWith('%') ? acc.conversionRate : ((+acc.conversionRate)*100).toFixed(1)+'%')
          : 'â€”';
        const card=document.createElement('div'); card.className='card span-4';
        card.innerHTML = `
          <div style="font-weight:800;margin-bottom:6px">${esc(id)}</div>
          <div class="muted">Network</div><div style="font-weight:700">${esc(acc.network||'CPA Grip')}</div>
          <div class="muted">Custom Domain</div><div style="font-weight:700">${esc(acc.domain||'â€”')}</div>
          <div class="muted">Active Offers</div><div style="font-weight:700">${num(acc.activeOffers||0)}</div>
          <div class="muted">Revenue</div><div style="font-weight:700">${usd(acc.revenue||0)}</div>
          <div class="muted">Clicks</div><div style="font-weight:700">${num(acc.clicks||0)}</div>
          <div class="muted">Conversion</div><div style="font-weight:700">${conv}</div>`;
        grid.appendChild(card);
      });
      if(!grid.children.length) grid.innerHTML=`<div class="note err">No CPA accounts returned.</div>`;
    }catch(e){
      grid.innerHTML=`<div class="note err">Failed to load CPA: ${esc(e.message)}</div>`;
    }
  }
  // modal handlers
  $('btnAddCpa')?.addEventListener('click',()=>$('cpaModal').classList.remove('hidden'));
  $('cpaCancel')?.addEventListener('click',()=>$('cpaModal').classList.add('hidden'));
  $('cpaSave')?.addEventListener('click', async ()=>{
    try{
      const body = {
        action:'addCpa',
        account:$('cpa_id').value.trim(),
        network:$('cpa_network').value.trim()||'CPA Grip',
        domain:$('cpa_domain').value.trim(),
        activeOffers:+$('cpa_offers').value||0,
        clicks:+$('cpa_clicks').value||0,
        revenue:+$('cpa_revenue').value||0,
        conversionRate:0
      };
      const r = await jpost(body);
      if (!r.ok) return alert(r.error||'Failed');
      $('cpaModal').classList.add('hidden');
      loadCpa();
      alert('Saved âœ“');
    }catch(e){ alert('Error: '+e.message); }
  });

  /* ======= USERS ======= */
  async function loadUsers(){
    const body=document.querySelector('#tbl-users tbody'); body.innerHTML='';
    try{
      const j = await jget(api("users"));
      const seen = new Set();
      (j.items||[]).forEach(u=>{
        const key = (u.email||'').toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(u.name||'')}</td>
                      <td>${esc(u.email||'')}</td>
                      <td>${esc(u.phone||'')}</td>
                      <td class="muted">${esc(u.authority||'')}</td>`;
        body.appendChild(tr);
      });
      if(!body.children.length) body.innerHTML=`<tr><td colspan="4" class="muted">No users.</td></tr>`;
    }catch(e){
      body.innerHTML=`<tr><td colspan="4">Failed to load users.</td></tr>`;
    }
  }

  /* ======= ANALYTICS ======= */
  async function loadAnalytics(){
    const body=document.querySelector('#tbl-analytics tbody'); body.innerHTML='';
    try{
      const j = await jget(api("analytics"));
      (j.items||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(r.metric||'')}</td><td>${esc(r.value||'')}</td>`;
        body.appendChild(tr);
      });
      if(!body.children.length) body.innerHTML=`<tr><td colspan="2" class="muted">No analytics rows.</td></tr>`;
    }catch(e){
      body.innerHTML=`<tr><td colspan="2">Failed to load analytics.</td></tr>`;
    }
  }

  /* ======= WALLET ======= */
  async function loadWallet(){
    const list=$('walletList'); list.innerHTML='';
    try{
      const j = await jget(api("wallet"));
      const bal = +(+j.balance||0).toFixed(2);
      $('wallet-balance').textContent = usd(bal);

      const amt = $('wd_amt'), wdraw=$('wd_withdraw'), remain=$('wd_remaining');
      function recalc(){ const a=Math.max(0,+amt.value||0); wdraw.textContent=usd(a); remain.textContent=usd(Math.max(0,bal-a)); }
      amt?.addEventListener('input', recalc); recalc();

      (j.history||[]).forEach(tx=>{
        const div=document.createElement('div'); div.className='card span-6';
        div.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
          <div><div class="muted">${esc(tx.date||'')}</div><div>${esc(tx.method||'')}</div></div>
          <div style="text-align:right"><div style="font-weight:800">${usd(tx.amount||0)}</div><span class="muted">${esc(tx.status||'COMPLETED')}</span></div>
        </div>`;
        list.appendChild(div);
      });
      if(!list.children.length) list.innerHTML=`<div class="note err">No transactions.</div>`;
    }catch(e){
      list.innerHTML=`<div class="note err">Failed to load wallet.</div>`;
    }
  }

  function wdMsg(type, text){
    const el = $('wd_msg');
    el.className = 'note ' + (type==='err'?'err':'');
    el.textContent = text; el.classList.remove('hidden');
  }
  $('wd_validate')?.addEventListener('click', async ()=>{
    try{
      const country = $('wd_country').value;
      const bank    = $('wd_bank').value.trim();
      const code    = $('wd_bankcode').value.trim();
      const acct    = $('wd_acct').value.replace(/\D/g,'');
      if (!acct) return wdMsg('err','Enter account number');
      const r = await jget(api('validateBank', { country, bank, code, acct }));
      if (!r.ok) return wdMsg('err', r.error||'Validation failed');
      if (!r.valid) return wdMsg('err', r.message||'Account is invalid');
      $('wd_name').value = r.holder || $('wd_name').value || '';
      wdMsg('ok', 'Account verified âœ“');
    }catch(e){ wdMsg('err','Validation error: '+e.message); }
  });

  $('wd_request')?.addEventListener('click', async ()=>{
    try{
      const payload = {
        action:'withdraw',
        method:$('wd_method').value,
        country:$('wd_country').value,
        category:$('wd_cat').value,
        bank:$('wd_bank').value.trim(),
        bankCode:$('wd_bankcode').value.trim(),
        account:$('wd_acct').value.replace(/\D/g,''),
        holder:$('wd_name').value.trim(),
        phone:$('wd_phone').value.trim(),
        amount:+$('wd_amt').value||0
      };
      if (payload.amount < 200) return wdMsg('err','Minimum withdrawal is $200');
      const r = await jpost(payload);
      if (!r.ok) return wdMsg('err', r.error||'Failed to submit');
      wdMsg('ok', 'Withdrawal request submitted âœ“ ID: '+r.requestId);
      loadWallet();
    }catch(e){ wdMsg('err','Submit error: '+e.message); }
  });

  /* ======= MONITORING ======= */
  async function loadMonitoring(){
    const body=document.querySelector('#tbl-monitor tbody'); body.innerHTML='';
    try{
      const j = await jget(api("monitoring"));
      (j.events||[]).forEach(ev=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(ev.time||'')}</td><td>${esc(ev.type||'')}</td><td>${esc(ev.msg||'')}</td>`;
        body.appendChild(tr);
      });
      if(!body.children.length) body.innerHTML=`<tr><td colspan="3" class="muted">No events.</td></tr>`;
    }catch(e){
      body.innerHTML=`<tr><td colspan="3">Failed to load events.</td></tr>`;
    }
  }

  /* ======= SETTINGS ======= */
  async function loadSettings(){
    try{
      const j = await jget(api("config"));
      $('cfgDump').textContent = JSON.stringify(j,null,2);
    }catch(e){
      $('cfgDump').textContent = 'Failed to load config.';
    }
  }

  /* ======= INIT ======= */
  window.addEventListener('DOMContentLoaded', ()=>{
    const h=(location.hash||'#dashboard').replace('#','');
    showTab(h);
  });
  window.addEventListener('hashchange', ()=>{
    const h=(location.hash||'#dashboard').replace('#','');
    showTab(h);
  });
</script>
<!-- ===================  ADD CPA ACCOUNT â€“ ONE-PIECE COMPONENT  =================== -->
<style>
  :root{
    --emp-bg:#0d1b2a; --emp-panel:#0a1522; --emp-border:rgba(255,255,255,.10);
    --emp-text:#e8f1ff; --emp-muted:#9bb2c5; --emp-brand:#ffb800; --emp-shadow:rgba(0,0,0,.45);
  }
  .emp-btn{padding:.6rem 1rem;border-radius:.6rem;border:0;background:#2c3e50;color:#fff;cursor:pointer}
  .emp-btn-primary{background:var(--emp-brand);color:#111;font-weight:700}
  .emp-btn:disabled{opacity:.6;cursor:not-allowed}

  /* Modal Shell */
  .emp-modal.hidden{display:none}
  .emp-modal{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center}
  .emp-modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
  .emp-modal__panel{
    position:relative;z-index:1;width:min(620px,94vw);max-height:min(86vh,1000px);
    background:var(--emp-bg);border:1px solid var(--emp-border);border-radius:16px;
    box-shadow:0 28px 90px var(--emp-shadow);color:var(--emp-text);display:flex;flex-direction:column
  }
  .emp-modal__header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--emp-border)}
  .emp-modal__title{font-size:1.05rem;letter-spacing:.3px}
  .emp-modal__close{all:unset;cursor:pointer;font-size:22px;line-height:1;padding:4px 8px;border-radius:8px}
  .emp-modal__body{display:grid;gap:12px;padding:16px;overflow:auto}
  .emp-field{display:grid;gap:6px}
  .emp-label{font-size:.85rem;color:var(--emp-muted)}
  .emp-input{
    padding:.65rem .75rem;border-radius:.55rem;border:1px solid var(--emp-border);
    background:var(--emp-panel);color:var(--emp-text);outline:none
  }
  .emp-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.emp-row{grid-template-columns:1fr}}
  .emp-modal__footer{display:flex;gap:10px;justify-content:flex-end;margin-top:4px}

  /* tiny toast */
  .emp-toast{position:fixed;right:14px;bottom:14px;background:#0b2033;color:#dff3ff;border:1px solid var(--emp-border);
    padding:.65rem .8rem;border-radius:10px;z-index:11000;box-shadow:0 10px 30px var(--emp-shadow);opacity:0;transform:translateY(8px);
    transition:.25s ease}
  .emp-toast.show{opacity:1;transform:translateY(0)}
</style>

<!-- Trigger Button (place anywhere in your toolbar) -->
<button id="emp-open-cpa" class="emp-btn emp-btn-primary">+ Add CPA Account</button>

<!-- Modal -->
<div id="emp-cpa-modal" class="emp-modal hidden" aria-hidden="true">
  <div class="emp-modal__backdrop" data-close="true"></div>
  <div class="emp-modal__panel" role="dialog" aria-modal="true" aria-labelledby="emp-cpa-title">
    <div class="emp-modal__header">
      <div class="emp-modal__title" id="emp-cpa-title">Add CPA Account</div>
      <button class="emp-modal__close" aria-label="Close" data-close="true">Ã—</button>
    </div>

    <form id="emp-cpa-form" class="emp-modal__body">
      <div class="emp-row">
        <div class="emp-field">
          <label class="emp-label">Account ID</label>
          <input class="emp-input" name="AccountID" required />
        </div>
        <div class="emp-field">
          <label class="emp-label">Network (e.g., CPA Grip)</label>
          <input class="emp-input" name="Network" required />
        </div>
      </div>

      <div class="emp-row">
        <div class="emp-field">
          <label class="emp-label">Custom Domain</label>
          <input class="emp-input" name="Domain" placeholder="yourdomain.com" required />
        </div>
        <div class="emp-field">
          <label class="emp-label">Active Offers</label>
          <input class="emp-input" type="number" min="0" name="ActiveOffers" required />
        </div>
      </div>

      <div class="emp-row">
        <div class="emp-field">
          <label class="emp-label">Revenue (USD)</label>
          <input class="emp-input" type="number" min="0" step="0.01" name="Revenue" required />
        </div>
        <div class="emp-field">
          <label class="emp-label">Clicks</label>
          <input class="emp-input" type="number" min="0" name="Clicks" required />
        </div>
      </div>

      <div class="emp-row">
        <div class="emp-field">
          <label class="emp-label">Conversion Rate (%)</label>
          <input class="emp-input" type="number" min="0" step="0.001" name="ConversionRate" />
        </div>
        <div class="emp-field">
          <label class="emp-label">Status</label>
          <select class="emp-input" name="Status">
            <option value="ACTIVE" selected>ACTIVE</option>
            <option value="PAUSED">PAUSED</option>
          </select>
        </div>
      </div>

      <div class="emp-modal__footer">
        <button type="button" class="emp-btn" data-close="true">Cancel</button>
        <button id="emp-cpa-save" type="submit" class="emp-btn emp-btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="emp-toast" class="emp-toast" role="status" aria-live="polite"></div>

<script>
/* ====== CONFIG: set once ====== */
const GAS_BASE = window.GAS_BASE || 'https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYMENT/exec';
/* Expected GAS behavior:
   - Accept POST JSON: { action: "addCpa", account: { AccountID, Network, Domain, ActiveOffers, Revenue, Clicks, ConversionRate, Status } }
   - Upsert by AccountID (insert if new, update if existing). Return {ok:true}.
*/

(function(){
  const modal   = document.getElementById('emp-cpa-modal');
  const openBtn = document.getElementById('emp-open-cpa');
  const form    = document.getElementById('emp-cpa-form');
  const saveBtn = document.getElementById('emp-cpa-save');
  const toastEl = document.getElementById('emp-toast');

  const showToast = (msg, ms=2500) => {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), ms);
  };

  const escClose = (e)=>{ if(e.key==='Escape') closeModal(); };

  function openModal(){
    modal.classList.remove('hidden');
    document.body.style.overflow='hidden';
    const first = form.querySelector('input,select'); first && first.focus();
    window.addEventListener('keydown', escClose);
  }
  function closeModal(){
    modal.classList.add('hidden');
    document.body.style.overflow='';
    window.removeEventListener('keydown', escClose);
    form.reset();
  }

  openBtn?.addEventListener('click', openModal);
  modal.addEventListener('click', (e)=>{ if(e.target.dataset.close) closeModal(); });
  window.addEventListener('hashchange', closeModal);

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());

    // clean/normalize
    data.ActiveOffers    = +data.ActiveOffers || 0;
    data.Revenue         = +data.Revenue || 0;
    data.Clicks          = +data.Clicks || 0;
    data.ConversionRate  = data.ConversionRate ? +data.ConversionRate : null;
    data.Status          = data.Status || 'ACTIVE';

    saveBtn.disabled = true;

    try{
      const res = await fetch(GAS_BASE, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'addCpa', account:data })
      });
      const json = await res.json().catch(()=>({ok:false, error:'Bad JSON'}));
      if(!res.ok || !json.ok){ throw new Error(json.error || ('HTTP '+res.status)); }

      showToast('CPA account saved');
      closeModal();

      // If you have a refresh function on the page, call it:
      if (typeof window.refreshCpaAccounts === 'function') {
        window.refreshCpaAccounts();  // re-pulls from GAS to avoid duplicates in UI
      }
    }catch(err){
      console.error(err);
      showToast('Save failed: '+err.message, 3500);
    }finally{
      saveBtn.disabled = false;
    }
  });
})();
</script>
<!-- ===================  /END ADD CPA ACCOUNT  =================== -->
<!-- â€¦ your dashboard content â€¦ -->

  <!-- CPA Accounts Add Modal -->
  <div id="emp-cpa-modal" class="emp-modal hidden">
    <div class="emp-modal__backdrop" data-close="true"></div>
    <div class="emp-modal__panel">
      <div class="emp-modal__header" id="emp-cpa-drag">
        <div class="emp-modal__title">Add New CPA Account</div>
        <button class="emp-modal__close" data-close="true">Ã—</button>
      </div>

      <form id="emp-cpa-form" class="emp-modal__body">
        <div class="emp-field">
          <label class="emp-label">Account Name</label>
          <input class="emp-input" name="AccountName" required />
        </div>
        <div class="emp-field">
          <label class="emp-label">Network</label>
          <select class="emp-input" name="Network" required>
            <option value="">Select Network</option>
            <option value="CPA Grip">CPA Grip</option>
            <option value="CPAlead">CPAlead</option>
            <option value="AdWorkMedia">AdWork Media</option>
            <option value="OGAds">OGAds</option>
          </select>
        </div>
        <div class="emp-field">
          <label class="emp-label">Account ID</label>
          <input class="emp-input" name="AccountID" required />
        </div>
        <div class="emp-modal__footer">
          <button type="button" class="emp-btn" data-close="true">Cancel</button>
          <button type="submit" class="emp-btn emp-btn-primary">+ Add Account</button>
        </div>
      </form>
    </div>
  </div>

  <!-- scripts here -->
  <script src="app.js"></script>
</body>
</html>
<!-- ==== CPA MODAL (robust, draggable, closable) ==== -->
<style>
  .emp-modal{position:fixed;inset:0;z-index:9999;display:none}
  .emp-modal.show{display:block}
  .emp-modal__backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(2px)}
  .emp-modal__panel{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(520px,90vw);border-radius:14px;padding:0;
    background:linear-gradient(180deg,#0f1b2e,#0a1424);
    box-shadow:0 12px 40px rgba(0,0,0,.45),0 0 0 1px rgba(255,255,255,.06);
    color:#e9eefc; pointer-events:auto;
  }
  .emp-modal__header{display:flex;align-items:center;justify-content:space-between;
    padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);cursor:move;user-select:none}
  .emp-modal__title{font-weight:700;letter-spacing:.2px}
  .emp-modal__close{all:unset;cursor:pointer;font-size:20px;line-height:1;padding:8px;border-radius:8px}
  .emp-modal__close:hover{background:rgba(255,255,255,.08)}
  .emp-modal__body{padding:16px}
  .emp-field{margin-bottom:12px}
  .emp-label{display:block;font-size:12px;opacity:.85;margin-bottom:6px}
  .emp-input,.emp-select{
    width:100%;padding:12px 12px;border-radius:10px;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#fff;
    outline:none;
  }
  .emp-input:focus,.emp-select:focus{border-color:#62b0ff;box-shadow:0 0 0 3px rgba(98,176,255,.18)}
  .emp-modal__footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px 16px}
  .emp-btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
  .emp-btn-primary{background:#ffd654;color:#1b1b1b;border-color:#ffd654;font-weight:700}
</style>

<div id="emp-cpa-modal" class="emp-modal" aria-hidden="true">
  <div class="emp-modal__backdrop" data-close="1"></div>
  <div class="emp-modal__panel" role="dialog" aria-modal="true" aria-labelledby="emp-cpa-title">
    <div class="emp-modal__header" id="emp-cpa-drag">
      <div class="emp-modal__title" id="emp-cpa-title">Add New CPA Account</div>
      <button class="emp-modal__close" data-close="1" aria-label="Close">Ã—</button>
    </div>

    <form id="emp-cpa-form" class="emp-modal__body" autocomplete="off">
      <div class="emp-field">
        <label class="emp-label">Account Name</label>
        <input class="emp-input" name="accountName" required />
      </div>
      <div class="emp-field">
        <label class="emp-label">Network</label>
        <select class="emp-select" name="network" required>
          <option value="">Select Network</option>
          <option>CPA Grip</option>
          <option>CPAlead</option>
          <option>AdWork Media</option>
          <option>OGAds</option>
        </select>
      </div>
      <div class="emp-field">
        <label class="emp-label">Account ID</label>
        <input class="emp-input" name="accountId" required />
      </div>
      <div class="emp-modal__footer">
        <button type="button" class="emp-btn" data-close="1">Cancel</button>
        <button type="submit" class="emp-btn emp-btn-primary">+ Add Account</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  const modal   = document.getElementById('emp-cpa-modal');
  const panel   = modal.querySelector('.emp-modal__panel');
  const header  = document.getElementById('emp-cpa-drag');
  const form    = document.getElementById('emp-cpa-form');

  // open/close helpers
  function openModal() {
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    // center only if no stored position
    if (!panel.dataset.pinned) {
      panel.style.left = '50%';
      panel.style.top  = '50%';
      panel.style.transform = 'translate(-50%,-50%)';
    }
    // focus first field
    const first = form.querySelector('input,select');
    if (first) setTimeout(() => first.focus(), 10);
  }
  function closeModal() {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
  }

  // expose an opener if you need to call from your button:
  // <button onclick="window.empireOpenCpa()">Add CPA Account</button>
  window.empireOpenCpa = openModal;

  // close on backdrop or X
  modal.addEventListener('click', (e) => {
    if (e.target.dataset.close) closeModal();
  });
  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (modal.classList.contains('show') && e.key === 'Escape') closeModal();
  });

  // --- DRAGGABLE ---
  let drag = null;
  header.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const rect = panel.getBoundingClientRect();
    drag = {
      dx: e.clientX - rect.left,
      dy: e.clientY - rect.top
    };
    panel.style.transform = 'none'; // disable centering transform when dragging
    panel.dataset.pinned = '1';
    // improve dragging across iframes/canvases
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', (e) => {
    if (!drag) return;
    const x = Math.max(8, Math.min(window.innerWidth  - panel.offsetWidth  - 8, e.clientX - drag.dx));
    const y = Math.max(8, Math.min(window.innerHeight - panel.offsetHeight - 8, e.clientY - drag.dy));
    panel.style.left = x + 'px';
    panel.style.top  = y + 'px';
  });
  window.addEventListener('mouseup', () => {
    if (drag) document.body.style.userSelect = '';
    drag = null;
  });

  // --- SUBMIT -> your GAS endpoint (already working on backend) ---
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    const payload = { action:'addcpa', ...data };
    try {
      const res = await fetch(YOUR_GAS_WEBAPP_URL /* <- put your URL */, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Add failed');
      closeModal();
      // optional: refresh list
      if (window.refreshCpaList) window.refreshCpaList();
    } catch(err) {
      alert('Add CPA failed: ' + err.message);
    }
  });
})();
<!-- your modal HTML here -->

<!-- script goes LAST, after the modal -->
<script>
 (function() {
   const GAS_URL = "https://script.google.com/macros/s/AKfycbwD_SO3xzMetaspwhWngcu0INBZOhwMfGb8PMS5tF-pk75tjNVW0XsdXnL7YDWm7VbX/exec";

   const form = document.getElementById("emp-cpa-form");
   const modal = document.getElementById("emp-cpa-modal");

   function closeModal() { modal.classList.add("hidden"); }

   form.addEventListener("submit", async (e) => {
     e.preventDefault();
     const data = Object.fromEntries(new FormData(form).entries());
     const payload = { action: "addcpa", ...data };

     try {
       const res = await fetch(GAS_URL, {
         method: "POST",
         headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
         body: new URLSearchParams(payload).toString()
       });
       const json = await res.json();
       if (!json.ok) throw new Error(json.error || "Add failed");

       alert("CPA account added âœ”");
       closeModal();
       if (window.refreshCpaList) window.refreshCpaList();
     } catch (err) {
       alert("Add CPA failed: " + err.message);
     }
   });
 })();
</script>
</body>
</html>