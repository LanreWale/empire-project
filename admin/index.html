<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Empire – Commander Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inline EmpireAuth (always available, no external file) -->
  <script>
  window.EmpireAuth = (function () {
    const KEY = "EMPIRE_TOKEN";
    function get(){ try{ return localStorage.getItem(KEY) || ""; }catch(_){ return "" } }
    function set(tok){ try{ localStorage.setItem(KEY, tok||""); }catch(_){} }
    function clear(){ try{ localStorage.removeItem(KEY); }catch(_){} }
    function has(){ return !!get(); }
    function authz(headers){
      headers = headers || {};
      const t = get();
      if (t) headers["Authorization"] = "Bearer " + t;
      return headers;
    }
    async function authedFetch(url, opts){
      opts = opts || {};
      const headers = authz(Object.assign({ "Content-Type": "application/json" }, opts.headers||{}));
      const r = await fetch(url, Object.assign({}, opts, { headers }));
      if (r.status === 401) throw new Error("Unauthorized");
      return r;
    }
    return { get,set,clear,has,authz,authedFetch };
  })();
  </script>

  <style>
    :root { --bg:#0b1220; --card:#111827; --muted:#97a0b6; --ok:#18b26b; --bad:#de524c; --txt:#e7ecf7; --accent:#4bb1ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:18px}
    .grid{display:grid;gap:14px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 40px rgba(0,0,0,.25);padding:14px}
    h1{margin:0 0 6px;font-size:20px}
    h2{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted)}
    label{display:block;margin:10px 0 6px;font-size:13px}
    input,select,textarea{width:100%;padding:12px 12px;border:1px solid #22304e;background:#0d1525;color:var(--txt);border-radius:10px}
    textarea{min-height:84px;resize:vertical}
    button{width:100%;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:#051225;font-weight:700;cursor:pointer}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .msg{padding:10px 12px;border-radius:12px;margin:8px 0;font-size:13px}
    .ok{background:#0f2b21;border:1px solid #166c4a;color:#b9f4d8}
    .bad{background:#2a1414;border:1px solid #944040;color:#ffd6d5}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0d1a2a;color:#cfe1ff;border:1px solid #2a3d5c;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}
    .small{font-size:12px}
    .footer{color:#7d879b;text-align:center;margin:18px 0 4px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap grid">

    <!-- PIN Controls -->
    <div class="card">
      <h1>Commander Console <span class="pill">Empire</span></h1>
      <div class="muted small">Mobile-first controls for Invites, Approvals, Levels & Performance.</div>
      <div id="pinRow" class="flex" style="margin-top:10px;gap:10px">
        <input id="pin" placeholder="Admin PIN (CMD_USER)" />
        <button id="savePin" style="width:auto">Save</button>
        <button id="clearPin" style="width:auto;background:#334155;color:#dbe4f7">Clear</button>
      </div>
      <div id="pinStatus" class="small muted" style="margin-top:8px"></div>
    </div>

    <!-- Create Invite -->
    <div class="card">
      <h2>Create Invite</h2>
      <div class="row">
        <div><label>Name</label><input id="inv_name" placeholder="Full name" /></div>
        <div><label>Email</label><input id="inv_email" placeholder="email@example.com" type="email" /></div>
      </div>
      <div class="row">
        <div><label>Phone (WhatsApp, optional)</label><input id="inv_phone" placeholder="+23480..." /></div>
        <div><label>Telegram (optional)</label><input id="inv_tg" placeholder="@channel" /></div>
      </div>
      <button id="btnInvite">Generate Invite</button>
      <div id="inviteMsg"></div>
    </div>

    <!-- Approve User -->
    <div class="card">
      <h2>Approve User</h2>
      <div class="row">
        <div><label>Name</label><input id="appr_name" placeholder="Full name" /></div>
        <div><label>Email</label><input id="appr_email" placeholder="email@example.com" type="email" /></div>
      </div>
      <div class="row">
        <div><label>Phone (WhatsApp)</label><input id="appr_phone" placeholder="+234803..." /></div>
        <div><label>Approve?</label>
          <select id="appr_approve">
            <option value="true" selected>Approve</option>
            <option value="false">Reject</option>
          </select>
        </div>
      </div>
      <button id="btnApprove">Send Approval</button>
      <div id="apprMsg"></div>
    </div>

    <!-- Set User Level -->
    <div class="card">
      <h2>Set User Level</h2>
      <div class="row">
        <div><label>Email</label><input id="lvl_email" placeholder="user@example.com" type="email" /></div>
        <div><label>Level</label>
          <select id="lvl_level">
            <option>1x</option><option>2x</option><option>3x</option>
            <option>4x</option><option>5x</option><option>10x (Commander)</option>
            <option>0x (Suspended)</option>
          </select>
        </div>
      </div>
      <label>Reason / Note</label>
      <input id="lvl_reason" placeholder="e.g., performance upgrade" />
      <button id="btnLevel">Apply Level</button>
      <div id="lvlMsg"></div>
    </div>

    <!-- Log Performance -->
    <div class="card">
      <h2>Log Performance</h2>
      <div class="row">
        <div><label>Email</label><input id="perf_email" placeholder="user@example.com" /></div>
        <div><label>Level Snapshot</label>
          <select id="perf_level">
            <option>1x</option><option>2x</option><option>3x</option>
            <option>4x</option><option>5x</option><option>10x</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Clicks</label><input id="perf_clicks" type="number" inputmode="numeric" value="0" /></div>
        <div><label>Conversions</label><input id="perf_conversions" type="number" inputmode="numeric" value="0" /></div>
      </div>
      <div class="row">
        <div><label>Revenue (USD)</label><input id="perf_revenue" type="number" step="0.01" value="0" /></div>
        <div><label>Notify</label>
          <select id="perf_notify">
            <option value="true" selected>Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <label>Notes</label><textarea id="perf_notes" placeholder="e.g., evening push"></textarea>
      <label>WhatsApp (optional)</label><input id="perf_phone" placeholder="+234803..." />
      <button id="btnPerf">Record Performance</button>
      <div id="perfMsg"></div>
    </div>

    <div class="footer">© Empire Affiliate Marketing Hub</div>
  </div>

  <!-- Main logic -->
  <script>
    const KEY_PIN = "empire_cmd_user";
    function getPIN(){ try { return localStorage.getItem(KEY_PIN) || ""; } catch { return ""; } }
    function setPIN(v){ try { localStorage.setItem(KEY_PIN, v || ""); } catch {} }

    function authz(headers = {}) {
      if (window.EmpireAuth && typeof window.EmpireAuth.authz === "function") {
        headers = window.EmpireAuth.authz(headers);
      }
      const pin = getPIN();
      if (pin) headers["x-cmd-user"] = pin;
      return headers;
    }

    function setMsg(el, ok, html){ el.className = "msg " + (ok ? "ok" : "bad"); el.innerHTML = html; }
    function escapeHTML(s){ return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

    async function callJSON(path, body, msgEl){
      try{
        const r = await fetch(path, {
          method:"POST",
          headers: authz({ "content-type": "application/json" }),
          body: JSON.stringify(body || {})
        });
        const data = await r.json().catch(()=>({ok:false,error:"Bad JSON"}));
        setMsg(msgEl, data.ok !== false, `<pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>`);
      }catch(e){ setMsg(msgEl, false, escapeHTML(String(e))); }
    }

    window.addEventListener("DOMContentLoaded", () => {
      // PIN Controls
      const pinInput = document.getElementById("pin");
      const pinStatus = document.getElementById("pinStatus");
      document.getElementById("savePin").onclick = () => { setPIN(pinInput.value.trim()); pinStatus.textContent = "PIN saved."; };
      document.getElementById("clearPin").onclick = () => { setPIN(""); pinInput.value=""; pinStatus.textContent = "PIN cleared."; };
      pinInput.value = getPIN();
      pinStatus.textContent = getPIN() ? "PIN loaded." : "No PIN saved.";

      // Invite
      document.getElementById("btnInvite").onclick = () => {
        callJSON("/.netlify/functions/invite-create", {
          name: document.getElementById("inv_name").value.trim(),
          email: document.getElementById("inv_email").value.trim(),
          phone: document.getElementById("inv_phone").value.trim(),
          telegramHandle: document.getElementById("inv_tg").value.trim()
        }, document.getElementById("inviteMsg"));
      };

      // Approve
      document.getElementById("btnApprove").onclick = () => {
        callJSON("/.netlify/functions/approve-user", {
          name: document.getElementById("appr_name").value.trim(),
          email: document.getElementById("appr_email").value.trim(),
          phone: document.getElementById("appr_phone").value.trim(),
          approve: document.getElementById("appr_approve").value === "true"
        }, document.getElementById("apprMsg"));
      };

      // Set Level
      document.getElementById("btnLevel").onclick = () => {
        callJSON("/.netlify/functions/user-level-set", {
          email: document.getElementById("lvl_email").value.trim(),
          level: document.getElementById("lvl_level").value.trim(),
          reason: document.getElementById("lvl_reason").value.trim()
        }, document.getElementById("lvlMsg"));
      };

      // Performance
      document.getElementById("btnPerf").onclick = () => {
        callJSON("/.netlify/functions/log-performance", {
          email: document.getElementById("perf_email").value.trim(),
          clicks: Number(document.getElementById("perf_clicks").value || 0),
          conversions: Number(document.getElementById("perf_conversions").value || 0),
          revenueUSD: Number(document.getElementById("perf_revenue").value || 0),
          level: document.getElementById("perf_level").value.trim(),
          notes: document.getElementById("perf_notes").value.trim(),
          phone: document.getElementById("perf_phone").value.trim(),
          notify: document.getElementById("perf_notify").value === "true"
        }, document.getElementById("perfMsg"));
      };
    });
  </script>
</body>
</html>