<script>
  // --- guard: require saved PIN ---
  (function(){
    if (!localStorage.getItem("empire_cmd_user")) location.replace("/");
  })();

  // (your current console JS continues below‚Ä¶)
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Empire ‚Äì Commander Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1220; --card:#111827; --muted:#97a0b6; --ok:#18b26b; --bad:#de524c;
      --txt:#e7ecf7; --accent:#4bb1ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    .grid{display:grid;gap:14px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 40px rgba(0,0,0,.25);padding:14px}
    h1{margin:0 0 6px;font-size:20px}
    h2{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted)}
    label{display:block;margin:10px 0 6px;font-size:13px}
    input,select,textarea{
      width:100%;padding:12px 12px;border:1px solid #22304e;background:#0d1525;color:var(--txt);border-radius:10px;
    }
    textarea{min-height:84px;resize:vertical}
    button{
      width:100%;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:#051225;font-weight:700;cursor:pointer
    }
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .msg{padding:10px 12px;border-radius:12px;margin:8px 0;font-size:13px;white-space:pre-wrap}
    .ok{background:#0f2b21;border:1px solid #166c4a;color:#b9f4d8}
    .bad{background:#2a1414;border:1px solid #944040;color:#ffd6d5}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0d1a2a;color:#cfe1ff;border:1px solid #2a3d5c;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px}
    .hr{height:1px;background:#1b2740;margin:14px 0}
    .footer{color:#7d879b;text-align:center;margin:18px 0 4px;font-size:12px}
    code{background:#091223;border:1px solid #1b2b4a;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap grid">

    <!-- Header / PIN -->
    <div class="card">
      <h1>Commander Console <span class="pill">Empire</span></h1>
      <div class="muted small">Mobile-first controls for Invites, Approvals, Levels & Performance.</div>
      <div class="flex" style="margin-top:10px;gap:10px">
        <input id="pin" placeholder="Admin PIN (CMD_USER)" />
        <button id="savePin" style="width:auto">Save</button>
        <button id="clearPin" style="width:auto;background:#334155;color:#dbe4f7">Clear</button>
      </div>
      <div id="pinStatus" class="small muted" style="margin-top:8px"></div>
    </div>

    <!-- Create Invite -->
    <div class="card">
      <h2>Create Invite</h2>
      <div class="row">
        <div>
          <label>Name</label>
          <input id="inv_name" placeholder="Full name" />
        </div>
        <div>
          <label>Email</label>
          <input id="inv_email" placeholder="email@example.com" type="email" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Phone (WhatsApp, optional)</label>
          <input id="inv_phone" placeholder="+23480..." />
        </div>
        <div>
          <label>Telegram (optional)</label>
          <input id="inv_tg" placeholder="@channel_handle" />
        </div>
      </div>
      <button id="btnInvite">Generate Invite</button>
      <div id="inviteMsg"></div>
    </div>

    <!-- Approve User -->
    <div class="card">
      <h2>Approve User</h2>
      <div class="row">
        <div>
          <label>Name</label>
          <input id="appr_name" placeholder="Full name" />
        </div>
        <div>
          <label>Email</label>
          <input id="appr_email" placeholder="email@example.com" type="email" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Phone (WhatsApp)</label>
          <input id="appr_phone" placeholder="+234803..." />
        </div>
        <div>
          <label>Approve?</label>
          <select id="appr_approve">
            <option value="true" selected>Approve</option>
            <option value="false">Reject</option>
          </select>
        </div>
      </div>
      <button id="btnApprove">Send Approval</button>
      <div id="apprMsg"></div>
    </div>

    <!-- Set Level -->
    <div class="card">
      <h2>Set User Level</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="lvl_email" placeholder="user@example.com" type="email" />
        </div>
        <div>
          <label>Level</label>
          <select id="lvl_level">
            <option>1x</option>
            <option>2x</option>
            <option>3x</option>
            <option>4x</option>
            <option>5x</option>
            <option>10x (Commander)</option>
            <option>0x (Suspended)</option>
          </select>
        </div>
      </div>
      <label>Reason / Note</label>
      <input id="lvl_reason" placeholder="e.g., performance upgrade" />
      <button id="btnLevel">Apply Level</button>
      <div id="lvlMsg"></div>
    </div>

    <!-- Log Performance -->
    <div class="card">
      <h2>Log Performance</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="perf_email" placeholder="user@example.com" />
        </div>
        <div>
          <label>Level Snapshot</label>
          <select id="perf_level">
            <option>1x</option><option>2x</option><option>3x</option><option>4x</option><option>5x</option><option>10x</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Clicks</label>
          <input id="perf_clicks" type="number" inputmode="numeric" value="0" />
        </div>
        <div>
          <label>Conversions</label>
          <input id="perf_conversions" type="number" inputmode="numeric" value="0" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Revenue (USD)</label>
          <input id="perf_revenue" type="number" step="0.01" value="0" />
        </div>
        <div>
          <label>Notify</label>
          <select id="perf_notify">
            <option value="true">Yes</option>
            <option value="false" selected>No</option>
          </select>
        </div>
      </div>
      <label>Notes</label>
      <textarea id="perf_notes" placeholder="e.g., evening push"></textarea>
      <label>WhatsApp (optional)</label>
      <input id="perf_phone" placeholder="+234803..." />
      <button id="btnPerf">Record Performance</button>
      <div id="perfMsg"></div>
    </div>

    <!-- üî• One-click Smoke Test -->
    <div class="card">
      <h2>One-click Smoke Test</h2>
      <div class="small muted">Runs: Invite ‚Üí Verify ‚Üí Set Level ‚Üí Log Performance ‚Üí GS Bridge. Uses test data; no WhatsApp/Telegram spam.</div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <label>Test Email</label>
          <input id="smoke_email" value="qa@example.com" />
        </div>
        <div>
          <label>Test Level</label>
          <select id="smoke_level">
            <option>2x</option><option>3x</option><option>4x</option><option>5x</option>
          </select>
        </div>
      </div>
      <button id="btnSmoke">Run Smoke Test</button>
      <div id="smokeMsg" class="msg"></div>

      <div class="hr"></div>
      <div class="small muted">Optionally test approval (sends messages):</div>
      <div class="row">
        <div>
          <label>Approval Name</label>
          <input id="sm_appr_name" value="QA User" />
        </div>
        <div>
          <label>Approval Phone (WhatsApp)</label>
          <input id="sm_appr_phone" placeholder="+234803..." />
        </div>
      </div>
      <button id="btnSmokeApprove">Test Approve User</button>
      <div id="smokeApprMsg" class="msg"></div>
    </div>

    <div class="footer">¬© Empire Affiliate Marketing Hub</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // PIN management (x-cmd-user)
    function getPIN(){ return localStorage.getItem("empire_cmd_user") || ""; }
    function setPIN(v){ localStorage.setItem("empire_cmd_user", v || ""); }
    function headerAuth(){ const p=getPIN(); return p?{ "x-cmd-user": p }:{}; }

    function setMsg(el, ok, html){
      el.className = "msg " + (ok ? "ok" : "bad");
      el.innerHTML = html;
    }
    function line(ok, text){ return (ok? "‚úÖ " : "‚ùå ") + text; }
    function escapeHTML(s){ return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

    $("savePin").onclick = () => {
      setPIN($("pin").value.trim());
      $("pinStatus").textContent = "PIN saved (used as x-cmd-user header).";
    };
    $("clearPin").onclick = () => {
      setPIN("");
      $("pin").value = "";
      $("pinStatus").textContent = "PIN cleared.";
    };
    window.addEventListener("DOMContentLoaded", () => {
      $("pin").value = getPIN();
      $("pinStatus").textContent = getPIN() ? "PIN loaded." : "No PIN saved.";
    });

    async function callJSON(path, body, msgEl){
      try{
        const headers = { "content-type": "application/json", ...headerAuth() };
        const r = await fetch(path, { method:"POST", headers, body: JSON.stringify(body || {}) });
        const data = await r.json();
        setMsg(msgEl, data.ok !== false, `<pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>`);
      }catch(e){
        setMsg(msgEl, false, escapeHTML(String(e)));
      }
    }

    // Create invite
    $("btnInvite").onclick = () => {
      const body = {
        name: $("inv_name").value.trim(),
        email: $("inv_email").value.trim(),
        phone: $("inv_phone").value.trim(),
        telegramHandle: $("inv_tg").value.trim()
      };
      callJSON("/.netlify/functions/invite-create", body, $("inviteMsg"));
    };

    // Approve user
    $("btnApprove").onclick = () => {
      const body = {
        name: $("appr_name").value.trim(),
        email: $("appr_email").value.trim(),
        phone: $("appr_phone").value.trim(),
        approve: $("appr_approve").value === "true"
      };
      callJSON("/.netlify/functions/approve-user", body, $("apprMsg"));
    };

    // Set Level
    $("btnLevel").onclick = () => {
      const body = {
        email: $("lvl_email").value.trim(),
        level: $("lvl_level").value.trim(),
        reason: $("lvl_reason").value.trim()
      };
      callJSON("/.netlify/functions/user-level-set", body, $("lvlMsg"));
    };

    // Log Performance
    $("btnPerf").onclick = () => {
      const body = {
        email: $("perf_email").value.trim(),
        clicks: Number($("perf_clicks").value || 0),
        conversions: Number($("perf_conversions").value || 0),
        revenueUSD: Number($("perf_revenue").value || 0),
        level: $("perf_level").value.trim(),
        notes: $("perf_notes").value.trim(),
        phone: $("perf_phone").value.trim(),
        notify: $("perf_notify").value === "true"
      };
      callJSON("/.netlify/functions/log-performance", body, $("perfMsg"));
    };

    // ---------- ONE-CLICK SMOKE TEST ----------
    $("btnSmoke").onclick = async () => {
      const out = [];
      const email = $("smoke_email").value.trim() || "qa@example.com";
      const level = $("smoke_level").value.trim() || "2x";
      const headers = { "content-type": "application/json", ...headerAuth() };

      try {
        // 1) invite-create
        let r = await fetch("/.netlify/functions/invite-create", {
          method: "POST", headers,
          body: JSON.stringify({ name: "QA", email })
        });
        let data = await r.json();
        out.push(line(data.ok !== false, "invite-create"));
        if (!data.inviteUrl) throw new Error("No inviteUrl returned");
        // token can be at /i/<token> or /login?i=<token>
        let token = "";
        try {
          const url = new URL(data.inviteUrl);
          token = url.searchParams.get("i") || url.pathname.split("/").pop();
        } catch { token = ""; }
        if (!token) throw new Error("Could not parse token");
        out.push("‚Ä¢ token: " + token.slice(0,24) + "...");

        // 2) invite-verify (code=<token>)
        r = await fetch(`/.netlify/functions/invite-verify?code=${encodeURIComponent(token)}`);
        data = await r.json();
        out.push(line(data.ok === true, "invite-verify"));

        // 3) user-level-set
        r = await fetch("/.netlify/functions/user-level-set", {
          method: "POST", headers,
          body: JSON.stringify({ email, level, reason: "smoke test" })
        });
        data = await r.json();
        out.push(line(data.ok === true, `user-level-set ‚Üí ${level}`));

        // 4) log-performance (notify false to avoid channel noise)
        r = await fetch("/.netlify/functions/log-performance", {
          method: "POST", headers,
          body: JSON.stringify({
            email, clicks: 1, conversions: 0, revenueUSD: 0,
            level, notes: "smoke test", notify: false
          })
        });
        data = await r.json();
        out.push(line(data.ok === true, "log-performance (notify:false)"));

        // 5) gs-bridge health
        r = await fetch("/.netlify/functions/gs-bridge");
        data = await r.json();
        out.push(line(data.ok === true, "gs-bridge (doGet)"));

        setMsg($("smokeMsg"), true, out.join("\n"));
      } catch (e) {
        out.push(line(false, String(e)));
        setMsg($("smokeMsg"), false, out.join("\n"));
      }
    };

    // Optional: approve-user smoke (will send messages if configured)
    $("btnSmokeApprove").onclick = async () => {
      const headers = { "content-type": "application/json", ...headerAuth() };
      const body = {
        name: $("sm_appr_name").value.trim() || "QA User",
        email: $("smoke_email").value.trim() || "qa@example.com",
        phone: $("sm_appr_phone").value.trim(),
        approve: true
      };
      try {
        const r = await fetch("/.netlify/functions/approve-user", {
          method:"POST", headers, body: JSON.stringify(body)
        });
        const data = await r.json();
        setMsg($("smokeApprMsg"), data.ok !== false, JSON.stringify(data, null, 2));
      } catch(e) {
        setMsg($("smokeApprMsg"), false, String(e));
      }
    };
  </script>
</body>
</html>