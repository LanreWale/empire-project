<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Empire – My Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root { --bg:#0b1220; --card:#111827; --muted:#97a0b6; --txt:#e7ecf7; --accent:#4bb1ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:20px}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 40px rgba(0,0,0,.25);padding:16px}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted)}
    label{display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px;border:0;border-radius:12px}
    input,textarea,select{background:#0d1525;color:var(--txt);border:1px solid #22304e}
    button{width:100%;padding:12px;border:0;border-radius:12px;background:var(--accent);color:#051225;font-weight:700;cursor:pointer}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .msg{padding:10px 12px;border-radius:12px;margin:8px 0;font-size:13px}
    .ok{background:#0f2b21;border:1px solid #166c4a;color:#b9f4d8}
    .bad{background:#2a1414;border:1px solid #944040;color:#ffd6d5}
    .small{font-size:12px}
    .footer{color:#7d879b;text-align:center;margin:18px 0 4px;font-size:12px}
    .ghost{background:#334155;color:#dbe4f7;width:auto}
    .flex{display:flex;gap:8px;align-items:center}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="wrap grid">
    <div class="card">
      <h1>My Dashboard</h1>
      <div id="who" class="muted">Loading…</div>
      <div class="flex" style="margin-top:8px;gap:8px">
        <button id="logout" class="ghost">Logout</button>
        <a class="ghost" style="text-decoration:none;display:inline-block;padding:12px;border-radius:12px" href="/">Back to Access</a>
      </div>
    </div>

    <div class="card">
      <h2>Quick Performance Log</h2>
      <div class="row">
        <div>
          <label>Clicks</label>
          <input id="pf_clicks" type="number" inputmode="numeric" value="0" />
        </div>
        <div>
          <label>Conversions</label>
          <input id="pf_conv" type="number" inputmode="numeric" value="0" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Revenue (USD)</label>
          <input id="pf_rev" type="number" step="0.01" value="0" />
        </div>
        <div>
          <label>Notify</label>
          <select id="pf_notify">
            <option value="true" selected>Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <label>Notes</label>
      <textarea id="pf_notes" placeholder="e.g., morning push"></textarea>
      <button id="btnLog">Submit Performance</button>
      <div id="pfMsg"></div>
    </div>

    <div class="card">
      <h2>Invite (Short Link Tester)</h2>
      <div class="muted small">This generates an invite URL for you to share (if enabled by Commander).</div>
      <div class="row">
        <div>
          <label>Name (optional)</label>
          <input id="inv_name" placeholder="Your name (for invite)" />
        </div>
        <div>
          <label>Phone (optional, WhatsApp)</label>
          <input id="inv_phone" placeholder="+23480..." />
        </div>
      </div>
      <button id="btnInvite">Create Invite Link</button>
      <div id="invMsg"></div>
    </div>

    <div class="footer">© Empire Affiliate Marketing Hub</div>
  </div>

  <script>
    // --- guard: require saved email ---
    (function(){
      if (!localStorage.getItem("empire_user_email")) location.replace("/");
    })();

    const email = localStorage.getItem("empire_user_email") || "";
    const $ = (id) => document.getElementById(id);
    const setMsg = (el, ok, html) => { el.className = "msg " + (ok ? "ok" : "bad"); el.innerHTML = html; };
    const escapeHTML = (s) => String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));

    $("who").textContent = email ? `Signed in as ${email}` : "Not signed in";

    $("logout").onclick = () => {
      localStorage.removeItem("empire_user_email");
      location.replace("/");
    };

    // Quick log
    $("btnLog").onclick = async () => {
      try {
        const body = {
          email,
          clicks: Number($("pf_clicks").value||0),
          conversions: Number($("pf_conv").value||0),
          revenueUSD: Number($("pf_rev").value||0),
          level: "", // snapshot optional (Commander can set level separately)
          notes: $("pf_notes").value.trim(),
          notify: $("pf_notify").value === "true"
        };
        const r = await fetch("/.netlify/functions/log-performance", {
          method:"POST", headers:{"content-type":"application/json"},
          body: JSON.stringify(body)
        });
        const data = await r.json();
        setMsg($("pfMsg"), data.ok !== false, `<pre>${escapeHTML(JSON.stringify(data,null,2))}</pre>`);
      } catch(e) {
        setMsg($("pfMsg"), false, escapeHTML(String(e)));
      }
    };

    // Invite
    $("btnInvite").onclick = async () => {
      try {
        const body = {
          name: ($("inv_name").value||"").trim(),
          email,
          phone: ($("inv_phone").value||"").trim()
        };
        const r = await fetch("/.netlify/functions/invite-create", {
          method:"POST", headers:{"content-type":"application/json"},
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (data.inviteUrl) {
          setMsg($("invMsg"), true, `<div>Invite:</div><div><a target="_blank" href="${data.inviteUrl}">${escapeHTML(data.inviteUrl)}</a></div>`);
        } else {
          setMsg($("invMsg"), false, `<pre>${escapeHTML(JSON.stringify(data,null,2))}</pre>`);
        }
      } catch(e) {
        setMsg($("invMsg"), false, escapeHTML(String(e)));
      }
    };
  </script>
</body>
</html>