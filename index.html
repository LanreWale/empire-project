<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>THE EMPIRE — Command Dashboard</title>
<link rel="icon" href="assets/brand/favicon.png" type="image/png"/>

<style>
  :root{
    --bg:#0f1620; --panel:#121a25; --ink:#e9eef6; --muted:#8ca1c2;
    --brand:#f2c230; --brand2:#1f2937; --ok:#19c37d; --err:#ef4444; --line:#223046;
  }
  *{box-sizing:border-box} html,body{height:100%;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit}
  .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
  .side{background:#0c121a;border-right:1px solid var(--line);padding:14px 10px}
  .brand{display:flex;align-items:center;gap:8px;padding:8px 10px;margin-bottom:8px}
  .brand img{width:20px;height:20px}
  .brand .t1{font-weight:800;letter-spacing:.5px}
  .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .nav button{all:unset;cursor:pointer;padding:9px 12px;border-radius:8px;color:var(--muted)}
  .nav button.active,.nav button:hover{background:var(--panel);color:var(--ink);border:1px solid var(--line)}
  main{padding:18px}
  h1{font-size:18px;letter-spacing:.6px;margin:0 0 12px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .span-12{grid-column:span 12}
  .span-6{grid-column:span 6}
  .span-4{grid-column:span 4}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .kpi{background:var(--panel);border:1px solid var(--line);padding:10px 12px;border-radius:10px;min-width:120px}
  .kpi .lab{color:var(--muted);font-size:12px}
  .kpi .val{font-weight:800;font-size:18px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .panel h3{margin:0 0 10px 0;font-size:13px;color:var(--muted);letter-spacing:.3px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--line)}
  th{color:var(--muted);text-align:left;font-weight:600}
  .muted{color:var(--muted)}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{color:#0b5133;background:#063}
  .down{color:#460;background:#640}
  .note{padding:10px;border-radius:8px}
  .note.err{background:#2b1114;border:1px solid #541015}
  .note.warn{background:#2a210e;border:1px solid #5c4a12}
  .hidden{display:none}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .hero{background:url('assets/brand/welcome_banner.jpg') center/cover no-repeat;min-height:90px;border-radius:12px;border:1px solid var(--line)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .actions{display:flex;gap:8px;align-items:center}
  button.link{all:unset;cursor:pointer;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:8px}
  button.link:hover{color:var(--ink);background:var(--panel)}
  .ts{color:var(--muted);font-size:12px}
  .skeleton{position:relative;overflow:hidden;background:#0e1520;border:1px solid var(--line);border-radius:8px;min-height:38px}
  .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:s 1.2s infinite}
  @keyframes s{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
  @media(max-width:1024px){ .grid{grid-template-columns:repeat(6,1fr)} .span-6{grid-column:span 6} .span-4{grid-column:span 6} }
  @media(max-width:680px){ .app{grid-template-columns:1fr} .side{position:sticky;top:0;z-index:2} }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="side">
    <div class="brand">
      <img src="assets/brand/empire-logo.png" alt="The Empire"/>
      <div class="t1">THE EMPIRE</div>
    </div>
    <div class="nav">
      <button class="active" data-tab="dashboard">Overview</button>
      <button data-tab="cpa">CPA Accounts</button>
      <button data-tab="users">Users</button>
      <button data-tab="analytics">Analytics</button>
      <button data-tab="wallet">Wallet</button>
      <button data-tab="monitoring">Monitoring</button>
      <button data-tab="settings">Settings</button>
    </div>
  </aside>

  <!-- Main -->
  <main>
    <!-- OVERVIEW -->
    <section id="view-dashboard" class="view">
      <div class="row">
        <h1>COMMAND DASHBOARD</h1>
        <div class="actions">
          <span id="ovr-ts" class="ts"></span>
          <button class="link" id="btn-refresh-ovr">Refresh</button>
        </div>
      </div>
      <div class="hero panel span-12" style="display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;letter-spacing:2px">WELCOME TO THE EMPIRE</div>

      <div class="kpis" id="kpi-skel">
        <div class="skeleton" style="width:120px;height:56px"></div>
        <div class="skeleton" style="width:120px;height:56px"></div>
        <div class="skeleton" style="width:120px;height:56px"></div>
        <div class="skeleton" style="width:120px;height:56px"></div>
        <div class="skeleton" style="width:120px;height:56px"></div>
        <div class="skeleton" style="width:120px;height:56px"></div>
      </div>

      <div class="kpis" id="kpi-wrap" class="hidden">
        <div class="kpi"><div class="lab">Earnings</div><div class="val" id="kpi-earn">$0.00</div></div>
        <div class="kpi"><div class="lab">Leads</div><div class="val" id="kpi-leads">0</div></div>
        <div class="kpi"><div class="lab">Clicks</div><div class="val" id="kpi-clicks">0</div></div>
        <div class="kpi"><div class="lab">EPC</div><div class="val" id="kpi-epc">$0.00</div></div>
        <div class="kpi"><div class="lab">CPA</div><div class="val" id="kpi-cpa">$0.00</div></div>
        <div class="kpi"><div class="lab">RPM</div><div class="val" id="kpi-rpm">$0.00</div></div>
      </div>

      <div class="grid">
        <div class="panel span-6">
          <h3>BY GEO</h3>
          <table id="tbl-geo"><thead><tr><th>Country</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>BY DEVICE</h3>
          <table id="tbl-device"><thead><tr><th>Device</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>BY OFFER TYPE</h3>
          <table id="tbl-offer"><thead><tr><th>Offer Type</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>BY DAY</h3>
          <table id="tbl-day"><thead><tr><th>Date</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="ovrErr" class="note err hidden">Failed to load overview.</div>
    </section>

    <!-- CPA -->
    <section id="view-cpa" class="view hidden">
      <div class="row">
        <h1>CPA ACCOUNTS</h1>
        <div class="actions"><span id="cpa-ts" class="ts"></span><button class="link" id="btn-refresh-cpa">Refresh</button></div>
      </div>
      <div id="cpaGrid" class="grid"></div>
    </section>

    <!-- USERS -->
    <section id="view-users" class="view hidden">
      <div class="row">
        <h1>USERS</h1>
        <div class="actions"><span id="usr-ts" class="ts"></span><button class="link" id="btn-refresh-users">Refresh</button></div>
      </div>
      <table id="tbl-users"><thead><tr><th>Name</th><th>Email</th><th>Phone</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- ANALYTICS -->
    <section id="view-analytics" class="view hidden">
      <div class="row">
        <h1>ANALYTICS</h1>
        <div class="actions"><span id="ana-ts" class="ts"></span><button class="link" id="btn-refresh-ana">Refresh</button></div>
      </div>
      <table id="tbl-analytics"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- WALLET -->
    <section id="view-wallet" class="view hidden">
      <div class="row">
        <h1>WALLET</h1>
        <div class="actions"><span id="wal-ts" class="ts"></span><button class="link" id="btn-refresh-wallet">Refresh</button></div>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="lab">Balance</div><div class="val" id="wallet-balance">$0.00</div></div>
      </div>
      <div id="walletList" class="grid"></div>
    </section>

    <!-- MONITORING -->
    <section id="view-monitoring" class="view hidden">
      <div class="row">
        <h1>MONITORING</h1>
        <div class="actions"><span id="mon-ts" class="ts"></span><button class="link" id="btn-refresh-mon">Refresh</button></div>
      </div>
      <table id="tbl-monitor"><thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="view hidden">
      <div class="row">
        <h1>SETTINGS</h1>
        <div class="actions"><span id="cfg-ts" class="ts"></span><button class="link" id="btn-refresh-cfg">Refresh</button></div>
      </div>
      <pre id="cfgDump" class="panel" style="white-space:pre-wrap"></pre>
      <div id="cfgErr" class="note err hidden"></div>
      <div class="note warn">If you see “unknown action: config”, add support for <code>?action=config</code> in GAS to return system config JSON.</div>
    </section>
  </main>
</div>

<script>
  /* ======= CONFIG ======= */
  // Primary data source (GAS). If you later proxy through Netlify, just swap the URL.
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz-jj7Cr_KzqCku4SQPQ14MEIuCPdq5OEgiiqjo_O2A0FItBrHlmfkoJHViDxuX4P6z/exec";

  /* ======= UTILS ======= */
  const $=id=>document.getElementById(id);
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  const num=n=>(+n||0).toLocaleString();
  const fmtUSD=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(+n||0);
  const nowStr=()=>new Date().toLocaleString();

  // fetch with timeout + retries + explicit error body surfacing
  async function jget(url,{timeout=12000,retries=2}={}){
    for(let attempt=0; attempt<=retries; attempt++){
      const ctrl=new AbortController();
      const t=setTimeout(()=>ctrl.abort(),timeout);
      try{
        const r=await fetch(url,{cache:'no-store',signal:ctrl.signal});
        clearTimeout(t);
        const text=await r.text();
        let data; try{ data=JSON.parse(text); }catch{ data={ok:false,raw:text}; }
        if(!r.ok){ throw new Error(`HTTP ${r.status} ${r.statusText}`); }
        return data;
      }catch(e){
        clearTimeout(e?.name==="AbortError"?0:0);
        if(attempt===retries) throw e;
        await new Promise(res=>setTimeout(res, 600*(attempt+1))); // backoff
      }
    }
  }

  function setTS(id){ const el=$(id); if(el) el.textContent = `Updated ${nowStr()}`; }
  function emptyRow(cols,msg="No data."){ return `<tr><td colspan="${cols}" class="muted">${esc(msg)}</td></tr>`; }

  /* ======= TABS ======= */
  function showTab(key){
    document.querySelectorAll('.nav button').forEach(b=>{
      b.classList.toggle('active', b.dataset.tab===key);
    });
    document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
    const view = document.getElementById('view-'+key);
    if(view) view.classList.remove('hidden');

    if(key==='dashboard') loadOverview();
    if(key==='cpa')       loadCpa();
    if(key==='users')     loadUsers();
    if(key==='analytics') loadAnalytics();
    if(key==='wallet')    loadWallet();
    if(key==='monitoring')loadMonitoring();
    if(key==='settings')  loadSettings();
  }
  document.querySelectorAll('.nav button').forEach(b=>{
    b.addEventListener('click',()=>{ location.hash=b.dataset.tab; showTab(b.dataset.tab); });
  });

  /* ======= OVERVIEW ======= */
  async function loadOverview(){
    $('ovrErr').classList.add('hidden');
    $('kpi-wrap')?.classList?.add('hidden');
    $('kpi-skel')?.classList?.remove('hidden');
    try{
      const j = await jget(GAS_URL+"?action=overview");
      const t = j.totals||{};
      $('kpi-earn').textContent = fmtUSD(t.earnings||0);
      $('kpi-leads').textContent = num(t.leads||0);
      $('kpi-clicks').textContent = num(t.clicks||0);
      $('kpi-epc').textContent = fmtUSD(t.epc||0);
      $('kpi-cpa').textContent = fmtUSD(t.cpa||0);
      $('kpi-rpm').textContent = fmtUSD(t.rpm||0);
      $('kpi-skel')?.classList?.add('hidden');
      $('kpi-wrap')?.classList?.remove('hidden');

      const fill = (tbody, obj, keyLabel) => {
        tbody.innerHTML='';
        if(Array.isArray(obj)){ // array of {label,value} or keyed labels
          if(!obj.length){ tbody.innerHTML = emptyRow(2); return; }
          obj.forEach(r=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${esc(r.label||r[keyLabel]||'')}</td><td>${fmtUSD(r.value||r.amount||0)}</td>`;
            tbody.appendChild(tr);
          });
        }else{
          const entries = Object.entries(obj||{});
          if(!entries.length){ tbody.innerHTML = emptyRow(2); return; }
          entries.forEach(([k,v])=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${esc(k)}</td><td>${fmtUSD(v)}</td>`;
            tbody.appendChild(tr);
          });
        }
      };
      fill($('#tbl-geo tbody'), j.geo, 'country');
      fill($('#tbl-device tbody'), j.devices, 'device');
      fill($('#tbl-offer tbody'), j.offerTypes, 'offer');

      const dayBody=$('#tbl-day tbody'); dayBody.innerHTML='';
      const dayEntries = Object.entries(j.byDay||{});
      if(!dayEntries.length){ dayBody.innerHTML = emptyRow(2); }
      else{
        dayEntries.forEach(([d,v])=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(d)}</td><td>${fmtUSD(v)}</td>`;
          dayBody.appendChild(tr);
        });
      }
      setTS('ovr-ts');
    }catch(e){
      $('ovrErr').textContent = `Failed to load overview. ${e.message||e}`;
      $('ovrErr').classList.remove('hidden');
    }
  }
  $('#btn-refresh-ovr')?.addEventListener('click',loadOverview);

  /* ======= CPA ======= */
  async function loadCpa(){
    const grid=$('cpaGrid'); grid.innerHTML='';
    try{
      const j = await jget(GAS_URL+"?action=cpa");
      const items = Array.isArray(j.items)? j.items : [];
      if(!items.length){
        grid.innerHTML=`<div class="note err">No CPA accounts returned.</div>`;
      }else{
        items.forEach(acc=>{
          const card=document.createElement('div'); card.className='card span-4';
          card.innerHTML = `
            <div style="font-weight:800;margin-bottom:6px">${esc(acc.name||'CPA')}</div>
            <div class="muted">Offers</div><div style="font-weight:700">${num(acc.offers||acc.activeOffers||0)}</div>
            <div class="muted">Revenue</div><div style="font-weight:700">${fmtUSD(acc.revenue||0)}</div>
            <div class="muted">Clicks</div><div style="font-weight:700">${num(acc.clicks||0)}</div>
            <div class="muted">Conversion</div><div style="font-weight:700">${acc.conversionRate!=null?(typeof acc.conversionRate==='string'?acc.conversionRate:((acc.conversionRate*100).toFixed(1)+'%')):'—'}</div>`;
          grid.appendChild(card);
        });
      }
      setTS('cpa-ts');
    }catch(e){
      grid.innerHTML=`<div class="note err">Failed to load CPA: ${esc(e.message||e)}</div>`;
    }
  }
  $('#btn-refresh-cpa')?.addEventListener('click',loadCpa);

  /* ======= USERS ======= */
  async function loadUsers(){
    const body=$('#tbl-users tbody'); body.innerHTML='';
    try{
      const j = await jget(GAS_URL+"?action=users");
      const rows = Array.isArray(j.items)? j.items : [];
      if(!rows.length){ body.innerHTML = emptyRow(3,"No users."); }
      else{
        rows.forEach(u=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(u.name||'')}</td><td>${esc(u.email||'')}</td><td>${esc(u.phone||'')}</td>`;
          body.appendChild(tr);
        });
      }
      setTS('usr-ts');
    }catch(e){
      body.innerHTML=`<tr><td colspan="3">Failed to load users. ${esc(e.message||e)}</td></tr>`;
    }
  }
  $('#btn-refresh-users')?.addEventListener('click',loadUsers);

  /* ======= ANALYTICS ======= */
  async function loadAnalytics(){
    const body=$('#tbl-analytics tbody'); body.innerHTML='';
    try{
      const j = await jget(GAS_URL+"?action=analytics");
      const rows = Array.isArray(j.items)? j.items : [];
      if(!rows.length){ body.innerHTML = emptyRow(2,"No analytics rows."); }
      else{
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(r.metric||'')}</td><td>${esc(r.value==null?'':r.value)}</td>`;
          body.appendChild(tr);
        });
      }
      setTS('ana-ts');
    }catch(e){
      body.innerHTML=`<tr><td colspan="2">Failed to load analytics. ${esc(e.message||e)}</td></tr>`;
    }
  }
  $('#btn-refresh-ana')?.addEventListener('click',loadAnalytics);

  /* ======= WALLET ======= */
  async function loadWallet(){
    const list=$('walletList'); list.innerHTML='';
    try{
      const j = await jget(GAS_URL+"?action=wallet");
      $('wallet-balance').textContent = fmtUSD(j.balance||0);
      const hist = Array.isArray(j.history)? j.history : [];
      if(!hist.length){ list.innerHTML=`<div class="note err">No transactions.</div>`; }
      else{
        hist.forEach(tx=>{
          const div=document.createElement('div'); div.className='card span-6';
          const status = String(tx.status||'COMPLETED').toUpperCase();
          const badgeClass = status==='SUCCESS' || status==='COMPLETED' ? 'ok' : (status==='PENDING'?'':'down');
          div.innerHTML = `<div class="row">
              <div><div class="muted">${esc(tx.date||'')}</div><div>${esc(tx.method||'')}</div></div>
              <div style="text-align:right"><div style="font-weight:800">${fmtUSD(tx.amount||0)}</div>
              <span class="badge ${badgeClass}">${esc(status)}</span></div>
            </div>`;
          list.appendChild(div);
        });
      }
      setTS('wal-ts');
    }catch(e){
      list.innerHTML=`<div class="note err">Failed to load wallet. ${esc(e.message||e)}</div>`;
    }
  }
  $('#btn-refresh-wallet')?.addEventListener('click',loadWallet);

  /* ======= MONITORING ======= */
  async function loadMonitoring(){
    const body=$('#tbl-monitor tbody'); body.innerHTML='';
    try{
      const j = await jget(GAS_URL+"?action=monitoring");
      const evs = Array.isArray(j.events)? j.events : [];
      if(!evs.length){ body.innerHTML = emptyRow(3,"No events."); }
      else{
        evs.forEach(ev=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(ev.time||'')}</td><td>${esc(ev.type||'')}</td><td>${esc(ev.msg||'')}</td>`;
          body.appendChild(tr);
        });
      }
      setTS('mon-ts');
    }catch(e){
      body.innerHTML=`<tr><td colspan="3">Failed to load events. ${esc(e.message||e)}</td></tr>`;
    }
  }
  $('#btn-refresh-mon')?.addEventListener('click',loadMonitoring);

  /* ======= SETTINGS ======= */
  async function loadSettings(){
    $('cfgErr').classList.add('hidden');
    try{
      const j = await jget(GAS_URL+"?action=config");
      $('cfgDump').textContent = JSON.stringify(j,null,2);
      setTS('cfg-ts');
    }catch(e){
      $('cfgDump').textContent = '';
      $('cfgErr').textContent = `Failed to load config. ${e.message||e}`;
      $('cfgErr').classList.remove('hidden');
    }
  }
  $('#btn-refresh-cfg')?.addEventListener('click',loadSettings);

  /* ======= INIT & AUTO-REFRESH ======= */
  function boot(){
    const h=(location.hash||'#dashboard').replace('#','');
    showTab(h);
  }
  window.addEventListener('DOMContentLoaded', boot);
  window.addEventListener('hashchange', boot);

  // Light auto-refresh only for visible tab (60s)
  setInterval(()=>{
    const active = document.querySelector('.nav button.active')?.dataset?.tab;
    if(active==='dashboard') loadOverview();
    else if(active==='cpa') loadCpa();
    else if(active==='users') loadUsers();
    else if(active==='analytics') loadAnalytics();
    else if(active==='wallet') loadWallet();
    else if(active==='monitoring') loadMonitoring();
    else if(active==='settings') loadSettings();
  }, 60000);
</script>
</body>
</html>