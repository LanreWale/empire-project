<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THE EMPIRE — Command Dashboard</title>

<!-- Chart.js (for small simple charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0b1220;
    --bg2:#0f1620;
    --panel:#142030;
    --muted:#9fb2d1;
    --text:#e9eef6;
    --brand:#F2C230;
    --border:#1e2b40;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:#08101b; color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }

  a{ color:#b8d4ff; text-decoration:none; }
  .muted{ color:var(--muted); }
  .right{ margin-left:auto; }
  .hidden{ display:none !important; }

  /* NAV */
  header{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, #0d1726 0%, rgba(13,23,38,.6) 100%);
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .bar{ max-width:1180px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:12px; }
  .logo{ font-weight:900; letter-spacing:.08em; }
  nav{ display:flex; gap:12px; flex-wrap:wrap; }
  nav a{ padding:8px 10px; border-radius:8px; color:#cfe2ff; border:1px solid transparent; }
  nav a.active, nav a:hover{ background:#0f1d30; border-color:#213149; }

  /* LAYOUT */
  main{ padding: 0; }
  .container{ max-width:1180px; margin:0 auto; padding:18px 16px; }

  .hero{
    min-height:86px;
    background: radial-gradient(900px 500px at -10% 0%, #1b2d47, rgba(17,24,39,.2));
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px 16px;
    margin:16px 0;
  }
  .grid{ display:grid; gap:12px; }
  .grid.cols-12{ grid-template-columns: repeat(12, 1fr); }
  .span-12{ grid-column: span 12; }
  .span-8{ grid-column: span 8; }
  .span-6{ grid-column: span 6; }
  .span-4{ grid-column: span 4; }
  .span-3{ grid-column: span 3; }

  .panel{
    background: radial-gradient(1100px 700px at 25% -10%, #17253a 0%, #0f1620 55%);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.25) inset, 0 8px 20px rgba(0,0,0,.18);
    backdrop-filter: blur(6px);
  }
  .panel h3{ margin:0 0 6px; font-size:13px; color:#bcd0ea; font-weight:700; letter-spacing:.04em; }

  /* KPI */
  .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
  .kpi{ background:#101a2b; border:1px solid var(--border); border-radius:12px; padding:10px; }
  .kpi .lbl{ color:#8da6c8; font-size:12px; }
  .kpi .val{ font-size:20px; font-weight:800; letter-spacing:.02em; }

  /* CHARTS */
  .chart-box{ height:260px; }
  .chart-box canvas{ max-height:220px; }

  /* TABLE */
  table{ width:100%; border-collapse:collapse; }
  th,td{ text-align:left; padding:8px 10px; border-bottom:1px solid #152238; }
  th{ color:#a9c0df; font-weight:700; font-size:12px; letter-spacing:.03em; }

  /* BUTTONS */
  .btn{ all:unset; display:inline-flex; align-items:center; gap:8px; cursor:pointer;
        padding:8px 12px; border:1px solid #273449; border-radius:10px; color:#d9e6ff; }
  .btn.small{ padding:6px 10px; font-size:12px; }
  .btn:hover{ background:#0e1c2f; }
  .btn.brand{ background:var(--brand); color:#111; font-weight:800; border:none; }
  .btn.brand:hover{ filter:brightness(.95); }
  .btn.danger{ background:#c9364b; border:none; }

  /* FORM */
  .field{ margin:8px 0; }
  label{ display:block; font-size:12px; color:#9fb2d1; margin:0 0 4px; }
  input, select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #24324a;
    background:#0d1730; color:#e6eefc; outline:none;
  }
  input[readonly]{ opacity:.9 }

  /* MODAL */
  .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(4,10,18,.55); z-index:100; }
  .modal .panel{ width:100%; max-width:680px; }
  .flex{ display:flex; align-items:center; gap:10px; }

  /* Users pills */
  .pillbar{ display:flex; gap:8px; margin:8px 0 12px }
  .pill{ all:unset; cursor:pointer; padding:6px 10px; border-radius:999px; border:1px solid #273449; color:#9fb2d1; }
  .pill.active, .pill:hover{ background:#162232; color:#e9eef6; }

  /* small helpers */
  .note.err{ color:#ff8a8a; margin-top:6px; }
</style>
</head>

<body>
<header>
  <div class="bar">
    <div class="logo">THE&nbsp;EMPIRE</div>
    <nav id="nav">
      <a href="#/"            data-v="dashboard" class="active">Overview</a>
      <a href="#/cpa"         data-v="cpa">CPA Accounts</a>
      <a href="#/users"       data-v="users">Users</a>
      <a href="#/analytics"   data-v="analytics">Analytics</a>
      <a href="#/wallet"      data-v="wallet">Wallet</a>
      <a href="#/monitoring"  data-v="monitoring">Monitoring</a>
      <a href="#/settings"    data-v="settings">Settings</a>
    </nav>
    <button id="btn-open-cpa" class="btn brand right">+ Add Account</button>
  </div>
</header>

<main>

  <!-- ====== OVERVIEW ====== -->
  <section id="view-dashboard" class="view">
    <div class="container">
      <div class="hero">
        <h1 style="margin:0 0 4px">WELCOME TO THE EMPIRE</h1>
        <div class="kpis">
          <div class="kpi"><div class="lbl">Daily Earnings</div><div id="kpi-earn" class="val">$0.00</div></div>
          <div class="kpi"><div class="lbl">Total Clicks</div><div id="kpi-clicks" class="val">0</div></div>
          <div class="kpi"><div class="lbl">Total Leads</div><div id="kpi-leads" class="val">0</div></div>
          <div class="kpi"><div class="lbl">Conversion Rate</div><div id="kpi-cr" class="val">0.00%</div></div>
        </div>
      </div>

      <div class="grid cols-12">
        <div class="panel span-8 chart-box">
          <h3>Daily Earnings</h3>
          <canvas id="chart-daily"></canvas>
        </div>
        <div class="panel span-4 chart-box">
          <h3>Traffic Sources</h3>
          <canvas id="chart-traffic"></canvas>
        </div>

        <div class="panel span-6">
          <h3>By GEO</h3>
          <table id="tbl-geo"><thead><tr><th>Country</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="panel span-6">
          <h3>By DEVICE</h3>
          <table id="tbl-device"><thead><tr><th>Device</th><th>Earnings ($)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="ovrErr" class="note err hidden">Failed to load overview.</div>
    </div>
  </section>

  <!-- ====== CPA ACCOUNTS ====== -->
  <section id="view-cpa" class="view hidden">
    <div class="container">
      <h1>CPA ACCOUNTS</h1>
      <div class="panel">
        <table id="tbl-cpa">
          <thead><tr>
            <th>Account</th><th>Network</th><th>Custom Domain</th><th>Active Offers</th><th>Revenue ($)</th><th>Clicks</th><th>Conversion (%)</th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <div id="cpaEmpty" class="muted" style="margin-top:8px; display:none">No CPA accounts yet.</div>
      </div>
    </div>
  </section>

  <!-- Add CPA Modal -->
  <div id="cpa-modal" class="modal hidden">
    <div class="panel">
      <div class="flex" style="margin-bottom:8px">
        <h2 style="margin:0">Add New CPA Account</h2>
        <button id="cpa-close" class="btn right">×</button>
      </div>
      <form id="cpa-form" class="grid cols-12">
        <div class="field span-6">
          <label>Account Name</label>
          <input name="accountName" placeholder="e.g., Lanre Main" required />
        </div>
        <div class="field span-6">
          <label>Network</label>
          <select name="network" required>
            <option value="">Select…</option>
            <option>CPA Grip</option>
            <option>CPAlead</option>
            <option>AdWork Media</option>
            <option>OGAds</option>
          </select>
        </div>
        <div class="field span-6">
          <label>Account ID</label>
          <input name="accountId" placeholder="1533836" required />
        </div>
        <div class="field span-6">
          <label>Custom Domain</label>
          <input name="domain" placeholder="yourdomain.com" />
        </div>
        <div class="span-12 flex" style="margin-top:6px">
          <button type="button" class="btn" id="cpa-cancel">Cancel</button>
          <button type="submit" class="btn brand right">+ Add Account</button>
        </div>
      </form>
      <div id="cpaErr" class="note err hidden">Failed to add account.</div>
    </div>
  </div>

  <!-- ====== USERS ====== -->
  <section id="view-users" class="view hidden">
    <div class="container">
      <h1>USERS MANAGEMENT</h1>

      <div class="pillbar">
        <button class="pill active" data-uview="all">All</button>
        <button class="pill" data-uview="approved">Approved</button>
        <button class="pill" data-uview="pending">Pending</button>
        <button class="pill" data-uview="rejected">Rejected</button>
        <button class="btn small right" id="btn-open-invite">Invite</button>
      </div>

      <div class="panel">
        <table id="tbl-users">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Authority</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="usrErr" class="note err hidden">Failed to load users.</div>
    </div>
  </section>

  <!-- Invite modal -->
  <div id="invite-modal" class="modal hidden">
    <div class="panel" style="max-width:520px">
      <div class="flex" style="margin-bottom:8px">
        <h2 style="margin:0">Invite Link</h2>
        <button class="btn right" id="inv-close">×</button>
      </div>
      <div class="field">
        <label>Share this link</label>
        <input id="inv-link" readonly />
      </div>
      <div class="flex">
        <button id="inv-copy" class="btn brand">Copy</button>
        <a id="inv-wa" class="btn" target="_blank" rel="noopener">Share on WhatsApp</a>
        <span id="inv-msg" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- ====== ANALYTICS ====== -->
  <section id="view-analytics" class="view hidden">
    <div class="container">
      <h1>ANALYTICS</h1>
      <div class="grid cols-12">
        <div class="panel span-8 chart-box">
          <h3>Performance Overview</h3>
          <canvas id="chart-perf"></canvas>
        </div>
        <div class="panel span-4 chart-box">
          <h3>Geographic Distribution</h3>
          <canvas id="chart-geo"></canvas>
        </div>
      </div>
      <div id="anaErr" class="note err hidden">Failed to load analytics.</div>
    </div>
  </section>

  <!-- ====== WALLET ====== -->
  <section id="view-wallet" class="view hidden">
    <div class="container">
      <h1>WALLET</h1>
      <div class="grid cols-12">
        <div class="panel span-8">
          <h3>Transaction History</h3>
          <table id="tbl-wallet">
            <thead><tr><th>Date</th><th>Method</th><th>Amount ($)</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
          <div id="walEmpty" class="muted" style="margin-top:8px; display:none">No transactions.</div>
        </div>
        <div class="panel span-4">
          <h3>Validate Account</h3>
          <div class="field"><label>Country</label>
            <select id="wCountry"><option value="NG">NG</option><option value="US">US</option></select>
          </div>
          <div class="field"><label>Bank Code</label><input id="wBankCode" placeholder="058" /></div>
          <div class="field"><label>Account Number</label><input id="wAcct" placeholder="0123456789" /></div>
          <button id="wValidate" class="btn">Validate</button>
          <div id="valStatus" class="muted" style="margin-top:6px"></div>
          <hr style="border:0;border-top:1px solid #1e2b40; margin:14px 0">
          <div class="field"><label>Phone</label><input id="wPhone" placeholder="+234..." /></div>
          <div class="field"><label>Amount (USD)</label><input id="wAmount" placeholder="200" /></div>
          <button id="wRequest" class="btn brand right">Request Withdrawal</button>
          <div id="wMsg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== MONITORING ====== -->
  <section id="view-monitoring" class="view hidden">
    <div class="container">
      <h1>MONITORING</h1>
      <div class="panel">
        <table id="tbl-mon">
          <thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="monEmpty" class="muted" style="margin-top:8px; display:none">No events.</div>
    </div>
  </section>

  <!-- ====== SETTINGS ====== -->
  <section id="view-settings" class="view hidden">
    <div class="container">
      <h1>SETTINGS</h1>
      <div class="panel">
        <table><tbody id="cfgTable"></tbody></table>
      </div>
    </div>
  </section>

</main>

<script>
  /* ====== CONFIG ====== */
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZVlGMvYonfCNdQlwPHiqqgOVC80_HsyktSYmqmQPBKmRrlzg_yo4lKz_Mmu85B7eY/exec'

  /* ====== helpers ====== */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const esc = s => (s==null?'':String(s)).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const usd = v => '$' + (Number(v)||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => (Number(v)||0).toLocaleString();

  const jget  = async url => (await fetch(url, {cache:'no-store'})).json();
  const jpost = async (url, obj) => (await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams(obj).toString()
  })).json();

  /* ====== ROUTER ====== */
  function showView(name){
    $$('.view').forEach(v=>v.classList.add('hidden'));
    $('#view-'+name).classList.remove('hidden');
    $$('#nav a').forEach(a=>a.classList.toggle('active', a.dataset.v===name));

    // lazy-load per tab
    if(name==='dashboard') loadOverview();
    if(name==='cpa')       loadCpa();
    if(name==='users')     loadUsers();
    if(name==='analytics') loadAnalytics();
    if(name==='wallet')    loadWallet();
    if(name==='monitoring')loadMonitoring();
    if(name==='settings')  loadSettings();
  }
  function parseRoute(){
    const h=location.hash.replace('#','');
    if(!h || h==='/') return 'dashboard';
    return h.replace('/','');
  }
  window.addEventListener('hashchange', ()=>showView(parseRoute()));

  /* ====== OVERVIEW ====== */
  let chartDaily=null, chartTraffic=null;

  async function loadOverview(){
    try{
      const j = await jget(GAS_URL + '?action=overview');
      const t = j.totals || {};
      $('#kpi-earn').textContent  = usd((+t.earnings||0).toFixed(2));
      $('#kpi-clicks').textContent= num(t.clicks||0);
      $('#kpi-leads').textContent = num(t.leads||0);
      $('#kpi-cr').textContent    = ((t.conversionRate??0).toFixed(2)) + '%';

      const fillObj = (tbodySel, obj) => {
        const tb = $(tbodySel); tb.innerHTML='';
        const entries = Object.entries(obj||{});
        if(!entries.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No data</td></tr>`; return; }
        entries.forEach(([k,v])=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${esc(k)}</td><td>${usd((+v||0).toFixed(2))}</td>`;
          tb.appendChild(tr);
        });
      };
      fillObj('#tbl-geo tbody', j.geo);
      fillObj('#tbl-device tbody', j.devices);

      const dayArr = Array.isArray(j.byDay) ? j.byDay : [];
      const labels = dayArr.map(r => r.t || r.date || '');
      const values = dayArr.map(r => +r.earnings || +r.value || 0);

      if(chartDaily) chartDaily.destroy();
      chartDaily = new Chart($('#chart-daily'), {
        type:'line',
        data:{ labels: labels.length ? labels : [''], datasets:[{ label:'Earnings', data: values.length ? values : [0] }] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });

      const traffic = j.offerTypes || {};
      const tLabels = Object.keys(traffic); const tVals = Object.values(traffic).map(v=>+v||0);
      if(chartTraffic) chartTraffic.destroy();
      chartTraffic = new Chart($('#chart-traffic'), {
        type:'pie',
        data:{ labels: tLabels.length?tLabels:['No data'], datasets:[{ data: tVals.length?tVals:[1] }] },
        options:{ responsive:true, plugins:{legend:{display:true}} }
      });

      $('#ovrErr').classList.add('hidden');
    }catch(e){ $('#ovrErr').classList.remove('hidden'); }
  }

  /* ====== CPA ====== */
  async function loadCpa(){
    const body = $('#tbl-cpa tbody'); body.innerHTML='';
    try{
      const j = await jget(GAS_URL + '?action=cpa');
      const items = Array.isArray(j.items)? j.items: [];
      if(!items.length){ $('#cpaEmpty').style.display='block'; return; }
      $('#cpaEmpty').style.display='none';
      items.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${esc(r.account||'')}</td>
          <td>${esc(r.network||'')}</td>
          <td>${esc(r.domain||'')}</td>
          <td>${num(r.activeOffers||0)}</td>
          <td>${usd(r.revenue||0)}</td>
          <td>${num(r.clicks||0)}</td>
          <td>${((r.conversionRate||0)*100).toFixed(2)}</td>`;
        body.appendChild(tr);
      });
    }catch(e){ $('#cpaEmpty').style.display='block'; }
  }

  // open/close modal
  $('#btn-open-cpa').onclick = ()=> $('#cpa-modal').classList.remove('hidden');
  const closeCpaModal = ()=> $('#cpa-modal').classList.add('hidden');
  $('#cpa-close').onclick = closeCpaModal;
  $('#cpa-cancel').onclick = closeCpaModal;

  // submit CPA
  $('#cpa-form').addEventListener('submit', async e=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    try{
      // Backend expects action "addcpa" (GAS doPost router)
      const json = await jpost(GAS_URL, { action:'addcpa', ...data });
      if(!json.ok) throw new Error(json.error || 'Add failed');
      alert('CPA account added ✔');
      closeCpaModal();
      loadCpa();
    }catch(err){
      $('#cpaErr').classList.remove('hidden');
      alert('Add CPA failed: ' + err.message);
    }
  });

  /* ====== USERS ====== */
  async function loadUsers(){
    const body = $('#tbl-users tbody'); body.innerHTML='';
    try{
      const j = await jget(GAS_URL + '?action=users');
      // de-dupe by email
      const map = {};
      (j.items||[]).forEach(u=>{
        const key = String(u.email||'').toLowerCase().trim();
        if(!key) return;
        if(!map[key]) map[key] = u;
      });
      const items = Object.values(map);

      // segmentation
      const by = { all: items, pending:[], approved:[], rejected:[] };
      items.forEach(u=>{
        const s = String(u.status||u.approval||'approved').toLowerCase();
        if(s.includes('pend')) by.pending.push(u);
        else if(s.includes('reject')) by.rejected.push(u);
        else by.approved.push(u);
      });

      // renderer
      const render = arr=>{
        body.innerHTML='';
        if(!arr.length){ body.innerHTML=`<tr><td colspan="4" class="muted">No users.</td></tr>`; return; }
        arr.forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${esc(u.name||'')}</td>
                          <td>${esc(u.email||'')}</td>
                          <td>${esc(u.phone||'')}</td>
                          <td>${esc(u.authority||'1x User')}</td>`;
          body.appendChild(tr);
        });
      };

      // pills click
      const pills = $$('.pillbar .pill');
      pills.forEach(p=>p.onclick = ()=>{
        pills.forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        render(by[p.dataset.uview] || items);
      });

      render(items); // default
      $('#usrErr').classList.add('hidden');

      // Invite modal wiring
      const cfg = await jget(GAS_URL + "?action=config");
      const base = cfg.invite_base || 'https://superlative-pothos-ebf5f2.netlify.app/';
      const link = base + (base.includes('?')?'&':'?') + 'ref=SUPREME_COMMANDER';
      $('#inv-link').value = link;
      $('#inv-copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText(link); $('#inv-msg').textContent='Copied ✔'; setTimeout(()=>$('#inv-msg').textContent='',1200);}catch{ alert(link); } };
      $('#inv-wa').href = `https://wa.me/?text=${encodeURIComponent('Join the Empire: ' + link)}`;

    }catch(e){ $('#usrErr').classList.remove('hidden'); }
  }
  $('#btn-open-invite').onclick = ()=> $('#invite-modal').classList.remove('hidden');
  $('#inv-close').onclick = ()=> $('#invite-modal').classList.add('hidden');

  /* ====== ANALYTICS ====== */
  let chartPerf=null, chartGeo=null;
  async function loadAnalytics(){
    try{
      const j = await jget(GAS_URL + '?action=analytics');
      const items = Array.isArray(j.items) ? j.items : [];

      // Simple: if metrics list present, bar them; else empty-state
      const labels = items.map(x=>x.metric||'');
      const values = items.map(x=>Number(x.value)||0);

      if(chartPerf) chartPerf.destroy();
      chartPerf = new Chart($('#chart-perf'), {
        type:'bar',
        data:{ labels: labels.length?labels:[''], datasets:[{ data: values.length?values:[0], label:'Metrics' }] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });

      if(chartGeo) chartGeo.destroy();
      chartGeo = new Chart($('#chart-geo'), {
        type:'doughnut',
        data:{ labels: labels.length?labels.slice(0,6):['No data'], datasets:[{ data: values.length?values.slice(0,6):[1] }] },
        options:{ responsive:true }
      });

      $('#anaErr').classList.add('hidden');
    }catch(e){ $('#anaErr').classList.remove('hidden'); }
  }

  /* ====== WALLET ====== */
  async function loadWallet(){
    try{
      const j = await jget(GAS_URL + '?action=wallet');
      const body = $('#tbl-wallet tbody'); body.innerHTML='';
      const items = Array.isArray(j.history)? j.history : [];
      if(!items.length){ $('#walEmpty').style.display='block'; } else { $('#walEmpty').style.display='none'; }
      items.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(r.date||'')}</td><td>${esc(r.method||'')}</td><td>${usd(r.amount||0)}</td><td>${esc(r.status||'')}</td>`;
        body.appendChild(tr);
      });
    }catch(e){
      $('#walEmpty').style.display='block';
    }
  }

  $('#wValidate').onclick = async ()=>{
    const country = $('#wCountry').value;
    const code    = $('#wBankCode').value.trim();
    const acct    = $('#wAcct').value.trim();
    $('#valStatus').textContent = 'Validating...';
    try{
      const j = await jget(`${GAS_URL}?action=validatebank&country=${encodeURIComponent(country)}&code=${encodeURIComponent(code)}&acct=${encodeURIComponent(acct)}`);
      if(!j.ok){ $('#valStatus').textContent = 'Validation failed.'; return; }
      $('#valStatus').textContent = j.valid ? `Valid ✔  ${j.bank||''} ${j.code||''}  ${j.holder||''}` : 'Invalid account';
    }catch{ $('#valStatus').textContent = 'Validation error.'; }
  };

  $('#wRequest').onclick = async ()=>{
    const amt = $('#wAmount').value.trim();
    const country = $('#wCountry').value;
    const code = $('#wBankCode').value.trim();
    const acct = $('#wAcct').value.trim();
    const phone = $('#wPhone').value.trim();
    $('#wMsg').textContent = 'Submitting...';
    try{
      const j = await jpost(GAS_URL, { action:'withdraw', amount:amt, country, bankCode:code, account:acct, phone });
      if(!j.ok) throw new Error(j.error||'Failed');
      $('#wMsg').textContent = `Requested ✔  ID: ${j.requestId}`;
      loadWallet();
    }catch(e){ $('#wMsg').textContent = 'Request failed: ' + e.message; }
  };

  /* ====== MONITORING ====== */
  async function loadMonitoring(){
    try{
      const j = await jget(GAS_URL + '?action=monitoring');
      const body = $('#tbl-mon tbody'); body.innerHTML='';
      const items = Array.isArray(j.events)? j.events : [];
      if(!items.length){ $('#monEmpty').style.display='block'; } else { $('#monEmpty').style.display='none'; }
      items.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${esc(r.time||'')}</td><td>${esc(r.type||'')}</td><td>${esc(r.msg||'')}</td>`;
        body.appendChild(tr);
      });
    }catch(e){ $('#monEmpty').style.display='block'; }
  }

  /* ====== SETTINGS ====== */
  async function loadSettings(){
    try{
      const j = await jget(GAS_URL + '?action=config');
      const t = $('#cfgTable'); t.innerHTML='';
      const flat = {
        'Commander Name': j.commander_name,
        'Theme': j.theme,
        'Invite Base': j.invite_base,
        'Sheet ID': (j.config||{}).sheetId,
        'Telegram Chat': (((j.config||{}).telegram||{}).chatId),
        'Updated At': j.updatedAt
      };
      Object.entries(flat).forEach(([k,v])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<th style="width:180px" class="muted">${esc(k)}</th><td>${esc(v||'')}</td>`;
        t.appendChild(tr);
      });
    }catch(e){
      $('#cfgTable').innerHTML = `<tr><td class="muted">Failed to load config.</td></tr>`;
    }
  }

  /* ====== INIT ====== */
  showView(parseRoute());

</script>
</body>
</html>